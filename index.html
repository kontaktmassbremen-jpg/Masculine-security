<!-- ======================================================================
FILE: index.html
Masculine Security — Dienstplan (Blue theme, White text)
✅ Fix: WhatsApp senden (PDF share on mobile, fallback desktop)
✅ Fix: Datum format dd.mm.yyyy (e.g., 16.02.2026)
✅ Fix: NO code/raw text shown at bottom
✅ Auto: Tag/Nacht + Uhrzeit (based on shift)
✅ Arbeitstage: choose by clicking (chips)
✅ PDF: Logo + company info + professional layout (like sample)
✅ Documentation section (tab)
✅ Offline cache (works with service-worker.js + version.txt)
====================================================================== -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Dienstplan</title>
  <meta name="theme-color" content="#0b4fa3"/>

  <!-- Optional PWA -->
  <link rel="manifest" href="manifest.json"/>

  <!-- PDF libs (CDN) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg1:#06213f;
      --bg2:#073d78;
      --panel:#0b4fa3;
      --card:#0a3f7e;
      --line:rgba(255,255,255,.12);
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --accent:#61b6ff;
      --good:#28e0b2;
      --warn:#ffd166;
      --bad:#ff5a7a;

      --r:18px;
      --r2:12px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 25% -10%, rgba(97,182,255,.35), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(40,224,178,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Prevent any accidental code overflow showing */
    pre, code, textarea, .debug, .raw, .dump { display:none !important; }

    .wrap{max-width:1200px; margin:22px auto; padding:0 14px 28px;}

    .topbar{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{display:flex; gap:12px; align-items:center; min-width:260px;}
    .logo{
      width:52px; height:52px; border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--line);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .btxt{display:flex; flex-direction:column; gap:3px;}
    .title{font-size:18px; font-weight:800; letter-spacing:.4px}
    .sub{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
    .sub b{color:var(--text); font-weight:700}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tabbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .tabbtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}
    .tabbtn.active{background:rgba(97,182,255,.25); border-color:rgba(97,182,255,.55)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.14)}
    .btn.primary{background:rgba(97,182,255,.28); border-color:rgba(97,182,255,.6)}
    .btn.good{background:rgba(40,224,178,.22); border-color:rgba(40,224,178,.55)}
    .btn.warn{background:rgba(255,209,102,.18); border-color:rgba(255,209,102,.5)}
    .btn.bad{background:rgba(255,90,122,.18); border-color:rgba(255,90,122,.5)}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      min-width:0;
    }

    h2{margin:0 0 8px; font-size:16px; font-weight:900}
    .hint{color:var(--muted); font-size:12px; line-height:1.45}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
      margin-top:12px;
    }
    @media (max-width: 680px){ .form{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px; min-width:0}
    label{font-size:12px; color:var(--muted); font-weight:800}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(7,25,55,.45);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    input::placeholder{color:rgba(255,255,255,.55); font-weight:700}
    input:focus, select:focus{border-color:rgba(97,182,255,.75); box-shadow:0 0 0 3px rgba(97,182,255,.18)}

    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px; border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(7,25,55,.25);
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:.12s transform, .12s background;
      font-size:12px;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.on{background:rgba(97,182,255,.26); border-color:rgba(97,182,255,.55)}
    .row-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,25,55,.25);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:12px;
      vertical-align:top;
      color:var(--text);
      font-weight:800;
    }
    th{background:rgba(255,255,255,.10); text-transform:uppercase; letter-spacing:.35px; font-size:11px;}
    tr:last-child td{border-bottom:none}
    td.muted{color:rgba(255,255,255,.70); font-weight:700}

    .previewBox{
      background:rgba(7,25,55,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px;
      min-height:110px;
      font-size:12px;
      color:rgba(255,255,255,.92);
      white-space:pre-wrap;
      line-height:1.5;
      font-weight:800;
    }

    /* PDF hidden template */
    #pdfRoot{ position:absolute; left:-99999px; top:-99999px; width:794px; } /* A4 width @ 96dpi */
    .pdfPage{
      width:794px; min-height:1123px; /* A4 */
      background:#ffffff;
      color:#0b1a33;
      font-family: Arial, sans-serif;
      padding:26px 28px;
    }
    .pdfHeader{
      display:flex; justify-content:space-between; align-items:flex-start;
      border-bottom:3px solid #0b4fa3;
      padding-bottom:10px;
      margin-bottom:12px;
      gap:14px;
    }
    .pdfBrand{display:flex; gap:12px; align-items:center}
    .pdfLogo{
      width:56px; height:56px; border-radius:12px;
      border:1px solid rgba(11,79,163,.25);
      overflow:hidden;
      background:#f3f8ff;
      display:grid; place-items:center;
    }
    .pdfLogo img{width:100%; height:100%; object-fit:cover}
    .pdfTitle{font-size:18px; font-weight:900; color:#0b4fa3}
    .pdfMeta{font-size:11px; color:#2b3a55; line-height:1.35}
    .pdfMeta b{color:#0b1a33}
    .pdfH1{
      text-align:center;
      color:#0b4fa3;
      font-size:16px;
      font-weight:900;
      margin:14px 0 10px;
    }
    .pdfInfoRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 16px;
      font-size:11px;
      margin-bottom:12px;
    }
    .pdfBox{
      border:1px solid rgba(11,79,163,.25);
      border-radius:10px;
      padding:8px 10px;
      background:#f6fbff;
    }
    .pdfTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:8px;
      border:1px solid rgba(11,79,163,.25);
    }
    .pdfTable th, .pdfTable td{
      border:1px solid rgba(11,79,163,.25);
      padding:7px 8px;
      text-align:left;
    }
    .pdfTable th{
      background:#eaf4ff;
      color:#0b4fa3;
      font-weight:900;
      font-size:10.5px;
      text-transform:uppercase;
      letter-spacing:.25px;
    }
    .pdfNoticeTitle{
      margin:14px 0 6px;
      text-align:center;
      color:#c62828;
      font-weight:900;
      font-size:12px;
    }
    .pdfNotice{
      font-size:10.5px;
      line-height:1.35;
      color:#1d2a44;
      text-align:center;
    }
    .pdfFooter{
      position:relative;
      margin-top:18px;
      font-size:10px;
      color:#3a4a66;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
    }
    .pdfPageNo{color:#3a4a66}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img id="brandLogo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
        </div>
        <div class="btxt">
          <div class="title">MASCULINE SECURITY — Dienstplan</div>
          <div class="sub">
            <span><b>Adresse:</b> Werschenregerstraße 6 · 28237 Bremen</span>
            <span><b>Tel:</b> 015778697052</span>
            <span><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</span>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tabbtn active" id="tabPlan">Wochenplan</button>
        <button class="tabbtn" id="tabDocs">Dokumentation</button>
      </div>

      <div class="actions">
        <button class="btn" id="btnPrint">Drucken</button>
        <button class="btn primary" id="btnPdf">PDF</button>
        <button class="btn good" id="btnWhatsApp">WhatsApp senden</button>
        <button class="btn" id="btnCsv">Export CSV</button>
        <button class="btn bad" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT: PLAN -->
      <div class="card" id="viewPlan">
        <h2>Wöchentlicher Mitarbeiter-Dienstplan</h2>
        <div class="hint">
          ✅ Arbeitstage dooro adigoo <b>click</b> ku saaraya (chips).<br>
          ✅ Shift (Tag/Nacht) + Uhrzeit waa <b>automatic</b> markaad doorato “Schicht”.<br>
          ✅ Datum wuxuu noqdaa <b>dd.mm.yyyy</b> (tusaale 16.02.2026).
        </div>

        <div class="form">
          <div class="field">
            <label>Datum (dd.mm.yyyy)</label>
            <input id="date" placeholder="16.02.2026">
          </div>

          <div class="field">
            <label>KW (optional)</label>
            <input id="kw" placeholder="z.B. 07">
          </div>

          <div class="field">
            <label>Mitarbeiter Name</label>
            <input id="empName" placeholder="z.B. Mustafa Mursal Abdi">
          </div>

          <div class="field">
            <label>Mitarbeiter-Nr (optional)</label>
            <input id="empNo" placeholder="z.B. MS-001">
          </div>

          <div class="field" style="grid-column:1 / -1">
            <label>Arbeitstage (klick auswählen)</label>
            <div class="chips" id="dayChips"></div>
          </div>

          <div class="field">
            <label>Objekt / Einsatz</label>
            <input id="objekt" placeholder="z.B. LAST Birkenfels">
          </div>

          <div class="field">
            <label>Notiz (optional)</label>
            <input id="note" placeholder="z.B. Tor 2 / Schlüssel / Uniform">
          </div>

          <div class="field">
            <label>Schicht (Tag/Nacht) — automatisch</label>
            <select id="shift">
              <option value="Tag">Tag</option>
              <option value="Nacht">Nacht</option>
            </select>
          </div>

          <div class="field">
            <label>Uhrzeit — automatisch</label>
            <input id="time" placeholder="07:00–19:00">
          </div>
        </div>

        <div class="row-actions">
          <button class="btn good" id="btnAdd">+ Eintrag speichern</button>
          <button class="btn" id="btnClearForm">Formular leeren</button>
        </div>

        <div style="height:12px"></div>

        <h2>Gespeicherte Einträge</h2>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Mitarbeiter</th>
              <th>Nr</th>
              <th>Tage</th>
              <th>Objekt</th>
              <th>Schicht</th>
              <th>Uhrzeit</th>
              <th>Notiz</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td class="muted" colspan="9">Noch keine Einträge.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- RIGHT: PREVIEW + DOCS -->
      <div class="card" id="viewRight">
        <div id="viewPreview">
          <h2>Vorschau (Text an Mitarbeiter senden)</h2>
          <div class="hint">Kopieren & direkt in WhatsApp/Email einfügen (oder Button “WhatsApp senden”).</div>
          <div style="height:10px"></div>
          <div class="previewBox" id="msgPreview"></div>

          <div class="row-actions">
            <button class="btn" id="btnCopy">Text kopieren</button>
            <button class="btn good" id="btnWhatsAppText">WhatsApp (Text)</button>
          </div>
        </div>

        <div id="viewDocs" style="display:none">
          <h2>Dokumentation</h2>
          <div class="hint">
            Halkan ku qor dokumentation (tusaale: Einsatz-Notizen, Übergabe, Vorkommnisse).<br>
            ✅ Auto-save (local) — kadib PDF waxaad ku darsan kartaa dokumentation.
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Dokumentation Text</label>
            <textarea id="docText" style="display:block; width:100%; min-height:260px; padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.16); background:rgba(7,25,55,.45); color:#fff; font-weight:800; outline:none;"></textarea>
          </div>

          <div class="row-actions">
            <button class="btn good" id="btnSaveDoc">Dokumentation speichern</button>
            <button class="btn warn" id="btnPdfDoc">Dokumentation als PDF</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Hidden PDF template -->
  <div id="pdfRoot">
    <div class="pdfPage" id="pdfPage">
      <div class="pdfHeader">
        <div class="pdfBrand">
          <div class="pdfLogo"><img id="pdfLogo" src="logo.png" alt="Logo"></div>
          <div>
            <div class="pdfTitle">Masculine Security</div>
            <div class="pdfMeta">
              <div><b>Adresse:</b> Werschenregerstraße 6, 28237 Bremen</div>
              <div><b>Tel:</b> 015778697052</div>
              <div><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</div>
            </div>
          </div>
        </div>
        <div class="pdfMeta" style="text-align:right">
          <div><b>Datum:</b> <span id="pdfDate">16.02.2026</span></div>
          <div><b>KW:</b> <span id="pdfKW">—</span></div>
          <div><b>Seite:</b> <span class="pdfPageNo">1 / 1</span></div>
        </div>
      </div>

      <div class="pdfH1">Vorläufiger Dienstplan</div>

      <div class="pdfInfoRow">
        <div class="pdfBox"><b>Mitarbeiter:</b> <span id="pdfEmp">—</span></div>
        <div class="pdfBox"><b>Mitarbeiter-Nr:</b> <span id="pdfEmpNo">—</span></div>
        <div class="pdfBox"><b>Objekt / Einsatz:</b> <span id="pdfObj">—</span></div>
        <div class="pdfBox"><b>Schicht / Uhrzeit:</b> <span id="pdfShiftTime">—</span></div>
      </div>

      <table class="pdfTable" id="pdfTable">
        <thead>
          <tr>
            <th>Tag</th>
            <th>Uhrzeit</th>
            <th>Objekt</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody id="pdfTbody">
          <tr><td colspan="4">Keine Einträge.</td></tr>
        </tbody>
      </table>

      <div class="pdfNoticeTitle">DRINGEND BEACHTEN:</div>
      <div class="pdfNotice">
        Dienstantritt ist 20 Minuten vor Dienstbeginn!<br>
        Verspätungen und Ausfälle sind unverzüglich telefonisch zu melden!<br>
        Sonderbewachungen müssen nach Dienstende schriftlich mitgeteilt werden.<br>
        Stundenzettel spätestens 2 Tage vor Monatsende einreichen.
      </div>

      <div class="pdfFooter">
        <div>Masculine Security — Dienstplan</div>
        <div class="pdfPageNo">Seite 1 von 1</div>
      </div>
    </div>
  </div>

  <script>
    /* ======================
       STORAGE / STATE
       ====================== */
    const LS_KEY = "ms_dienstplan_v9";
    const LS_DOC = "ms_doku_v1";
    const state = {
      entries: [],
      days: new Set(),
      meta: {
        date: "",
        kw: "",
        empName: "",
        empNo: "",
        objekt: "",
        note: "",
        shift: "Tag",
        time: ""
      }
    };

    const DAY_LIST = [
      {key:"Mo", label:"Montag"},
      {key:"Di", label:"Dienstag"},
      {key:"Mi", label:"Mittwoch"},
      {key:"Do", label:"Donnerstag"},
      {key:"Fr", label:"Freitag"},
      {key:"Sa", label:"Samstag"},
      {key:"So", label:"Sonntag"},
    ];

    const SHIFT_TIMES = {
      Tag: "07:00–19:00",
      Nacht: "19:00–07:00"
    };

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatDateDE(d){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`; }

    function tryParseDateAny(v){
      if(!v) return null;
      v = String(v).trim();
      const iso = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso){
        const d = new Date(+iso[1], +iso[2]-1, +iso[3]);
        return isNaN(d) ? null : d;
      }
      const de = v.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
      if(de){
        const d = new Date(+de[3], +de[2]-1, +de[1]);
        return isNaN(d) ? null : d;
      }
      return null;
    }
    function normalizeDateToDE(v){
      const d = tryParseDateAny(v);
      return d ? formatDateDE(d) : formatDateDE(new Date());
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        entries: state.entries,
        days: Array.from(state.days),
        meta: state.meta
      }));
    }
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        state.entries = Array.isArray(data.entries) ? data.entries : [];
        state.days = new Set(Array.isArray(data.days) ? data.days : []);
        state.meta = Object.assign(state.meta, data.meta||{});
      }catch(e){}
    }

    /* ======================
       UI helpers
       ====================== */
    const $ = (s)=>document.querySelector(s);

    function renderDayChips(){
      const wrap = $("#dayChips");
      wrap.innerHTML = "";
      for(const d of DAY_LIST){
        const chip = document.createElement("div");
        chip.className = "chip" + (state.days.has(d.key) ? " on" : "");
        chip.textContent = d.key;
        chip.title = d.label;
        chip.addEventListener("click", ()=>{
          if(state.days.has(d.key)) state.days.delete(d.key);
          else state.days.add(d.key);
          renderDayChips();
          rebuildPreview();
          saveState();
        });
        wrap.appendChild(chip);
      }
    }

    function setFormFromMeta(){
      $("#date").value   = state.meta.date || formatDateDE(new Date());
      $("#kw").value     = state.meta.kw || "";
      $("#empName").value= state.meta.empName || "";
      $("#empNo").value  = state.meta.empNo || "";
      $("#objekt").value = state.meta.objekt || "";
      $("#note").value   = state.meta.note || "";
      $("#shift").value  = state.meta.shift || "Tag";
      $("#time").value   = state.meta.time || SHIFT_TIMES[$("#shift").value] || "07:00–19:00";
    }

    function syncMetaFromForm(){
      state.meta.date    = normalizeDateToDE($("#date").value);
      state.meta.kw      = $("#kw").value.trim();
      state.meta.empName = $("#empName").value.trim();
      state.meta.empNo   = $("#empNo").value.trim();
      state.meta.objekt  = $("#objekt").value.trim();
      state.meta.note    = $("#note").value.trim();
      state.meta.shift   = $("#shift").value;
      state.meta.time    = $("#time").value.trim();
      $("#date").value = state.meta.date; // enforce dd.mm.yyyy
    }

    function autoShiftByTime(){
      // If time looks like "19:00–07:00" or "19:00-07:00"
      const t = ($("#time").value||"").replace(/\s/g,"");
      const m = t.match(/^(\d{1,2}):(\d{2}).*?(\d{1,2}):(\d{2})$/);
      if(!m) return;
      const start = (+m[1])*60 + (+m[2]);
      const end   = (+m[3])*60 + (+m[4]);
      // If crosses midnight or start >= 18:00 => Nacht
      const nacht = (end < start) || (start >= 18*60) || (end <= 6*60);
      $("#shift").value = nacht ? "Nacht" : "Tag";
    }

    function autoTimeByShift(){
      const sh = $("#shift").value;
      $("#time").value = SHIFT_TIMES[sh] || $("#time").value;
    }

    function renderRows(){
      const tb = $("#rows");
      if(!state.entries.length){
        tb.innerHTML = `<tr><td class="muted" colspan="9">Noch keine Einträge.</td></tr>`;
        return;
      }
      tb.innerHTML = "";
      state.entries.forEach((e, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(e.empName||"")}</td>
          <td>${escapeHtml(e.empNo||"")}</td>
          <td>${escapeHtml((e.days||[]).join(", "))}</td>
          <td>${escapeHtml(e.objekt||"")}</td>
          <td>${escapeHtml(e.shift||"")}</td>
          <td>${escapeHtml(e.time||"")}</td>
          <td>${escapeHtml(e.note||"")}</td>
          <td>
            <button class="btn bad" data-del="${idx}" style="padding:7px 9px; border-radius:10px;">Löschen</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = +btn.getAttribute("data-del");
          state.entries.splice(i,1);
          saveState();
          renderRows();
          rebuildPreview();
        });
      });
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function buildMessageText(){
      syncMetaFromForm();
      const date = state.meta.date || formatDateDE(new Date());
      const kw = state.meta.kw ? `KW ${state.meta.kw}` : "KW —";
      const name = state.meta.empName || "Mitarbeiter";
      const empNo = state.meta.empNo ? ` (${state.meta.empNo})` : "";
      const obj = state.meta.objekt || "—";
      const shift = state.meta.shift || "Tag";
      const time = state.meta.time || SHIFT_TIMES[shift];
      const days = Array.from(state.days);
      const dayStr = days.length ? days.join(", ") : "—";

      return [
        `MASCULINE SECURITY — Dienstplan`,
        `Datum: ${date} | ${kw}`,
        `Mitarbeiter: ${name}${empNo}`,
        `Tage: ${dayStr}`,
        `Objekt: ${obj}`,
        `Schicht: ${shift} | Uhrzeit: ${time}`,
        state.meta.note ? `Notiz: ${state.meta.note}` : "",
        ``,
        `DRINGEND: 20 Min vor Dienstbeginn da sein. Ausfälle sofort melden.`
      ].filter(Boolean).join("\n");
    }

    function rebuildPreview(){
      $("#msgPreview").textContent = buildMessageText();
      // also refresh pdf template values
      fillPdfTemplate();
    }

    /* ======================
       PDF TEMPLATE
       ====================== */
    function fillPdfTemplate(){
      syncMetaFromForm();

      const date = state.meta.date || formatDateDE(new Date());
      $("#pdfDate").textContent = date;
      $("#pdfKW").textContent = state.meta.kw ? `KW ${state.meta.kw}` : "—";
      $("#pdfEmp").textContent = state.meta.empName || "—";
      $("#pdfEmpNo").textContent = state.meta.empNo || "—";
      $("#pdfObj").textContent = state.meta.objekt || "—";
      $("#pdfShiftTime").textContent = `${state.meta.shift || "—"} / ${state.meta.time || "—"}`;

      const body = $("#pdfTbody");
      const days = Array.from(state.days);
      const obj = state.meta.objekt || "—";
      const note = state.meta.note || "—";
      const time = state.meta.time || "—";

      if(!days.length){
        body.innerHTML = `<tr><td colspan="4">Keine Einträge.</td></tr>`;
        return;
      }

      body.innerHTML = days.map(d=>`
        <tr>
          <td>${escapeHtml(d)}</td>
          <td>${escapeHtml(time)}</td>
          <td>${escapeHtml(obj)}</td>
          <td>${escapeHtml(note)}</td>
        </tr>
      `).join("");
    }

    async function makePdfBlobFromTemplate(){
      fillPdfTemplate();

      const date = $("#pdfDate").textContent || formatDateDE(new Date());
      const filename = `Dienstplan_${date.replaceAll(".","-")}.pdf`;

      // Ensure logo loads
      const img = $("#pdfLogo");
      if(img && !img.complete){
        await new Promise(res=>{ img.onload=res; img.onerror=res; });
      }

      const element = $("#pdfPage");
      const opt = {
        margin: [10, 10, 10, 10],
        filename,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      // html2pdf returns instance; we can get blob via outputPdf
      const worker = html2pdf().set(opt).from(element);
      const pdf = await worker.toPdf().get("pdf");
      const blob = pdf.output("blob");
      return { blob, filename };
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    /* ======================
       WHATSAPP SEND (PDF + TEXT)
       ====================== */
    function openWhatsAppWithText(text){
      const encoded = encodeURIComponent(text);
      window.open(`https://wa.me/?text=${encoded}`, "_blank", "noopener,noreferrer");
    }

    async function sendWhatsAppPdf(){
      // 1) create pdf
      let out = null;
      try{ out = await makePdfBlobFromTemplate(); }catch(e){ out = null; }

      // 2) if mobile share supports files => share pdf directly (best)
      if(out && navigator.canShare){
        try{
          const file = new File([out.blob], out.filename, {type:"application/pdf"});
          if(navigator.canShare({files:[file]})){
            await navigator.share({
              title: `Dienstplan ${$("#pdfDate").textContent}`,
              text: `Dienstplan (${ $("#pdfDate").textContent })`,
              files: [file]
            });
            return;
          }
        }catch(e){/* fallback */}
      }

      // 3) fallback: download then open whatsapp with text (desktop)
      if(out){
        downloadBlob(out.blob, out.filename);
        openWhatsAppWithText(
          buildMessageText() + "\n\nPDF wurde heruntergeladen: " + out.filename + "\nBitte in WhatsApp als Anhang hinzufügen."
        );
        return;
      }

      // 4) last fallback: text only
      openWhatsAppWithText(buildMessageText());
    }

    /* ======================
       CSV EXPORT
       ====================== */
    function exportCSV(){
      syncMetaFromForm();
      const rows = [];
      rows.push(["Datum", state.meta.date]);
      rows.push(["KW", state.meta.kw || ""]);
      rows.push(["Mitarbeiter", state.meta.empName || ""]);
      rows.push(["MitarbeiterNr", state.meta.empNo || ""]);
      rows.push(["Objekt", state.meta.objekt || ""]);
      rows.push(["Schicht", state.meta.shift || ""]);
      rows.push(["Uhrzeit", state.meta.time || ""]);
      rows.push(["Tage", Array.from(state.days).join(", ")]);
      rows.push(["Notiz", state.meta.note || ""]);
      rows.push(["---", "---"]);
      rows.push(["#", "Mitarbeiter", "Nr", "Tage", "Objekt", "Schicht", "Uhrzeit", "Notiz"]);
      state.entries.forEach((e,i)=>{
        rows.push([
          String(i+1),
          e.empName||"",
          e.empNo||"",
          (e.days||[]).join(", "),
          e.objekt||"",
          e.shift||"",
          e.time||"",
          e.note||""
        ]);
      });

      const csv = rows.map(r=>r.map(v=>{
        const s = String(v??"");
        return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
      }).join(",")).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(blob, `Dienstplan_${(state.meta.date||formatDateDE(new Date())).replaceAll(".","-")}.csv`);
    }

    /* ======================
       DOCS
       ====================== */
    function loadDocs(){
      const t = localStorage.getItem(LS_DOC) || "";
      $("#docText").value = t;
    }
    function saveDocs(){
      localStorage.setItem(LS_DOC, $("#docText").value || "");
      alert("Dokumentation gespeichert.");
    }
    async function pdfDocs(){
      // simple docs PDF: reuse pdf template but replace table with doc
      const doc = ($("#docText").value||"").trim();
      if(!doc){ alert("Dokumentation ist leer."); return; }

      // Create a temporary page
      const root = document.createElement("div");
      root.style.position="absolute";
      root.style.left="-99999px";
      root.style.top="-99999px";
      root.style.width="794px";
      root.innerHTML = `
        <div class="pdfPage">
          <div class="pdfHeader">
            <div class="pdfBrand">
              <div class="pdfLogo"><img src="logo.png" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
              <div>
                <div class="pdfTitle">Masculine Security</div>
                <div class="pdfMeta">
                  <div><b>Adresse:</b> Werschenregerstraße 6, 28237 Bremen</div>
                  <div><b>Tel:</b> 015778697052</div>
                  <div><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</div>
                </div>
              </div>
            </div>
            <div class="pdfMeta" style="text-align:right">
              <div><b>Datum:</b> ${normalizeDateToDE($("#date").value)}</div>
              <div><b>Dokumentation</b></div>
              <div><b>Seite:</b> 1 / 1</div>
            </div>
          </div>
          <div class="pdfH1">Dokumentation</div>
          <div class="pdfBox" style="white-space:pre-wrap; font-size:11px; line-height:1.45">${escapeHtml(doc)}</div>
          <div class="pdfFooter">
            <div>Masculine Security — Dokumentation</div>
            <div>Seite 1 von 1</div>
          </div>
        </div>
      `;
      document.body.appendChild(root);

      const opt = {
        margin: [10,10,10,10],
        filename: `Dokumentation_${normalizeDateToDE($("#date").value).replaceAll(".","-")}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      await html2pdf().set(opt).from(root.firstElementChild).save();
      root.remove();
    }

    /* ======================
       ADD ENTRY
       ====================== */
    function addEntry(){
      syncMetaFromForm();

      // Auto shift/time enforcement
      autoShiftByTime();
      autoTimeByShift();
      syncMetaFromForm();

      const days = Array.from(state.days);
      if(!state.meta.empName){ alert("Mitarbeiter Name fehlt."); return; }
      if(!days.length){ alert("Bitte Arbeitstage auswählen (klick)."); return; }
      if(!state.meta.objekt){ alert("Objekt/Einsatz fehlt."); return; }

      const entry = {
        empName: state.meta.empName,
        empNo: state.meta.empNo,
        days,
        objekt: state.meta.objekt,
        shift: state.meta.shift,
        time: state.meta.time,
        note: state.meta.note,
        date: state.meta.date,
        kw: state.meta.kw
      };

      state.entries.push(entry);
      saveState();
      renderRows();
      rebuildPreview();
    }

    function clearForm(){
      state.days = new Set();
      state.meta.empName = "";
      state.meta.empNo = "";
      state.meta.objekt = "";
      state.meta.note = "";
      state.meta.shift = "Tag";
      state.meta.time = SHIFT_TIMES.Tag;
      saveState();
      renderDayChips();
      setFormFromMeta();
      rebuildPreview();
    }

    function resetAll(){
      if(!confirm("Alles löschen?")) return;
      localStorage.removeItem(LS_KEY);
      state.entries = [];
      state.days = new Set();
      state.meta = { date:"", kw:"", empName:"", empNo:"", objekt:"", note:"", shift:"Tag", time:"" };
      init();
    }

    /* ======================
       TABS
       ====================== */
    function setTab(which){
      if(which === "plan"){
        $("#tabPlan").classList.add("active");
        $("#tabDocs").classList.remove("active");
        $("#viewPlan").style.display = "";
        $("#viewPreview").style.display = "";
        $("#viewDocs").style.display = "none";
      }else{
        $("#tabDocs").classList.add("active");
        $("#tabPlan").classList.remove("active");
        $("#viewPlan").style.display = "none";
        $("#viewPreview").style.display = "none";
        $("#viewDocs").style.display = "";
      }
    }

    /* ======================
       PRINT / PDF / COPY
       ====================== */
    function doPrint(){
      // printing the PDF template is more professional: create blob then open in new tab
      makePdfBlobFromTemplate().then(out=>{
        const url = URL.createObjectURL(out.blob);
        const w = window.open(url, "_blank", "noopener,noreferrer");
        if(!w) alert("Popup blockiert. Bitte Popups erlauben und erneut klicken.");
      }).catch(()=>window.print());
    }

    async function doPdf(){
      const out = await makePdfBlobFromTemplate();
      downloadBlob(out.blob, out.filename);
    }

    async function copyText(){
      const text = buildMessageText();
      try{
        await navigator.clipboard.writeText(text);
        alert("Text kopiert.");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("Text kopiert.");
      }
    }

    /* ======================
       INIT + EVENTS
       ====================== */
    function bindEvents(){
      // date normalize
      $("#date").addEventListener("blur", ()=>{
        $("#date").value = normalizeDateToDE($("#date").value);
        syncMetaFromForm(); saveState(); rebuildPreview();
      });

      // shift/time automatic
      $("#shift").addEventListener("change", ()=>{
        autoTimeByShift();
        syncMetaFromForm(); saveState(); rebuildPreview();
      });
      $("#time").addEventListener("input", ()=>{
        autoShiftByTime();
        syncMetaFromForm(); saveState(); rebuildPreview();
      });

      // meta fields autosave
      ["kw","empName","empNo","objekt","note"].forEach(id=>{
        $("#"+id).addEventListener("input", ()=>{
          syncMetaFromForm(); saveState(); rebuildPreview();
        });
      });

      $("#btnAdd").addEventListener("click", addEntry);
      $("#btnClearForm").addEventListener("click", clearForm);

      $("#btnPrint").addEventListener("click", doPrint);
      $("#btnPdf").addEventListener("click", doPdf);
      $("#btnWhatsApp").addEventListener("click", sendWhatsAppPdf);
      $("#btnCsv").addEventListener("click", exportCSV);
      $("#btnReset").addEventListener("click", resetAll);

      $("#btnCopy").addEventListener("click", copyText);
      $("#btnWhatsAppText").addEventListener("click", ()=>openWhatsAppWithText(buildMessageText()));

      $("#tabPlan").addEventListener("click", ()=>setTab("plan"));
      $("#tabDocs").addEventListener("click", ()=>setTab("docs"));

      $("#btnSaveDoc").addEventListener("click", saveDocs);
      $("#btnPdfDoc").addEventListener("click", pdfDocs);
    }

    function init(){
      loadState();

      // default date
      if(!state.meta.date) state.meta.date = formatDateDE(new Date());
      state.meta.date = normalizeDateToDE(state.meta.date);

      renderDayChips();
      setFormFromMeta();
      renderRows();
      rebuildPreview();
      loadDocs();
      setTab("plan");
      bindEvents();
      saveState();

      // register service worker
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>


<!-- ======================================================================
FILE: service-worker.js
✅ Fix: Cache stale issues
✅ Network-first for HTML so new updates show immediately
====================================================================== -->
/*
self.addEventListener('install', (event) => {
  self.skipWaiting();
  event.waitUntil((async () => {
    const cache = await caches.open('ms-dienstplan-v9');
    await cache.addAll([
      './',
      './index.html',
      './logo.png',
      './manifest.json',
      './version.txt'
    ]);
  })());
});

self.addEventListener('activate', (event) => {
  event.waitUntil((async () => {
    const keys = await caches.keys();
    await Promise.all(keys.map(k => (k !== 'ms-dienstplan-v9') ? caches.delete(k) : null));
    await self.clients.claim();
  })());
});

self.addEventListener('fetch', (event) => {
  const req = event.request;
  const url = new URL(req.url);

  // Network-first for HTML so updates appear immediately
  const isHTML = req.method === 'GET' && (req.headers.get('accept') || '').includes('text/html');
  if (isHTML) {
    event.respondWith((async () => {
      try {
        const fresh = await fetch(req, { cache: 'no-store' });
        const cache = await caches.open('ms-dienstplan-v9');
        cache.put(req, fresh.clone());
        return fresh;
      } catch (e) {
        const cached = await caches.match(req);
        return cached || caches.match('./index.html');
      }
    })());
    return;
  }

  // Cache-first for other assets
  event.respondWith((async () => {
    const cached = await caches.match(req);
    if (cached) return cached;
    const fresh = await fetch(req);
    const cache = await caches.open('ms-dienstplan-v9');
    cache.put(req, fresh.clone());
    return fresh;
  })());
});
*/


<!-- ======================================================================
FILE: version.txt
✅ Increase this whenever you deploy to force refresh (optional)
====================================================================== -->
v9

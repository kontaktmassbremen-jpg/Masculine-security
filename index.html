<!-- =========================
FILE: index.html
REPLACE your whole index.html with this
========================= -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Dienstplan</title>
  <meta name="theme-color" content="#0b4ea2"/>
  <link rel="manifest" href="manifest.json"/>

  <style>
    :root{
      --bg1:#062a55; --bg2:#0b4ea2; --panel:#083a73; --card:#0a4d95;
      --line:rgba(255,255,255,.14);
      --text:#ffffff; --muted:rgba(255,255,255,.8);
      --accent:#5fd0ff; --accent2:#2aa8ff;
      --good:#3ddc97; --warn:#ffd166; --bad:#ff5b7a;
      --r:18px; --r2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background: radial-gradient(1200px 700px at 18% -15%, rgba(95,208,255,.25), transparent 55%),
                  radial-gradient(1000px 650px at 90% 10%, rgba(42,168,255,.18), transparent 55%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    a{color:var(--accent)}
    .wrap{max-width:1150px; margin:26px auto; padding:0 14px}
    .topbar{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 16px;
      box-shadow:var(--shadow);
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      min-width:260px;
    }
    .logoBadge{
      width:46px; height:46px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logoBadge img{width:100%; height:100%; object-fit:cover}
    .brand h1{
      font-size:16px; margin:0; letter-spacing:.5px; font-weight:800;
      text-transform:uppercase;
    }
    .brand small{display:block; color:var(--muted); margin-top:4px; font-size:12px; line-height:1.25}
    .tabs{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:center;
    }
    .tabBtn{
      appearance:none; border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      transition:.18s transform,.18s background;
      white-space:nowrap;
    }
    .tabBtn:hover{transform:translateY(-1px); background:rgba(0,0,0,.24)}
    .tabBtn.active{background:rgba(95,208,255,.18); border-color:rgba(95,208,255,.55)}
    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      transition:.18s transform,.18s background;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.24)}
    .btn.primary{background:rgba(42,168,255,.22); border-color:rgba(42,168,255,.65)}
    .btn.good{background:rgba(61,220,151,.18); border-color:rgba(61,220,151,.55)}
    .btn.warn{background:rgba(255,209,102,.18); border-color:rgba(255,209,102,.55)}
    .btn.bad{background:rgba(255,91,122,.18); border-color:rgba(255,91,122,.55)}
    .grid{
      margin-top:16px;
      display:grid; gap:14px;
      grid-template-columns: 1.05fr .95fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
    .card{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px 0; font-size:15px; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .row{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.62)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px dashed rgba(255,255,255,.25);
      padding:10px 12px; border-radius:16px;
      background:rgba(0,0,0,.14);
    }
    .wkDays{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
    .dayChip{
      user-select:none;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:9px 11px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      transition:.14s transform,.14s background;
    }
    .dayChip:hover{transform:translateY(-1px); background:rgba(0,0,0,.24)}
    .dayChip.on{background:rgba(95,208,255,.18); border-color:rgba(95,208,255,.55)}
    .smallNote{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .hr{height:1px; background:var(--line); margin:12px 0}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:16px}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{font-size:12px; color:rgba(255,255,255,.85); text-transform:uppercase; letter-spacing:.4px}
    tr:last-child td{border-bottom:none}
    .tag{
      display:inline-block; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      font-weight:900; font-size:12px;
    }
    .rightMeta{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; font-size:12px; color:var(--muted);
    }
    .doc{
      display:none;
      margin-top:14px;
    }
    .doc.active{display:block}
    .doc h3{margin:0 0 8px; font-size:14px}
    .doc ol{margin:0; padding-left:18px; color:var(--text)}
    .doc li{margin:6px 0; color:rgba(255,255,255,.92)}
    .noteBox{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      padding:12px; border-radius:16px;
      color:rgba(255,255,255,.92);
      line-height:1.45;
      font-size:13px;
    }
    .hint{color:rgba(255,255,255,.85)}
    .kbd{
      display:inline-block; padding:2px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.16);
      font-weight:900; font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logoBadge" title="Masculine Security Logo">
          <img id="appLogoImg" src="logo.png" alt="Logo" onerror="this.style.display='none'">
        </div>
        <div>
          <h1>MASCULINE SECURITY — Dienstplan</h1>
          <small>
            Adresse: Werschenregerstraße 6, 28237 Bremen &nbsp;&nbsp;•&nbsp;&nbsp;
            Tel: <span id="hdrPhone">015778697052</span><br/>
            E-Mail: <span id="hdrEmail">Kontakt.mass.bremen@hotmail.com</span>
          </small>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" id="tabPlan">Wochenplan</button>
        <button class="tabBtn" id="tabDoc">Dokumentation</button>
      </div>

      <div class="actions">
        <button class="btn bad" id="btnReset">Reset</button>
        <button class="btn good" id="btnSaveEntry">Eintrag speichern</button>
        <button class="btn primary" id="btnPdf">PDF</button>
        <button class="btn warn" id="btnWhatsPdf">WhatsApp (PDF)</button>
      </div>
    </div>

    <!-- =======================
         MAIN: PLAN
    ======================== -->
    <div class="grid" id="planView">

      <div class="card">
        <h2>Wöchentlicher Mitarbeiter-Dienstplan</h2>

        <div class="row">
          <div>
            <label>Mitarbeiter Name</label>
            <input id="empName" placeholder="z.B. Mustafa Mursal Abdi" autocomplete="off">
          </div>
          <div>
            <label>Mitarbeiter-Nr (optional)</label>
            <input id="empNr" placeholder="z.B. MS-001" autocomplete="off">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Objekt / Einsatz</label>
            <input id="objekt" placeholder="z.B. Hotel / Baustelle / Asylheim" autocomplete="off">
          </div>
          <div>
            <label>Logo (optional) — für PDF</label>
            <input type="file" id="logoFile" accept="image/*">
            <div class="smallNote">Tipp: Logo wird gespeichert & im PDF angezeigt.</div>
          </div>
        </div>

        <div class="hr"></div>

        <label>Arbeitstage (klicken)</label>
        <div class="wkDays" id="daysWrap"></div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Schicht (Tag/Nacht) — automatisch</label>
            <select id="shift" disabled>
              <option value="Tag">Tag</option>
              <option value="Nacht">Nacht</option>
            </select>
            <div class="smallNote">Wird automatisch gesetzt: Tag = 07:00–19:00, Nacht = 19:00–07:00.</div>
          </div>

          <div>
            <label>Uhrzeit — automatisch</label>
            <input id="time" placeholder="automatisch" readonly>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Datum (für PDF)</label>
            <input id="pdfDate" placeholder="TT.MM.JJJJ (z.B. 16.02.2026)" autocomplete="off">
            <div class="smallNote">Format: TT.MM.JJJJ</div>
          </div>
          <div>
            <label>Notiz — automatisch</label>
            <input id="note" placeholder="z.B. Rundgang / Schlüssel" autocomplete="off">
            <div class="smallNote">Wenn leer: wird automatisch gesetzt je nach Objekt (z.B. Hotel → „Rundgang / Schlüssel“).</div>
          </div>
        </div>

        <div class="rightMeta">
          <div class="pill"><b>Auto-Save:</b> <span id="autoSaveState">AN</span></div>
          <div class="pill"><b>Version:</b> <span id="ver">vFinal</span></div>
        </div>

        <div class="hr"></div>

        <div class="noteBox">
          <b>Hinweis:</b> WhatsApp kann aus dem Browser <u>kein PDF automatisch anhängen</u> (Sicherheit).<br/>
          Der Button <b>„WhatsApp (PDF)”</b> macht:
          <br/>• PDF wird vorbereitet & Download startet
          <br/>• WhatsApp wird geöffnet mit Text
          <br/>➡️ Du fügst nur noch die Datei im Chat an.
        </div>

      </div>

      <div class="card">
        <h2>Vorschau + Gespeicherte Einträge</h2>

        <label>Vorschau (WhatsApp Text)</label>
        <textarea id="preview" placeholder="Vorschau..." readonly></textarea>

        <div class="hr"></div>

        <table>
          <thead>
            <tr>
              <th>Mitarbeiter</th>
              <th>Tage</th>
              <th>Objekt</th>
              <th>Schicht</th>
              <th>Uhrzeit</th>
              <th>Notiz</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted">Noch keine Einträge.</td></tr>
          </tbody>
        </table>

        <div class="rightMeta">
          <div class="pill"><b>PDF-Name:</b> <span id="pdfName">Dienstplan</span></div>
          <div class="pill"><b>Speicher:</b> LocalStorage</div>
        </div>
      </div>

    </div>

    <!-- =======================
         DOCUMENTATION
    ======================== -->
    <div class="card doc" id="docView">
      <h2>Dokumentation</h2>

      <div class="noteBox">
        <h3>1) Wochenplan ausfüllen</h3>
        <ol>
          <li>Mitarbeiter Name + (optional) Mitarbeiter-Nr eingeben.</li>
          <li>Objekt / Einsatz eintragen (z.B. „Hotel“).</li>
          <li>Arbeitstage anklicken (Mo–So).</li>
          <li>Schicht & Uhrzeit werden automatisch gesetzt (Tag/Nacht).</li>
          <li>Notiz ist automatisch — du kannst sie trotzdem ändern.</li>
          <li><b>„Eintrag speichern“</b> drücken → Eintrag wird gespeichert & erscheint rechts.</li>
        </ol>
      </div>

      <div class="hr"></div>

      <div class="noteBox">
        <h3>2) PDF erstellen (Blue/White + Logo + Datum)</h3>
        <ol>
          <li>Falls du willst: Logo hochladen (wird gespeichert).</li>
          <li>Datum prüfen (Format <span class="kbd">TT.MM.JJJJ</span>).</li>
          <li><b>„PDF“</b> drücken → PDF-Vorschau/Print öffnet sich.</li>
          <li>Im Print-Fenster: <b>Save as PDF</b> → Speichern.</li>
        </ol>
      </div>

      <div class="hr"></div>

      <div class="noteBox">
        <h3>3) WhatsApp (PDF) senden — (maximal automatisch)</h3>
        <ol>
          <li><b>„WhatsApp (PDF)”</b> drücken.</li>
          <li>PDF Download startet (Datei ist bereit).</li>
          <li>WhatsApp öffnet sich mit Text.</li>
          <li>Im Chat → <b>Büroklammer</b> → Datei auswählen → PDF anhängen → Senden.</li>
        </ol>
        <div class="smallNote hint">
          Wenn WhatsApp nicht aufgeht: Pop-ups erlauben (Browser: <span class="kbd">Site settings</span> → Pop-ups).
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   STORAGE + STATE
========================= */
const STORE_KEY = "ms_dienstplan_vFinal";
const META_KEY  = "ms_meta_vFinal";
const DAYS = [
  {k:"Mo", label:"Montag"},
  {k:"Di", label:"Dienstag"},
  {k:"Mi", label:"Mittwoch"},
  {k:"Do", label:"Donnerstag"},
  {k:"Fr", label:"Freitag"},
  {k:"Sa", label:"Samstag"},
  {k:"So", label:"Sonntag"},
];

const SHIFT_TIMES = {
  Tag:   "07:00–19:00",
  Nacht: "19:00–07:00",
};

let state = {
  entries: [],
  selectedDays: new Set(), // Mo..So
};

let meta = {
  logoDataUrl: null,
  companyName: "Masculine Security",
  address: "Werschenregerstraße 6, 28237 Bremen",
  phone: "015778697052",
  email: "Kontakt.mass.bremen@hotmail.com",
};

function safeParse(json, fallback){
  try { return JSON.parse(json); } catch { return fallback; }
}
function saveAll(){
  localStorage.setItem(STORE_KEY, JSON.stringify({ entries: state.entries }));
  localStorage.setItem(META_KEY, JSON.stringify(meta));
  document.getElementById("autoSaveState").textContent = "AN";
}
function loadAll(){
  const s = safeParse(localStorage.getItem(STORE_KEY), null);
  const m = safeParse(localStorage.getItem(META_KEY), null);
  if(s?.entries) state.entries = s.entries;
  if(m) meta = { ...meta, ...m };
}
function normalize(s){
  return String(s||"").trim().replace(/\s+/g," ");
}
function todayDE(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function isValidDEDate(x){
  const m = String(x||"").match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return false;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  if(mm<1||mm>12||dd<1||dd>31||yy<1900) return false;
  return true;
}

/* =========================
   UI INIT
========================= */
const $ = (id)=>document.getElementById(id);

function renderDays(){
  const wrap = $("daysWrap");
  wrap.innerHTML = "";
  for(const d of DAYS){
    const b = document.createElement("button");
    b.type="button";
    b.className = "dayChip" + (state.selectedDays.has(d.k) ? " on" : "");
    b.textContent = d.k;
    b.title = d.label;
    b.addEventListener("click", ()=>{
      if(state.selectedDays.has(d.k)) state.selectedDays.delete(d.k);
      else state.selectedDays.add(d.k);
      renderDays();
      buildPreview();
      autoShiftAndTime(); // keep time consistent
    });
    wrap.appendChild(b);
  }
}

function setHeaderMeta(){
  $("hdrPhone").textContent = meta.phone;
  $("hdrEmail").textContent = meta.email;
  $("pdfName").textContent = "Dienstplan";
  const img = $("appLogoImg");
  if(meta.logoDataUrl){
    img.src = meta.logoDataUrl;
    img.style.display = "";
  }else{
    img.src = "logo.png";
    img.style.display = "";
  }
}

function autoShiftAndTime(){
  // RULE: if any selected day + objekt contains "nacht" -> Nacht
  // Otherwise Tag by default.
  const obj = normalize($("objekt").value).toLowerCase();
  let shift = "Tag";
  if(/\bnacht\b/.test(obj) || /night/.test(obj)) shift = "Nacht";
  $("shift").value = shift;
  $("time").value = SHIFT_TIMES[shift];
}

function autoNotiz(){
  // If user typed note -> keep it
  const current = normalize($("note").value);
  if(current) return;

  const obj = normalize($("objekt").value).toLowerCase();
  let n = "";
  if(/hotel|hostel|pension/.test(obj)) n = "Rundgang / Schlüssel";
  else if(/baustelle|construction/.test(obj)) n = "Tor / Kontrolle / Sicherheit";
  else if(/asyl|heim|unterkunft/.test(obj)) n = "Eingang / Kontrolle / Rundgang";
  else if(obj) n = "Rundgang / Schlüssel";
  $("note").value = n;
}

function buildPreview(){
  const name = normalize($("empName").value) || "Mitarbeiter";
  const nr = normalize($("empNr").value);
  const obj = normalize($("objekt").value) || "Objekt";
  const shift = $("shift").value;
  const time = $("time").value || SHIFT_TIMES[shift];
  const date = normalize($("pdfDate").value) || todayDE();
  const note = normalize($("note").value) || "—";
  const days = Array.from(state.selectedDays);

  const daysLong = days.map(k=>{
    const d = DAYS.find(x=>x.k===k);
    return d ? d.k : k;
  }).join(", ") || "—";

  const lines = [];
  lines.push(`${meta.companyName} — Dienstplan`);
  lines.push(`Datum: ${date}`);
  lines.push(`Mitarbeiter: ${name}${nr ? " ("+nr+")" : ""}`);
  lines.push(`Tage: ${daysLong}`);
  lines.push(`Objekt: ${obj}`);
  lines.push(`Schicht: ${shift} | Uhrzeit: ${time}`);
  lines.push(`Notiz: ${note}`);
  lines.push(`Kontakt: ${meta.phone} | ${meta.email}`);
  $("preview").value = lines.join("\n");
}

function renderTable(){
  const tb = $("tbody");
  tb.innerHTML = "";
  if(!state.entries.length){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan=7; td.className="muted";
    td.textContent="Noch keine Einträge.";
    tr.appendChild(td);
    tb.appendChild(tr);
    return;
  }
  state.entries.forEach((e, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(e.empName)}${e.empNr?`<div class="muted">${escapeHtml(e.empNr)}</div>`:""}</td>
      <td>${escapeHtml(e.days.join(", "))}</td>
      <td>${escapeHtml(e.objekt)}</td>
      <td><span class="tag">${escapeHtml(e.shift)}</span></td>
      <td>${escapeHtml(e.time)}</td>
      <td>${escapeHtml(e.note || "—")}</td>
      <td><button class="btn bad" data-del="${idx}" type="button">Delete</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-del");
      state.entries.splice(i,1);
      saveAll();
      renderTable();
      buildPreview();
    });
  });
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   ENTRY SAVE
========================= */
function saveEntry(){
  const empName = normalize($("empName").value);
  if(!empName){ alert("Bitte Mitarbeiter Name eingeben."); return; }
  const empNr = normalize($("empNr").value);
  const objekt = normalize($("objekt").value);
  if(!objekt){ alert("Bitte Objekt / Einsatz eingeben."); return; }

  const days = Array.from(state.selectedDays);
  if(!days.length){ alert("Bitte mindestens einen Arbeitstag anklicken (Mo–So)."); return; }

  autoShiftAndTime();
  autoNotiz();
  const shift = $("shift").value;
  const time  = $("time").value || SHIFT_TIMES[shift];
  const note  = normalize($("note").value);

  const entry = {
    empName, empNr, objekt, days,
    shift, time,
    note: note || "—",
  };

  state.entries.push(entry);
  saveAll();
  renderTable();
  buildPreview();
}

/* =========================
   PDF BUILD (PRINT)
========================= */
function buildPdfHtml(){
  const date = normalize($("pdfDate").value) || todayDE();
  const fixedDate = isValidDEDate(date) ? date : todayDE();

  const rows = [];
  // We render one combined schedule from latest entry OR all entries.
  // For a clean layout, we render ALL entries grouped by day.
  const byDay = new Map(DAYS.map(d=>[d.k, []]));
  for(const e of state.entries){
    for(const d of e.days){
      if(byDay.has(d)) byDay.get(d).push(e);
    }
  }

  for(const d of DAYS){
    const list = byDay.get(d.k) || [];
    if(!list.length){
      rows.push(`<tr><td>${d.k}</td><td>—</td><td>—</td><td>—</td></tr>`);
      continue;
    }
    // If multiple entries same day, show first line + then extra lines (small)
    const first = list[0];
    const obj = first.objekt || "—";
    const time = first.time || "—";
    const note = first.note || "—";
    rows.push(`<tr>
      <td>${d.k}</td>
      <td>${escapeHtml(time)}</td>
      <td>${escapeHtml(obj)}</td>
      <td>${escapeHtml(note)}</td>
    </tr>`);
    for(let i=1;i<list.length;i++){
      const x = list[i];
      rows.push(`<tr class="sub">
        <td>${d.k}</td>
        <td>${escapeHtml(x.time||"—")}</td>
        <td>${escapeHtml(x.objekt||"—")}</td>
        <td>${escapeHtml(x.note||"—")}</td>
      </tr>`);
    }
  }

  const logo = meta.logoDataUrl ? `<img class="logo" src="${meta.logoDataUrl}" alt="logo">` : `<img class="logo" src="logo.png" alt="logo">`;

  return `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dienstplan ${fixedDate}</title>
  <style>
    @page { size: A4; margin: 16mm; }
    body{ font-family: Arial, Helvetica, sans-serif; color:#0a1b2e; }
    .head{
      border:2px solid #1f6fd8;
      border-radius:12px;
      padding:12px 14px;
      display:flex; align-items:center; gap:14px;
    }
    .logo{ width:52px; height:52px; border-radius:10px; object-fit:cover; border:1px solid #cfe2ff; }
    .title{ font-size:18px; font-weight:800; color:#0b4ea2; margin:0; }
    .sub{ font-size:12px; color:#204569; margin-top:4px; line-height:1.3; }
    .date{ margin-left:auto; font-size:12px; color:#204569; }
    .sep{ height:3px; background:#1f6fd8; margin:14px 0 10px; border-radius:999px; opacity:.7; }
    .centerTitle{ text-align:center; font-size:18px; font-weight:900; color:#0b4ea2; margin:0 0 10px; }
    table{ width:100%; border-collapse:collapse; font-size:12.5px; }
    th,td{ border:1px solid #d7e6ff; padding:8px 8px; }
    th{ background:#eaf3ff; color:#0b4ea2; text-transform:uppercase; letter-spacing:.4px; font-size:11px; }
    tr.sub td{ background:#f7fbff; color:#204569; }
    .warnTitle{ text-align:center; font-weight:900; color:#c0162b; margin:14px 0 6px; font-size:12px; }
    .warnText{ text-align:center; font-size:11px; color:#203044; line-height:1.35; }
    .foot{ margin-top:10px; font-size:10px; color:#5a6b7b; display:flex; justify-content:space-between; }
  </style>
</head>
<body>
  <div class="head">
    ${logo}
    <div>
      <div class="title">${escapeHtml(meta.companyName)}</div>
      <div class="sub">
        Adresse: ${escapeHtml(meta.address)}<br/>
        Tel: ${escapeHtml(meta.phone)}<br/>
        E-Mail: ${escapeHtml(meta.email)}
      </div>
    </div>
    <div class="date"><b>Datum:</b> ${escapeHtml(fixedDate)}</div>
  </div>

  <div class="sep"></div>

  <div class="centerTitle">Vorläufiger Dienstplan</div>

  <table>
    <thead>
      <tr>
        <th>TAG</th>
        <th>UHRZEIT</th>
        <th>OBJEKT</th>
        <th>NOTIZ</th>
      </tr>
    </thead>
    <tbody>
      ${rows.join("")}
    </tbody>
  </table>

  <div class="warnTitle">DRINGEND BEACHTEN:</div>
  <div class="warnText">
    Dienstantritt ist 20 Minuten vor Dienstbeginn!<br/>
    Verspätungen und Ausfälle sind unverzüglich telefonisch zu melden!<br/>
    Stundenzettel spätestens 2 Tage vor Monatsende einreichen.
  </div>

  <div class="foot">
    <div>${escapeHtml(meta.companyName)} — Dienstplan</div>
    <div>Seite 1 von 1</div>
  </div>
</body>
</html>`;
}

function openPrintWindow(){
  const html = buildPdfHtml();
  const w = window.open("", "_blank", "noopener,noreferrer");
  if(!w){ alert("Popup blockiert. Bitte Popups erlauben und nochmal klicken."); return null; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  return w;
}

function downloadPdfHtmlAsFile(){
  // This is NOT a real PDF generator; it triggers print/save.
  // We also trigger a HTML download as backup.
  const date = normalize($("pdfDate").value) || todayDE();
  const safeDate = (isValidDEDate(date) ? date : todayDE()).replaceAll(".","-");
  const name = `Dienstplan_${safeDate}.html`;
  const blob = new Blob([buildPdfHtml()], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* =========================
   WHATSAPP FLOW
========================= */
function openWhatsAppWithText(text){
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank", "noopener,noreferrer");
}

function whatsAppPdfFlow(){
  if(!state.entries.length){
    alert("Bitte zuerst mindestens einen Eintrag speichern.");
    return;
  }
  // 1) open print window (user saves as PDF)
  const w = openPrintWindow();
  // 2) also offer HTML backup download
  downloadPdfHtmlAsFile();

  // 3) open WhatsApp with ready text
  const msg =
`${$("preview").value}

✅ PDF ist bereit.
➡️ Bitte im Print-Fenster „Save as PDF“ wählen und danach im WhatsApp-Chat Datei anhängen.`;

  // give browser a moment before opening WA
  setTimeout(()=>openWhatsAppWithText(msg), 650);

  // optional: focus print window for the user
  if(w) setTimeout(()=>{ try{ w.focus(); }catch{} }, 200);
}

/* =========================
   EVENTS
========================= */
function bindEvents(){
  $("objekt").addEventListener("input", ()=>{
    autoShiftAndTime();
    autoNotiz();
    buildPreview();
    saveAll();
  });
  $("empName").addEventListener("input", ()=>{ buildPreview(); saveAll(); });
  $("empNr").addEventListener("input", ()=>{ buildPreview(); saveAll(); });

  $("pdfDate").addEventListener("input", ()=>{
    // enforce DE format lightly
    buildPreview(); saveAll();
  });

  $("note").addEventListener("input", ()=>{ buildPreview(); saveAll(); });

  $("logoFile").addEventListener("change", async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const data = await fileToDataUrl(f);
    meta.logoDataUrl = data;
    saveAll();
    setHeaderMeta();
  });

  $("btnSaveEntry").addEventListener("click", saveEntry);

  $("btnPdf").addEventListener("click", ()=>{
    if(!state.entries.length){
      alert("Bitte zuerst mindestens einen Eintrag speichern.");
      return;
    }
    const w = openPrintWindow();
    if(w) setTimeout(()=>{ try{ w.print(); }catch{} }, 450);
  });

  $("btnWhatsPdf").addEventListener("click", whatsAppPdfFlow);

  $("btnReset").addEventListener("click", ()=>{
    const ok = confirm("Reset? Alle gespeicherten Daten werden gelöscht.");
    if(!ok) return;
    localStorage.removeItem(STORE_KEY);
    localStorage.removeItem(META_KEY);
    state.entries = [];
    state.selectedDays = new Set();
    meta.logoDataUrl = null;
    $("logoFile").value = "";
    $("note").value = "";
    $("objekt").value = "";
    $("empName").value = "";
    $("empNr").value = "";
    $("pdfDate").value = todayDE();
    renderDays();
    renderTable();
    setHeaderMeta();
    autoShiftAndTime();
    autoNotiz();
    buildPreview();
  });

  // Tabs
  $("tabPlan").addEventListener("click", ()=>{
    $("tabPlan").classList.add("active");
    $("tabDoc").classList.remove("active");
    $("planView").style.display = "";
    $("docView").classList.remove("active");
  });
  $("tabDoc").addEventListener("click", ()=>{
    $("tabDoc").classList.add("active");
    $("tabPlan").classList.remove("active");
    $("planView").style.display = "none";
    $("docView").classList.add("active");
  });
}

async function fileToDataUrl(file){
  return await new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(String(r.result));
    r.onerror = ()=>rej(new Error("file read error"));
    r.readAsDataURL(file);
  });
}

/* =========================
   BOOT
========================= */
(function init(){
  loadAll();
  setHeaderMeta();

  // defaults
  if(!normalize($("pdfDate").value)) $("pdfDate").value = todayDE();

  renderDays();
  renderTable();

  autoShiftAndTime();
  autoNotiz();
  buildPreview();

  bindEvents();

  // Service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("service-worker.js").catch(()=>{});
  }
})();
</script>
</body>
</html>


<!-- =========================
FILE: service-worker.js
REPLACE your service-worker.js with this
========================= -->
<script type="text/plain" id="__SW__">
/* ms-dienstplan vFinal (cache-bust) */
const CACHE_NAME = "ms-dienstplan-vfinal-2026-02-16";
const ASSETS = [
  "./",
  "./index.html",
  "./manifest.json",
  "./logo.png",
  "./service-worker.js",
  "./version.txt"
];

self.addEventListener("install", (event) => {
  self.skipWaiting();
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)).catch(()=>{})
  );
});

self.addEventListener("activate", (event) => {
  event.waitUntil((async ()=>{
    const keys = await caches.keys();
    await Promise.all(keys.map(k => (k !== CACHE_NAME) ? caches.delete(k) : Promise.resolve()));
    await self.clients.claim();
  })());
});

// Network-first for HTML so updates show fast, cache-first for others
self.addEventListener("fetch", (event) => {
  const req = event.request;
  const url = new URL(req.url);

  // only same-origin
  if(url.origin !== location.origin) return;

  const isHTML = req.headers.get("accept")?.includes("text/html");

  if(isHTML){
    event.respondWith((async ()=>{
      try{
        const fresh = await fetch(req, {cache:"no-store"});
        const cache = await caches.open(CACHE_NAME);
        cache.put(req, fresh.clone());
        return fresh;
      }catch{
        const cached = await caches.match(req);
        return cached || caches.match("./index.html");
      }
    })());
    return;
  }

  event.respondWith((async ()=>{
    const cached = await caches.match(req);
    if(cached) return cached;
    try{
      const fresh = await fetch(req);
      const cache = await caches.open(CACHE_NAME);
      cache.put(req, fresh.clone());
      return fresh;
    }catch{
      return cached || new Response("Offline", {status:503});
    }
  })());
});
</script>


<!-- =========================
FILE: manifest.json
REPLACE your manifest.json with this
========================= -->
<script type="application/json" id="__MANIFEST__">
{
  "name": "Masculine Security — Dienstplan",
  "short_name": "Dienstplan",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0b4ea2",
  "theme_color": "#0b4ea2",
  "icons": [
    {
      "src": "logo.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "logo.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
</script>


<!-- =========================
FILE: version.txt
REPLACE your version.txt with this
========================= -->
<script type="text/plain" id="__VERSION__">vFinal-2026-02-16</script>

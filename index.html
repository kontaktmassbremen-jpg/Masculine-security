<!-- ===========================
     AUTO SHIFT (TAG/NACHT) + AUTO UHRZEIT
     Ku dheji gudaha <script> ee index.html
=========================== -->

(function(){
  // 1) IDs/Selectors (haddii names-kaaga kala duwanyihiin, halkaan ka beddel)
  const selShift   = () => document.getElementById("shift")   || document.querySelector("[name='shift']")   || document.querySelector("#Schicht");
  const selTime    = () => document.getElementById("time")    || document.querySelector("[name='time']")    || document.querySelector("#Uhrzeit");
  const selDay     = () => document.getElementById("day")     || document.querySelector("[name='day']")     || document.querySelector("#Tag");
  const selObjekt  = () => document.getElementById("objekt")  || document.querySelector("[name='objekt']")  || document.querySelector("#Objekt");

  // 2) Default times
  const SHIFT_TIMES = {
    Tag:   "07:00–19:00",
    Nacht: "19:00–07:00"
  };

  // 3) Helper: normalize dash
  function normalizeTime(s){
    return String(s||"").replace(/\s+/g,"").replace(/-/g,"–");
  }

  // 4) “Smart auto”: only overwrite if empty OR already one of our defaults
  function shouldAutoOverwriteTime(current){
    const cur = normalizeTime(current);
    const d1 = normalizeTime(SHIFT_TIMES.Tag);
    const d2 = normalizeTime(SHIFT_TIMES.Nacht);
    return !cur || cur === d1 || cur === d2;
  }

  function applyAutoTime(){
    const shiftEl = selShift();
    const timeEl  = selTime();
    if(!shiftEl || !timeEl) return;

    const shift = (shiftEl.value || "").trim();
    if(!SHIFT_TIMES[shift]) return;

    if(shouldAutoOverwriteTime(timeEl.value)){
      timeEl.value = SHIFT_TIMES[shift];
      timeEl.dispatchEvent(new Event("input", {bubbles:true}));
      timeEl.dispatchEvent(new Event("change", {bubbles:true}));
    }
  }

  // 5) Create shift dropdown if not exists
  function ensureShiftDropdown(){
    let shiftEl = selShift();
    const timeEl = selTime();
    if(shiftEl || !timeEl) return;

    // Same style as existing inputs
    shiftEl = document.createElement("select");
    shiftEl.id = "shift";
    shiftEl.name = "shift";
    shiftEl.innerHTML = `
      <option value="Tag">Tag</option>
      <option value="Nacht">Nacht</option>
    `;

    // Try insert near time input
    const wrap = timeEl.closest(".field") || timeEl.parentElement;
    if(wrap){
      const label = document.createElement("label");
      label.textContent = "Schicht (Tag/Nacht)";
      label.style.display = "block";
      label.style.margin = "10px 0 6px";
      wrap.insertBefore(label, timeEl);

      shiftEl.style.width = "100%";
      shiftEl.style.padding = "12px";
      shiftEl.style.borderRadius = "12px";
      shiftEl.style.border = "1px solid rgba(255,255,255,.16)";
      shiftEl.style.background = "rgba(0,0,0,.20)";
      shiftEl.style.color = "#fff";
      shiftEl.style.marginBottom = "10px";

      wrap.insertBefore(shiftEl, label.nextSibling);
    }
  }

  // 6) Optional: auto pick Tag/Nacht based on objekt keywords (haddii aad rabto)
  function autoShiftByObjekt(){
    const objektEl = selObjekt();
    const shiftEl  = selShift();
    const timeEl   = selTime();
    if(!objektEl || !shiftEl || !timeEl) return;

    const t = (objektEl.value||"").toLowerCase();
    // tusaale: haddii objekt leeyahay “nacht” ama “night” → Nacht
    if(/\bnacht\b|\bnight\b/.test(t)){
      shiftEl.value = "Nacht";
      applyAutoTime();
    }
  }

  // 7) Hook events
  function wire(){
    ensureShiftDropdown();

    const shiftEl = selShift();
    const dayEl   = selDay();
    const objektEl= selObjekt();

    if(shiftEl){
      shiftEl.addEventListener("change", applyAutoTime);
      shiftEl.addEventListener("input",  applyAutoTime);
    }

    // haddii aad rabto: markaad day doorato, waqtiga mar kale u set garee
    if(dayEl){
      dayEl.addEventListener("change", applyAutoTime);
    }

    // haddii objekt la beddelo, optional auto shift
    if(objektEl){
      objektEl.addEventListener("change", autoShiftByObjekt);
      objektEl.addEventListener("input",  autoShiftByObjekt);
    }

    // run once on load
    applyAutoTime();
  }

  document.addEventListener("DOMContentLoaded", wire);
})();

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Office (Rechnung + Mitarbeiter + Payroll)</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}

    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r2);
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px; border:1px solid rgba(255,255,255,.06)}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
    }
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
    }
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18);
      font-size:12px; font-weight:900; color:var(--muted)
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }
    @media print{
      body{background:#fff;color:#000}
      .app,.sidebar,.topbar,.statusbar,.toast{display:none!important}
      #printArea{display:block!important}
    }
    #printArea{display:none}
  </style>
</head>

<body>
<!-- VERSION (si aad u hubiso update) -->
<div style="position:fixed;left:10px;bottom:10px;z-index:99999;background:#000a;color:#fff;padding:6px 10px;border-radius:10px;font:12px Arial">
  v6-layout-fix
</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Rechnung ‚Ä¢ Mitarbeiter ‚Ä¢ Payroll/SV</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill">Auto</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmp">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll / SV</span><span class="pill">PDF</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Storage</span></button>
    </div>

    <div class="foot">
      <div><b>Hinweis:</b> PDFs waa ‚ÄúPrint ‚Üí Save as PDF‚Äù.</div>
      <div class="muted">Update ma muuqdo? fur link-ga: <b>?v=999</b></div>
      <div class="muted">¬ß19 UStG: USt = 0</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Tage + Std/Tag + ‚Ç¨/h ‚Üí Auto</small>
      </div>
      <div class="actions">
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Reset</button>
      </div>
    </div>

    <div class="content">

      <!-- ================== RECHNUNG ================== -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Tage (inta bari)</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>

            <div class="split">
              <div class="field"><label>‚Ç¨/h</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>

            <div class="note">Menge = <b>Stunden</b>. Preis = <b>‚Ç¨/h</b>. Netto = Stunden √ó ‚Ç¨/h.</div>

            <div class="hr"></div>

            <h3 style="margin:0 0 10px 0">Position</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                </tr>
              </thead>
              <tbody id="invLineBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen</label><input id="sum_total" readonly/></div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnPrintInvoice">PDF Rechnung</button>
            </div>
          </div>

          <div class="card">
            <h3>Quick Info</h3>
            <div class="note">
              <b>Su‚Äôaashaada:</b> ‚Äúqaabkaan badal‚Äù ‚Üí waxaan kuu sameeyay layout-ka
              sida professional app (sidebar + pages + cards).<br><br>
              Haddii wax aan muuqan: fur link-ga adigoo ku daraya <b>?v=999</b>.
            </div>
          </div>
        </div>
      </section>

      <!-- ================== MITARBEITER ================== -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter hinzuf√ºgen</h3>
            <div class="field"><label>Name</label><input id="e_name" placeholder="Vorname Nachname"/></div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h</label><input id="e_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>SV-pflichtig</label>
                <select id="e_sv">
                  <option value="yes">Ja</option>
                  <option value="no">Nein</option>
                </select>
              </div>
            </div>
            <button class="btn primary" id="btnEmpSave">Speichern</button>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th class="right">‚Ç¨/h</th><th class="right">SV</th><th class="right">Aktion</th></tr></thead>
              <tbody id="empList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ================== PAYROLL ================== -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Payroll Rechner</h3>
            <div class="field"><label>Mitarbeiter</label><select id="p_emp"></select></div>
            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.25" placeholder="z.B. 160"/></div>
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="auto"/></div>
            </div>

            <div class="note">SV waa <b>estimate</b> (internal), ma aha official Lohnabrechnung.</div>
            <div class="hr"></div>

            <table class="table">
              <thead><tr><th>Item</th><th class="right">Betrag</th></tr></thead>
              <tbody id="payTable"></tbody>
            </table>

            <div class="hr"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnPayCalc">Berechnen</button>
              <button class="btn" id="btnPayPDF">PDF Payroll</button>
            </div>
          </div>

          <div class="card">
            <h3>SV S√§tze (Default)</h3>
            <div class="note">Waxaad ka beddeli kartaa Settings (AN/AG %).</div>
          </div>
        </div>
      </section>

      <!-- ================== SETTINGS ================== -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma Einstellungen</h3>
            <div class="field"><label>Firma</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="s_email" placeholder="kontakt@..."/></div>
              <div class="field"><label>Telefon</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="..."/></div>
            </div>
            <div class="field"><label>Steuernummer / Steuer-ID</label><input id="s_taxid" placeholder="12/345/67890"/></div>

            <div class="hr"></div>
            <h3 style="margin:0 0 10px 0">SV S√§tze (Sch√§tzung)</h3>
            <div class="split">
              <div class="field"><label>AN %</label><input id="s_sv_an" type="number" step="0.01"/></div>
              <div class="field"><label>AG %</label><input id="s_sv_ag" type="number" step="0.01"/></div>
            </div>

            <button class="btn primary" id="btnSettingsSave">Speichern</button>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<div id="printArea"></div>

<script>
/* ====== cache/service-worker fix (GitHub Pages) ====== */
(async ()=>{
  try{
    if("serviceWorker" in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
    }
    if(window.caches){
      const keys = await caches.keys();
      for(const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

const $ = (id)=>document.getElementById(id);

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2200);
  }
};

function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function fmtEUR(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function todayISO(){
  const d=new Date();
  const p=(x)=>String(x).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
}
function escapeHtml(str){
  return String(str??"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

const DB_KEY = "ms_office_v6_layout_fix";

const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Bremen",
          email:"",
          phone:"",
          iban:"",
          bic:"",
          taxid:"",
          sv_an: 20.30,
          sv_ag: 20.30
        },
        employees:[]
      };
      this.save(true);
    }else{
      this.data.settings ||= {};
      if(this.data.settings.sv_an===undefined) this.data.settings.sv_an=20.30;
      if(this.data.settings.sv_ag===undefined) this.data.settings.sv_ag=20.30;
      if(!Array.isArray(this.data.employees)) this.data.employees=[];
    }
    return this.data;
  },
  save(silent=false){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("Gespeichert ‚úî");
    }catch(e){
      Toast.show("Speichern Fehler (Storage). Export JSON samee.");
    }
  },
  wipe(){
    StorageDriver.removeItem(DB_KEY);
    location.reload();
  }
};

const UI = {
  go(page){
    document.querySelectorAll("#nav button").forEach(b=>{
      b.classList.toggle("active", b.dataset.page===page);
    });
    ["invoices","employees","payroll","settings"].forEach(p=>{
      const sec = $("page-"+p);
      if(sec) sec.classList.toggle("hide", p!==page);
    });
    const titles={
      invoices:["Rechnung","Tage + Std/Tag + ‚Ç¨/h ‚Üí Auto"],
      employees:["Mitarbeiter","Speichern ‚Ä¢ Liste ‚Ä¢ ‚Ç¨/h"],
      payroll:["Payroll / SV","Stunden √ó ‚Ç¨/h + SV % (estimate)"],
      settings:["Firma","Daten + SV % speichern"]
    };
    $("pageTitle").textContent=titles[page][0];
    $("pageSub").textContent=titles[page][1];
    renderAll();
  }
};

function setStorageUI(){
  $("pillStore").textContent = StorageDriver.type;
  $("storeTag").textContent = "Storage: " + StorageDriver.type;
  $("storageNote").textContent = "Storage: " + StorageDriver.type + (StorageDriver.type!=="localStorage" ? " ‚Ä¢ Export JSON empfohlen" : "");
  $("dot").classList.toggle("off", StorageDriver.type==="memory");
}

function nextInvoiceNo(){
  const year = new Date().getFullYear();
  return "MS-"+year+"-"+String(Math.floor(Math.random()*9999)).padStart(4,"0");
}

/* ===== RECHNUNG ===== */
function calcInvoice(){
  const days = num($("w_days").value);
  const hpd  = num($("w_hpd").value);
  const rate = num($("w_rate").value);
  const hours = round2(days*hpd);
  const net = round2(hours*rate);

  $("w_total_hours").value = hours ? hours.toFixed(2) : "";
  $("sum_net").value = net ? net.toFixed(2) : "0.00";
  $("sum_total").value = $("sum_net").value;

  const desc = "Sicherheitsdienstleistung (Arbeitszeit)";
  $("invLineBody").innerHTML = `
    <tr>
      <td><b>${escapeHtml(desc)}</b></td>
      <td class="right">${hours ? hours.toFixed(2) : ""}</td>
      <td class="right">${rate ? rate.toFixed(2) : "0.00"}</td>
      <td class="right"><b>${fmtEUR(net)}</b></td>
    </tr>
  `;
}

function printInvoice(){
  const s = Store.data.settings;
  const no = ($("i_no").value||"").trim() || nextInvoiceNo();
  const date = $("i_date").value || todayISO();
  const hours = $("w_total_hours").value || "0.00";
  const rate = num($("w_rate").value).toFixed(2);
  const total = num($("sum_total").value).toFixed(2);

  const html = `
<!doctype html><html><head>
<meta charset="utf-8"/>
<title>Rechnung ${escapeHtml(no)}</title>
<style>
@page{size:A4;margin:10mm}
body{font-family:Arial;margin:0;color:#000}
.h{display:flex;justify-content:space-between;gap:12mm;border-bottom:1px solid #ddd;padding-bottom:5mm;margin-bottom:5mm}
.small{font-size:11px;color:#333}
table{width:100%;border-collapse:collapse;font-size:11px}
th,td{border-bottom:1px solid #eee;padding:6px}
.right{text-align:right}
.box{border:1px solid #eee;padding:8px;margin-top:6mm}
</style>
</head><body>
<div class="h">
  <div>
    <div style="font-size:18px;font-weight:800">Rechnung</div>
    <div style="font-weight:800">${escapeHtml(s.company||"")}</div>
    <div class="small" style="white-space:pre-line">${escapeHtml(s.addr||"")}</div>
    ${s.taxid ? `<div class="small">Steuernummer/Steuer-ID: ${escapeHtml(s.taxid)}</div>` : ""}
  </div>
  <div class="small right">
    <div><b>Nr.:</b> ${escapeHtml(no)}</div>
    <div><b>Datum:</b> ${escapeHtml(date)}</div>
  </div>
</div>

<table>
<thead><tr><th>Leistung</th><th class="right">Menge (Std)</th><th class="right">Preis ‚Ç¨/h</th><th class="right">Netto</th></tr></thead>
<tbody>
<tr>
  <td>Sicherheitsdienstleistung (Arbeitszeit)</td>
  <td class="right">${escapeHtml(hours)}</td>
  <td class="right">${escapeHtml(rate)}</td>
  <td class="right"><b>${fmtEUR(total)}</b></td>
</tr>
</tbody>
</table>

<div class="box small right">
  <div>Summe Netto: <b>${fmtEUR(total)}</b></div>
  <div>USt: 0,00 ‚Ç¨ (¬ß19 UStG)</div>
  <div style="font-size:13px;margin-top:6px">Zu zahlen: <b>${fmtEUR(total)}</b></div>
</div>

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
  const w=window.open("","_blank");
  if(!w){ Toast.show("Popup blockiert. Popups erlauben."); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ===== MITARBEITER ===== */
function renderEmployees(){
  const list = Store.data.employees;
  $("pillEmp").textContent = list.length;

  const tbody = $("empList");
  tbody.innerHTML = list.length ? "" : `<tr><td class="muted" colspan="4">Keine Mitarbeiter</td></tr>`;
  for(const e of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(e.name)}</b></td>
      <td class="right">${fmtEUR(e.rate)}/h</td>
      <td class="right">${e.sv ? "‚úÖ" : "‚Äî"}</td>
      <td class="right"><button class="btn danger" data-del="${e.id}">L√∂schen</button></td>
    `;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll("[data-del]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id=b.getAttribute("data-del");
      Store.data.employees = Store.data.employees.filter(x=>x.id!==id);
      Store.save();
      renderAll();
    });
  });

  // payroll select
  const sel = $("p_emp");
  const cur = sel.value;
  sel.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value = "";
  o0.textContent = list.length ? "Mitarbeiter w√§hlen" : "Keine Mitarbeiter";
  sel.appendChild(o0);
  for(const e of list){
    const o=document.createElement("option");
    o.value=e.id;
    o.textContent = `${e.name} ‚Ä¢ ${fmtEUR(e.rate)}/h`;
    sel.appendChild(o);
  }
  if(cur && list.some(x=>x.id===cur)) sel.value=cur;
}

function empSave(){
  const name = ($("e_name").value||"").trim();
  const rate = num($("e_rate").value);
  const sv = $("e_sv").value==="yes";
  if(!name){ Toast.show("Name fehlt"); return; }
  if(rate<=0){ Toast.show("‚Ç¨/h fehlt"); return; }
  Store.data.employees.unshift({id:uid(), name, rate: round2(rate), sv});
  Store.save();
  $("e_name").value=""; $("e_rate").value=""; $("e_sv").value="yes";
  renderAll();
}

/* ===== PAYROLL ===== */
function payrollFillRate(){
  const id = $("p_emp").value;
  const emp = Store.data.employees.find(x=>x.id===id);
  if(emp){
    const cur = num($("p_rate").value);
    if(cur<=0) $("p_rate").value = emp.rate.toFixed(2);
  }
}
function payrollCalc(){
  const id = $("p_emp").value;
  const emp = Store.data.employees.find(x=>x.id===id);
  const hours = num($("p_hours").value);
  const rate = num($("p_rate").value);
  const s = Store.data.settings;

  const brutto = round2(hours*rate);
  const an = emp && emp.sv ? round2(brutto * (num(s.sv_an)/100)) : 0;
  const ag = emp && emp.sv ? round2(brutto * (num(s.sv_ag)/100)) : 0;
  const netto = round2(brutto - an);
  const cost = round2(brutto + ag);

  const tbody = $("payTable");
  tbody.innerHTML = `
    <tr><td>Brutto</td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
    <tr><td>SV Arbeitnehmer</td><td class="right">${fmtEUR(an)}</td></tr>
    <tr><td>Netto (estimate)</td><td class="right"><b>${fmtEUR(netto)}</b></td></tr>
    <tr><td>SV Arbeitgeber</td><td class="right">${fmtEUR(ag)}</td></tr>
    <tr><td>Gesamtkosten Firma</td><td class="right"><b>${fmtEUR(cost)}</b></td></tr>
  `;
}
function payrollPDF(){
  payrollCalc();
  const id = $("p_emp").value;
  const emp = Store.data.employees.find(x=>x.id===id);
  if(!emp){ Toast.show("Mitarbeiter w√§hlen"); return; }
  const hours = num($("p_hours").value);
  const rate = num($("p_rate").value);
  const s = Store.data.settings;
  const brutto = round2(hours*rate);
  const an = emp.sv ? round2(brutto * (num(s.sv_an)/100)) : 0;
  const ag = emp.sv ? round2(brutto * (num(s.sv_ag)/100)) : 0;
  const netto = round2(brutto - an);

  const html = `
<!doctype html><html><head><meta charset="utf-8"/>
<title>Payroll ${escapeHtml(emp.name)}</title>
<style>
@page{size:A4;margin:10mm}
body{font-family:Arial;margin:0;color:#000}
.h{display:flex;justify-content:space-between;border-bottom:1px solid #ddd;padding-bottom:5mm;margin-bottom:5mm}
.small{font-size:11px;color:#333}
table{width:100%;border-collapse:collapse;font-size:11px}
th,td{border-bottom:1px solid #eee;padding:6px}
.right{text-align:right}
.note{margin-top:8mm;font-size:11px;color:#333;border:1px dashed #999;padding:8px}
</style></head><body>
<div class="h">
  <div>
    <div style="font-size:18px;font-weight:800">Payroll / SV (Estimate)</div>
    <div style="font-weight:800">${escapeHtml(s.company||"")}</div>
  </div>
  <div class="small right">
    <div><b>Mitarbeiter:</b> ${escapeHtml(emp.name)}</div>
    <div><b>Datum:</b> ${escapeHtml(todayISO())}</div>
  </div>
</div>

<table>
<tr><td>Stunden</td><td class="right">${hours.toFixed(2)}</td></tr>
<tr><td>‚Ç¨/h</td><td class="right">${rate.toFixed(2)}</td></tr>
<tr><td><b>Brutto</b></td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
<tr><td>SV Arbeitnehmer</td><td class="right">${fmtEUR(an)}</td></tr>
<tr><td><b>Netto (estimate)</b></td><td class="right"><b>${fmtEUR(netto)}</b></td></tr>
<tr><td>SV Arbeitgeber</td><td class="right">${fmtEUR(ag)}</td></tr>
</table>

<div class="note">
<b>Hinweis:</b> Dies ist nur eine interne Sch√§tzung. Keine offizielle Lohnabrechnung / Steuerbescheinigung.
</div>

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
  const w=window.open("","_blank");
  if(!w){ Toast.show("Popup blockiert. Popups erlauben."); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ===== SETTINGS ===== */
function settingsLoad(){
  const s = Store.data.settings;
  $("s_company").value = s.company||"";
  $("s_addr").value = s.addr||"";
  $("s_email").value = s.email||"";
  $("s_phone").value = s.phone||"";
  $("s_iban").value = s.iban||"";
  $("s_bic").value = s.bic||"";
  $("s_taxid").value = s.taxid||"";
  $("s_sv_an").value = Number(s.sv_an||20.30).toFixed(2);
  $("s_sv_ag").value = Number(s.sv_ag||20.30).toFixed(2);

  $("brandTitle").textContent = s.company || "Masculine Security";
  const initials = (s.company||"MS").split(/\s+/).map(x=>x[0]).slice(0,2).join("").toUpperCase();
  $("brandLogo").textContent = initials || "MS";
}
function settingsSave(){
  const s = Store.data.settings;
  s.company = ($("s_company").value||"").trim() || "Masculine Security";
  s.addr = ($("s_addr").value||"").trim();
  s.email = ($("s_email").value||"").trim();
  s.phone = ($("s_phone").value||"").trim();
  s.iban = ($("s_iban").value||"").trim();
  s.bic = ($("s_bic").value||"").trim();
  s.taxid = ($("s_taxid").value||"").trim();
  s.sv_an = round2(num($("s_sv_an").value));
  s.sv_ag = round2(num($("s_sv_ag").value));
  Store.save();
  settingsLoad();
  Toast.show("Settings saved");
}

/* ===== EXPORT / IMPORT ===== */
function exportJSON(){
  const blob=new Blob([JSON.stringify(Store.data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="ms-office-backup.json"; a.click();
  URL.revokeObjectURL(url);
  Toast.show("Export OK");
}
function importJSON(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const d=JSON.parse(r.result);
      if(!d || typeof d!=="object") throw new Error("bad");
      d.settings ||= Store.data.settings;
      if(!Array.isArray(d.employees)) d.employees=[];
      if(d.settings.sv_an===undefined) d.settings.sv_an=20.30;
      if(d.settings.sv_ag===undefined) d.settings.sv_ag=20.30;
      Store.data=d;
      Store.save(true);
      renderAll();
      Toast.show("Import OK");
    }catch(e){
      Toast.show("Import Fehler");
    }
  };
  r.readAsText(file);
}

/* ===== RENDER ALL ===== */
function renderAll(){
  setStorageUI();
  settingsLoad();
  renderEmployees();
  // invoice defaults
  if(!$("i_date").value) $("i_date").value = todayISO();
  if(!$("i_no").value) $("i_no").value = nextInvoiceNo();
  calcInvoice();
}

/* ===== BIND ===== */
function bind(){
  document.querySelectorAll("#nav button").forEach(b=>{
    b.addEventListener("click", ()=>UI.go(b.dataset.page));
  });

  ["w_days","w_hpd","w_rate"].forEach(id=>{
    $(id).addEventListener("input", calcInvoice);
    $(id).addEventListener("change", calcInvoice);
  });

  $("btnPrintInvoice").addEventListener("click", printInvoice);

  $("btnEmpSave").addEventListener("click", empSave);

  $("p_emp").addEventListener("change", ()=>{ $("p_rate").value=""; payrollFillRate(); payrollCalc(); });
  $("p_hours").addEventListener("input", payrollCalc);
  $("p_rate").addEventListener("input", payrollCalc);
  $("btnPayCalc").addEventListener("click", payrollCalc);
  $("btnPayPDF").addEventListener("click", payrollPDF);

  $("btnSettingsSave").addEventListener("click", settingsSave);

  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", ()=>$("fileImport").click());
  $("fileImport").addEventListener("change",(e)=>{
    const f=e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value="";
  });

  $("btnWipe").addEventListener("click", ()=>{
    const ok=confirm("Reset? (Employees + Settings)");
    if(ok) Store.wipe();
  });
}

/* ===== INIT ===== */
(function init(){
  Store.load();
  bind();
  UI.go("invoices");
})();
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masculine Security ‚Äî Dienstplan & Dokumentation</title>
  <meta name="theme-color" content="#0b2d57" />
  <style>
    :root{
      --bg:#071225;
      --panel:#0b1a33;
      --panel2:#0c2242;
      --card:#0f2a4f;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --good:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:16px;
      --r2:12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.25), transparent 55%),
        radial-gradient(900px 600px at 110% 0%, rgba(33,209,159,.16), transparent 50%),
        radial-gradient(900px 600px at 10% 110%, rgba(255,206,84,.10), transparent 55%),
        var(--bg);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{max-width:1200px; margin:20px auto; padding:0 14px 60px}
    .topbar{
      display:flex; gap:14px; align-items:stretch; justify-content:space-between;
      background:linear-gradient(180deg, rgba(12,34,66,.95), rgba(11,26,51,.95));
      border:1px solid rgba(22,52,94,.8);
      border-radius:24px;
      padding:14px 14px;
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; gap:12px; align-items:center; min-width:280px;
    }
    .logo{
      width:54px; height:54px; border-radius:14px;
      background:rgba(255,255,255,.08);
      display:grid; place-items:center;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover; display:block}
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1.15;
      font-weight:800;
    }
    .brand .sub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.3;
    }
    .pillrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      border:1px solid rgba(22,52,94,.9);
      background:rgba(15,42,79,.55);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.15s transform ease, .15s opacity ease, .15s background ease;
    }
    .pill:hover{transform:translateY(-1px); background:rgba(15,42,79,.75)}
    .pill.primary{
      background:linear-gradient(180deg, rgba(58,166,255,.25), rgba(58,166,255,.10));
      border-color:rgba(58,166,255,.45);
    }
    .pill.good{
      background:linear-gradient(180deg, rgba(33,209,159,.22), rgba(33,209,159,.10));
      border-color:rgba(33,209,159,.45);
    }
    .pill.warn{
      background:linear-gradient(180deg, rgba(255,206,84,.18), rgba(255,206,84,.08));
      border-color:rgba(255,206,84,.35);
    }
    .pill.bad{
      background:linear-gradient(180deg, rgba(255,77,109,.18), rgba(255,77,109,.08));
      border-color:rgba(255,77,109,.35);
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
      .topbar{flex-direction:column; align-items:stretch}
      .pillrow{justify-content:flex-start}
    }

    .card{
      background:linear-gradient(180deg, rgba(12,34,66,.75), rgba(11,26,51,.75));
      border:1px solid rgba(22,52,94,.85);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:12px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{
      flex:1 1 220px;
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{font-size:12px; color:var(--muted); font-weight:700}
    input, select, textarea{
      width:100%;
      background:rgba(7,18,37,.7);
      border:1px solid rgba(22,52,94,.95);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(155,177,213,.65)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:1px solid rgba(22,52,94,.95);
      background:rgba(15,42,79,.65);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(15,42,79,.85)}
    .btn.primary{border-color:rgba(58,166,255,.5); background:rgba(58,166,255,.18)}
    .btn.good{border-color:rgba(33,209,159,.5); background:rgba(33,209,159,.16)}
    .btn.bad{border-color:rgba(255,77,109,.45); background:rgba(255,77,109,.14)}
    .btn.warn{border-color:rgba(255,206,84,.45); background:rgba(255,206,84,.12)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(22,52,94,.85);
      background:rgba(7,18,37,.35);
    }
    th, td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(22,52,94,.6);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      background:rgba(15,42,79,.45);
      font-weight:900;
      letter-spacing:.2px;
    }
    tr:last-child td{border-bottom:none}
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      border:1px solid rgba(22,52,94,.85);
      background:rgba(15,42,79,.65);
    }
    .tag.good{border-color:rgba(33,209,159,.45); background:rgba(33,209,159,.14)}
    .tag.warn{border-color:rgba(255,206,84,.45); background:rgba(255,206,84,.12)}
    .tag.bad{border-color:rgba(255,77,109,.45); background:rgba(255,77,109,.12)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .mini{
      padding:7px 10px; border-radius:12px; font-size:11px; font-weight:900;
      border:1px solid rgba(22,52,94,.85); background:rgba(15,42,79,.55); cursor:pointer;
    }
    .mini:hover{background:rgba(15,42,79,.8)}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(12,34,66,.92); border:1px solid rgba(22,52,94,.9);
      color:var(--text); padding:10px 12px; border-radius:14px; box-shadow:var(--shadow);
      font-weight:800; font-size:12px; display:none; z-index:9999;
      max-width:min(560px, 92vw);
    }
    .tabs{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(22,52,94,.85);
      background:rgba(15,42,79,.55);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .tab.active{
      border-color:rgba(58,166,255,.45);
      background:rgba(58,166,255,.18);
    }
    .panel{display:none}
    .panel.active{display:block}

    /* PRINT / PDF */
    @media print{
      body{background:#fff !important; color:#000 !important}
      .topbar, .tabs, .no-print{display:none !important}
      .wrap{max-width:100%; margin:0; padding:0}
      .card{box-shadow:none; border:1px solid #d7d7d7; background:#fff; border-radius:10px}
      table{border:1px solid #d7d7d7; background:#fff}
      th{background:#eef6ff; color:#0b2d57}
      .print-header{
        display:flex !important;
        justify-content:space-between;
        align-items:center;
        gap:14px;
        border-bottom:2px solid #0b2d57;
        padding-bottom:10px;
        margin-bottom:12px;
      }
      .print-header .left{display:flex; gap:10px; align-items:center}
      .print-header img{width:56px; height:56px; object-fit:cover; border-radius:12px}
      .print-title{font-size:16px; font-weight:900; color:#0b2d57}
      .print-sub{font-size:11px; color:#234}
      .print-meta{font-size:11px; color:#234; text-align:right}
    }
    .print-header{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="logo.png">
          <img id="logoImg" src="logo.png" alt="Masculine Security Logo" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='grid';" />
          <div id="logoFallback" style="display:none; place-items:center; width:100%; height:100%; color:rgba(255,255,255,.85); font-weight:900; font-size:12px; background:rgba(58,166,255,.10)">
            LOGO
          </div>
        </div>
        <div>
          <h1 id="companyName">MASCULINE SECURITY ‚Äî Dienstplan</h1>
          <div class="sub">
            <span id="companyAddress">Werschenregerstra√üe 6 ¬∑ 28237 Bremen</span> ¬∑
            Tel: <span id="companyPhone">015778697052</span> ¬∑
            <span id="companyEmail">Kontakt.mass.bremen@hotmail.com</span>
            <div class="muted" id="autosaveInfo" style="margin-top:4px;">Auto-Speichern aktiv.</div>
          </div>
        </div>
      </div>

      <div class="pillrow no-print">
        <button class="pill primary" id="tabDienstplan">Wochenplan</button>
        <button class="pill" id="tabDok">Dokumentation</button>
        <button class="pill warn" id="btnPrint">Drucken</button>
        <button class="pill primary" id="btnPDF">PDF</button>
        <button class="pill good" id="btnAutoPrint">Auto-Print Sheet</button>
        <button class="pill" id="btnExportCSV">Export CSV</button>
        <button class="pill" id="btnWhatsApp">WhatsApp (PDF teilen)</button>
        <button class="pill bad" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="tabs no-print">
      <button class="tab active" data-panel="pDienstplan">Dienstplan</button>
      <button class="tab" data-panel="pDok">Dokumentation</button>
    </div>

    <!-- PRINT HEADER (only appears on print/PDF) -->
    <div class="print-header">
      <div class="left">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none';" />
        <div>
          <div class="print-title">Masculine Security ‚Äî Dienstplan</div>
          <div class="print-sub" id="printCompanyLine">Werschenregerstra√üe 6, 28237 Bremen ¬∑ Tel: 015778697052 ¬∑ Kontakt.mass.bremen@hotmail.com</div>
        </div>
      </div>
      <div class="print-meta">
        <div><strong>Erstellt am:</strong> <span id="printCreatedAt"></span></div>
        <div><strong>Dokument:</strong> Wochenplan & Dokumentation</div>
      </div>
    </div>

    <div class="grid panel active" id="pDienstplan">
      <div class="card">
        <h2>W√∂chentlicher Mitarbeiter-Dienstplan</h2>
        <div class="muted">
          Beispiel: Mitarbeiter ‚ÄûMustafa‚Äú arbeitet <strong>Mo, Di, Mi, Do</strong> am Objekt <strong>Baustelle Bremen</strong> in Schicht <strong>Nacht</strong>.
          Du kannst daraus einen Text erzeugen (WhatsApp/Email) und als PDF drucken.
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field">
            <label>Monat (z.B. M√§rz 2026)</label>
            <input id="metaMonth" placeholder="Februar 2026" />
          </div>
          <div class="field">
            <label>Standort</label>
            <input id="metaLocation" placeholder="Bremen & Umgebung" />
          </div>
          <div class="field">
            <label>Objekt (Standard)</label>
            <input id="metaObjekt" placeholder="Baustelle / Hotel / Lager" />
          </div>
          <div class="field">
            <label>Logo-Datei (muss im Repo liegen)</label>
            <input id="metaLogo" value="logo.png" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field">
            <label>Mitarbeiter-Nr.</label>
            <input id="empNr" placeholder="z.B. 001" />
          </div>
          <div class="field">
            <label>Name</label>
            <input id="empName" placeholder="Mustafa" />
          </div>
          <div class="field">
            <label>Arbeitstage</label>
            <input id="empDays" placeholder="Mo, Di, Mi, Do" />
          </div>
          <div class="field">
            <label>Schicht</label>
            <select id="empShift">
              <option value="Tag">Tag</option>
              <option value="Nacht">Nacht</option>
            </select>
          </div>
          <div class="field" style="flex:1 1 260px">
            <label>Objekt / Einsatzort</label>
            <input id="empObjekt" placeholder="Baustelle Bremen" />
          </div>
        </div>

        <div class="btnrow no-print">
          <button class="btn good" id="btnSaveWeekly">Speichern</button>
          <button class="btn" id="btnClearWeekly">Felder leeren</button>
          <button class="btn primary" id="btnGenerateMsg">Nachricht erzeugen</button>
        </div>

        <div style="height:12px"></div>

        <div class="card" style="padding:12px; border-radius:18px; background:rgba(7,18,37,.35)">
          <h2 style="margin:0 0 8px 0; font-size:14px">Nachricht-Vorschau (zum Senden)</h2>
          <div class="muted">Du kannst den Text kopieren und per WhatsApp/Email senden.</div>
          <div style="height:8px"></div>
          <textarea id="msgPreview" placeholder="Hier erscheint die Nachricht..." class="no-print"></textarea>
          <div class="btnrow no-print">
            <button class="btn" id="btnCopyMsg">Text kopieren</button>
            <button class="btn primary" id="btnOpenWhatsAppText">WhatsApp Text √∂ffnen</button>
          </div>
        </div>

        <div style="height:14px"></div>

        <h2>Gespeicherte Wochenpl√§ne</h2>
        <div class="muted">Diese Liste wird lokal im Browser gespeichert (Auto-Save).</div>
        <div style="height:10px"></div>
        <div class="no-print" id="weeklyEmpty" style="display:none" class="muted">Noch keine Wochenpl√§ne gespeichert.</div>
        <div style="overflow:auto">
          <table id="weeklyTable">
            <thead>
              <tr>
                <th>Mitarb.-Nr.</th>
                <th>Name</th>
                <th>Tage</th>
                <th>Schicht</th>
                <th>Objekt</th>
                <th>Monat</th>
                <th>Standort</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="weeklyTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Schnell-PDF / Druck</h2>
        <div class="muted">
          <strong>PDF</strong> = √ñffnet Print-Dialog ‚Üí w√§hle ‚ÄûAls PDF speichern‚Äú.<br>
          <strong>Auto-Print Sheet</strong> = druckt direkt die Tabellenansicht (Blau).
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <div class="field">
            <label>Kontakt-Email (klickbar im PDF-Text)</label>
            <input id="metaEmail" value="Kontakt.mass.bremen@hotmail.com" />
          </div>
          <div class="field">
            <label>Telefon</label>
            <input id="metaPhone" value="015778697052" />
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="btnrow no-print">
          <button class="btn warn" id="btnPrint2">Drucken</button>
          <button class="btn primary" id="btnPDF2">PDF</button>
          <button class="btn good" id="btnAutoPrint2">Auto-Print Sheet</button>
        </div>

        <div style="height:12px"></div>
        <div class="card" style="padding:12px; border-radius:18px; background:rgba(7,18,37,.35)">
          <h2 style="margin:0 0 8px 0; font-size:14px">Warum war es bei dir ‚Äûblank‚Äú?</h2>
          <div class="muted">
            Meistens: alter Cache/Service-Worker oder ein JS-Fehler. Dieses HTML ist ‚Äûein File‚Äú und hat Error-Schutz,
            damit die Seite nicht wei√ü bleibt.
          </div>
        </div>
      </div>
    </div>

    <div class="grid panel" id="pDok">
      <div class="card">
        <h2>Dokumentation ‚Äî Anwesend / Abwesend</h2>
        <div class="muted">
          Hier dokumentierst du Mitarbeiter, die <strong>anwesend</strong> oder <strong>abwesend</strong> sind (z.B. Nachweis f√ºr Objekt).
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field">
            <label>Datum</label>
            <input id="docDate" type="date" />
          </div>
          <div class="field">
            <label>Objekt</label>
            <input id="docObjekt" placeholder="z.B. Hotel XYZ / Baustelle Bremen" />
          </div>
          <div class="field">
            <label>Mitarbeiter-Nr.</label>
            <input id="docNr" placeholder="z.B. 001" />
          </div>
          <div class="field">
            <label>Name</label>
            <input id="docName" placeholder="Mitarbeiter Name" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Anwesend (Liste)</label>
            <textarea id="docPresent" placeholder="z.B. Mustafa (001)&#10;Ali (002)"></textarea>
          </div>
          <div class="field">
            <label>Abwesend (Liste + Grund)</label>
            <textarea id="docAbsent" placeholder="z.B. Ahmed (003) ‚Äî krank&#10;Hassan (004) ‚Äî Urlaub"></textarea>
          </div>
        </div>

        <div class="btnrow no-print">
          <button class="btn good" id="btnSaveDoc">Speichern</button>
          <button class="btn" id="btnClearDoc">Felder leeren</button>
        </div>

        <div style="height:14px"></div>

        <h2>Gespeicherte Dokumentationen</h2>
        <div class="muted">Wird automatisch gespeichert (lokal).</div>
        <div style="height:10px"></div>

        <div style="overflow:auto">
          <table id="docTable">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Objekt</th>
                <th>Anwesend</th>
                <th>Abwesend</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="docTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>PDF / Export</h2>
        <div class="muted">
          Dokumentation kann ebenfalls im PDF erscheinen (Druck ‚Üí ‚ÄûAls PDF speichern‚Äú).
        </div>
        <div style="height:12px"></div>

        <div class="btnrow no-print">
          <button class="btn warn" id="btnPrintDoc">Drucken</button>
          <button class="btn primary" id="btnPDFDoc">PDF</button>
          <button class="btn" id="btnExportDocCSV">Export CSV</button>
        </div>

        <div style="height:12px"></div>
        <div class="card" style="padding:12px; border-radius:18px; background:rgba(7,18,37,.35)">
          <h2 style="margin:0 0 8px 0; font-size:14px">WhatsApp (PDF)</h2>
          <div class="muted">
            Browser wuxuu kuu ogolaan karaa ‚ÄúShare‚Äù haddii uu taageero. Haddii kale:
            <br>1) PDF ‚Üí Save as PDF
            <br>2) WhatsApp ‚Üí Attach ‚Üí Document ‚Üí dooro PDF ‚Üí Send
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      // ---------- SAFE HELPERS ----------
      const $ = (id)=> document.getElementById(id);
      const nowStr = ()=> new Date().toLocaleString("de-DE");
      const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toast._tm);
        toast._tm = setTimeout(()=> t.style.display="none", 2600);
      }

      function safeJsonParse(v, fallback){
        try{ return JSON.parse(v); } catch(e){ return fallback; }
      }

      function normalizeDays(days){
        // allow user: Mon, dienstag... -> German short
        const map = new Map([
          ["montag","Mo"],["mon","Mo"],["mo","Mo"],
          ["dienstag","Di"],["tue","Di"],["di","Di"],
          ["mittwoch","Mi"],["wed","Mi"],["mi","Mi"],
          ["donnerstag","Do"],["thu","Do"],["do","Do"],
          ["freitag","Fr"],["fri","Fr"],["fr","Fr"],
          ["samstag","Sa"],["sat","Sa"],["sa","Sa"],
          ["sonntag","So"],["sun","So"],["so","So"],
        ]);
        const parts = String(days||"").split(/[,/]/).map(s=>s.trim()).filter(Boolean);
        const out = [];
        for(const p of parts){
          const key = p.toLowerCase();
          out.push(map.get(key) || p);
        }
        return out.join(", ");
      }

      // ---------- STORAGE KEYS ----------
      const K_META = "MS_META_V3";
      const K_WEEKLY = "MS_WEEKLY_V3";
      const K_DOCS = "MS_DOCS_V3";
      const APP_VERSION = "v3.1.0"; // bump to force reload notice

      // ---------- DEFAULT META ----------
      const defaultMeta = {
        companyName: "MASCULINE SECURITY ‚Äî Dienstplan",
        address: "Werschenregerstra√üe 6 ¬∑ 28237 Bremen",
        phone: "015778697052",
        email: "Kontakt.mass.bremen@hotmail.com",
        month: "",
        location: "Bremen & Umgebung",
        objekt: "",
        logo: "logo.png",
        updatedAt: null
      };

      // ---------- LOAD META ----------
      let meta = Object.assign({}, defaultMeta, safeJsonParse(localStorage.getItem(K_META), {}));

      function applyMeta(){
        $("companyName").textContent = meta.companyName || defaultMeta.companyName;
        $("companyAddress").textContent = meta.address || defaultMeta.address;
        $("companyPhone").textContent = meta.phone || defaultMeta.phone;
        $("companyEmail").textContent = meta.email || defaultMeta.email;

        $("metaMonth").value = meta.month || "";
        $("metaLocation").value = meta.location || "";
        $("metaObjekt").value = meta.objekt || "";
        $("metaLogo").value = meta.logo || "logo.png";
        $("metaEmail").value = meta.email || defaultMeta.email;
        $("metaPhone").value = meta.phone || defaultMeta.phone;

        // logo path
        const logoPath = (meta.logo || "logo.png").trim() || "logo.png";
        $("logoImg").src = logoPath + (logoPath.includes("?") ? "" : "?v=" + encodeURIComponent(APP_VERSION));
        // print header
        $("printCompanyLine").textContent =
          (meta.address || defaultMeta.address).replace(" ¬∑ ", ", ") + " ¬∑ Tel: " + (meta.phone||defaultMeta.phone) + " ¬∑ " + (meta.email||defaultMeta.email);
      }

      function saveMeta(){
        meta.companyName = $("companyName").textContent.trim() || defaultMeta.companyName;
        meta.address = $("companyAddress").textContent.trim() || defaultMeta.address;
        meta.phone = $("metaPhone").value.trim() || defaultMeta.phone;
        meta.email = $("metaEmail").value.trim() || defaultMeta.email;
        meta.month = $("metaMonth").value.trim();
        meta.location = $("metaLocation").value.trim();
        meta.objekt = $("metaObjekt").value.trim();
        meta.logo = ($("metaLogo").value.trim() || "logo.png");
        meta.updatedAt = new Date().toISOString();
        localStorage.setItem(K_META, JSON.stringify(meta));
        $("autosaveInfo").textContent = "Auto-Update: " + nowStr();
      }

      // ---------- WEEKLY PLANS ----------
      let weekly = safeJsonParse(localStorage.getItem(K_WEEKLY), []);
      if(!Array.isArray(weekly)) weekly = [];

      function renderWeekly(){
        const tb = $("weeklyTbody");
        tb.innerHTML = "";
        $("weeklyEmpty").style.display = weekly.length ? "none" : "block";

        for(const row of weekly){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="tag">${escapeHtml(row.nr||"")}</span></td>
            <td><strong>${escapeHtml(row.name||"")}</strong></td>
            <td>${escapeHtml(row.days||"")}</td>
            <td><span class="tag ${row.shift==="Nacht"?"warn":"good"}">${escapeHtml(row.shift||"")}</span></td>
            <td>${escapeHtml(row.objekt||"")}</td>
            <td>${escapeHtml(row.month||"")}</td>
            <td>${escapeHtml(row.location||"")}</td>
            <td>
              <div class="actions no-print">
                <button class="mini" data-act="use" data-id="${row.id}">Nutzen</button>
                <button class="mini" data-act="msg" data-id="${row.id}">Text</button>
                <button class="mini" data-act="del" data-id="${row.id}">L√∂schen</button>
              </div>
            </td>
          `;
          tb.appendChild(tr);
        }
      }

      function saveWeekly(){
        localStorage.setItem(K_WEEKLY, JSON.stringify(weekly));
        $("autosaveInfo").textContent = "Auto-Update: " + nowStr();
      }

      function getWeeklyForm(){
        const nr = $("empNr").value.trim();
        const name = $("empName").value.trim();
        const days = normalizeDays($("empDays").value.trim());
        const shift = $("empShift").value;
        const objekt = ($("empObjekt").value.trim() || meta.objekt || "");
        const month = meta.month || $("metaMonth").value.trim();
        const location = meta.location || $("metaLocation").value.trim();
        return { nr, name, days, shift, objekt, month, location };
      }

      function clearWeeklyForm(){
        $("empNr").value = "";
        $("empName").value = "";
        $("empDays").value = "";
        $("empShift").value = "Tag";
        $("empObjekt").value = "";
      }

      function generateMessage(w){
        const lines = [];
        lines.push("üìå MASCULINE SECURITY ‚Äî DIENSTPLAN");
        lines.push("");
        lines.push("Mitarbeiter: " + (w.name || "-") + (w.nr ? " (Nr. " + w.nr + ")" : ""));
        lines.push("Arbeitstage: " + (w.days || "-"));
        lines.push("Schicht: " + (w.shift || "-"));
        lines.push("Objekt: " + (w.objekt || "-"));
        if(w.location) lines.push("Standort: " + w.location);
        if(w.month) lines.push("Monat: " + w.month);
        lines.push("");
        lines.push("Kontakt:");
        lines.push("Tel: " + (meta.phone || defaultMeta.phone));
        lines.push("Email: " + (meta.email || defaultMeta.email));
        lines.push("");
        lines.push("Bitte p√ºnktlich erscheinen. Danke.");
        return lines.join("\n");
      }

      // ---------- DOCUMENTATION ----------
      let docs = safeJsonParse(localStorage.getItem(K_DOCS), []);
      if(!Array.isArray(docs)) docs = [];

      function saveDocs(){
        localStorage.setItem(K_DOCS, JSON.stringify(docs));
        $("autosaveInfo").textContent = "Auto-Update: " + nowStr();
      }

      function renderDocs(){
        const tb = $("docTbody");
        tb.innerHTML = "";
        for(const d of docs){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(d.date||"")}</td>
            <td>${escapeHtml(d.objekt||"")}</td>
            <td>${nl2br(escapeHtml(d.present||""))}</td>
            <td>${nl2br(escapeHtml(d.absent||""))}</td>
            <td>
              <div class="actions no-print">
                <button class="mini" data-act="useDoc" data-id="${d.id}">Nutzen</button>
                <button class="mini" data-act="delDoc" data-id="${d.id}">L√∂schen</button>
              </div>
            </td>
          `;
          tb.appendChild(tr);
        }
      }

      function clearDocForm(){
        $("docDate").value = "";
        $("docObjekt").value = "";
        $("docNr").value = "";
        $("docName").value = "";
        $("docPresent").value = "";
        $("docAbsent").value = "";
      }

      // ---------- EXPORT CSV ----------
      function downloadText(filename, text){
        const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
      }

      function exportWeeklyCSV(){
        const headers = ["MitarbeiterNr","Name","Tage","Schicht","Objekt","Monat","Standort"];
        const rows = weekly.map(w=>[
          w.nr||"", w.name||"", w.days||"", w.shift||"", w.objekt||"", w.month||"", w.location||""
        ]);
        const csv = [headers, ...rows]
          .map(r=> r.map(v=> `"${String(v).replaceAll('"','""')}"`).join(";"))
          .join("\n");
        downloadText("dienstplan_wochenplan.csv", csv);
      }

      function exportDocsCSV(){
        const headers = ["Datum","Objekt","Anwesend","Abwesend"];
        const rows = docs.map(d=>[d.date||"", d.objekt||"", d.present||"", d.absent||""]);
        const csv = [headers, ...rows]
          .map(r=> r.map(v=> `"${String(v).replaceAll('"','""')}"`).join(";"))
          .join("\n");
        downloadText("dokumentation.csv", csv);
      }

      // ---------- PRINT / PDF ----------
      function doPrint(){
        $("printCreatedAt").textContent = new Date().toLocaleString("de-DE");
        // ensure meta saved
        saveMeta();
        // small delay so print header updates
        setTimeout(()=> window.print(), 60);
      }

      // "Auto-Print Sheet" = print immediately the tables (same print)
      function autoPrintSheet(){
        // Ensure message area doesn't block printing
        doPrint();
      }

      // ---------- WHATSAPP SHARE ----------
      async function sharePDFHint(){
        // Browsers cannot directly "send PDF to WhatsApp" without user save/share.
        // We try navigator.share with text, and also open wa.me for text.
        const msg = $("msgPreview").value.trim() || "Masculine Security ‚Äî Dienstplan";
        try{
          if(navigator.share){
            await navigator.share({ title:"Dienstplan", text: msg });
            toast("Teilen ge√∂ffnet (WhatsApp ausw√§hlen, wenn verf√ºgbar).");
            return;
          }
        }catch(e){}
        // fallback open WhatsApp web text
        const url = "https://wa.me/?text=" + encodeURIComponent(msg);
        window.open(url, "_blank", "noopener,noreferrer");
        toast("WhatsApp Text ge√∂ffnet. PDF bitte √ºber Drucken ‚Üí Als PDF speichern senden.");
      }

      // ---------- HTML ESCAPE ----------
      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }
      function nl2br(s){ return s.replaceAll("\n","<br>"); }

      // ---------- TABS ----------
      function setPanel(panelId){
        for(const p of document.querySelectorAll(".panel")) p.classList.remove("active");
        $(panelId).classList.add("active");
        for(const t of document.querySelectorAll(".tab")) t.classList.toggle("active", t.dataset.panel === panelId);
      }

      // ---------- INIT ----------
      function init(){
        // default date
        const today = new Date();
        $("docDate").value = today.toISOString().slice(0,10);

        // apply meta
        applyMeta();

        // render lists
        renderWeekly();
        renderDocs();

        // autosave meta on input
        const metaInputs = ["metaMonth","metaLocation","metaObjekt","metaLogo","metaEmail","metaPhone"];
        metaInputs.forEach(id=>{
          $(id).addEventListener("input", ()=>{
            // update live
            meta.month = $("metaMonth").value.trim();
            meta.location = $("metaLocation").value.trim();
            meta.objekt = $("metaObjekt").value.trim();
            meta.logo = $("metaLogo").value.trim() || "logo.png";
            meta.email = $("metaEmail").value.trim();
            meta.phone = $("metaPhone").value.trim();
            localStorage.setItem(K_META, JSON.stringify(Object.assign(meta,{updatedAt:new Date().toISOString()})));
            applyMeta();
            $("autosaveInfo").textContent = "Auto-Update: " + nowStr();
          });
        });

        // tabs (top)
        document.querySelectorAll(".tab").forEach(btn=>{
          btn.addEventListener("click", ()=> setPanel(btn.dataset.panel));
        });
        $("tabDienstplan").addEventListener("click", ()=> setPanel("pDienstplan"));
        $("tabDok").addEventListener("click", ()=> setPanel("pDok"));

        // weekly save
        $("btnSaveWeekly").addEventListener("click", ()=>{
          saveMeta();
          const w = getWeeklyForm();
          if(!w.name){ toast("Bitte Name eingeben."); return; }
          if(!w.days){ toast("Bitte Arbeitstage eingeben (z.B. Mo, Di, Mi)."); return; }
          const item = { id: uid(), ...w };
          weekly.unshift(item);
          saveWeekly();
          renderWeekly();
          $("msgPreview").value = generateMessage(item);
          toast("Wochenplan gespeichert.");
        });

        $("btnClearWeekly").addEventListener("click", ()=>{
          clearWeeklyForm();
          toast("Felder geleert.");
        });

        $("btnGenerateMsg").addEventListener("click", ()=>{
          saveMeta();
          const w = getWeeklyForm();
          if(!w.name){ toast("Bitte Name eingeben."); return; }
          if(!w.days){ toast("Bitte Arbeitstage eingeben."); return; }
          $("msgPreview").value = generateMessage(w);
          toast("Nachricht erzeugt.");
        });

        $("btnCopyMsg").addEventListener("click", async ()=>{
          const txt = $("msgPreview").value;
          if(!txt.trim()){ toast("Kein Text."); return; }
          try{
            await navigator.clipboard.writeText(txt);
            toast("Kopiert.");
          }catch(e){
            $("msgPreview").focus();
            $("msgPreview").select();
            toast("Markiert ‚Äî bitte STRG+C.");
          }
        });

        $("btnOpenWhatsAppText").addEventListener("click", ()=>{
          const txt = $("msgPreview").value.trim();
          if(!txt){ toast("Erst Nachricht erzeugen."); return; }
          window.open("https://wa.me/?text=" + encodeURIComponent(txt), "_blank", "noopener,noreferrer");
        });

        // weekly table actions
        $("weeklyTable").addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          const w = weekly.find(x=>x.id===id);
          if(!w) return;

          if(act==="use"){
            $("empNr").value = w.nr || "";
            $("empName").value = w.name || "";
            $("empDays").value = w.days || "";
            $("empShift").value = w.shift || "Tag";
            $("empObjekt").value = w.objekt || "";
            $("msgPreview").value = generateMessage(w);
            toast("In Formular geladen.");
          }
          if(act==="msg"){
            $("msgPreview").value = generateMessage(w);
            toast("Text erstellt.");
          }
          if(act==="del"){
            if(!confirm("Diesen Wochenplan l√∂schen?")) return;
            weekly = weekly.filter(x=>x.id!==id);
            saveWeekly();
            renderWeekly();
            toast("Gel√∂scht.");
          }
        });

        // docs save
        $("btnSaveDoc").addEventListener("click", ()=>{
          saveMeta();
          const date = $("docDate").value;
          const objekt = $("docObjekt").value.trim();
          const nr = $("docNr").value.trim();
          const name = $("docName").value.trim();

          let present = $("docPresent").value.trim();
          let absent = $("docAbsent").value.trim();

          // quick helper: if user filled nr/name but not lists, auto put into present
          if((nr || name) && !present && !absent){
            present = [name ? (name + (nr? " ("+nr+")":"")) : (nr? ("Nr. "+nr):"")].filter(Boolean).join("");
          }

          if(!date){ toast("Bitte Datum w√§hlen."); return; }
          if(!objekt){ toast("Bitte Objekt eingeben."); return; }
          if(!present && !absent){ toast("Bitte Anwesend oder Abwesend ausf√ºllen."); return; }

          const d = { id: uid(), date, objekt, present, absent };
          docs.unshift(d);
          saveDocs();
          renderDocs();
          toast("Dokumentation gespeichert.");
        });

        $("btnClearDoc").addEventListener("click", ()=>{
          clearDocForm();
          toast("Felder geleert.");
        });

        // docs table actions
        $("docTable").addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          const d = docs.find(x=>x.id===id);
          if(!d) return;

          if(act==="useDoc"){
            $("docDate").value = d.date || "";
            $("docObjekt").value = d.objekt || "";
            $("docPresent").value = d.present || "";
            $("docAbsent").value = d.absent || "";
            toast("In Formular geladen.");
          }
          if(act==="delDoc"){
            if(!confirm("Diese Dokumentation l√∂schen?")) return;
            docs = docs.filter(x=>x.id!==id);
            saveDocs();
            renderDocs();
            toast("Gel√∂scht.");
          }
        });

        // export
        $("btnExportCSV").addEventListener("click", ()=>{ exportWeeklyCSV(); toast("CSV exportiert."); });
        $("btnExportDocCSV").addEventListener("click", ()=>{ exportDocsCSV(); toast("CSV exportiert."); });

        // print/pdf
        $("btnPrint").addEventListener("click", doPrint);
        $("btnPDF").addEventListener("click", doPrint);
        $("btnPrint2").addEventListener("click", doPrint);
        $("btnPDF2").addEventListener("click", doPrint);
        $("btnPrintDoc").addEventListener("click", doPrint);
        $("btnPDFDoc").addEventListener("click", doPrint);

        $("btnAutoPrint").addEventListener("click", autoPrintSheet);
        $("btnAutoPrint2").addEventListener("click", autoPrintSheet);

        // WhatsApp share
        $("btnWhatsApp").addEventListener("click", sharePDFHint);

        // reset
        $("btnReset").addEventListener("click", ()=>{
          if(!confirm("Alles l√∂schen? (Dienstplan + Dokumentation + Meta)")) return;
          localStorage.removeItem(K_META);
          localStorage.removeItem(K_WEEKLY);
          localStorage.removeItem(K_DOCS);
          toast("Reset gemacht. Seite l√§dt neu‚Ä¶");
          setTimeout(()=> location.reload(), 700);
        });

        // keep meta consistent with top header phone/email
        // (we keep header fixed; phone/email are from meta inputs)
        // show app version
        const last = meta.updatedAt ? new Date(meta.updatedAt).toLocaleString("de-DE") : "‚Äî";
        $("autosaveInfo").textContent = "Auto-Update aktiv ¬∑ Letztes Speichern: " + last + " ¬∑ " + APP_VERSION;

        // show hint if logo missing
        setTimeout(()=>{
          const img = $("logoImg");
          if(img && img.style.display==="none"){
            toast("Logo nicht gefunden. Datei muss exakt 'logo.png' hei√üen (im Repo Root).");
          }
        }, 1200);
      }

      // Hard protection against blank screen: show errors as toast
      window.addEventListener("error", (e)=>{
        toast("Fehler: " + (e.message || "Unbekannt"));
      });
      window.addEventListener("unhandledrejection", (e)=>{
        toast("Fehler: " + (e.reason?.message || "Promise error"));
      });

      // Start
      try{ init(); }
      catch(err){
        document.body.innerHTML =
          "<div style='padding:20px;font-family:Arial;color:#fff;background:#071225'>" +
          "<h2>App Fehler</h2><pre style='white-space:pre-wrap;color:#ffce54'>" + (err?.stack || err) + "</pre>" +
          "<p>Bitte Screenshot senden.</p></div>";
      }
    })();
  </script>
</body>
</html>

/* =========================
   DATE FORMAT FIX (DE)
   Use everywhere in invoice preview + PDF export
   ========================= */

/** Pads number to 2 digits */
function pad2(n){ return String(n).padStart(2,'0'); }

/** Convert Date or date-like value to "DD.MM.YYYY" (Germany standard) */
function formatDateDE(value){
  if(!value) return "";
  // If already a Date
  const d = (value instanceof Date) ? value : toDate(value);
  if(!d) return "";
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
}

/** Accepts: "YYYY-MM-DD" (from <input type="date">), "DD.MM.YYYY", Date */
function toDate(value){
  if(!value) return null;
  if(value instanceof Date && !isNaN(value)) return value;

  // Handle "YYYY-MM-DD"
  if(typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)){
    const [y,m,d] = value.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return isNaN(dt) ? null : dt;
  }

  // Handle "DD.MM.YYYY"
  if(typeof value === "string" && /^\d{2}\.\d{2}\.\d{4}$/.test(value)){
    const [d,m,y] = value.split(".").map(Number);
    const dt = new Date(y, m-1, d);
    return isNaN(dt) ? null : dt;
  }

  // Fallback (try Date parse)
  const dt = new Date(value);
  return isNaN(dt) ? null : dt;
}

/** Build Zeitraum string as "DD.MM.YYYY – DD.MM.YYYY" */
function formatZeitraumDE(von, bis){
  const a = formatDateDE(von);
  const b = formatDateDE(bis);
  if(!a && !b) return "";
  if(a && !b) return a;
  if(!a && b) return b;
  return `${a} – ${b}`;
}

/* =========================
   APPLY IN YOUR INVOICE RENDER
   (Replace your old date outputs with these)
   ========================= */

// Example state fields you likely have:
const invoiceState = {
  rechnungsdatum: "2026-02-07", // from date input
  von: "2026-01-01",
  bis: "2026-01-31",
  faellig: "2026-02-15"
};

// Example render function (adapt to your code)
function renderInvoiceDates(){
  // Wherever you set text in HTML / PDF:
  const rechnungsdatumText = formatDateDE(invoiceState.rechnungsdatum);
  const zeitraumText = formatZeitraumDE(invoiceState.von, invoiceState.bis);
  const faelligText = formatDateDE(invoiceState.faellig);

  // Example DOM (rename ids to your real ones)
  const elRechnungsdatum = document.getElementById("invRechnungsdatum");
  const elZeitraum = document.getElementById("invZeitraum");
  const elFaellig = document.getElementById("invFaellig");

  if(elRechnungsdatum) elRechnungsdatum.textContent = rechnungsdatumText;
  if(elZeitraum) elZeitraum.textContent = zeitraumText;
  if(elFaellig) elFaellig.textContent = faelligText;
}

/* =========================
   IMPORTANT: Make sure you do NOT print mixed formats anywhere else.
   - If you currently print new Date().toISOString().slice(0,10)
     -> replace with formatDateDE(new Date())
   ========================= */

// Example replacements:
function getTodayDE(){
  return formatDateDE(new Date());
}

// When exporting PDF, ALWAYS use formatDateDE / formatZeitraumDE
function buildInvoicePdfData(state){
  return {
    rechnungsdatum: formatDateDE(state.rechnungsdatum || new Date()),
    zeitraum: formatZeitraumDE(state.von, state.bis),
    faellig: formatDateDE(state.faellig),
  };
}

/* Call this after any date change */
renderInvoiceDates();

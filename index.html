<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Dienstplan (Monatsplan)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <!-- PWA (optional). If files exist, great. If not, app still works. -->
  <link rel="manifest" href="manifest.json"/>

  <style>
    :root{
      --bg1:#06254f;
      --bg2:#083b79;
      --card:#0b4a92;
      --card2:#0a3e7a;
      --line:rgba(255,255,255,.16);
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --muted2:rgba(255,255,255,.62);
      --accent:#39a9ff;
      --accent2:#1b7bff;
      --good:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:18px;
      --shadow: 0 12px 34px rgba(0,0,0,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background: radial-gradient(1200px 600px at 15% -10%, rgba(57,169,255,.35), transparent 60%),
                  radial-gradient(900px 500px at 85% 0%, rgba(27,123,255,.30), transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1) 60%, #041a38);
      min-height:100vh;
    }
    a{color:var(--accent)}
    .wrap{max-width:1180px; margin:22px auto 40px; padding:0 14px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background: linear-gradient(180deg, rgba(11,74,146,.75), rgba(6,37,79,.55));
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:50;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px;}
    .logoBox{
      width:44px; height:44px; border-radius:12px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .logoBox img{width:100%; height:100%; object-fit:cover}
    .brand h1{margin:0; font-size:16px; letter-spacing:.6px; text-transform:uppercase}
    .meta{font-size:12px; color:var(--muted); line-height:1.25}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .tabBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      user-select:none;
    }
    .tabBtn.active{background: rgba(57,169,255,.22); border-color: rgba(57,169,255,.55)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.10);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      user-select:none;
      transition:.12s transform ease, .12s background ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14)}
    .btn.primary{background: rgba(57,169,255,.28); border-color: rgba(57,169,255,.55)}
    .btn.good{background: rgba(33,209,159,.20); border-color: rgba(33,209,159,.55)}
    .btn.bad{background: rgba(255,77,109,.18); border-color: rgba(255,77,109,.55)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .brand{min-width:auto} }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(11,74,146,.70), rgba(6,37,79,.45));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead h2{margin:0; font-size:14px}
    .cardBody{padding:14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media(max-width:700px){ .row{grid-template-columns:1fr} }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
      font-weight:650;
    }
    .field input, .field textarea, .field select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.09);
      color:var(--text);
      outline:none;
    }
    .field input::placeholder, .field textarea::placeholder{color: rgba(255,255,255,.55)}
    .field textarea{min-height:110px; resize:vertical}
    .hint{font-size:12px; color:var(--muted2); margin-top:8px; line-height:1.35}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      font-weight:700;
      min-width:44px;
      text-align:center;
    }
    .chip.active{
      background: rgba(57,169,255,.25);
      border-color: rgba(57,169,255,.6);
    }
    .tableWrap{overflow:auto; border-top:1px solid var(--line)}
    table{width:100%; border-collapse:collapse; min-width:820px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); font-size:12px}
    th{color:var(--muted); text-align:left; font-weight:800; background: rgba(255,255,255,.06)}
    td{color:var(--text)}
    .tdSmall{color:var(--muted); font-weight:650}
    .right{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.08); border:1px solid var(--line);
      color:var(--text); font-weight:750;
    }
    .hide{display:none !important}

    /* PRINT / PDF */
    @media print{
      body{background:#fff !important; color:#111 !important}
      .topbar, .noPrint{display:none !important}
      .wrap{max-width:none; margin:0; padding:0}
      .printPage{
        display:block !important;
        padding:22mm 16mm;
        font-family: Arial, sans-serif;
      }
      .printCard{
        border:1px solid #cfd7e3;
        border-radius:10px;
        padding:14px;
      }
      .printHeader{
        display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
        border-bottom:3px solid #1b7bff;
        padding-bottom:10px; margin-bottom:12px;
      }
      .printBrand{ display:flex; gap:10px; align-items:center; }
      .printLogo{
        width:42px; height:42px; border-radius:10px;
        border:1px solid #cfd7e3; overflow:hidden;
      }
      .printLogo img{width:100%; height:100%; object-fit:cover}
      .printTitle{ font-size:18px; font-weight:800; color:#0b3a78; margin:0; }
      .printMeta{font-size:11px; color:#444; line-height:1.25}
      .printDate{font-size:11px; color:#333; text-align:right}
      .printH2{
        text-align:center; margin:12px 0 10px;
        color:#0b3a78; font-size:16px; font-weight:900;
      }
      .printTable{
        width:100%; border-collapse:collapse; margin-top:6px; font-size:11px;
      }
      .printTable th{
        background:#eaf2ff; color:#0b3a78; border:1px solid #cfd7e3;
        padding:7px; font-weight:800;
      }
      .printTable td{ border:1px solid #cfd7e3; padding:7px; color:#111; }
      .notice{ margin-top:12px; text-align:center; font-size:11px; }
      .notice b{color:#c81f2c}
      .footerLine{
        margin-top:18px; font-size:10px; color:#666;
        display:flex; justify-content:space-between;
      }
    }
  </style>

  <!-- PDF generator (WhatsApp share on mobile) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logoBox"><img id="logoImg" alt="Logo"/></div>
      <div>
        <h1>MASCULINE SECURITY — Dienstplan</h1>
        <div class="meta" id="companyLine"></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabPlan">Monatsplan</button>
      <button class="tabBtn" id="tabDocs">Dokumentation</button>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnPDF">PDF</button>
      <button class="btn" id="btnPrint">Drucken</button>
      <button class="btn good" id="btnWhatsAppPDF">WhatsApp (PDF)</button>
      <button class="btn" id="btnExportCSV">Export CSV</button>
      <button class="btn bad" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- PLAN -->
  <section id="pagePlan" class="grid">
    <div class="card">
      <div class="cardHead">
        <h2>Monatlicher Mitarbeiter-Dienstplan</h2>
        <div class="right">
          <span class="pill" id="pillShift">Schicht: —</span>
          <span class="pill" id="pillTime">Uhrzeit: —</span>
          <span class="pill" id="pillNote">Notiz: —</span>
        </div>
      </div>

      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label>Firmenname</label>
            <input id="companyName" placeholder="Masculine Security"/>
          </div>
          <div class="field">
            <label>Logo (optional)</label>
            <input id="logoFile" type="file" accept="image/*"/>
            <div class="hint">Logo wird gespeichert & im PDF angezeigt.</div>
          </div>

          <div class="field">
            <label>Adresse</label>
            <input id="companyAddr" placeholder="Werschenregerstraße 6, 28237 Bremen"/>
          </div>
          <div class="field">
            <label>Telefon</label>
            <input id="companyPhone" placeholder="015778697052"/>
          </div>

          <div class="field">
            <label>E-Mail</label>
            <input id="companyEmail" placeholder="Kontakt.mass.bremen@hotmail.com"/>
          </div>
          <div class="field">
            <label>Datum (für PDF)</label>
            <input id="docDate" placeholder="16.02.2026 (oder 2026-02-16)"/>
            <div class="hint">Format: TT.MM.JJJJ</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <div class="field">
            <label>Mitarbeiter-Nr. (optional)</label>
            <input id="empNo" placeholder="z.B. MS-001"/>
          </div>
          <div class="field">
            <label>Mitarbeiter Name</label>
            <input id="empName" placeholder="z.B. Mustafa Mursal Abdi"/>
          </div>

          <div class="field">
            <label>Monat (auswählen)</label>
            <input id="monthPick" type="month"/>
            <div class="hint">Bisha dooro. Hoos ka dooro maalmaha (01–31).</div>
          </div>

          <div class="field">
            <label>Monatstage (klicken)</label>
            <div class="chips" id="dayChips"></div>
            <div class="hint">Maalmo badan dooro (tusaale: 01, 02, 05...).</div>
          </div>

          <div class="field">
            <label>Objekt / Einsatz</label>
            <input id="objekt" placeholder="z.B. Hotel / Baustelle / Asylheim"/>
            <div class="hint">Schicht (Tag/Nacht), Uhrzeit & Notiz waa automatic.</div>
          </div>

          <div class="field">
            <label>Schicht (Tag/Nacht) — automatisch</label>
            <select id="shift">
              <option value="auto">Automatisch</option>
              <option value="Tag">Tag</option>
              <option value="Nacht">Nacht</option>
            </select>
            <div class="hint">Auto: Objekt keywords + Uhrzeit.</div>
          </div>

          <div class="field">
            <label>Uhrzeit — automatisch</label>
            <input id="time" placeholder="z.B. 19:00–07:00"/>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Notiz — automatisch</label>
            <input id="note" placeholder="(wird automatisch ausgefüllt)"/>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="right">
          <button class="btn good" id="btnSaveEntry">+ Eintrag speichern</button>
        </div>

        <div class="hint" id="statusPlan">Bereit.</div>
        <div class="hint">
          <b>WhatsApp (PDF):</b> Mobile (Android/iPhone) → PDF file waa la share-gareyn karaa toos (WhatsApp wuxuu ka soo muuqan karaa).  
          Desktop (Edge/PC) → browser ma diri karo file toos WhatsApp; wuxuu sameeyaa PDF download + text, kadib adiga waxaad ku attach-gareysaa WhatsApp.
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Mitarbeiter</th>
              <th>Nr.</th>
              <th>Monat</th>
              <th>Tage</th>
              <th>Schicht</th>
              <th>Uhrzeit</th>
              <th>Objekt</th>
              <th>Notiz</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2>Vorschau (WhatsApp-Text)</h2>
        <div class="right">
          <button class="btn" id="btnCopyText">Text kopieren</button>
          <button class="btn good" id="btnWhatsAppText">WhatsApp (Text)</button>
        </div>
      </div>
      <div class="cardBody">
        <div class="field">
          <label>Vorschau</label>
          <textarea id="msgPreview" readonly></textarea>
        </div>
        <div class="hint">
          ✅ Desktop: WhatsApp-Web opens with text.  
          ✅ Mobile: WhatsApp (PDF) tries to share the PDF file with WhatsApp (if browser supports file sharing).
        </div>
      </div>
    </div>
  </section>

  <!-- DOCUMENTATION -->
  <section id="pageDocs" class="grid hide">
    <div class="card">
      <div class="cardHead">
        <h2>Dokumentation</h2>
        <div class="right">
          <button class="btn" id="btnDocsSave">Speichern</button>
          <button class="btn primary" id="btnDocsPDF">PDF (Dokumentation)</button>
        </div>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label>Notizen / Ereignisse</label>
            <textarea id="docsText" placeholder="z.B. Vorfälle, Übergabe, besondere Hinweise…"></textarea>
          </div>
          <div class="field">
            <label>Datum</label>
            <input id="docsDate" placeholder="16.02.2026"/>
            <div class="hint">Kani waa Dokumentation PDF gaar ah.</div>
          </div>
        </div>
        <div class="hint" id="statusDocs">Bereit.</div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2>Checkliste (Beispiel)</h2>
      </div>
      <div class="cardBody">
        <div class="hint">
          ✅ 20 Minuten vorher da sein • ✅ Ausfälle sofort melden • ✅ Stundenzettel rechtzeitig abgeben
        </div>
      </div>
    </div>
  </section>

  <!-- PRINT PAGE (hidden on screen) -->
  <div class="printPage hide" id="printPage">
    <div class="printCard">
      <div class="printHeader">
        <div class="printBrand">
          <div class="printLogo"><img id="printLogo" alt="Logo"/></div>
          <div>
            <p class="printTitle" id="pCompany">Masculine Security</p>
            <div class="printMeta" id="pMeta"></div>
          </div>
        </div>
        <div class="printDate" id="pDate"></div>
      </div>

      <div class="printH2">Vorläufiger Dienstplan (Monatsplan)</div>

      <table class="printTable">
        <thead>
          <tr>
            <th>DATUM</th>
            <th>UHRZEIT</th>
            <th>OBJEKT</th>
            <th>NOTIZ</th>
          </tr>
        </thead>
        <tbody id="pTbody"></tbody>
      </table>

      <div class="notice">
        <b>DRINGEND BEACHTEN:</b><br/>
        Dienstantritt ist 20 Minuten vor Dienstbeginn!<br/>
        Verspätungen und Ausfälle unverzüglich telefonisch melden!<br/>
        Stundenzettel spätestens 2 Tage vor Monatsende einreichen.
      </div>

      <div class="footerLine">
        <div id="pFooterLeft"></div>
        <div>Seite 1 von 1</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   SERVICE WORKER (optional)
========================= */
(function(){
  // If you deleted service-worker.js, this will fail silently (OK).
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./service-worker.js");
        reg.update().catch(()=>{});
      } catch(e) {}
    });
  }
})();

/* =========================
   STORAGE + DEFAULTS
========================= */
const LS_KEY  = "ms-dienstplan-monthly-v1";
const LS_DOCS = "ms-dienstplan-docs-v1";

const SHIFT_TIMES = {
  Tag:   "07:00–19:00",
  Nacht: "19:00–07:00"
};

function pad2(n){ return String(n).padStart(2,"0"); }
function formatDateDE(d){
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
}
function parseDateInput(v){
  v = (v||"").trim();
  if(!v) return null;
  if(/^\d{2}\.\d{2}\.\d{4}$/.test(v)) return v;
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
    const [y,m,dd] = v.split("-").map(Number);
    return formatDateDE(new Date(y, m-1, dd));
  }
  return null;
}
function getDocDate(){
  return parseDateInput(docDate.value) || formatDateDE(new Date());
}
function sanitize(s){ return String(s ?? "").trim(); }

let entries = [];

/* =========================
   MONTHLY DAYS (only monthly)
========================= */
let selectedDays = new Set();
let selectedMonth = ""; // "YYYY-MM"

function initMonthDefault(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  selectedMonth = `${y}-${m}`;
}
function daysInMonth(ym){
  const [y,m] = ym.split("-").map(Number);
  return new Date(y, m, 0).getDate();
}
function two(n){ return String(n).padStart(2,"0"); }

function ensureSomeDaySelected(maxDay){
  if(selectedDays.size === 0) selectedDays.add(1);
  for(const d of [...selectedDays]){
    if(d > maxDay) selectedDays.delete(d);
  }
  if(selectedDays.size === 0) selectedDays.add(maxDay);
}

function daysLabel(){
  const ym = monthPick.value || selectedMonth || "";
  const maxDay = ym ? daysInMonth(ym) : 31;
  ensureSomeDaySelected(maxDay);
  return [...selectedDays].sort((a,b)=>a-b).map(two).join(", ");
}
function datesLabelFull(){
  const ym = monthPick.value || selectedMonth || "";
  if(!ym) return "";
  const [y,m] = ym.split("-").map(Number);
  const maxDay = daysInMonth(ym);
  ensureSomeDaySelected(maxDay);
  const arr = [...selectedDays].sort((a,b)=>a-b);
  return arr.map(d => `${two(d)}.${two(m)}.${y}`).join(", ");
}

function renderDayChips(){
  const ym = monthPick.value || selectedMonth || "";
  if(!ym){
    dayChips.innerHTML = "";
    return;
  }
  const maxDay = daysInMonth(ym);
  ensureSomeDaySelected(maxDay);

  dayChips.innerHTML = "";
  for(let d=1; d<=maxDay; d++){
    const el = document.createElement("div");
    el.className = "chip" + (selectedDays.has(d) ? " active" : "");
    el.textContent = two(d);
    el.title = `Tag ${two(d)}`;
    el.addEventListener("click", () => {
      if(selectedDays.has(d)) selectedDays.delete(d);
      else selectedDays.add(d);
      ensureSomeDaySelected(maxDay);
      renderDayChips();
      buildMessagePreview();
      autosaveSoon();
    });
    dayChips.appendChild(el);
  }
}

/* =========================
   AUTO: SHIFT / TIME / NOTE
========================= */
function timeLooksNight(t){
  const m = String(t||"").match(/(\d{1,2}):(\d{2}).*?(\d{1,2}):(\d{2})/);
  if(!m) return null;
  const sH = Number(m[1]), sM = Number(m[2]);
  const eH = Number(m[3]), eM = Number(m[4]);
  const s = sH*60+sM;
  const e = eH*60+eM;
  if(e < s) return true;
  if(s >= 18*60) return true;
  if(e <= 8*60) return true;
  return false;
}

function inferShiftFromObject(obj){
  const o = (obj||"").toLowerCase();
  // keyword-based: you can add more
  if(/\b(nacht|night|nachtschicht)\b/.test(o)) return "Nacht";
  if(/\b(tag|tagschicht)\b/.test(o)) return "Tag";
  // hotel/heim often night; keep it conservative:
  if(/\b(asyl|heim)\b/.test(o)) return "Nacht";
  return null;
}

function inferShiftAuto(){
  // If time already indicates night, use it.
  const t = sanitize(time.value);
  const tn = timeLooksNight(t);
  if(tn === true) return "Nacht";
  if(tn === false) return "Tag";

  const byObj = inferShiftFromObject(objekt.value);
  if(byObj) return byObj;

  return "Tag";
}

function inferTimeForShift(sh){
  return SHIFT_TIMES[sh] || "";
}

function inferNoteAuto(obj){
  const o = (obj||"").toLowerCase();

  // simple rules (edit as you like)
  if(/\b(hotel)\b/.test(o)) return "Rundgang / Schlüssel";
  if(/\b(baustelle)\b/.test(o)) return "Kontrollgänge / Meldung an Bauleiter";
  if(/\b(asyl|heim)\b/.test(o)) return "Kontrollgänge / Dokumentation";
  if(/\b(last|birkenfels)\b/.test(o)) return "Rundgang / Schlüssel";
  // default
  return "Rundgang / Schlüssel";
}

function applyAutoFields(){
  // shift
  let sh = shift.value;
  if(sh === "auto") sh = inferShiftAuto();

  // time
  const desiredTime = inferTimeForShift(sh);
  if(!sanitize(time.value) || time.value === SHIFT_TIMES.Tag || time.value === SHIFT_TIMES.Nacht){
    time.value = desiredTime;
  } else {
    // if user typed custom time, still update shift pills
    // (do not overwrite)
  }

  // note
  if(!sanitize(note.value) || note.dataset.auto === "1"){
    note.value = inferNoteAuto(objekt.value);
    note.dataset.auto = "1";
  }

  // pills
  pillShift.textContent = `Schicht: ${sh}`;
  pillTime.textContent  = `Uhrzeit: ${sanitize(time.value) || desiredTime || "—"}`;
  pillNote.textContent  = `Notiz: ${sanitize(note.value) || "—"}`;

  autosaveSoon();
  buildMessagePreview();
}

/* =========================
   COMPANY LINE + LOGO
========================= */
function updateCompanyLine(){
  const name  = sanitize(companyName.value) || "Masculine Security";
  const addr  = sanitize(companyAddr.value) || "Werschenregerstraße 6, 28237 Bremen";
  const phone = sanitize(companyPhone.value) || "015778697052";
  const email = sanitize(companyEmail.value) || "Kontakt.mass.bremen@hotmail.com";
  companyLine.textContent = `${addr}  •  Tel: ${phone}  •  E-Mail: ${email}`;
  document.title = `${name} — Dienstplan (Monatsplan)`;
}

async function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result||""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

logoFile.addEventListener("change", async () => {
  const f = logoFile.files && logoFile.files[0];
  if(!f) return;
  try{
    const url = await fileToDataURL(f);
    logoImg.src = url;
    statusPlan.textContent = "Logo gespeichert.";
    saveState();
  }catch(e){
    statusPlan.textContent = "Logo konnte nicht geladen werden.";
  }
});

/* =========================
   SAVE / LOAD
========================= */
let autosaveTimer = null;
function autosaveSoon(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    saveState();
  }, 350);
}

function saveState(){
  const state = {
    meta: {
      companyName: companyName.value,
      companyAddr: companyAddr.value,
      companyPhone: companyPhone.value,
      companyEmail: companyEmail.value,
      docDate: docDate.value,
      monthPick: monthPick.value,
      logoDataUrl: logoImg.src || ""
    },
    monthly: {
      selectedDays: [...selectedDays]
    },
    fields: {
      empNo: empNo.value,
      empName: empName.value,
      objekt: objekt.value,
      shift: shift.value,
      time: time.value,
      note: note.value,
      noteAuto: note.dataset.auto || "0"
    },
    entries
  };
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  updateCompanyLine();
  statusPlan.textContent = "Auto-Save: AN";
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const st = JSON.parse(raw);

    if(st?.meta){
      companyName.value  = st.meta.companyName ?? companyName.value;
      companyAddr.value  = st.meta.companyAddr ?? companyAddr.value;
      companyPhone.value = st.meta.companyPhone ?? companyPhone.value;
      companyEmail.value = st.meta.companyEmail ?? companyEmail.value;
      docDate.value      = st.meta.docDate ?? docDate.value;
      monthPick.value    = st.meta.monthPick ?? monthPick.value;
      if(st.meta.logoDataUrl) logoImg.src = st.meta.logoDataUrl;
    }

    if(st?.monthly?.selectedDays && Array.isArray(st.monthly.selectedDays)){
      selectedDays = new Set(st.monthly.selectedDays.filter(n => Number.isFinite(n)));
    }

    if(st?.fields){
      empNo.value   = st.fields.empNo ?? "";
      empName.value = st.fields.empName ?? "";
      objekt.value  = st.fields.objekt ?? "";
      shift.value   = st.fields.shift ?? "auto";
      time.value    = st.fields.time ?? "";
      note.value    = st.fields.note ?? "";
      note.dataset.auto = st.fields.noteAuto ?? "0";
    }

    if(Array.isArray(st?.entries)) entries = st.entries;

  }catch(e){}
}

function resetAll(){
  if(!confirm("Reset? Alle gespeicherten Daten werden gelöscht.")) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_DOCS);
  selectedDays = new Set();
  entries = [];
  location.reload();
}

/* =========================
   TABLE RENDER
========================= */
function renderTable(){
  tbody.innerHTML = "";
  if(!entries.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="10" class="tdSmall">Noch keine Einträge.</td>`;
    tbody.appendChild(tr);
    return;
  }

  entries.forEach((e, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="tdSmall">${idx+1}</td>
      <td>${escapeHTML(e.empName)}</td>
      <td class="tdSmall">${escapeHTML(e.empNo||"")}</td>
      <td class="tdSmall">${escapeHTML(e.month||"")}</td>
      <td>${escapeHTML(e.days||"")}</td>
      <td>${escapeHTML(e.shift||"")}</td>
      <td>${escapeHTML(e.time||"")}</td>
      <td>${escapeHTML(e.objekt||"")}</td>
      <td>${escapeHTML(e.note||"")}</td>
      <td>
        <button class="btn bad" data-del="${idx}">Löschen</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = Number(btn.getAttribute("data-del"));
      entries.splice(i,1);
      saveState();
      renderTable();
      buildMessagePreview();
    });
  });
}

function escapeHTML(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   WHATSAPP TEXT PREVIEW
========================= */
function buildMessagePreview(){
  const name  = sanitize(companyName.value) || "Masculine Security";
  const addr  = sanitize(companyAddr.value) || "Werschenregerstraße 6, 28237 Bremen";
  const phone = sanitize(companyPhone.value) || "015778697052";
  const email = sanitize(companyEmail.value) || "Kontakt.mass.bremen@hotmail.com";

  const emp = sanitize(empName.value) || "Mitarbeiter";
  const no  = sanitize(empNo.value) || "";
  const obj = sanitize(objekt.value) || "";
  const sh  = (shift.value === "auto") ? inferShiftAuto() : shift.value;
  const tm  = sanitize(time.value) || inferTimeForShift(sh) || "";
  const nt  = sanitize(note.value) || inferNoteAuto(obj);

  const month = monthPick.value || selectedMonth || "";
  const dates = datesLabelFull();

  let text = `${name} — Dienstplan (Monatsplan)\n`;
  text += `${addr}\nTel: ${phone}\nE-Mail: ${email}\n`;
  text += `Datum: ${getDocDate()}\n\n`;

  text += `Mitarbeiter: ${emp}${no ? " ("+no+")" : ""}\n`;
  if(month) text += `Monat: ${month}\n`;
  if(dates) text += `Datum(e): ${dates}\n`;
  if(obj) text += `Objekt: ${obj}\n`;
  text += `Schicht: ${sh}\nUhrzeit: ${tm}\nNotiz: ${nt}\n\n`;

  if(entries.length){
    text += `Gespeicherte Einträge:\n`;
    entries.forEach((e, i) => {
      text += `${i+1}) ${e.empName}${e.empNo? " ("+e.empNo+")":""} | ${e.month||""} | ${e.dates||e.days||""} | ${e.shift} | ${e.time} | ${e.objekt} | ${e.note}\n`;
    });
  }

  msgPreview.value = text;
}

/* =========================
   SAVE ENTRY
========================= */
btnSaveEntry.addEventListener("click", () => {
  const emp = sanitize(empName.value);
  if(!emp){
    alert("Bitte Mitarbeiter Name eingeben.");
    return;
  }
  const month = monthPick.value || selectedMonth || "";
  if(!month){
    alert("Bitte Monat auswählen.");
    return;
  }

  const sh = (shift.value === "auto") ? inferShiftAuto() : shift.value;
  const tm = sanitize(time.value) || inferTimeForShift(sh);
  const obj = sanitize(objekt.value);
  const nt = sanitize(note.value) || inferNoteAuto(obj);

  const days = daysLabel();
  const dates = datesLabelFull();

  const entry = {
    empName: emp,
    empNo: sanitize(empNo.value),
    month,
    days,
    dates,
    shift: sh,
    time: tm,
    objekt: obj,
    note: nt
  };

  entries.push(entry);
  saveState();
  renderTable();
  buildMessagePreview();
  statusPlan.textContent = "Eintrag gespeichert.";
});

/* =========================
   CSV EXPORT
========================= */
btnExportCSV.addEventListener("click", () => {
  const headers = ["Mitarbeiter","Nr","Monat","Tage","Datum(e)","Schicht","Uhrzeit","Objekt","Notiz"];
  const rows = entries.map(e => [
    e.empName, e.empNo||"", e.month||"", e.days||"", e.dates||"", e.shift||"", e.time||"", e.objekt||"", e.note||""
  ]);

  const csv = [headers, ...rows]
    .map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(";"))
    .join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Dienstplan_${getDocDate().replaceAll(".","-")}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
});

/* =========================
   PRINT / PDF (browser)
========================= */
function buildPrintFromEntries(){
  // Use entries if exist; else build from current form selection
  const use = entries.length ? entries : [{
    empName: sanitize(empName.value) || "Mitarbeiter",
    empNo: sanitize(empNo.value) || "",
    month: monthPick.value || selectedMonth || "",
    days: daysLabel(),
    dates: datesLabelFull(),
    shift: (shift.value === "auto") ? inferShiftAuto() : shift.value,
    time: sanitize(time.value) || inferTimeForShift((shift.value==="auto")?inferShiftAuto():shift.value),
    objekt: sanitize(objekt.value) || "",
    note: sanitize(note.value) || inferNoteAuto(objekt.value)
  }];

  // logo in print
  printLogo.src = logoImg.src || "";
  pCompany.textContent = sanitize(companyName.value) || "Masculine Security";
  pMeta.textContent = `${sanitize(companyAddr.value)||"Werschenregerstraße 6, 28237 Bremen"} • Tel: ${sanitize(companyPhone.value)||"015778697052"} • ${sanitize(companyEmail.value)||"Kontakt.mass.bremen@hotmail.com"}`;
  pDate.textContent = `Datum: ${getDocDate()}`;
  pFooterLeft.textContent = `${sanitize(companyName.value)||"Masculine Security"} — Dienstplan`;

  // table rows
  pTbody.innerHTML = "";
  use.forEach(e => {
    // Make one row per selected date (more "official") for PDF look
    const dateList = (e.dates||"").split(",").map(x=>x.trim()).filter(Boolean);
    if(dateList.length){
      dateList.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHTML(d)}</td>
          <td>${escapeHTML(e.time||"")}</td>
          <td>${escapeHTML(e.objekt||"")}</td>
          <td>${escapeHTML(e.note||"")}</td>
        `;
        pTbody.appendChild(tr);
      });
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(e.month||"")}</td>
        <td>${escapeHTML(e.time||"")}</td>
        <td>${escapeHTML(e.objekt||"")}</td>
        <td>${escapeHTML(e.note||"")}</td>
      `;
      pTbody.appendChild(tr);
    }
  });
}

btnPrint.addEventListener("click", () => {
  buildPrintFromEntries();
  // show print page just for print
  printPage.classList.remove("hide");
  setTimeout(() => {
    window.print();
    setTimeout(() => printPage.classList.add("hide"), 400);
  }, 60);
});

btnPDF.addEventListener("click", () => {
  // PDF via browser "Print to PDF"
  buildPrintFromEntries();
  printPage.classList.remove("hide");
  setTimeout(() => {
    window.print();
    setTimeout(() => printPage.classList.add("hide"), 400);
  }, 60);
});

/* =========================
   WhatsApp (Text)
========================= */
function openWhatsAppText(text){
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank", "noopener,noreferrer");
}

btnWhatsAppText.addEventListener("click", () => {
  buildMessagePreview();
  openWhatsAppText(msgPreview.value);
});

btnCopyText.addEventListener("click", async () => {
  try{
    await navigator.clipboard.writeText(msgPreview.value);
    alert("Text kopiert ✅");
  }catch(e){
    // fallback
    msgPreview.focus();
    msgPreview.select();
    document.execCommand("copy");
    alert("Text kopiert ✅");
  }
});

/* =========================
   WhatsApp (PDF) — best effort
   - Mobile: tries navigator.share({files:[pdf]})
   - Desktop: downloads pdf + opens WhatsApp Web with text (attach manually)
========================= */
async function buildPDFBlob(){
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF) throw new Error("jsPDF not loaded");

  // Use entries if exist; else form
  const use = entries.length ? entries : [{
    empName: sanitize(empName.value) || "Mitarbeiter",
    empNo: sanitize(empNo.value) || "",
    month: monthPick.value || selectedMonth || "",
    days: daysLabel(),
    dates: datesLabelFull(),
    shift: (shift.value === "auto") ? inferShiftAuto() : shift.value,
    time: sanitize(time.value) || inferTimeForShift((shift.value==="auto")?inferShiftAuto():shift.value),
    objekt: sanitize(objekt.value) || "",
    note: sanitize(note.value) || inferNoteAuto(objekt.value)
  }];

  const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
  const name  = sanitize(companyName.value) || "Masculine Security";
  const addr  = sanitize(companyAddr.value) || "Werschenregerstraße 6, 28237 Bremen";
  const phone = sanitize(companyPhone.value) || "015778697052";
  const email = sanitize(companyEmail.value) || "Kontakt.mass.bremen@hotmail.com";
  const dateStr = getDocDate();

  // Header
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text(`${name}`, 70, 50);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`${addr}`, 70, 68);
  doc.text(`Tel: ${phone}`, 70, 82);
  doc.text(`E-Mail: ${email}`, 70, 96);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Datum: ${dateStr}`, 740, 50, {align:"right"});

  // Logo (if present)
  try{
    if(logoImg.src && logoImg.src.startsWith("data:image")){
      doc.addImage(logoImg.src, "PNG", 20, 35, 38, 38, undefined, "FAST");
    }
  }catch(e){}

  doc.setDrawColor(27,123,255);
  doc.setLineWidth(2);
  doc.line(20, 112, 820, 112);

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Vorläufiger Dienstplan (Monatsplan)", 420, 140, {align:"center"});

  // Rows: one row per date (clean)
  const rows = [];
  use.forEach(e => {
    const list = (e.dates||"").split(",").map(x=>x.trim()).filter(Boolean);
    if(list.length){
      list.forEach(d => rows.push([d, e.time||"", e.objekt||"", e.note||""]));
    }else{
      rows.push([e.month||"", e.time||"", e.objekt||"", e.note||""]);
    }
  });

  doc.autoTable({
    startY: 160,
    head: [["DATUM", "UHRZEIT", "OBJEKT", "NOTIZ"]],
    body: rows,
    theme: "grid",
    styles: {font:"helvetica", fontSize:10, cellPadding:6},
    headStyles: {fillColor:[234,242,255], textColor:[11,58,120]},
    columnStyles: {
      0:{cellWidth:120},
      1:{cellWidth:120},
      2:{cellWidth:240},
      3:{cellWidth:260}
    },
    margin: {left:20, right:20}
  });

  const endY = doc.lastAutoTable.finalY || 420;

  doc.setFont("helvetica","bold");
  doc.setFontSize(10);
  doc.setTextColor(200,31,44);
  doc.text("DRINGEND BEACHTEN:", 420, endY + 24, {align:"center"});

  doc.setFont("helvetica","normal");
  doc.setTextColor(17,17,17);
  doc.setFontSize(10);
  doc.text("Dienstantritt ist 20 Minuten vor Dienstbeginn • Ausfälle sofort melden • Stundenzettel rechtzeitig abgeben",
           420, endY + 40, {align:"center"});

  const blob = doc.output("blob");
  return blob;
}

async function sharePDFOnMobile(blob, filename){
  // navigator.share with files (works on many mobile browsers; desktop often not)
  const file = new File([blob], filename, {type:"application/pdf"});
  if(navigator.canShare && navigator.canShare({files:[file]}) && navigator.share){
    await navigator.share({
      title: "Dienstplan PDF",
      text: "Dienstplan als PDF",
      files: [file]
    });
    return true;
  }
  return false;
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

btnWhatsAppPDF.addEventListener("click", async () => {
  try{
    buildMessagePreview();
    statusPlan.textContent = "PDF wird erstellt…";
    const blob = await buildPDFBlob();
    const filename = `Dienstplan_${getDocDate().replaceAll(".","-")}.pdf`;

    // Try mobile share first (this is the only realistic "direct send" method from browser)
    const shared = await sharePDFOnMobile(blob, filename);

    if(shared){
      statusPlan.textContent = "WhatsApp Share geöffnet ✅";
      return;
    }

    // Desktop fallback: download + open WhatsApp text
    downloadBlob(blob, filename);
    openWhatsAppText(msgPreview.value);
    statusPlan.textContent = "PDF heruntergeladen. WhatsApp Text geöffnet. Datei bitte im Chat anhängen.";

  }catch(e){
    console.error(e);
    alert("PDF/WhatsApp konnte nicht gestartet werden. Bitte prüfe Internet/Browser und versuche erneut.");
    statusPlan.textContent = "Fehler.";
  }
});

/* =========================
   DOCS (Dokumentation)
========================= */
function saveDocs(){
  const st = { text: docsText.value, date: docsDate.value };
  localStorage.setItem(LS_DOCS, JSON.stringify(st));
  statusDocs.textContent = "Dokumentation gespeichert.";
}
function loadDocs(){
  try{
    const raw = localStorage.getItem(LS_DOCS);
    if(!raw) return;
    const st = JSON.parse(raw);
    docsText.value = st.text ?? "";
    docsDate.value = st.date ?? "";
  }catch(e){}
}
btnDocsSave.addEventListener("click", () => saveDocs());

btnDocsPDF.addEventListener("click", async () => {
  try{
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF) throw new Error("jsPDF not loaded");

    const doc = new jsPDF({orientation:"portrait", unit:"pt", format:"a4"});
    const name  = sanitize(companyName.value) || "Masculine Security";
    const addr  = sanitize(companyAddr.value) || "Werschenregerstraße 6, 28237 Bremen";
    const phone = sanitize(companyPhone.value) || "015778697052";
    const email = sanitize(companyEmail.value) || "Kontakt.mass.bremen@hotmail.com";
    const dStr  = parseDateInput(docsDate.value) || getDocDate();

    doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(`${name} — Dokumentation`, 40, 50);

    doc.setFont("helvetica","normal"); doc.setFontSize(10);
    doc.text(`${addr}`, 40, 70);
    doc.text(`Tel: ${phone} • E-Mail: ${email}`, 40, 85);
    doc.text(`Datum: ${dStr}`, 40, 100);

    doc.setDrawColor(27,123,255); doc.setLineWidth(2);
    doc.line(40, 112, 555, 112);

    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    const text = sanitize(docsText.value) || "—";
    const lines = doc.splitTextToSize(text, 515);
    doc.text(lines, 40, 140);

    doc.save(`Dokumentation_${dStr.replaceAll(".","-")}.pdf`);
    statusDocs.textContent = "Dokumentation PDF erstellt.";
  }catch(e){
    console.error(e);
    alert("Dokumentation PDF Fehler.");
  }
});

/* =========================
   TABS
========================= */
function setTab(which){
  const plan = (which === "plan");
  tabPlan.classList.toggle("active", plan);
  tabDocs.classList.toggle("active", !plan);
  pagePlan.classList.toggle("hide", !plan);
  pageDocs.classList.toggle("hide", plan);
}
tabPlan.addEventListener("click", () => setTab("plan"));
tabDocs.addEventListener("click", () => setTab("docs"));

/* =========================
   EVENTS (auto)
========================= */
["input","change"].forEach(ev => {
  companyName.addEventListener(ev, () => { updateCompanyLine(); autosaveSoon(); buildMessagePreview(); });
  companyAddr.addEventListener(ev, () => { updateCompanyLine(); autosaveSoon(); buildMessagePreview(); });
  companyPhone.addEventListener(ev, () => { updateCompanyLine(); autosaveSoon(); buildMessagePreview(); });
  companyEmail.addEventListener(ev, () => { updateCompanyLine(); autosaveSoon(); buildMessagePreview(); });
  docDate.addEventListener(ev, () => { autosaveSoon(); buildMessagePreview(); });
  empNo.addEventListener(ev, () => { autosaveSoon(); buildMessagePreview(); });
  empName.addEventListener(ev, () => { autosaveSoon(); buildMessagePreview(); });

  objekt.addEventListener(ev, () => { applyAutoFields(); });
  shift.addEventListener(ev, () => { applyAutoFields(); });
  time.addEventListener(ev, () => { note.dataset.auto = note.dataset.auto || "0"; applyAutoFields(); });
  note.addEventListener(ev, () => { note.dataset.auto = "0"; autosaveSoon(); buildMessagePreview(); });

  monthPick.addEventListener(ev, () => {
    selectedMonth = monthPick.value || selectedMonth;
    renderDayChips();
    autosaveSoon();
    buildMessagePreview();
  });
});

btnReset.addEventListener("click", resetAll);

/* =========================
   INIT
========================= */
(function init(){
  initMonthDefault();

  // defaults (your choice)
  companyName.value  = companyName.value  || "Masculine Security";
  companyAddr.value  = companyAddr.value  || "Werschenregerstraße 6, 28237 Bremen";
  companyPhone.value = companyPhone.value || "015778697052";
  companyEmail.value = companyEmail.value || "Kontakt.mass.bremen@hotmail.com";
  if(!docDate.value) docDate.value = "16.02.2026"; // your choice

  monthPick.value = selectedMonth;

  loadState();
  loadDocs();

  // ensure month value exists after load
  if(monthPick.value) selectedMonth = monthPick.value;
  else monthPick.value = selectedMonth;

  // ensure selectedDays
  if(selectedDays.size === 0) selectedDays.add(1);

  updateCompanyLine();
  renderDayChips();
  applyAutoFields();
  renderTable();
  buildMessagePreview();
})();

</script>
</body>
</html>

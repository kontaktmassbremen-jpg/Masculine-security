<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
      user-select:none;
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .foot b{color:var(--text)}
    .warn{color:#ffb3c0; font-weight:900}

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px}

    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.06)
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
      line-height:1.35;
    }
    .note.bad{border-color: rgba(255,77,109,.55); background: rgba(255,77,109,.08)}
    .note.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.08)}

    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
    }

    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }

    /* PRINT */
    @media print{
      body{background:#fff !important; color:#000 !important}
      .app, .sidebar, .topbar, .statusbar, .toast{display:none !important}
      #printArea{display:block !important}
      a{color:#000 !important; text-decoration:underline !important}
    }
    #printArea{display:none}
    .printDoc{font-family: Arial, sans-serif; padding:18px; color:#000;}
    .printHead{display:flex; justify-content:space-between; gap:18px; align-items:flex-start; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:10px;}
    .printTitle{font-size:18px; font-weight:800; margin:0}
    .printMeta{font-size:12px; color:#111; text-align:right; line-height:1.35}
    .printBox{border:1px solid #ddd; padding:10px; margin:10px 0; font-size:12px; line-height:1.4}
    .printGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .printTable{width:100%; border-collapse:collapse; margin-top:10px}
    .printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:12px}
    .printTable th{background:#fafafa}
    .printRight{text-align:right}
    .printSmall{font-size:11px; color:#333}
  </style>
</head>

<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Mini Office ‚Ä¢ Offline ‚Ä¢ Auto-Save</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll / SV</span><span class="pill" id="pillPayroll">PDF</span></button>
      <button data-page="docs"><span>üìÑ Bescheinigungen</span><span class="pill">PDF</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Offline:</b> Daten bleiben im Browser.</div>
      <div class="muted">Wenn Update nicht sichtbar: Link mit <b>?v=999</b> √∂ffnen oder Incognito.</div>
      <div class="muted"><span class="warn">Hinweis:</span> Rechnungen: ¬ß19 UStG ‚Üí USt = 0.</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Tage √ó Std/Tag ‚Üí Stunden ‚Ä¢ Stunden √ó ‚Ç¨/h ‚Üí Netto</small>
      </div>
      <div class="actions" id="topActions">
        <button class="btn primary" id="btnNewInvoice">+ Neue Rechnung</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Alles l√∂schen</button>
      </div>
    </div>

    <div class="content">

      <!-- INVOICES -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen / bearbeiten</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>F√§llig am</label><input id="i_due" type="date"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Arbeitszeit Auto-Rechner</h3>
            <div class="split">
              <div class="field"><label>Tage (inta bari)</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag (saacado maalintii)</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h (qiime saacaddii)</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 22"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>

            <div class="note" id="w_note">Geli Tage + Std/Tag + ‚Ç¨/h ‚Üí Position 1 auto: Menge = Stunden, Preis = ‚Ç¨/h, Netto = Stunden √ó ‚Ç¨/h.</div>
            <div class="note bad hide" id="w_warn"></div>

            <div class="hr"></div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <h3 style="margin:0">Positionen</h3>
              <button class="btn" id="btnAddLine">+ Position</button>
            </div>

            <table class="table" style="margin-top:10px">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto (auto)</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
            </div>

            <div class="note" id="i_preview">Positionen: 0 ‚Ä¢ Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSaveInvoice">Speichern</button>
              <button class="btn" id="btnPrintInvoice">PDF Rechnung (A4)</button>
            </div>

            <input id="i_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Rechnungen Liste</h3>

            <div class="split">
              <div class="field"><label>Suche</label><input id="inv_search" placeholder="Nr / Kunde / Status"/></div>
              <div class="field"><label>Status Filter</label>
                <select id="inv_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Status</th>
                  <th class="right">Total</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde anlegen</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..."/></div>
            <div class="hr"></div>

            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCustomerSave">Speichern</button>
              <button class="btn danger" id="btnCustomerClear">Leeren</button>
            </div>
            <div class="note good">Tipp: E-Mail & Tel werden in PDF **clickable** (mailto/tel).</div>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter anlegen</h3>
            <div class="field"><label>Suche</label><input id="e_search" placeholder="Name / Pers-Nr / Steuer-ID"/></div>
            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Name</label><input id="e_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Personal-Nr. (optional)</label><input id="e_pnr" placeholder="z.B. 4943"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="e_taxid" placeholder="11-stellig (optional)"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="e_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Familienstand</label>
                <select id="e_family">
                  <option value="single">single</option>
                  <option value="married">married</option>
                </select>
              </div>
              <div class="field"><label>Kinder (Anzahl)</label><input id="e_kids" type="number" step="1" min="0" placeholder="0"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Krankenkasse (AOK/Barmer/...)</label><input id="e_kk" placeholder="z.B. AOK"/></div>
              <div class="field"><label>KK-Nr. (optional)</label><input id="e_kkno" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>SV-Nr. (optional)</label><input id="e_svno" placeholder="optional"/></div>
              <div class="field"><label>Stundenlohn ‚Ç¨/h (Default)</label><input id="e_rate" type="number" step="0.01" placeholder="z.B. 14.60"/></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnEmployeeSave">Speichern</button>
              <button class="btn danger" id="btnEmployeeClear">Leeren</button>
            </div>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Klasse</th><th>Krankenkasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Payroll / SV (PDF)</h3>

            <div class="field"><label>Mitarbeiter</label>
              <select id="p_employee"></select>
            </div>

            <div class="split">
              <div class="field"><label>Monat (YYYY-MM)</label><input id="p_month" type="month"/></div>
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.01" placeholder="z.B. 216"/></div>
            </div>

            <div class="split">
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="auto aus Mitarbeiter"/></div>
              <div class="field"><label>Brutto (auto)</label><input id="p_brutto" readonly/></div>
            </div>

            <div class="note" id="p_note">SV & Lohnsteuer hier sind **vereinfachte Sch√§tzung** (nicht amtlich). F√ºr echte Lohnabrechnung: Steuerberater/Payroll-Software.</div>

            <div class="split">
              <div class="field"><label>SV Arbeitnehmer % (Default)</label><input id="p_sv_pct" type="number" step="0.1"/></div>
              <div class="field"><label>Lohnsteuer % (Default)</label><input id="p_tax_pct" type="number" step="0.1"/></div>
            </div>

            <div class="split">
              <div class="field"><label>SV Arbeitnehmer (auto)</label><input id="p_sv_an" readonly/></div>
              <div class="field"><label>Lohnsteuer (auto)</label><input id="p_tax" readonly/></div>
            </div>

            <div class="split">
              <div class="field"><label>Netto (auto)</label><input id="p_netto" readonly/></div>
              <div class="field"><label>SV Arbeitgeber (auto)</label><input id="p_sv_ag" readonly/></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnPayrollSave">Speichern</button>
              <button class="btn" id="btnPrintPayroll">PDF Lohnabrechnung</button>
            </div>
          </div>

          <div class="card">
            <h3>Payroll Liste</h3>
            <table class="table">
              <thead><tr><th>Monat</th><th>Mitarbeiter</th><th class="right">Netto</th><th class="right">Aktion</th></tr></thead>
              <tbody id="payrollList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DOCS -->
      <section id="page-docs" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Bescheinigungen (PDF)</h3>
            <div class="note">Diese Dokumente sind **Muster/Entwurf** (f√ºr deine Unterlagen). F√ºr amtliche Bescheinigungen nutze offizielle Tools/Steuerberater.</div>

            <div class="field"><label>Mitarbeiter</label>
              <select id="d_employee"></select>
            </div>

            <div class="split">
              <div class="field"><label>Zeitraum von</label><input id="d_from" type="date"/></div>
              <div class="field"><label>Zeitraum bis</label><input id="d_to" type="date"/></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="btnPrintArbeits">PDF Arbeitbescheinigung</button>
              <button class="btn" id="btnPrintSteuer">PDF Lohnsteuerbescheinigung</button>
            </div>
          </div>

          <div class="card">
            <h3>Info</h3>
            <div class="note">
              <b>Clickables:</b> Email/Tel/Web sind im PDF anklickbar.<br/>
              <b>Keine Unterschrift:</b> Unterschrift-Felder wurden entfernt (wie du wolltest).<br/>
              <b>Datum:</b> Wird automatisch gesetzt.
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma Einstellungen</h3>
            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>

            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>

            <div class="split">
              <div class="field"><label>Website (optional)</label><input id="s_web" placeholder="https://..."/></div>
              <div class="field"><label>Steuernummer / Steuer-ID (Firma)</label><input id="s_taxid" placeholder="z.B. 12/345/67890"/></div>
            </div>

            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
            </div>

            <div class="field"><label>¬ß19 Hinweis</label><input id="s_hint"/></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSettingsSave">Speichern</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
            <div class="note good">Tipp: GitHub Pages cache ‚Üí √∂ffne mit <b>?v=999</b>.</div>
          </div>
        </div>
      </section>

    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>
<div id="printArea"></div>

<script>
/* ============================================================
   FIX: unregister service worker + clear caches (GitHub Pages)
============================================================ */
(async () => {
  try{
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

/* =========================
   Utils
========================= */
const $ = (id)=>document.getElementById(id);
const DB_KEY = "ms_mini_office_v10_allinone";

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2200);
  }
};

function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function fmtEUR(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function todayISO(){
  const d=new Date();
  const p=(x)=>String(x).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
}
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* Clickable helpers (UI + PDF) */
function clickableEmail(email){
  const e = String(email||"").trim();
  if(!e) return "";
  return `<a href="mailto:${encodeURIComponent(e)}" style="color:inherit;text-decoration:underline">${esc(e)}</a>`;
}
function clickableTel(tel){
  const t = String(tel||"").trim();
  if(!t) return "";
  const clean = t.replace(/[^\d+]/g,"");
  return `<a href="tel:${clean}" style="color:inherit;text-decoration:underline">${esc(t)}</a>`;
}
function clickableUrl(url){
  let u = String(url||"").trim();
  if(!u) return "";
  if(!/^https?:\/\//i.test(u)) u = "https://" + u;
  return `<a href="${esc(u)}" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline">${esc(url)}</a>`;
}

/* =========================
   Storage Driver (FIX speichern)
========================= */
function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

/* =========================
   Store
========================= */
const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"+4915778697052",
          web:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          taxid:"",
          hint:"Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet."
        },
        customers:[],
        invoices:[],
        employees:[],
        payroll:[]
      };
      this.save(true);
    } else {
      // ensure new fields
      this.data.settings ||= {};
      for(const k of ["company","addr","email","phone","web","iban","bic","taxid","hint"]){
        if(this.data.settings[k] === undefined) this.data.settings[k] = "";
      }
      this.data.customers ||= [];
      this.data.invoices ||= [];
      this.data.employees ||= [];
      this.data.payroll ||= [];
      this.save(true);
    }
    UI.updateStorageStatus();
  },
  save(silent=false){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("Gespeichert ‚úÖ");
      UI.updateStorageStatus(true);
      return true;
    }catch(e){
      UI.updateStorageStatus(false, e);
      Toast.show("Speichern fehlgeschlagen ‚ùå");
      return false;
    }
  },
  wipe(){
    StorageDriver.removeItem(DB_KEY);
    this.data=null;
    this.load();
    Toast.show("Alles gel√∂scht ‚úÖ");
  }
};

/* =========================
   UI / Navigation
========================= */
const UI = {
  page:"invoices",
  go(page){
    this.page = page;
    // show/hide sections
    for(const id of ["invoices","customers","employees","payroll","docs","settings"]){
      $("page-"+id).classList.toggle("hide", id!==page);
    }
    // nav active
    [...document.querySelectorAll("#nav button")].forEach(b=>b.classList.toggle("active", b.dataset.page===page));

    const titles = {
      invoices:["Rechnung","Tage √ó Std/Tag ‚Üí Stunden ‚Ä¢ Stunden √ó ‚Ç¨/h ‚Üí Netto"],
      customers:["Kunden","Speichern + Auswahl in Rechnung"],
      employees:["Mitarbeiter","Krankenkasse / Steuerklasse / Kinder"],
      payroll:["Payroll / SV","PDF Lohnabrechnung (Muster)"],
      docs:["Bescheinigungen","Arbeitbescheinigung + Lohnsteuerbescheinigung (Muster)"],
      settings:["Firma","Kontakt + Bank + Steuer"]
    };
    $("pageTitle").textContent = titles[page]?.[0] || "Mini Office";
    $("pageSub").textContent = titles[page]?.[1] || "";
    UI.refreshAll();
  },
  updateStorageStatus(ok=true, err=null){
    $("storeTag").textContent = "Storage: " + StorageDriver.type;
    $("pillStore").textContent = StorageDriver.type;
    $("storageNote").textContent = "Storage: " + StorageDriver.type + (ok ? " ‚úÖ" : " ‚ùå");
    $("dot").classList.toggle("off", !ok);
    $("statusText").textContent = ok ? "Bereit" : ("Storage Fehler: " + (err?.message||""));
  },
  refreshAll(){
    Customers.render();
    Invoices.renderLists();
    Employees.render();
    Payroll.render();
    Docs.render();
    Pills.update();
  }
};

const Pills = {
  update(){
    $("pillCustomers").textContent = Store.data.customers.length;
    $("pillInvoices").textContent = Store.data.invoices.length;
    $("pillEmployees").textContent = Store.data.employees.length;
  }
};

/* =========================
   Customers
========================= */
const Customers = {
  clearForm(){
    $("c_name").value="";
    $("c_email").value="";
    $("c_phone").value="";
    $("c_addr").value="";
  },
  save(){
    const c = {
      id: uid(),
      name: $("c_name").value.trim(),
      email: $("c_email").value.trim(),
      phone: $("c_phone").value.trim(),
      addr: $("c_addr").value.trim()
    };
    if(!c.name){ Toast.show("Name fehlt"); return; }
    Store.data.customers.push(c);
    Store.save();
    this.clearForm();
    UI.refreshAll();
  },
  remove(id){
    Store.data.customers = Store.data.customers.filter(x=>x.id!==id);
    Store.save();
    UI.refreshAll();
  },
  render(){
    // list
    const q = ($("c_search").value||"").toLowerCase();
    const rows = Store.data.customers
      .filter(c=>!q || (c.name+" "+c.email+" "+c.addr).toLowerCase().includes(q))
      .map(c=>`
        <tr>
          <td>${esc(c.name)}</td>
          <td>${esc(c.email)}</td>
          <td>${esc(c.addr).replace(/\n/g,"<br/>")}</td>
          <td class="right">
            <button class="btn danger" onclick="Customers.remove('${c.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("");
    $("customersList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Kunden</td></tr>`;

    // invoice customer dropdown
    const opts = [`<option value="">Bitte Kunde w√§hlen</option>`]
      .concat(Store.data.customers.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`));
    $("i_customer").innerHTML = opts.join("");
    if($("i_edit_id").value){
      const inv = Invoices.getEditing();
      if(inv) $("i_customer").value = inv.customerId || "";
    }

    // docs/payroll dropdowns
    const eopts = [`<option value="">Bitte Mitarbeiter w√§hlen</option>`]
      .concat(Store.data.employees.map(e=>`<option value="${e.id}">${esc(e.name)}</option>`));
    $("p_employee").innerHTML = eopts.join("");
    $("d_employee").innerHTML = eopts.join("");
  }
};

/* =========================
   Invoice Lines
========================= */
function lineRow(line, idx){
  const net = round2(num(line.qty)*num(line.price));
  return `
    <tr>
      <td><input value="${esc(line.desc)}" oninput="Invoices.updateLine(${idx},'desc',this.value)" placeholder="z.B. Sicherheitsdienstleistung"/></td>
      <td class="right"><input type="number" step="0.01" value="${esc(line.qty)}" oninput="Invoices.updateLine(${idx},'qty',this.value)"/></td>
      <td class="right"><input type="number" step="0.01" value="${esc(line.price)}" oninput="Invoices.updateLine(${idx},'price',this.value)"/></td>
      <td class="right"><b>${fmtEUR(net)}</b></td>
      <td class="right">
        <button class="btn" onclick="Invoices.dupLine(${idx})">Duplizieren</button>
        <button class="btn danger" onclick="Invoices.delLine(${idx})">L√∂schen</button>
      </td>
    </tr>
  `;
}

/* =========================
   Invoices
========================= */
const Invoices = {
  editing:null,
  new(){
    const no = this.nextNo();
    this.editing = {
      id: uid(),
      no,
      date: todayISO(),
      von:"",
      bis:"",
      due:"",
      status:"Entwurf",
      customerId:"",
      lines:[
        { desc:"Sicherheitsdienstleistung (Arbeitszeit)", qty:0, price:0 }
      ],
      auto:{
        days:"",
        hpd:"",
        rate:""
      }
    };
    this.loadToForm(this.editing);
    Toast.show("Neue Rechnung");
  },
  nextNo(){
    // MS-YYYY-0001
    const y = new Date().getFullYear();
    const used = Store.data.invoices
      .filter(i=>String(i.no||"").includes(y))
      .map(i=>i.no);
    let n = 1;
    while(true){
      const cand = `MS-${y}-${String(n).padStart(4,"0")}`;
      if(!used.includes(cand)) return cand;
      n++;
    }
  },
  getEditing(){
    const id = $("i_edit_id").value;
    if(!id) return null;
    return Store.data.invoices.find(x=>x.id===id) || this.editing;
  },
  loadToForm(inv){
    $("i_edit_id").value = inv.id;
    $("i_no").value = inv.no || "";
    $("i_date").value = inv.date || todayISO();
    $("i_von").value = inv.von || "";
    $("i_bis").value = inv.bis || "";
    $("i_due").value = inv.due || "";
    $("i_status").value = inv.status || "Entwurf";
    $("i_customer").value = inv.customerId || "";

    $("w_days").value = inv.auto?.days ?? "";
    $("w_hpd").value = inv.auto?.hpd ?? "";
    $("w_rate").value = inv.auto?.rate ?? "";

    this.renderLines(inv);
    this.recalc(inv, true);
  },
  readFromForm(){
    const inv = this.getEditing() || this.editing;
    if(!inv) return null;

    inv.no = $("i_no").value.trim();
    inv.date = $("i_date").value || todayISO();
    inv.von = $("i_von").value || "";
    inv.bis = $("i_bis").value || "";
    inv.due = $("i_due").value || "";
    inv.status = $("i_status").value || "Entwurf";
    inv.customerId = $("i_customer").value || "";

    inv.auto = inv.auto || {};
    inv.auto.days = $("w_days").value;
    inv.auto.hpd = $("w_hpd").value;
    inv.auto.rate = $("w_rate").value;

    return inv;
  },
  addLine(){
    const inv = this.readFromForm();
    if(!inv) return;
    inv.lines.push({desc:"", qty:0, price:0});
    this.renderLines(inv);
    this.recalc(inv,true);
  },
  delLine(idx){
    const inv = this.readFromForm();
    if(!inv) return;
    inv.lines.splice(idx,1);
    if(inv.lines.length===0) inv.lines.push({desc:"", qty:0, price:0});
    this.renderLines(inv);
    this.recalc(inv,true);
  },
  dupLine(idx){
    const inv = this.readFromForm();
    if(!inv) return;
    const L = inv.lines[idx];
    inv.lines.splice(idx+1,0,{...L});
    this.renderLines(inv);
    this.recalc(inv,true);
  },
  updateLine(idx, key, val){
    const inv = this.readFromForm();
    if(!inv) return;
    inv.lines[idx][key] = val;
    this.recalc(inv,true);
  },
  renderLines(inv){
    $("linesBody").innerHTML = inv.lines.map((l,i)=>lineRow(l,i)).join("");
  },
  applyAutoWorkToLine1(inv){
    const days = num(inv.auto?.days);
    const hpd  = num(inv.auto?.hpd);
    const rate = num(inv.auto?.rate);

    const warnEl = $("w_warn");
    warnEl.classList.add("hide");
    warnEl.textContent = "";

    // Validation: Std/Tag should be realistic
    if(hpd > 24){
      warnEl.textContent = `Warnung: Std/Tag ist ${hpd}. Meistens ist es z.B. 8 oder 12. (216 geh√∂rt bei dir zu Total Stunden, nicht Std/Tag)`;
      warnEl.classList.remove("hide");
    }

    const hours = round2(days * hpd);
    $("w_total_hours").value = hours ? String(hours.toFixed(2)) : "";

    if(days>0 && hpd>0 && rate>0){
      // Set line1 automatically
      if(!inv.lines || inv.lines.length===0) inv.lines=[{desc:"Sicherheitsdienstleistung (Arbeitszeit)", qty:0, price:0}];
      inv.lines[0].desc = inv.lines[0].desc || "Sicherheitsdienstleistung (Arbeitszeit)";
      inv.lines[0].qty = hours;
      inv.lines[0].price = rate;
    }
  },
  recalc(inv, silent=false){
    // apply auto calc
    this.applyAutoWorkToLine1(inv);

    const sumNet = round2((inv.lines||[]).reduce((a,l)=>a + (num(l.qty)*num(l.price)), 0));
    $("sum_net").value = fmtEUR(sumNet);
    $("sum_total").value = fmtEUR(sumNet); // ¬ß19 UStG -> no VAT
    $("i_preview").textContent = `Positionen: ${(inv.lines||[]).length} ‚Ä¢ Gesamt: ${fmtEUR(sumNet)} ‚Ä¢ USt: ${fmtEUR(0)}`;

    if(!silent){
      // no toast here
    }
  },
  save(){
    const inv = this.readFromForm();
    if(!inv) return;

    if(!inv.no){ Toast.show("Rechnungs-Nr fehlt"); return; }
    if(!inv.date){ inv.date = todayISO(); }

    // ensure auto calc latest
    this.recalc(inv, true);

    const exists = Store.data.invoices.findIndex(x=>x.id===inv.id);
    if(exists>=0) Store.data.invoices[exists] = inv;
    else Store.data.invoices.unshift(inv);

    Store.save();
    UI.refreshAll();
  },
  edit(id){
    const inv = Store.data.invoices.find(x=>x.id===id);
    if(!inv) return;
    this.loadToForm(inv);
    UI.go("invoices");
  },
  remove(id){
    Store.data.invoices = Store.data.invoices.filter(x=>x.id!==id);
    Store.save();
    UI.refreshAll();
  },
  renderLists(){
    // search/filter
    const q = ($("inv_search").value||"").toLowerCase();
    const f = $("inv_filter").value || "";
    const custName = (cid)=> (Store.data.customers.find(c=>c.id===cid)?.name || "");

    const items = Store.data.invoices
      .filter(i=>{
        const text = (i.no+" "+custName(i.customerId)+" "+i.status).toLowerCase();
        return (!q || text.includes(q)) && (!f || i.status===f);
      });

    const rows = items.map(i=>{
      const total = round2((i.lines||[]).reduce((a,l)=>a + num(l.qty)*num(l.price), 0));
      return `
        <tr>
          <td>${esc(i.no)}</td>
          <td>${esc(custName(i.customerId))}</td>
          <td>${esc(i.status)}</td>
          <td class="right"><b>${fmtEUR(total)}</b></td>
          <td class="right">
            <button class="btn" onclick="Invoices.edit('${i.id}')">√ñffnen</button>
            <button class="btn danger" onclick="Invoices.remove('${i.id}')">L√∂schen</button>
          </td>
        </tr>
      `;
    }).join("");
    $("invoicesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Rechnungen</td></tr>`;
  },
  print(){
    const inv = this.readFromForm();
    if(!inv){ Toast.show("Keine Rechnung"); return; }
    this.recalc(inv,true);

    const s = Store.data.settings;
    const cust = Store.data.customers.find(c=>c.id===inv.customerId) || {name:"",email:"",addr:"",phone:""};
    const total = round2((inv.lines||[]).reduce((a,l)=>a + num(l.qty)*num(l.price), 0));

    const linesHtml = (inv.lines||[]).map((l,idx)=>{
      const net = round2(num(l.qty)*num(l.price));
      return `
        <tr>
          <td>${idx+1}</td>
          <td>${esc(l.desc||"")}</td>
          <td class="printRight">${num(l.qty).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
          <td class="printRight">${fmtEUR(num(l.price))}</td>
          <td class="printRight"><b>${fmtEUR(net)}</b></td>
        </tr>
      `;
    }).join("");

    const companyBlock = `
      <b>${esc(s.company)}</b><br/>
      ${esc(s.addr).replace(/\n/g,"<br/>")}<br/>
      E-Mail: ${clickableEmail(s.email)}<br/>
      Tel: ${clickableTel(s.phone)}<br/>
      ${s.web ? `Web: ${clickableUrl(s.web)}<br/>` : ``}
      ${s.taxid ? `<span class="printSmall">Steuernr/ID: ${esc(s.taxid)}</span><br/>` : ``}
    `;

    const custBlock = `
      <b>${esc(cust.name||"")}</b><br/>
      ${esc(cust.addr||"").replace(/\n/g,"<br/>")}<br/>
      ${cust.email ? `E-Mail: ${clickableEmail(cust.email)}<br/>` : ``}
      ${cust.phone ? `Tel: ${clickableTel(cust.phone)}<br/>` : ``}
    `;

    const period = (inv.von && inv.bis) ? `${inv.von} ‚Ä¶ ${inv.bis}` : "";

    $("printArea").innerHTML = `
      <div class="printDoc">
        <div class="printHead">
          <div>
            <h1 class="printTitle">Rechnung</h1>
            <div class="printSmall">${companyBlock}</div>
          </div>
          <div class="printMeta">
            Rechnungs-Nr: <b>${esc(inv.no)}</b><br/>
            Rechnungsdatum: <b>${esc(inv.date)}</b><br/>
            ${period ? `Zeitraum: <b>${esc(period)}</b><br/>` : ``}
            ${inv.due ? `F√§llig: <b>${esc(inv.due)}</b><br/>` : ``}
            Status: <b>${esc(inv.status)}</b>
          </div>
        </div>

        <div class="printBox">
          <b>Rechnung an:</b><br/>
          ${custBlock}
        </div>

        <table class="printTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Leistung</th>
              <th class="printRight">Menge</th>
              <th class="printRight">Preis</th>
              <th class="printRight">Netto</th>
            </tr>
          </thead>
          <tbody>${linesHtml}</tbody>
        </table>

        <div class="printGrid" style="margin-top:10px">
          <div class="printBox">
            <b>Zahlung:</b> Bitte √ºberweisen Sie den Betrag auf folgendes Konto:<br/>
            IBAN: <b>${esc(s.iban)}</b> ‚Ä¢ BIC: <b>${esc(s.bic)}</b>
          </div>
          <div class="printBox">
            <div class="printRight">Summe Netto: <b>${fmtEUR(total)}</b></div>
            <div class="printRight">Umsatzsteuer: <b>${fmtEUR(0)}</b></div>
            <div class="printRight">Zu zahlen: <b>${fmtEUR(total)}</b></div>
          </div>
        </div>

        <div class="printBox printSmall">
          Hinweis: ${esc(s.hint || "Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.")}
        </div>
      </div>
    `;
    window.print();
  }
};

/* =========================
   Employees
========================= */
const Employees = {
  clearForm(){
    for(const id of ["e_name","e_pnr","e_taxid","e_kids","e_kk","e_kkno","e_svno","e_rate"]){ $(id).value=""; }
    $("e_taxclass").value="I";
    $("e_family").value="single";
  },
  save(){
    const e = {
      id: uid(),
      name: $("e_name").value.trim(),
      pnr: $("e_pnr").value.trim(),
      taxid: $("e_taxid").value.trim(),
      taxclass: $("e_taxclass").value,
      family: $("e_family").value,
      kids: num($("e_kids").value),
      kk: $("e_kk").value.trim(),
      kkno: $("e_kkno").value.trim(),
      svno: $("e_svno").value.trim(),
      rate: num($("e_rate").value)
    };
    if(!e.name){ Toast.show("Name fehlt"); return; }
    Store.data.employees.push(e);
    Store.save();
    this.clearForm();
    UI.refreshAll();
  },
  remove(id){
    Store.data.employees = Store.data.employees.filter(x=>x.id!==id);
    Store.data.payroll = Store.data.payroll.filter(p=>p.employeeId!==id);
    Store.save();
    UI.refreshAll();
  },
  render(){
    const q = ($("e_search").value||"").toLowerCase();
    const rows = Store.data.employees
      .filter(e=>!q || (e.name+" "+e.pnr+" "+e.taxid+" "+e.kk).toLowerCase().includes(q))
      .map(e=>`
        <tr>
          <td>${esc(e.name)}</td>
          <td>${esc(e.taxclass||"")}</td>
          <td>${esc(e.kk||"")}</td>
          <td class="right">
            <button class="btn danger" onclick="Employees.remove('${e.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("");
    $("employeesList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Mitarbeiter</td></tr>`;

    // refresh dropdowns (handled in Customers.render)
    Customers.render();
  }
};

/* =========================
   Payroll
========================= */
const Payroll = {
  currentId:null,
  defaultsForEmployee(e){
    // simple defaults (not official)
    // adjust by family/kids lightly
    let svPct = 20.0;
    let taxPct = 10.0;
    const kids = num(e.kids);
    if(kids>0) taxPct = Math.max(6.0, taxPct - Math.min(4.0, kids*1.0));
    if(e.taxclass==="V" || e.taxclass==="VI") taxPct += 4.0;
    if(e.taxclass==="III") taxPct -= 2.0;
    return {svPct, taxPct};
  },
  recalc(){
    const e = Store.data.employees.find(x=>x.id===$("p_employee").value);
    const hours = num($("p_hours").value);
    const rate = num($("p_rate").value || (e?.rate||0));
    if(e && !$("p_rate").value) $("p_rate").value = String(e.rate||0);

    const brutto = round2(hours * rate);
    $("p_brutto").value = fmtEUR(brutto);

    const svPct = num($("p_sv_pct").value);
    const taxPct = num($("p_tax_pct").value);

    const svAn = round2(brutto * (svPct/100));
    const tax  = round2(brutto * (taxPct/100));
    const netto = round2(brutto - svAn - tax);
    const svAg = round2(brutto * (svPct/100)); // simple mirror

    $("p_sv_an").value = fmtEUR(svAn);
    $("p_tax").value = fmtEUR(tax);
    $("p_netto").value = fmtEUR(netto);
    $("p_sv_ag").value = fmtEUR(svAg);
  },
  loadDefaults(){
    const e = Store.data.employees.find(x=>x.id===$("p_employee").value);
    if(!e) return;
    const d = this.defaultsForEmployee(e);
    $("p_sv_pct").value = String(d.svPct);
    $("p_tax_pct").value = String(d.taxPct);
    if(!$("p_rate").value) $("p_rate").value = String(e.rate||0);
    this.recalc();
  },
  save(){
    const eId = $("p_employee").value;
    if(!eId){ Toast.show("Mitarbeiter w√§hlen"); return; }
    const month = $("p_month").value;
    if(!month){ Toast.show("Monat w√§hlen"); return; }

    const hours = num($("p_hours").value);
    const rate = num($("p_rate").value);
    if(hours<=0 || rate<=0){ Toast.show("Stunden & ‚Ç¨/h eingeben"); return; }

    this.recalc();
    const brutto = round2(hours * rate);
    const svPct = num($("p_sv_pct").value);
    const taxPct = num($("p_tax_pct").value);
    const svAn = round2(brutto * (svPct/100));
    const tax  = round2(brutto * (taxPct/100));
    const netto = round2(brutto - svAn - tax);
    const svAg = round2(brutto * (svPct/100));

    const p = {
      id: this.currentId || uid(),
      employeeId: eId,
      month,
      hours, rate,
      svPct, taxPct,
      brutto, svAn, tax, netto, svAg,
      createdAt: new Date().toISOString()
    };

    const ix = Store.data.payroll.findIndex(x=>x.id===p.id);
    if(ix>=0) Store.data.payroll[ix]=p;
    else Store.data.payroll.unshift(p);

    this.currentId = p.id;
    Store.save();
    UI.refreshAll();
  },
  edit(id){
    const p = Store.data.payroll.find(x=>x.id===id);
    if(!p) return;
    this.currentId = p.id;
    $("p_employee").value = p.employeeId;
    $("p_month").value = p.month;
    $("p_hours").value = p.hours;
    $("p_rate").value = p.rate;
    $("p_sv_pct").value = p.svPct;
    $("p_tax_pct").value = p.taxPct;
    this.recalc();
    UI.go("payroll");
  },
  remove(id){
    Store.data.payroll = Store.data.payroll.filter(x=>x.id!==id);
    Store.save();
    UI.refreshAll();
  },
  render(){
    // set month default
    if(!$("p_month").value){
      const d = new Date();
      $("p_month").value = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    }

    // list
    const empName = (id)=> Store.data.employees.find(e=>e.id===id)?.name || "";
    const rows = Store.data.payroll.map(p=>`
      <tr>
        <td>${esc(p.month)}</td>
        <td>${esc(empName(p.employeeId))}</td>
        <td class="right"><b>${fmtEUR(p.netto)}</b></td>
        <td class="right">
          <button class="btn" onclick="Payroll.edit('${p.id}')">√ñffnen</button>
          <button class="btn danger" onclick="Payroll.remove('${p.id}')">L√∂schen</button>
        </td>
      </tr>
    `).join("");
    $("payrollList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Payroll</td></tr>`;

    // dropdown already updated
  },
  print(){
    // Use current form values (Muster)
    const e = Store.data.employees.find(x=>x.id===$("p_employee").value);
    if(!e){ Toast.show("Mitarbeiter w√§hlen"); return; }
    if(!$("p_month").value){ Toast.show("Monat w√§hlen"); return; }

    this.recalc();

    const s = Store.data.settings;
    const month = $("p_month").value;
    const hours = num($("p_hours").value);
    const rate = num($("p_rate").value);
    const brutto = round2(hours*rate);
    const svAn = $("p_sv_an").value;
    const tax = $("p_tax").value;
    const netto = $("p_netto").value;
    const svAg = $("p_sv_ag").value;

    const headerLeft = `
      <b>${esc(s.company)}</b><br/>
      ${esc(s.addr).replace(/\n/g,"<br/>")}<br/>
      E-Mail: ${clickableEmail(s.email)}<br/>
      Tel: ${clickableTel(s.phone)}<br/>
      ${s.web ? `Web: ${clickableUrl(s.web)}<br/>` : ``}
      ${s.taxid ? `<span class="printSmall">Steuernr/ID: ${esc(s.taxid)}</span><br/>` : ``}
    `;

    const headerRight = `
      <b>Mitarbeiter:</b> ${esc(e.name)}${e.pnr ? ` ‚Ä¢ Pers-Nr: ${esc(e.pnr)}` : ``}<br/>
      ${e.taxid ? `Steuer-ID: ${esc(e.taxid)}<br/>` : ``}
      ${e.kk ? `Krankenkasse: ${esc(e.kk)}${e.kkno?` ‚Ä¢ Nr: ${esc(e.kkno)}`:""}<br/>` : ``}
      ${e.svno ? `SV-Nr: ${esc(e.svno)}<br/>` : ``}
      Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Familienstand: ${esc(e.family||"")} ‚Ä¢ Kinder: ${esc(e.kids||0)}
    `;

    $("printArea").innerHTML = `
      <div class="printDoc">
        <div class="printHead">
          <div>
            <h1 class="printTitle">Lohn- und Gehaltsabrechnung (Muster)</h1>
            <div class="printSmall">Monat: <b>${esc(month)}</b></div>
          </div>
          <div class="printMeta">${esc(new Date().toLocaleString("de-DE"))}</div>
        </div>

        <div class="printGrid">
          <div class="printBox">${headerLeft}</div>
          <div class="printBox">${headerRight}</div>
        </div>

        <table class="printTable">
          <tbody>
            <tr><td>Stunden</td><td class="printRight">${hours.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
            <tr><td>‚Ç¨/h</td><td class="printRight">${fmtEUR(rate)}</td></tr>
            <tr><td><b>Brutto</b></td><td class="printRight"><b>${fmtEUR(brutto)}</b></td></tr>
            <tr><td>SV Arbeitnehmer (Sch√§tzung)</td><td class="printRight">${svAn}</td></tr>
            <tr><td>Lohnsteuer (Sch√§tzung)</td><td class="printRight">${tax}</td></tr>
            <tr><td><b>Netto</b></td><td class="printRight"><b>${netto}</b></td></tr>
            <tr><td>SV Arbeitgeber (Sch√§tzung)</td><td class="printRight">${svAg}</td></tr>
          </tbody>
        </table>
      </div>
    `;
    window.print();
  }
};

/* =========================
   Docs (Arbeitsbescheinigung / Lohnsteuerbescheinigung)
========================= */
const Docs = {
  render(){
    // set default dates if empty
    if(!$("d_from").value) $("d_from").value = todayISO();
    if(!$("d_to").value) $("d_to").value = todayISO();
  },
  printArbeits(){
    const e = Store.data.employees.find(x=>x.id===$("d_employee").value);
    if(!e){ Toast.show("Mitarbeiter w√§hlen"); return; }
    const s = Store.data.settings;
    const von = $("d_from").value || "";
    const bis = $("d_to").value || "";
    const now = new Date().toLocaleString("de-DE");

    $("printArea").innerHTML = `
      <div class="printDoc">
        <div class="printHead">
          <div>
            <h1 class="printTitle">Arbeitbescheinigung (Muster)</h1>
            <div class="printSmall">Zeitraum: <b>${esc(von)}${bis?` ‚Ä¶ ${esc(bis)}`:""}</b></div>
          </div>
          <div class="printMeta">${esc(now)}</div>
        </div>

        <div class="printGrid">
          <div class="printBox">
            <b>Arbeitgeber</b><br/>
            <b>${esc(s.company)}</b><br/>
            ${esc(s.addr).replace(/\n/g,"<br/>")}<br/>
            E-Mail: ${clickableEmail(s.email)}<br/>
            Tel: ${clickableTel(s.phone)}<br/>
            ${s.taxid ? `Steuernr/ID: ${esc(s.taxid)}<br/>` : ``}
          </div>
          <div class="printBox">
            <b>Arbeitnehmer</b><br/>
            <b>${esc(e.name)}</b><br/>
            ${e.pnr ? `Pers-Nr: ${esc(e.pnr)}<br/>` : ``}
            ${e.taxid ? `Steuer-ID: ${esc(e.taxid)}<br/>` : ``}
            Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Familienstand: ${esc(e.family||"")} ‚Ä¢ Kinder: ${esc(e.kids||0)}<br/>
            ${e.kk ? `Krankenkasse: ${esc(e.kk)}${e.kkno?` ‚Ä¢ Nr: ${esc(e.kkno)}`:""}<br/>` : ``}
            ${e.svno ? `SV-Nr: ${esc(e.svno)}<br/>` : ``}
          </div>
        </div>

        <div class="printBox">
          Hiermit wird best√§tigt, dass die oben genannte Person im angegebenen Zeitraum bei <b>${esc(s.company)}</b> besch√§ftigt war.<br/>
          (Dieses Dokument ist ein <b>Muster</b> f√ºr interne Zwecke.)
        </div>
      </div>
    `;
    window.print();
  },
  printSteuer(){
    const e = Store.data.employees.find(x=>x.id===$("d_employee").value);
    if(!e){ Toast.show("Mitarbeiter w√§hlen"); return; }
    const s = Store.data.settings;
    const von = $("d_from").value || "";
    const bis = $("d_to").value || "";
    const now = new Date().toLocaleString("de-DE");

    $("printArea").innerHTML = `
      <div class="printDoc">
        <div class="printHead">
          <div>
            <h1 class="printTitle">Lohnsteuerbescheinigung (Muster)</h1>
            <div class="printSmall">Zeitraum: <b>${esc(von)}${bis?` ‚Ä¶ ${esc(bis)}`:""}</b></div>
          </div>
          <div class="printMeta">${esc(now)}</div>
        </div>

        <div class="printGrid">
          <div class="printBox">
            <b>Arbeitgeber</b><br/>
            <b>${esc(s.company)}</b><br/>
            ${esc(s.addr).replace(/\n/g,"<br/>")}<br/>
            E-Mail: ${clickableEmail(s.email)}<br/>
            Tel: ${clickableTel(s.phone)}<br/>
            ${s.taxid ? `Steuernr/ID: ${esc(s.taxid)}<br/>` : ``}
          </div>
          <div class="printBox">
            <b>Arbeitnehmer</b><br/>
            <b>${esc(e.name)}</b><br/>
            ${e.pnr ? `Pers-Nr: ${esc(e.pnr)}<br/>` : ``}
            ${e.taxid ? `Steuer-ID: ${esc(e.taxid)}<br/>` : ``}
            Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Familienstand: ${esc(e.family||"")} ‚Ä¢ Kinder: ${esc(e.kids||0)}
          </div>
        </div>

        <div class="printBox">
          Hinweis: Dieses Dokument ist ein <b>Muster</b>. F√ºr amtliche Lohnsteuerbescheinigung sind die offiziellen Verfahren/Programme zu nutzen.
        </div>
      </div>
    `;
    window.print();
  }
};

/* =========================
   Settings
========================= */
const Settings = {
  loadToForm(){
    const s = Store.data.settings;
    $("s_company").value = s.company || "";
    $("s_addr").value = s.addr || "";
    $("s_email").value = s.email || "";
    $("s_phone").value = s.phone || "";
    $("s_web").value = s.web || "";
    $("s_iban").value = s.iban || "";
    $("s_bic").value = s.bic || "";
    $("s_taxid").value = s.taxid || "";
    $("s_hint").value = s.hint || "Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.";
    $("brandTitle").textContent = s.company || "Mini Office";
  },
  save(){
    const s = Store.data.settings;
    s.company = $("s_company").value.trim();
    s.addr = $("s_addr").value.trim();
    s.email = $("s_email").value.trim();
    s.phone = $("s_phone").value.trim();
    s.web = $("s_web").value.trim();
    s.iban = $("s_iban").value.trim();
    s.bic = $("s_bic").value.trim();
    s.taxid = $("s_taxid").value.trim();
    s.hint = $("s_hint").value.trim();
    Store.save();
    this.loadToForm();
    Toast.show("Firma gespeichert ‚úÖ");
  }
};

/* =========================
   Import / Export
========================= */
function exportJSON(){
  const blob = new Blob([JSON.stringify(Store.data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ms-mini-office-backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const r = new FileReader();
  r.onload = () => {
    try{
      const obj = JSON.parse(String(r.result||""));
      // basic validation
      if(!obj || typeof obj!=="object") throw new Error("Invalid");
      Store.data = {
        settings: obj.settings || Store.data.settings,
        customers: Array.isArray(obj.customers)? obj.customers : [],
        invoices: Array.isArray(obj.invoices)? obj.invoices : [],
        employees: Array.isArray(obj.employees)? obj.employees : [],
        payroll: Array.isArray(obj.payroll)? obj.payroll : []
      };
      Store.save();
      UI.refreshAll();
      Settings.loadToForm();
      Toast.show("Import ok ‚úÖ");
    }catch(e){
      Toast.show("Import fehlgeschlagen ‚ùå");
    }
  };
  r.readAsText(file);
}

/* =========================
   Event wiring
========================= */
function wire(){
  // nav
  [...document.querySelectorAll("#nav button")].forEach(b=>{
    b.addEventListener("click", ()=>UI.go(b.dataset.page));
  });

  // top actions
  $("btnNewInvoice").addEventListener("click", ()=>{Invoices.new(); UI.go("invoices");});
  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", ()=>$("fileImport").click());
  $("fileImport").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value="";
  });
  $("btnWipe").addEventListener("click", ()=>{
    if(confirm("Alles l√∂schen?")) Store.wipe();
  });

  // customers
  $("btnCustomerSave").addEventListener("click", ()=>Customers.save());
  $("btnCustomerClear").addEventListener("click", ()=>Customers.clearForm());
  $("c_search").addEventListener("input", ()=>Customers.render());

  // invoices
  $("btnAddLine").addEventListener("click", ()=>Invoices.addLine());
  $("btnSaveInvoice").addEventListener("click", ()=>Invoices.save());
  $("btnPrintInvoice").addEventListener("click", ()=>Invoices.print());

  for(const id of ["i_no","i_date","i_von","i_bis","i_due","i_status","i_customer"]){
    $(id).addEventListener("input", ()=>{
      const inv = Invoices.readFromForm();
      if(inv) Invoices.recalc(inv,true);
    });
    $(id).addEventListener("change", ()=>{
      const inv = Invoices.readFromForm();
      if(inv) Invoices.recalc(inv,true);
    });
  }
  for(const id of ["w_days","w_hpd","w_rate"]){
    $(id).addEventListener("input", ()=>{
      const inv = Invoices.readFromForm();
      if(inv) Invoices.recalc(inv,true);
    });
  }
  $("inv_search").addEventListener("input", ()=>Invoices.renderLists());
  $("inv_filter").addEventListener("change", ()=>Invoices.renderLists());

  // employees
  $("btnEmployeeSave").addEventListener("click", ()=>Employees.save());
  $("btnEmployeeClear").addEventListener("click", ()=>Employees.clearForm());
  $("e_search").addEventListener("input", ()=>Employees.render());

  // payroll
  $("p_employee").addEventListener("change", ()=>Payroll.loadDefaults());
  for(const id of ["p_month","p_hours","p_rate","p_sv_pct","p_tax_pct"]){
    $(id).addEventListener("input", ()=>Payroll.recalc());
    $(id).addEventListener("change", ()=>Payroll.recalc());
  }
  $("btnPayrollSave").addEventListener("click", ()=>Payroll.save());
  $("btnPrintPayroll").addEventListener("click", ()=>Payroll.print());

  // docs
  $("btnPrintArbeits").addEventListener("click", ()=>Docs.printArbeits());
  $("btnPrintSteuer").addEventListener("click", ()=>Docs.printSteuer());

  // settings
  $("btnSettingsSave").addEventListener("click", ()=>Settings.save());
}

/* =========================
   Init
========================= */
Store.load();
wire();
Settings.loadToForm();
Invoices.new();
UI.go("invoices");
UI.refreshAll();

// Initial payroll defaults
if(!$("p_sv_pct").value) $("p_sv_pct").value = "20";
if(!$("p_tax_pct").value) $("p_tax_pct").value = "10";
Payroll.recalc();
</script>

</body>
</html>

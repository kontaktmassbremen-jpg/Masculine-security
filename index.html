<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masculine Security ‚Äî Dienstplan</title>

  <!-- Optional: PWA -->
  <meta name="theme-color" content="#0b5aa6" />
  <link rel="manifest" href="manifest.json" />

  <!-- PDF libs (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#083a66;
      --bg2:#0b4f8c;
      --panel:#0b5aa6;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.10);
      --line:rgba(255,255,255,.18);
      --text:#ffffff;
      --muted:rgba(255,255,255,.8);
      --muted2:rgba(255,255,255,.65);
      --accent:#46b6ff;
      --good:#2bd4bd;
      --warn:#ffd166;
      --danger:#ff6b6b;

      --r:18px;
      --r2:12px;
      --shadow: 0 12px 30px rgba(0,0,0,.25);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 800px at 30% -10%, rgba(70,182,255,.35), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(43,212,189,.22), transparent 55%),
                  linear-gradient(180deg, var(--bg), #052744);
    }

    a{color:var(--text); text-decoration:none}
    .wrap{max-width:1180px; margin:18px auto; padding:0 14px 24px}

    /* Header */
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:280px}
    .logoBox{
      width:44px; height:44px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.10);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logoBox img{width:100%; height:100%; object-fit:cover}
    .brandTitle{line-height:1.1}
    .brandTitle b{display:block; font-size:16px; letter-spacing:.2px}
    .brandTitle small{display:block; color:var(--muted2); font-size:12px; margin-top:2px}

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      transition:.15s transform, .15s background;
    }
    .pill:hover{transform: translateY(-1px); background: rgba(255,255,255,.12)}
    .pill.primary{background: rgba(70,182,255,.18); border-color: rgba(70,182,255,.45)}
    .pill.good{background: rgba(43,212,189,.18); border-color: rgba(43,212,189,.45)}
    .pill.warn{background: rgba(255,209,102,.18); border-color: rgba(255,209,102,.45)}
    .pill.danger{background: rgba(255,107,107,.18); border-color: rgba(255,107,107,.45)}
    .pill:active{transform: translateY(0px) scale(.99)}
    .status{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.25);
      background: rgba(0,0,0,.12);
      max-width:340px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Tabs */
    .tabsRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px}
    .tabBtn{
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      cursor:pointer; font-weight:700; font-size:13px;
      transition:.15s background;
    }
    .tabBtn.active{background: rgba(255,255,255,.14)}
    .tabPanel{display:none}
    .tabPanel.active{display:block}

    /* Layout cards */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
      .status{max-width:unset}
    }
    .card{
      border:1px solid var(--line);
      border-radius: 22px;
      background: rgba(255,255,255,.07);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      letter-spacing:.2px;
      color:var(--text);
    }
    .hint{color:var(--muted2); font-size:12px; margin-top:4px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }

    .field{
      display:flex; flex-direction:column; gap:6px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:10px 12px;
    }
    label{font-size:12px; color:var(--muted2); font-weight:700}
    input, select, textarea{
      width:100%;
      border:0;
      outline:none;
      border-radius:12px;
      padding:10px 10px;
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
    }
    textarea{min-height:86px; resize:vertical}

    .daysWrap{display:flex; flex-wrap:wrap; gap:8px; margin-top:2px}
    .dayChip{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .dayChip.on{background: rgba(70,182,255,.22); border-color: rgba(70,182,255,.55)}
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid rgba(255,255,255,.14)}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      background: rgba(0,0,0,.18);
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.14);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:0}
    .tdSmall{color:var(--muted2); font-size:12px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      font-weight:800; font-size:12px;
    }
    .badge.tag{border-color: rgba(70,182,255,.55); background: rgba(70,182,255,.18)}
    .badge.nacht{border-color: rgba(255,209,102,.55); background: rgba(255,209,102,.18)}
    .right{text-align:right}

    /* PDF template */
    #pdfCanvas{
      position:fixed; left:-99999px; top:0;
      width: 1123px; /* ~A4 landscape at 96dpi */
      background:#ffffff;
      color:#111;
      font-family: Arial, sans-serif;
    }
    .pdfPage{
      width:1123px; height:794px; /* A4 landscape */
      padding:38px 46px;
      position:relative;
      background:#fff;
    }
    .pdfHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      border:2px solid #2a78c7;
      border-radius:14px;
      padding:14px 16px;
    }
    .pdfBrand{display:flex; gap:12px; align-items:center}
    .pdfLogo{
      width:54px; height:54px; border-radius:12px;
      border:1px solid #d7e7fb;
      overflow:hidden;
      background:#f5fbff;
      display:grid; place-items:center;
    }
    .pdfLogo img{width:100%; height:100%; object-fit:cover}
    .pdfBrandText b{display:block; font-size:22px; color:#1e5fa5}
    .pdfBrandText small{display:block; color:#444; margin-top:2px; font-size:12px; line-height:1.35}
    .pdfMeta{font-size:13px; color:#111; text-align:right}
    .pdfLine{
      margin-top:14px;
      height:4px; background: linear-gradient(90deg, #2a78c7, #6fbfff);
      border-radius:999px;
    }
    .pdfTitle{
      margin:18px 0 10px;
      text-align:center;
      font-size:22px;
      color:#1e5fa5;
      font-weight:900;
    }
    .pdfTable{
      width:100%;
      border-collapse:collapse;
      border:1px solid #cfe3fb;
      border-radius:10px;
      overflow:hidden;
      font-size:14px;
    }
    .pdfTable th{
      background:#eaf4ff;
      color:#1e5fa5;
      text-align:left;
      padding:10px;
      border-bottom:1px solid #cfe3fb;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .pdfTable td{
      padding:10px;
      border-bottom:1px solid #e6eef9;
      color:#111;
    }
    .pdfTable tr:last-child td{border-bottom:0}
    .pdfNotice{
      margin-top:16px;
      text-align:center;
      font-size:13px;
      color:#111;
    }
    .pdfNotice b{
      display:block;
      margin-bottom:6px;
      color:#c0392b;
      letter-spacing:.4px;
    }
    .pdfFooter{
      position:absolute;
      left:46px; right:46px; bottom:30px;
      display:flex; align-items:center; justify-content:space-between;
      color:#666;
      font-size:12px;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.55);
      color:#fff;
      box-shadow: var(--shadow);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:.18s opacity, .18s transform;
      max-width:min(680px, calc(100% - 24px));
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoBox" title="Logo (logo.png)">
          <img id="appLogo" alt="Logo" />
        </div>
        <div class="brandTitle">
          <b>MASCULINE SECURITY ‚Äî Dienstplan</b>
          <small id="companyLine">Adresse ¬∑ Tel ¬∑ E-Mail</small>
        </div>
      </div>

      <div class="actions">
        <span class="status" id="status">Bereit.</span>
        <button class="pill primary" id="btnTabPlan">Wochenplan</button>
        <button class="pill" id="btnTabDocs">Dokumentation</button>
        <button class="pill" id="btnPDF">PDF</button>
        <button class="pill" id="btnPrint">Drucken</button>
        <button class="pill good" id="btnWhatsAppPDF">WhatsApp (PDF)</button>
        <button class="pill danger" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="tabsRow">
      <button class="tabBtn active" data-tab="plan">Wochenplan</button>
      <button class="tabBtn" data-tab="docs">Dokumentation</button>
    </div>

    <!-- PLAN TAB -->
    <div class="tabPanel active" id="tab-plan">
      <div class="grid">
        <div class="card">
          <h2>W√∂chentlicher Mitarbeiter-Dienstplan</h2>
          <div class="hint">
            ‚úÖ Auto: <b>Schicht (Tag/Nacht)</b> + <b>Uhrzeit</b> + <b>Notiz</b> ¬∑ Datumformat: <b>dd.mm.yyyy</b> ¬∑ Alles wird gespeichert.
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Firmenname</label>
              <input id="companyName" value="Masculine Security" />
            </div>
            <div class="field">
              <label>Datum (f√ºr PDF)</label>
              <input id="pdfDate" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Adresse</label>
              <input id="companyAddress" value="Werschenregerstra√üe 6, 28237 Bremen" />
            </div>
            <div class="field">
              <label>Telefon</label>
              <input id="companyPhone" value="015778697052" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>E-Mail</label>
              <input id="companyEmail" value="Kontakt.mass.bremen@hotmail.com" />
            </div>
            <div class="field">
              <label>Logo (optional) ‚Äî empfehlung: <b>logo.png</b></label>
              <input id="logoFile" type="file" accept="image/*" />
              <div class="hint">Wenn kein Upload: App versucht automatisch <b>logo.png</b> zu laden.</div>
            </div>
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.14);margin:14px 0">

          <div class="row">
            <div class="field">
              <label>Mitarbeiter Name</label>
              <input id="empName" placeholder="z.B. Mustafa Mursal Abdi" />
            </div>
            <div class="field">
              <label>Mitarbeiter-Nr (optional)</label>
              <input id="empNo" placeholder="z.B. MS-001" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Arbeitstage (klicken)</label>
              <div class="daysWrap" id="daysWrap"></div>
              <div class="hint">Mehrere Tage m√∂glich (z.B. Mo, Di, Mi, Do).</div>
            </div>

            <div class="field">
              <label>Objekt / Einsatz</label>
              <input id="objekt" placeholder="z.B. Hotel / Baustelle / LAST Birkenfels" />
              <div class="hint">üîé Auto-Notiz + Auto-Schicht kann aus Objekt erkannt werden (z.B. ‚ÄúHotel‚Äù, ‚ÄúAsyl‚Äù, ‚ÄúNacht‚Äù, ‚ÄúRundgang‚Äù).</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Schicht (Tag/Nacht) ‚Äî automatisch</label>
              <input id="shift" readonly />
            </div>
            <div class="field">
              <label>Uhrzeit ‚Äî automatisch</label>
              <input id="time" readonly />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Notiz (automatisch)</label>
              <input id="note" readonly />
              <div class="hint">Auto-Notiz kann angepasst werden √ºber ‚ÄúDokumentation‚Äù (Regeln).</div>
            </div>
            <div class="field">
              <label>Bereit</label>
              <div class="miniRow">
                <label class="badge" style="margin:0">
                  <input type="checkbox" id="ready" style="width:18px;height:18px; margin:0 6px 0 0" />
                  Bereit
                </label>
                <span class="tdSmall">Wird im Plan gespeichert.</span>
              </div>
            </div>
          </div>

          <div class="btnRow">
            <button class="pill good" id="btnAdd">+ Eintrag speichern</button>
            <button class="pill" id="btnExportCSV">Export CSV</button>
            <button class="pill warn" id="btnCopyText">Text kopieren</button>
          </div>
        </div>

        <div class="card">
          <h2>Vorschau (Text an Mitarbeiter senden)</h2>
          <div class="hint">Text wird automatisch aus gespeicherten Eintr√§gen gebaut. Kann direkt in WhatsApp eingef√ºgt werden.</div>
          <div class="field" style="margin-top:12px">
            <label>Text</label>
            <textarea id="previewText" readonly></textarea>
          </div>

          <div class="btnRow">
            <button class="pill primary" id="btnOpenWhatsAppText">WhatsApp (Text)</button>
            <button class="pill" id="btnWhatsAppPDF2">WhatsApp (PDF)</button>
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.14);margin:14px 0">

          <h2>Gespeicherte Wochenpl√§ne</h2>
          <div class="hint">Diese Liste wird im PDF angezeigt.</div>

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Mitarbeiter</th>
                  <th>Nr.</th>
                  <th>Tage</th>
                  <th>Objekt</th>
                  <th>Schicht</th>
                  <th>Uhrzeit</th>
                  <th>Notiz</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="planBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- DOCS TAB -->
    <div class="tabPanel" id="tab-docs">
      <div class="grid">
        <div class="card">
          <h2>Dokumentation (Regeln & Vorlagen)</h2>
          <div class="hint">
            Hier kannst du Auto-Notiz Regeln definieren (z.B. ‚ÄúHotel‚Äù ‚Üí ‚ÄúRundgang / Schl√ºssel‚Äù).
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Auto-Notiz Regeln (eine pro Zeile)</label>
              <textarea id="noteRules" placeholder="Beispiel:
hotel => Rundgang / Schl√ºssel
baustelle => Zugang / Ausweis
asyl => Kontrollgang / Schl√ºssel
schl√ºssel => Schl√ºssel √ºbernehmen
uniform => Uniform / Weste"></textarea>
              <div class="hint">Format: <b>keyword => Notiz</b> (case-insensitive).</div>
            </div>

            <div class="field">
              <label>Schicht Regeln (optional)</label>
              <textarea id="shiftRules" placeholder="Beispiel:
nacht => Nacht
night => Nacht
tag => Tag
day => Tag"></textarea>
              <div class="hint">Wenn Objekt ‚Äúnacht‚Äù enth√§lt ‚Üí Schicht Nacht.</div>
            </div>
          </div>

          <div class="btnRow">
            <button class="pill good" id="btnSaveDocs">Dokumentation speichern</button>
            <button class="pill danger" id="btnResetDocs">Dokumentation reset</button>
          </div>
        </div>

        <div class="card">
          <h2>Hilfe (WhatsApp PDF)</h2>
          <div class="hint">
            ‚ö†Ô∏è Desktop-Browser d√ºrfen <b>keine Datei automatisch</b> in WhatsApp anh√§ngen (Sicherheitsregel).
            <br>‚úÖ Mobile (Android) kann oft direkt teilen, wenn <b>navigator.share</b> unterst√ºtzt wird.
          </div>

          <div class="field" style="margin-top:12px">
            <label>Was die App macht</label>
            <textarea readonly>
1) PDF erzeugen
2) PDF automatisch speichern (Download)
3) WhatsApp √∂ffnen + Text vorbereiten
4) Du: WhatsApp ‚Üí üìé ‚Üí Dokument ‚Üí PDF ausw√§hlen ‚Üí Senden

Wenn dein Handy/Browser "Datei teilen" erlaubt:
‚Üí App versucht direkt "Share" mit PDF Datei.
            </textarea>
          </div>

          <div class="btnRow">
            <button class="pill good" id="btnWhatsAppPDF3">WhatsApp (PDF) testen</button>
            <button class="pill" id="btnPDF2">Nur PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden PDF canvas -->
  <div id="pdfCanvas" aria-hidden="true">
    <div class="pdfPage" id="pdfPage">
      <div class="pdfHeader">
        <div class="pdfBrand">
          <div class="pdfLogo"><img id="pdfLogo" alt="Logo" /></div>
          <div class="pdfBrandText">
            <b id="pdfCompanyName">Masculine Security</b>
            <small id="pdfCompanyMeta">
              Adresse: Werschenregerstra√üe 6, 28237 Bremen<br>
              Tel: 015778697052<br>
              E-Mail: Kontakt.mass.bremen@hotmail.com
            </small>
          </div>
        </div>
        <div class="pdfMeta">
          <div><b>Datum:</b> <span id="pdfDateOut">16.02.2026</span></div>
        </div>
      </div>

      <div class="pdfLine"></div>
      <div class="pdfTitle">Vorl√§ufiger Dienstplan</div>

      <table class="pdfTable" id="pdfTable">
        <thead>
          <tr>
            <th>TAG</th>
            <th>UHRZEIT</th>
            <th>OBJEKT</th>
            <th>NOTIZ</th>
          </tr>
        </thead>
        <tbody id="pdfRows"></tbody>
      </table>

      <div class="pdfNotice">
        <b>DRINGEND BEACHTEN:</b>
        Dienstantritt ist 20 Minuten vor Dienstbeginn!<br>
        Versp√§tungen und Ausf√§lle sind unverz√ºglich telefonisch zu melden!<br>
        Stundenzettel sp√§testens 2 Tage vor Monatsende einreichen.
      </div>

      <div class="pdfFooter">
        <div id="pdfFooterLeft">Masculine Security ‚Äî Dienstplan</div>
        <div id="pdfFooterRight">Seite 1 von 1</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**********************
     * Storage keys
     **********************/
    const KEY_PLAN = "ms_dienstplan_v1";
    const KEY_META = "ms_meta_v1";
    const KEY_DOCS = "ms_docs_v1";
    const DEFAULT_TIME = { Tag: "07:00‚Äì19:00", Nacht: "19:00‚Äì07:00" };
    const DAYS = ["Mo","Di","Mi","Do","Fr","Sa","So"];

    /**********************
     * Helpers
     **********************/
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2600);
    }
    function setStatus(msg){ $("#status").textContent = msg; }

    function todayDE(){
      return new Date().toLocaleDateString("de-DE"); // dd.mm.yyyy
    }

    function safeJSONParse(str, fallback){
      try{ return JSON.parse(str) ?? fallback; }catch{ return fallback; }
    }

    function normalize(s){
      return (s||"").toString().trim().toLowerCase();
    }

    function loadPlan(){
      return safeJSONParse(localStorage.getItem(KEY_PLAN), []);
    }
    function savePlan(plan){
      localStorage.setItem(KEY_PLAN, JSON.stringify(plan));
    }

    function loadMeta(){
      return safeJSONParse(localStorage.getItem(KEY_META), {
        companyName:"Masculine Security",
        companyAddress:"Werschenregerstra√üe 6, 28237 Bremen",
        companyPhone:"015778697052",
        companyEmail:"Kontakt.mass.bremen@hotmail.com",
        pdfDate: todayDE(),
        logoDataUrl: null
      });
    }
    function saveMeta(meta){
      localStorage.setItem(KEY_META, JSON.stringify(meta));
    }

    function loadDocs(){
      return safeJSONParse(localStorage.getItem(KEY_DOCS), {
        noteRules:
`hotel => Rundgang / Schl√ºssel
asyl => Kontrollgang / Schl√ºssel
baustelle => Zugang / Ausweis
schl√ºssel => Schl√ºssel √ºbernehmen
uniform => Uniform / Weste`,
        shiftRules:
`nacht => Nacht
night => Nacht
tag => Tag
day => Tag`
      });
    }
    function saveDocs(docs){
      localStorage.setItem(KEY_DOCS, JSON.stringify(docs));
    }

    function parseRules(text){
      const lines = (text||"").split("\n").map(l=>l.trim()).filter(Boolean);
      const rules = [];
      for(const l of lines){
        const idx = l.indexOf("=>");
        if(idx===-1) continue;
        const k = l.slice(0,idx).trim();
        const v = l.slice(idx+2).trim();
        if(k && v) rules.push({k: normalize(k), v});
      }
      return rules;
    }

    function pickByRules(value, rules){
      const val = normalize(value);
      if(!val) return null;
      for(const r of rules){
        if(val.includes(r.k)) return r.v;
      }
      return null;
    }

    function autoShift(objekt, docs){
      const byRule = pickByRules(objekt, parseRules(docs.shiftRules));
      if(byRule) return byRule;

      const o = normalize(objekt);
      if(/nacht|night|ns|nachtdienst/.test(o)) return "Nacht";
      return "Tag";
    }

    function autoNote(objekt, docs){
      const byRule = pickByRules(objekt, parseRules(docs.noteRules));
      if(byRule) return byRule;

      const o = normalize(objekt);
      if(o.includes("hotel")) return "Rundgang / Schl√ºssel";
      if(o.includes("asyl")) return "Kontrollgang / Schl√ºssel";
      if(o.includes("baustelle")) return "Zugang / Ausweis";
      if(o.includes("uniform")) return "Uniform / Weste";
      return "‚Äî";
    }

    function makePreviewText(meta, plan){
      if(plan.length===0){
        return `Masculine Security ‚Äî Dienstplan\nDatum: ${meta.pdfDate}\n\nNoch keine Eintr√§ge.`;
      }
      const lines = [];
      lines.push(`${meta.companyName} ‚Äî Dienstplan`);
      lines.push(`Datum: ${meta.pdfDate}`);
      lines.push("");
      for(const p of plan){
        const days = (p.days||[]).join(", ");
        lines.push(`‚Ä¢ ${p.empName}${p.empNo?` (${p.empNo})`:``}: ${days} ‚Äî ${p.objekt} ‚Äî ${p.shift} ‚Äî ${p.time} ‚Äî ${p.note}`);
      }
      lines.push("");
      lines.push("Bitte best√§tigen.");
      return lines.join("\n");
    }

    function escapeCSV(s){
      const v = (s??"").toString();
      if(/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    }

    /**********************
     * UI init
     **********************/
    const state = {
      meta: loadMeta(),
      docs: loadDocs(),
      plan: loadPlan(),
      selectedDays: new Set()
    };

    function renderDaysChips(){
      const wrap = $("#daysWrap");
      wrap.innerHTML = "";
      DAYS.forEach(d=>{
        const b = document.createElement("div");
        b.className = "dayChip";
        b.textContent = d;
        b.addEventListener("click", ()=>{
          if(state.selectedDays.has(d)) state.selectedDays.delete(d);
          else state.selectedDays.add(d);
          b.classList.toggle("on");
          autosaveSoon();
        });
        wrap.appendChild(b);
      });
    }

    function fillMetaInputs(){
      $("#companyName").value = state.meta.companyName;
      $("#companyAddress").value = state.meta.companyAddress;
      $("#companyPhone").value = state.meta.companyPhone;
      $("#companyEmail").value = state.meta.companyEmail;

      // Default required: pdf date 16.02.2026 if user wants fixed today
      $("#pdfDate").value = state.meta.pdfDate || todayDE();

      // header line
      $("#companyLine").textContent =
        `${state.meta.companyAddress} ¬∑ Tel: ${state.meta.companyPhone} ¬∑ ${state.meta.companyEmail}`;

      // logo
      setLogo(state.meta.logoDataUrl);
    }

    function setLogo(dataUrl){
      // fallback to logo.png if no dataUrl
      const appLogo = $("#appLogo");
      const pdfLogo = $("#pdfLogo");

      const src = dataUrl || "logo.png";
      appLogo.src = src;
      pdfLogo.src = src;

      // if logo.png missing, show placeholder
      appLogo.onerror = ()=>{
        appLogo.removeAttribute("src");
        appLogo.alt = "MS";
      };
      pdfLogo.onerror = ()=>{
        pdfLogo.removeAttribute("src");
        pdfLogo.alt = "MS";
      };
    }

    function renderPlanTable(){
      const body = $("#planBody");
      body.innerHTML = "";
      const sorted = [...state.plan].sort((a,b)=> (a.empName||"").localeCompare(b.empName||""));
      for(const p of sorted){
        const tr = document.createElement("tr");
        const badge = p.shift==="Nacht"
          ? `<span class="badge nacht">Nacht</span>`
          : `<span class="badge tag">Tag</span>`;

        tr.innerHTML = `
          <td><b>${p.empName||""}</b><div class="tdSmall">${p.ready? "‚úÖ Bereit" : "‚Äî"}</div></td>
          <td>${p.empNo||"‚Äî"}</td>
          <td>${(p.days||[]).join(", ")}</td>
          <td>${p.objekt||"‚Äî"}</td>
          <td>${badge}</td>
          <td>${p.time||"‚Äî"}</td>
          <td>${p.note||"‚Äî"}</td>
          <td class="right">
            <button class="pill danger" data-id="${p.id}" style="padding:8px 10px;font-size:12px">L√∂schen</button>
          </td>
        `;
        tr.querySelector("button").addEventListener("click", (e)=>{
          const id = e.currentTarget.getAttribute("data-id");
          state.plan = state.plan.filter(x=>x.id!==id);
          savePlan(state.plan);
          renderAll();
          toast("Eintrag gel√∂scht.");
        });
        body.appendChild(tr);
      }

      $("#previewText").value = makePreviewText(state.meta, state.plan);
    }

    function applyAutoFields(){
      const objekt = $("#objekt").value;
      const shift = autoShift(objekt, state.docs);
      const time = DEFAULT_TIME[shift] || DEFAULT_TIME.Tag;
      const note = autoNote(objekt, state.docs);

      $("#shift").value = shift;
      $("#time").value = time;
      $("#note").value = note;
    }

    function autosaveMeta(){
      state.meta.companyName = $("#companyName").value.trim() || "Masculine Security";
      state.meta.companyAddress = $("#companyAddress").value.trim() || "";
      state.meta.companyPhone = $("#companyPhone").value.trim() || "";
      state.meta.companyEmail = $("#companyEmail").value.trim() || "";
      state.meta.pdfDate = $("#pdfDate").value.trim() || todayDE();
      saveMeta(state.meta);

      $("#companyLine").textContent =
        `${state.meta.companyAddress} ¬∑ Tel: ${state.meta.companyPhone} ¬∑ ${state.meta.companyEmail}`;
      $("#previewText").value = makePreviewText(state.meta, state.plan);
    }

    let saveTimer = null;
    function autosaveSoon(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        autosaveMeta();
        applyAutoFields();
        setStatus("Gespeichert.");
      }, 250);
    }

    function renderAll(){
      fillMetaInputs();
      renderPlanTable();
      applyAutoFields();
      setStatus("Bereit.");
    }

    /**********************
     * PDF Generation
     **********************/
    async function buildPDFBlob(){
      // Fill PDF template
      $("#pdfCompanyName").textContent = state.meta.companyName || "Masculine Security";
      $("#pdfCompanyMeta").innerHTML =
        `Adresse: ${state.meta.companyAddress}<br>`+
        `Tel: ${state.meta.companyPhone}<br>`+
        `E-Mail: ${state.meta.companyEmail}`;
      $("#pdfDateOut").textContent = state.meta.pdfDate || todayDE();
      $("#pdfFooterLeft").textContent = `${state.meta.companyName} ‚Äî Dienstplan`;

      // Build rows (simple: group by first employee in list, show days rows)
      const tbody = $("#pdfRows");
      tbody.innerHTML = "";

      // Create day ‚Üí row map
      const dayMap = new Map(DAYS.map(d=>[d,{time:"‚Äî", objekt:"‚Äî", note:"‚Äî"}]));
      // If multiple entries, pick last for each day (simple)
      for(const p of state.plan){
        for(const d of (p.days||[])){
          dayMap.set(d, {time:p.time||"‚Äî", objekt:p.objekt||"‚Äî", note:p.note||"‚Äî"});
        }
      }

      for(const d of DAYS){
        const row = dayMap.get(d) || {time:"‚Äî", objekt:"‚Äî", note:"‚Äî"};
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d}</td><td>${row.time}</td><td>${row.objekt}</td><td>${row.note}</td>`;
        tbody.appendChild(tr);
      }

      // Ensure logo is loaded
      await new Promise(res=>{
        const img = $("#pdfLogo");
        if(img.complete && img.naturalWidth>0) return res();
        img.onload = ()=>res();
        img.onerror = ()=>res();
      });

      // Render to canvas
      const node = $("#pdfPage");
      const canvas = await html2canvas(node, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Fit image to page
      pdf.addImage(imgData, "PNG", 0, 0, pageW, pageH);

      // Return Blob
      const blob = pdf.output("blob");
      return blob;
    }

    async function downloadPDF(){
      setStatus("PDF wird erstellt‚Ä¶");
      const blob = await buildPDFBlob();
      const name = `Dienstplan_${(state.meta.pdfDate||todayDE()).replaceAll(".","-")}.pdf`;

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setStatus("PDF gespeichert (Download).");
      toast("PDF gespeichert. (Downloads)");
      return { blob, name };
    }

    /**********************
     * WhatsApp PDF (SOLVED)
     * - Mobile: tries navigator.share(files)
     * - Desktop: auto-download + open WhatsApp with text (user attaches file)
     **********************/
    async function sendWhatsAppPDF(){
      // 1) Ensure date is saved
      autosaveMeta();

      // 2) Create PDF + auto download (always)
      const { blob, name } = await downloadPDF();

      // 3) Text for WhatsApp
      const text =
`${state.meta.companyName} ‚Äì Dienstplan
Datum: ${state.meta.pdfDate}

‚úÖ PDF wurde gespeichert: ${name}
‚û°Ô∏è WhatsApp: üìé ‚Üí Dokument ‚Üí "${name}" ausw√§hlen ‚Üí Senden.`;

      // 4) Try direct share with file (mostly works on Android Chrome)
      try{
        const file = new File([blob], name, {type:"application/pdf"});
        if(navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share){
          setStatus("Teilen‚Ä¶");
          await navigator.share({
            title: `${state.meta.companyName} Dienstplan`,
            text,
            files: [file],
          });
          setStatus("WhatsApp Teilen: fertig.");
          return;
        }
      }catch(e){
        // ignore and fallback
      }

      // 5) Fallback: open WhatsApp text
      const wa = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(wa, "_blank", "noopener,noreferrer");
      setStatus("WhatsApp ge√∂ffnet (Text). Datei bitte anh√§ngen.");
      toast("WhatsApp ge√∂ffnet. PDF bitte als Dokument anh√§ngen.");
    }

    /**********************
     * Export CSV / Copy text / WhatsApp text
     **********************/
    function exportCSV(){
      const header = ["Mitarbeiter","Nr","Tage","Objekt","Schicht","Uhrzeit","Notiz","Bereit"];
      const rows = [header.join(",")];
      for(const p of state.plan){
        rows.push([
          escapeCSV(p.empName||""),
          escapeCSV(p.empNo||""),
          escapeCSV((p.days||[]).join(" ")),
          escapeCSV(p.objekt||""),
          escapeCSV(p.shift||""),
          escapeCSV(p.time||""),
          escapeCSV(p.note||""),
          escapeCSV(p.ready ? "JA" : "NEIN"),
        ].join(","));
      }
      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `Dienstplan_${(state.meta.pdfDate||todayDE()).replaceAll(".","-")}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast("CSV exportiert.");
    }

    async function copyText(){
      const t = $("#previewText").value;
      try{
        await navigator.clipboard.writeText(t);
        toast("Text kopiert.");
      }catch{
        // fallback
        const ta = $("#previewText");
        ta.focus(); ta.select();
        document.execCommand("copy");
        toast("Text kopiert (fallback).");
      }
    }

    function openWhatsAppText(){
      autosaveMeta();
      const text = $("#previewText").value || makePreviewText(state.meta, state.plan);
      window.open("https://wa.me/?text="+encodeURIComponent(text), "_blank", "noopener,noreferrer");
    }

    /**********************
     * Events
     **********************/
    document.addEventListener("DOMContentLoaded", ()=>{
      // Tabs
      $$(".tabBtn").forEach(b=>{
        b.addEventListener("click", ()=>{
          $$(".tabBtn").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const tab = b.getAttribute("data-tab");
          $$(".tabPanel").forEach(p=>p.classList.remove("active"));
          $("#tab-"+tab).classList.add("active");
        });
      });

      // Header quick tab buttons
      $("#btnTabPlan").addEventListener("click", ()=>$$(".tabBtn")[0].click());
      $("#btnTabDocs").addEventListener("click", ()=>$$(".tabBtn")[1].click());

      // Default date (must be dd.mm.yyyy)
      if(!state.meta.pdfDate) state.meta.pdfDate = todayDE();
      $("#pdfDate").value = state.meta.pdfDate || todayDE();

      // Render day chips
      renderDaysChips();

      // Meta inputs autosave
      ["companyName","companyAddress","companyPhone","companyEmail","pdfDate"].forEach(id=>{
        $("#"+id).addEventListener("input", autosaveSoon);
      });

      // Objekt triggers auto shift/time/note
      $("#objekt").addEventListener("input", ()=>{
        applyAutoFields();
        autosaveSoon();
      });

      // Logo upload
      $("#logoFile").addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          state.meta.logoDataUrl = reader.result;
          saveMeta(state.meta);
          setLogo(state.meta.logoDataUrl);
          toast("Logo gespeichert.");
        };
        reader.readAsDataURL(f);
      });

      // Add entry
      $("#btnAdd").addEventListener("click", ()=>{
        const empName = $("#empName").value.trim();
        const empNo = $("#empNo").value.trim();
        const objekt = $("#objekt").value.trim();
        const days = Array.from(state.selectedDays);

        if(!empName){ toast("Bitte Mitarbeiter Name eingeben."); return; }
        if(days.length===0){ toast("Bitte Arbeitstage anklicken."); return; }
        if(!objekt){ toast("Bitte Objekt / Einsatz eingeben."); return; }

        applyAutoFields();

        const entry = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
          empName,
          empNo,
          days: days.slice(),
          objekt,
          shift: $("#shift").value,
          time: $("#time").value,
          note: $("#note").value,
          ready: $("#ready").checked
        };
        state.plan.push(entry);
        savePlan(state.plan);

        // Reset form bits (keep meta)
        $("#empName").value = "";
        $("#empNo").value = "";
        $("#objekt").value = "";
        $("#ready").checked = false;
        state.selectedDays.clear();
        $$("#daysWrap .dayChip").forEach(x=>x.classList.remove("on"));
        applyAutoFields();

        renderPlanTable();
        toast("Eintrag gespeichert.");
      });

      // Export CSV
      $("#btnExportCSV").addEventListener("click", exportCSV);

      // Copy text
      $("#btnCopyText").addEventListener("click", copyText);

      // WhatsApp text
      $("#btnOpenWhatsAppText").addEventListener("click", openWhatsAppText);

      // PDF / Print / WhatsApp PDF
      $("#btnPDF").addEventListener("click", downloadPDF);
      $("#btnPDF2").addEventListener("click", downloadPDF);
      $("#btnPrint").addEventListener("click", ()=>window.print());

      $("#btnWhatsAppPDF").addEventListener("click", sendWhatsAppPDF);
      $("#btnWhatsAppPDF2").addEventListener("click", sendWhatsAppPDF);
      $("#btnWhatsAppPDF3").addEventListener("click", sendWhatsAppPDF);

      // Reset
      $("#btnReset").addEventListener("click", ()=>{
        if(!confirm("Alles l√∂schen? (Plan + Meta)")) return;
        localStorage.removeItem(KEY_PLAN);
        localStorage.removeItem(KEY_META);
        state.plan = [];
        state.meta = loadMeta();
        renderAll();
        toast("Reset ÏôÑÎ£å.");
      });

      // Docs
      $("#noteRules").value = state.docs.noteRules || "";
      $("#shiftRules").value = state.docs.shiftRules || "";

      $("#btnSaveDocs").addEventListener("click", ()=>{
        state.docs.noteRules = $("#noteRules").value;
        state.docs.shiftRules = $("#shiftRules").value;
        saveDocs(state.docs);
        applyAutoFields();
        toast("Dokumentation gespeichert.");
      });

      $("#btnResetDocs").addEventListener("click", ()=>{
        if(!confirm("Dokumentation reset?")) return;
        localStorage.removeItem(KEY_DOCS);
        state.docs = loadDocs();
        $("#noteRules").value = state.docs.noteRules;
        $("#shiftRules").value = state.docs.shiftRules;
        applyAutoFields();
        toast("Dokumentation reset.");
      });

      // Load initial
      renderAll();

      // Ensure default logo load attempt
      setLogo(state.meta.logoDataUrl);

      // Make sure date always dd.mm.yyyy (if user deletes)
      $("#pdfDate").addEventListener("blur", ()=>{
        if(!$("#pdfDate").value.trim()){
          $("#pdfDate").value = todayDE();
          autosaveMeta();
        }
      });
    });
  </script>
</body>
</html>

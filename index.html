<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Dienstplan</title>
  <meta name="theme-color" content="#0b4fa3"/>

  <!-- PDF lib -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg1:#06213f;
      --bg2:#073d78;
      --line:rgba(255,255,255,.12);
      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --accent:#61b6ff;
      --good:#28e0b2;
      --warn:#ffd166;
      --bad:#ff5a7a;
      --r:18px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 25% -10%, rgba(97,182,255,.35), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(40,224,178,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px; margin:22px auto; padding:0 14px 28px;}

    .topbar{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{display:flex; gap:12px; align-items:center; min-width:260px;}
    .logo{
      width:52px; height:52px; border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--line);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .btxt{display:flex; flex-direction:column; gap:3px;}
    .title{font-size:18px; font-weight:800; letter-spacing:.4px}
    .sub{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
    .sub b{color:var(--text); font-weight:700}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tabbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .tabbtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}
    .tabbtn.active{background:rgba(97,182,255,.25); border-color:rgba(97,182,255,.55)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.14)}
    .btn.primary{background:rgba(97,182,255,.28); border-color:rgba(97,182,255,.6)}
    .btn.good{background:rgba(40,224,178,.22); border-color:rgba(40,224,178,.55)}
    .btn.warn{background:rgba(255,209,102,.18); border-color:rgba(255,209,102,.5)}
    .btn.bad{background:rgba(255,90,122,.18); border-color:rgba(255,90,122,.5)}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      min-width:0;
    }

    h2{margin:0 0 8px; font-size:16px; font-weight:900}
    .hint{color:var(--muted); font-size:12px; line-height:1.45}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
      margin-top:12px;
    }
    @media (max-width: 680px){ .form{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px; min-width:0}
    label{font-size:12px; color:var(--muted); font-weight:800}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(7,25,55,.45);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.55); font-weight:700}
    input:focus, select:focus, textarea:focus{border-color:rgba(97,182,255,.75); box-shadow:0 0 0 3px rgba(97,182,255,.18)}

    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px; border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(7,25,55,.25);
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:.12s transform, .12s background;
      font-size:12px;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.on{background:rgba(97,182,255,.26); border-color:rgba(97,182,255,.55)}
    .row-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,25,55,.25);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:12px;
      vertical-align:top;
      color:var(--text);
      font-weight:800;
    }
    th{background:rgba(255,255,255,.10); text-transform:uppercase; letter-spacing:.35px; font-size:11px;}
    tr:last-child td{border-bottom:none}
    td.muted{color:rgba(255,255,255,.70); font-weight:700}

    .previewBox{
      background:rgba(7,25,55,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px;
      min-height:110px;
      font-size:12px;
      color:rgba(255,255,255,.92);
      white-space:pre-wrap;
      line-height:1.5;
      font-weight:800;
    }

    /* Hidden PDF template */
    #pdfRoot{ position:absolute; left:-99999px; top:-99999px; width:794px; }
    .pdfPage{
      width:794px; min-height:1123px;
      background:#ffffff;
      color:#0b1a33;
      font-family: Arial, sans-serif;
      padding:26px 28px;
    }
    .pdfHeader{
      display:flex; justify-content:space-between; align-items:flex-start;
      border-bottom:3px solid #0b4fa3;
      padding-bottom:10px;
      margin-bottom:12px;
      gap:14px;
    }
    .pdfBrand{display:flex; gap:12px; align-items:center}
    .pdfLogo{
      width:56px; height:56px; border-radius:12px;
      border:1px solid rgba(11,79,163,.25);
      overflow:hidden;
      background:#f3f8ff;
      display:grid; place-items:center;
    }
    .pdfLogo img{width:100%; height:100%; object-fit:cover}
    .pdfTitle{font-size:18px; font-weight:900; color:#0b4fa3}
    .pdfMeta{font-size:11px; color:#2b3a55; line-height:1.35}
    .pdfMeta b{color:#0b1a33}
    .pdfH1{
      text-align:center;
      color:#0b4fa3;
      font-size:16px;
      font-weight:900;
      margin:14px 0 10px;
    }
    .pdfTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:8px;
      border:1px solid rgba(11,79,163,.25);
    }
    .pdfTable th, .pdfTable td{
      border:1px solid rgba(11,79,163,.25);
      padding:7px 8px;
      text-align:left;
    }
    .pdfTable th{
      background:#eaf4ff;
      color:#0b4fa3;
      font-weight:900;
      font-size:10.5px;
      text-transform:uppercase;
      letter-spacing:.25px;
    }
    .pdfNoticeTitle{
      margin:14px 0 6px;
      text-align:center;
      color:#c62828;
      font-weight:900;
      font-size:12px;
    }
    .pdfNotice{
      font-size:10.5px;
      line-height:1.35;
      color:#1d2a44;
      text-align:center;
    }
    .pdfFooter{
      margin-top:18px;
      font-size:10px;
      color:#3a4a66;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img id="brandLogo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
        </div>
        <div class="btxt">
          <div class="title">MASCULINE SECURITY — Dienstplan</div>
          <div class="sub">
            <span><b>Adresse:</b> Werschenregerstraße 6 · 28237 Bremen</span>
            <span><b>Tel:</b> 015778697052</span>
            <span><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</span>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tabbtn active" id="tabPlan">Wochenplan</button>
        <button class="tabbtn" id="tabDocs">Dokumentation</button>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnPdf">PDF</button>
        <button class="btn good" id="btnWhatsApp">WhatsApp senden</button>
        <button class="btn" id="btnCsv">Export CSV</button>
        <button class="btn bad" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="viewPlan">
        <h2>Wöchentlicher Mitarbeiter-Dienstplan</h2>
        <div class="hint">
          ✅ Datum format: <b>dd.mm.yyyy</b> (tusaale 16.02.2026)<br>
          ✅ Schicht Tag/Nacht → Uhrzeit automatic<br>
          ✅ WhatsApp senden: Mobile share (PDF) / Desktop: download + WhatsApp text
        </div>

        <div class="form">
          <div class="field">
            <label>Datum (dd.mm.yyyy)</label>
            <input id="date" placeholder="16.02.2026">
          </div>

          <div class="field">
            <label>KW (optional)</label>
            <input id="kw" placeholder="z.B. 07">
          </div>

          <div class="field">
            <label>Mitarbeiter Name</label>
            <input id="empName" placeholder="z.B. Mustafa">
          </div>

          <div class="field">
            <label>Mitarbeiter-Nr (optional)</label>
            <input id="empNo" placeholder="z.B. MS-001">
          </div>

          <div class="field" style="grid-column:1 / -1">
            <label>Arbeitstage (klick auswählen)</label>
            <div class="chips" id="dayChips"></div>
          </div>

          <div class="field">
            <label>Objekt / Einsatz</label>
            <input id="objekt" placeholder="z.B. Hotel / Baustelle">
          </div>

          <div class="field">
            <label>Notiz (optional)</label>
            <input id="note" placeholder="z.B. Tor 2 / Schlüssel">
          </div>

          <div class="field">
            <label>Schicht (Tag/Nacht)</label>
            <select id="shift">
              <option value="Tag">Tag</option>
              <option value="Nacht">Nacht</option>
            </select>
          </div>

          <div class="field">
            <label>Uhrzeit (automatic)</label>
            <input id="time" placeholder="07:00–19:00">
          </div>
        </div>

        <div class="row-actions">
          <button class="btn good" id="btnAdd">+ Eintrag speichern</button>
          <button class="btn" id="btnClearForm">Formular leeren</button>
        </div>

        <div style="height:12px"></div>

        <h2>Gespeicherte Einträge</h2>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Mitarbeiter</th><th>Nr</th><th>Tage</th>
              <th>Objekt</th><th>Schicht</th><th>Uhrzeit</th><th>Notiz</th><th>Aktion</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td class="muted" colspan="9">Noch keine Einträge.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" id="viewRight">
        <div id="viewPreview">
          <h2>Vorschau</h2>
          <div class="hint">Text-ka WhatsApp/Email u dir. Button-ka WhatsApp wuxuu isku dayaa PDF share (mobile), haddii kale waa text + download.</div>
          <div style="height:10px"></div>
          <div class="previewBox" id="msgPreview"></div>

          <div class="row-actions">
            <button class="btn" id="btnCopy">Text kopieren</button>
            <button class="btn good" id="btnWhatsAppText">WhatsApp (Text)</button>
          </div>
        </div>

        <div id="viewDocs" style="display:none">
          <h2>Dokumentation</h2>
          <div class="hint">Qor dokumentation—waxaa la keydinayaa.</div>
          <div style="height:10px"></div>

          <div class="field">
            <label>Dokumentation Text</label>
            <textarea id="docText" rows="12" placeholder="Vorkommnisse / Übergabe / Notizen..."></textarea>
          </div>

          <div class="row-actions">
            <button class="btn good" id="btnSaveDoc">Dokumentation speichern</button>
            <button class="btn warn" id="btnPdfDoc">Dokumentation als PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden PDF template -->
  <div id="pdfRoot">
    <div class="pdfPage" id="pdfPage">
      <div class="pdfHeader">
        <div class="pdfBrand">
          <div class="pdfLogo"><img id="pdfLogo" src="logo.png" alt="Logo"></div>
          <div>
            <div class="pdfTitle">Masculine Security</div>
            <div class="pdfMeta">
              <div><b>Adresse:</b> Werschenregerstraße 6, 28237 Bremen</div>
              <div><b>Tel:</b> 015778697052</div>
              <div><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</div>
            </div>
          </div>
        </div>
        <div class="pdfMeta" style="text-align:right">
          <div><b>Datum:</b> <span id="pdfDate">16.02.2026</span></div>
          <div><b>KW:</b> <span id="pdfKW">—</span></div>
          <div><b>Seite:</b> 1 / 1</div>
        </div>
      </div>

      <div class="pdfH1">Vorläufiger Dienstplan</div>

      <table class="pdfTable">
        <thead>
          <tr>
            <th>Tag</th>
            <th>Uhrzeit</th>
            <th>Objekt</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody id="pdfTbody">
          <tr><td colspan="4">Keine Einträge.</td></tr>
        </tbody>
      </table>

      <div class="pdfNoticeTitle">DRINGEND BEACHTEN:</div>
      <div class="pdfNotice">
        Dienstantritt ist 20 Minuten vor Dienstbeginn!<br>
        Verspätungen und Ausfälle sind unverzüglich telefonisch zu melden!<br>
        Stundenzettel spätestens 2 Tage vor Monatsende einreichen.
      </div>

      <div class="pdfFooter">
        <div>Masculine Security — Dienstplan</div>
        <div>Seite 1 von 1</div>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "ms_dienstplan_single_v1";
    const LS_DOC = "ms_doku_single_v1";

    const DAY_LIST = [
      {key:"Mo", label:"Montag"},
      {key:"Di", label:"Dienstag"},
      {key:"Mi", label:"Mittwoch"},
      {key:"Do", label:"Donnerstag"},
      {key:"Fr", label:"Freitag"},
      {key:"Sa", label:"Samstag"},
      {key:"So", label:"Sonntag"},
    ];

    const SHIFT_TIMES = { Tag:"07:00–19:00", Nacht:"19:00–07:00" };

    const state = {
      days: new Set(),
      entries: [],
      meta: { date:"", kw:"", empName:"", empNo:"", objekt:"", note:"", shift:"Tag", time:"" }
    };

    const $ = (s)=>document.querySelector(s);

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatDateDE(d){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`; }

    function tryParseDateAny(v){
      if(!v) return null;
      v = String(v).trim();
      const iso = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso){ const d = new Date(+iso[1], +iso[2]-1, +iso[3]); return isNaN(d)?null:d; }
      const de = v.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
      if(de){ const d = new Date(+de[3], +de[2]-1, +de[1]); return isNaN(d)?null:d; }
      return null;
    }
    function normalizeDateToDE(v){
      const d = tryParseDateAny(v);
      return d ? formatDateDE(d) : formatDateDE(new Date());
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        days:[...state.days],
        entries:state.entries,
        meta:state.meta
      }));
    }
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        state.days = new Set(Array.isArray(d.days)?d.days:[]);
        state.entries = Array.isArray(d.entries)?d.entries:[];
        state.meta = Object.assign(state.meta, d.meta||{});
      }catch{}
    }

    function renderDayChips(){
      const wrap = $("#dayChips");
      wrap.innerHTML = "";
      DAY_LIST.forEach(d=>{
        const el = document.createElement("div");
        el.className = "chip" + (state.days.has(d.key) ? " on" : "");
        el.textContent = d.label;
        el.addEventListener("click", ()=>{
          if(state.days.has(d.key)) state.days.delete(d.key); else state.days.add(d.key);
          renderDayChips();
          rebuildPreview();
          saveState();
        });
        wrap.appendChild(el);
      });
    }

    function syncMetaFromForm(){
      state.meta.date = normalizeDateToDE($("#date").value);
      $("#date").value = state.meta.date;

      state.meta.kw = $("#kw").value.trim();
      state.meta.empName = $("#empName").value.trim();
      state.meta.empNo = $("#empNo").value.trim();
      state.meta.objekt = $("#objekt").value.trim();
      state.meta.note = $("#note").value.trim();
      state.meta.shift = $("#shift").value;
      state.meta.time = $("#time").value.trim();
    }

    function autoTimeByShift(){
      $("#time").value = SHIFT_TIMES[$("#shift").value] || $("#time").value;
    }

    function setFormFromMeta(){
      $("#date").value = state.meta.date || formatDateDE(new Date());
      $("#kw").value = state.meta.kw || "";
      $("#empName").value = state.meta.empName || "";
      $("#empNo").value = state.meta.empNo || "";
      $("#objekt").value = state.meta.objekt || "";
      $("#note").value = state.meta.note || "";
      $("#shift").value = state.meta.shift || "Tag";
      $("#time").value = state.meta.time || SHIFT_TIMES[$("#shift").value];
    }

    function buildMessageText(){
      syncMetaFromForm();
      const date = state.meta.date || formatDateDE(new Date());
      const kw = state.meta.kw ? `KW ${state.meta.kw}` : "KW —";
      const days = [...state.days];
      const dayStr = days.length ? days.join(", ") : "—";
      const time = state.meta.time || SHIFT_TIMES[state.meta.shift];

      return [
        `MASCULINE SECURITY — Dienstplan`,
        `Datum: ${date} | ${kw}`,
        `Mitarbeiter: ${state.meta.empName || "—"}${state.meta.empNo ? " ("+state.meta.empNo+")" : ""}`,
        `Tage: ${dayStr}`,
        `Objekt: ${state.meta.objekt || "—"}`,
        `Schicht: ${state.meta.shift} | Uhrzeit: ${time}`,
        state.meta.note ? `Notiz: ${state.meta.note}` : "",
        ``,
        `DRINGEND: 20 Min vor Dienstbeginn da sein. Ausfälle sofort melden.`
      ].filter(Boolean).join("\n");
    }

    function rebuildPreview(){
      $("#msgPreview").textContent = buildMessageText();
      fillPdfTemplate();
    }

    function fillPdfTemplate(){
      syncMetaFromForm();
      $("#pdfDate").textContent = state.meta.date || formatDateDE(new Date());
      $("#pdfKW").textContent = state.meta.kw ? `KW ${state.meta.kw}` : "—";

      const body = $("#pdfTbody");
      const days = [...state.days];
      const obj = state.meta.objekt || "—";
      const note = state.meta.note || "—";
      const time = state.meta.time || SHIFT_TIMES[state.meta.shift];

      if(!days.length){
        body.innerHTML = `<tr><td colspan="4">Keine Einträge.</td></tr>`;
        return;
      }

      body.innerHTML = days.map(d=>`
        <tr>
          <td>${escapeHtml(d)}</td>
          <td>${escapeHtml(time)}</td>
          <td>${escapeHtml(obj)}</td>
          <td>${escapeHtml(note)}</td>
        </tr>
      `).join("");
    }

    async function makePdfBlob(){
      fillPdfTemplate();

      // wait logo
      const img = $("#pdfLogo");
      if(img && !img.complete){
        await new Promise(res=>{ img.onload=res; img.onerror=res; });
      }

      const date = $("#pdfDate").textContent || formatDateDE(new Date());
      const filename = `Dienstplan_${date.replaceAll(".","-")}.pdf`;

      const opt = {
        margin: [10,10,10,10],
        filename,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      const worker = html2pdf().set(opt).from($("#pdfPage"));
      const pdf = await worker.toPdf().get("pdf");
      const blob = pdf.output("blob");
      return { blob, filename, date };
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function openWhatsAppWithText(text){
      const encoded = encodeURIComponent(text);
      window.open(`https://wa.me/?text=${encoded}`, "_blank", "noopener,noreferrer");
    }

    async function doPdfDownload(){
      const out = await makePdfBlob();
      downloadBlob(out.blob, out.filename);
    }

    async function sendWhatsAppPdf(){
      // Mobile: share PDF file, Desktop: download + WhatsApp text
      let out = null;
      try{ out = await makePdfBlob(); }catch{ out = null; }

      if(out && navigator.canShare){
        try{
          const file = new File([out.blob], out.filename, {type:"application/pdf"});
          if(navigator.canShare({files:[file]})){
            await navigator.share({ title:`Dienstplan ${out.date}`, text:`Dienstplan (${out.date})`, files:[file] });
            return;
          }
        }catch{}
      }

      if(out){
        downloadBlob(out.blob, out.filename);
        openWhatsAppWithText(buildMessageText() + `\n\nPDF downloaded: ${out.filename}\nAttach it in WhatsApp.`);
        return;
      }

      openWhatsAppWithText(buildMessageText());
    }

    function exportCSV(){
      syncMetaFromForm();
      const rows = [];
      rows.push(["Datum", state.meta.date]);
      rows.push(["KW", state.meta.kw || ""]);
      rows.push(["Mitarbeiter", state.meta.empName || ""]);
      rows.push(["MitarbeiterNr", state.meta.empNo || ""]);
      rows.push(["Objekt", state.meta.objekt || ""]);
      rows.push(["Schicht", state.meta.shift || ""]);
      rows.push(["Uhrzeit", state.meta.time || ""]);
      rows.push(["Tage", [...state.days].join(", ")]);
      rows.push(["Notiz", state.meta.note || ""]);
      rows.push(["---","---"]);
      const csv = rows.map(r=>r.map(v=>{
        const s = String(v??"");
        return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
      }).join(",")).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(blob, `Dienstplan_${(state.meta.date||formatDateDE(new Date())).replaceAll(".","-")}.csv`);
    }

    function renderEntries(){
      const tb = $("#rows");
      if(!state.entries.length){
        tb.innerHTML = `<tr><td class="muted" colspan="9">Noch keine Einträge.</td></tr>`;
        return;
      }
      tb.innerHTML = "";
      state.entries.forEach((e, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(e.empName||"")}</td>
          <td>${escapeHtml(e.empNo||"")}</td>
          <td>${escapeHtml((e.days||[]).join(", "))}</td>
          <td>${escapeHtml(e.objekt||"")}</td>
          <td>${escapeHtml(e.shift||"")}</td>
          <td>${escapeHtml(e.time||"")}</td>
          <td>${escapeHtml(e.note||"")}</td>
          <td><button class="btn bad" data-del="${idx}" style="padding:7px 9px; border-radius:10px;">Löschen</button></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = +btn.getAttribute("data-del");
          state.entries.splice(i,1);
          saveState();
          renderEntries();
          rebuildPreview();
        });
      });
    }

    function addEntry(){
      syncMetaFromForm();
      if(!state.meta.empName){ alert("Mitarbeiter Name fehlt."); return; }
      if(!state.meta.objekt){ alert("Objekt/Einsatz fehlt."); return; }
      if(!state.days.size){ alert("Bitte Arbeitstage auswählen."); return; }

      const time = state.meta.time || SHIFT_TIMES[state.meta.shift];
      const entry = {
        date: state.meta.date,
        kw: state.meta.kw,
        empName: state.meta.empName,
        empNo: state.meta.empNo,
        days: [...state.days],
        objekt: state.meta.objekt,
        shift: state.meta.shift,
        time,
        note: state.meta.note
      };
      state.entries.push(entry);
      saveState();
      renderEntries();
      rebuildPreview();
    }

    function clearForm(){
      state.days = new Set();
      state.meta.empName = "";
      state.meta.empNo = "";
      state.meta.objekt = "";
      state.meta.note = "";
      state.meta.shift = "Tag";
      state.meta.time = SHIFT_TIMES.Tag;
      saveState();
      renderDayChips();
      setFormFromMeta();
      rebuildPreview();
    }

    function resetAll(){
      if(!confirm("Alles löschen?")) return;
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_DOC);
      state.days = new Set();
      state.entries = [];
      state.meta = { date:"", kw:"", empName:"", empNo:"", objekt:"", note:"", shift:"Tag", time:"" };
      init();
    }

    async function copyText(){
      const text = buildMessageText();
      try{
        await navigator.clipboard.writeText(text);
        alert("Text kopiert.");
      }catch{
        alert("Copy not available.");
      }
    }

    function setTab(which){
      if(which==="plan"){
        $("#tabPlan").classList.add("active");
        $("#tabDocs").classList.remove("active");
        $("#viewPlan").style.display = "";
        $("#viewPreview").style.display = "";
        $("#viewDocs").style.display = "none";
      }else{
        $("#tabDocs").classList.add("active");
        $("#tabPlan").classList.remove("active");
        $("#viewPlan").style.display = "none";
        $("#viewPreview").style.display = "none";
        $("#viewDocs").style.display = "";
      }
    }

    function loadDocs(){ $("#docText").value = localStorage.getItem(LS_DOC) || ""; }
    function saveDocs(){ localStorage.setItem(LS_DOC, $("#docText").value||""); alert("Dokumentation gespeichert."); }

    async function pdfDocs(){
      const doc = ($("#docText").value||"").trim();
      if(!doc){ alert("Dokumentation ist leer."); return; }

      const temp = document.createElement("div");
      temp.style.position="absolute"; temp.style.left="-99999px"; temp.style.top="-99999px"; temp.style.width="794px";
      temp.innerHTML = `
        <div class="pdfPage">
          <div class="pdfHeader">
            <div class="pdfBrand">
              <div class="pdfLogo"><img src="logo.png" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
              <div>
                <div class="pdfTitle">Masculine Security</div>
                <div class="pdfMeta">
                  <div><b>Adresse:</b> Werschenregerstraße 6, 28237 Bremen</div>
                  <div><b>Tel:</b> 015778697052</div>
                  <div><b>E-Mail:</b> Kontakt.mass.bremen@hotmail.com</div>
                </div>
              </div>
            </div>
            <div class="pdfMeta" style="text-align:right">
              <div><b>Datum:</b> ${normalizeDateToDE($("#date").value)}</div>
              <div><b>Dokumentation</b></div>
              <div><b>Seite:</b> 1 / 1</div>
            </div>
          </div>
          <div class="pdfH1">Dokumentation</div>
          <div style="border:1px solid rgba(11,79,163,.25); border-radius:10px; padding:10px; background:#f6fbff; white-space:pre-wrap; font-size:11px; line-height:1.45">
            ${escapeHtml(doc)}
          </div>
          <div class="pdfFooter">
            <div>Masculine Security — Dokumentation</div>
            <div>Seite 1 von 1</div>
          </div>
        </div>
      `;
      document.body.appendChild(temp);

      const opt = {
        margin: [10,10,10,10],
        filename: `Dokumentation_${normalizeDateToDE($("#date").value).replaceAll(".","-")}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      await html2pdf().set(opt).from(temp.firstElementChild).save();
      temp.remove();
    }

    function bind(){
      $("#date").addEventListener("blur", ()=>{ $("#date").value = normalizeDateToDE($("#date").value); syncMetaFromForm(); saveState(); rebuildPreview(); });
      $("#shift").addEventListener("change", ()=>{ autoTimeByShift(); syncMetaFromForm(); saveState(); rebuildPreview(); });

      ["kw","empName","empNo","objekt","note","time"].forEach(id=>{
        $("#"+id).addEventListener("input", ()=>{ syncMetaFromForm(); saveState(); rebuildPreview(); });
      });

      $("#btnAdd").addEventListener("click", addEntry);
      $("#btnClearForm").addEventListener("click", clearForm);

      $("#btnPdf").addEventListener("click", doPdfDownload);
      $("#btnWhatsApp").addEventListener("click", sendWhatsAppPdf);
      $("#btnCsv").addEventListener("click", exportCSV);
      $("#btnReset").addEventListener("click", resetAll);

      $("#btnCopy").addEventListener("click", copyText);
      $("#btnWhatsAppText").addEventListener("click", ()=>openWhatsAppWithText(buildMessageText()));

      $("#tabPlan").addEventListener("click", ()=>setTab("plan"));
      $("#tabDocs").addEventListener("click", ()=>setTab("docs"));

      $("#btnSaveDoc").addEventListener("click", saveDocs);
      $("#btnPdfDoc").addEventListener("click", pdfDocs);
    }

    function init(){
      loadState();
      if(!state.meta.date) state.meta.date = formatDateDE(new Date());
      state.meta.date = normalizeDateToDE(state.meta.date);

      // default time
      if(!state.meta.time) state.meta.time = SHIFT_TIMES[state.meta.shift || "Tag"];

      renderDayChips();
      setFormFromMeta();
      renderEntries();
      rebuildPreview();
      loadDocs();
      setTab("plan");
      bind();
      saveState();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

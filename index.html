<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>
  <meta name="theme-color" content="#0b1220"/>

  <style>
    :root{
      --bg:#071225;
      --panel:#0b1a33;
      --panel2:#0c2242;
      --card:#0f2a4f;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --good:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:16px;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(58,166,255,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 15%, rgba(33,209,159,.14), transparent 55%),
        var(--bg);
    }
    a{color:inherit}
    a.link{color:var(--accent); text-decoration:none}
    a.link:hover{text-decoration:underline}

    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:14px;
      padding:14px;
      height:100%;
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; height:auto}
    }

    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 640px;
    }
    .sb-top{
      display:flex; gap:10px; align-items:center;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
    }
    .sb-logo{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      font-weight:900;
      background:linear-gradient(135deg, rgba(58,166,255,.35), rgba(33,209,159,.22));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .sb-title{line-height:1.1}
    .sb-title strong{display:block; font-size:14px}
    .sb-title small{display:block; font-size:12px; color:var(--muted); margin-top:3px}
    .sb-nav{padding:12px}
    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      margin-bottom:10px;
      text-align:left;
      transition: background .15s ease, border-color .15s ease;
    }
    .navbtn:hover{background:rgba(255,255,255,.06); border-color:rgba(58,166,255,.35)}
    .navbtn.active{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.45)}
    .navbadge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      padding:4px 9px;
      border-radius:999px;
      font-family:var(--mono);
    }

    .main{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 640px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .top-left strong{display:block; font-size:16px}
    .top-left small{display:block; font-size:12px; color:var(--muted); margin-top:3px}

    .btns{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.06); border-color:rgba(58,166,255,.35)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.35)}
    .btn.primary:hover{background:rgba(58,166,255,.22)}
    .btn.good{background:rgba(33,209,159,.16); border-color:rgba(33,209,159,.35)}
    .btn.good:hover{background:rgba(33,209,159,.22)}
    .btn.danger{background:rgba(255,77,109,.14); border-color:rgba(255,77,109,.35)}
    .btn.danger:hover{background:rgba(255,77,109,.20)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .mono{font-family:var(--mono)}
    .content{padding:14px}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.10);
    }
    .card .hd strong{display:block}
    .card .hd small{display:block;color:var(--muted); margin-top:4px; font-size:12px}
    .card .bd{padding:14px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background:rgba(5,12,25,.45);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(58,166,255,.45);
      box-shadow:0 0 0 3px rgba(58,166,255,.12);
    }
    textarea{min-height:90px; resize:vertical}

    .hint{font-size:12px;color:var(--muted); margin-top:8px}
    .sep{height:10px}

    .preview{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.12);
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
      font-size:12px;
      color:var(--muted);
    }
    .kv:last-child{border-bottom:none}
    .kv b{color:var(--text)}
    .big{font-size:18px;font-weight:900;letter-spacing:.2px}

    .list{display:grid; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .item strong{display:block}
    .item small{display:block;color:var(--muted); margin-top:4px}
    .item .actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
    .btn.small{padding:8px 10px; font-weight:900; border-radius:10px}
    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="app">

    <aside class="sidebar">
      <div class="sb-top">
        <div class="sb-logo">MS</div>
        <div class="sb-title">
          <strong>Masculine Security</strong>
          <small>Rechnung • Kunden • Firma</small>
        </div>
      </div>

      <div class="sb-nav">
        <button class="navbtn active" id="navRechnung" type="button">
          <span>Rechnung</span>
          <span class="navbadge" id="countRechnungen">1</span>
        </button>
        <button class="navbtn" id="navKunden" type="button">
          <span>Kunden</span>
          <span class="navbadge" id="countKunden">0</span>
        </button>
        <button class="navbtn" id="navFirma" type="button">
          <span>Firma</span>
          <span class="navbadge">local</span>
        </button>
      </div>
    </aside>

    <main class="main">

      <div class="topbar">
        <div class="top-left">
          <strong id="pageTitle">Rechnung</strong>
          <small id="pageSub">Automatisch: Tage × Std/Tag = Stunden • Stunden × €/h = Netto</small>
        </div>

        <div class="btns">
          <span class="pill"><span class="dot good"></span>Deploy: Auto</span>
          <span class="pill"><span class="dot warn"></span>Cache: Controlled</span>
          <span class="pill">Version: <b class="mono" id="ver">v4</b></span>

          <button class="btn primary" id="btnExport" type="button">Export JSON</button>
          <button class="btn" id="btnImport" type="button">Import JSON</button>
          <button class="btn good" id="btnSave" type="button">Speichern</button>
          <button class="btn" id="btnOpenPdf" type="button">Open PDF (Print)</button>
          <button class="btn danger" id="btnCacheFix" type="button">Cache Fix</button>

          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </div>
      </div>

      <div class="content">

        <!-- RECHNUNG -->
        <section id="pageRechnung">
          <div class="grid">
            <div class="card">
              <div class="hd">
                <strong>Rechnung erstellen / bearbeiten</strong>
                <small>Datum-Format im PDF: <span class="mono">DD.MM.YYYY</span> • E-Mail oben &amp; bei Kunde ist klickbar.</small>
              </div>
              <div class="bd">

                <div class="row">
                  <div>
                    <label>Rechnungs-Nr.</label>
                    <input id="invNo" value="MS-2026-0001">
                  </div>
                  <div>
                    <label>Rechnungsdatum</label>
                    <input id="invDate" type="date" value="2026-02-01">
                    <div class="hint">PDF Format: <span class="mono" id="pdfDateHint">01.02.2026</span></div>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Von</label>
                    <input id="periodFrom" type="date">
                  </div>
                  <div>
                    <label>Bis</label>
                    <input id="periodTo" type="date">
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Fällig am</label>
                    <input id="dueDate" type="date">
                  </div>
                  <div>
                    <label>Status</label>
                    <select id="status">
                      <option value="Entwurf" selected>Entwurf</option>
                      <option value="Gesendet">Gesendet</option>
                      <option value="Bezahlt">Bezahlt</option>
                      <option value="Storniert">Storniert</option>
                    </select>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Kunde auswählen (gespeichert)</label>
                    <select id="customerSelect">
                      <option value="">— bitte wählen —</option>
                    </select>
                  </div>
                  <div>
                    <label>Kunde E-Mail (für PDF)</label>
                    <input id="customerEmail" value="mursal.abdi000@gmail.com">
                  </div>
                </div>

                <div class="sep"></div>

                <div>
                  <label>Leistungsbeschreibung</label>
                  <input id="serviceDesc" value="Sicherheitsdienstleistung — Objektbewachung">
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Automatisch (optional)</label>
                    <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                      <div>
                        <label style="margin-top:0">Tage</label>
                        <input id="days" type="number" step="1" min="0" value="0">
                      </div>
                      <div>
                        <label style="margin-top:0">Std/Tag</label>
                        <input id="hoursPerDay" type="number" step="0.01" min="0" value="0">
                      </div>
                    </div>
                    <div class="hint">Stunden = Tage × Std/Tag (wenn Tage &gt; 0)</div>
                  </div>

                  <div>
                    <label>Manuell</label>
                    <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                      <div>
                        <label style="margin-top:0">Stunden</label>
                        <input id="hours" type="number" step="0.01" min="0" value="120">
                      </div>
                      <div>
                        <label style="margin-top:0">€/h</label>
                        <input id="rate" type="number" step="0.01" min="0" value="22">
                      </div>
                    </div>
                    <div class="hint">Netto = Stunden × €/h</div>
                  </div>
                </div>

              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Vorschau (live)</strong>
                <small>PDF wird über “Open PDF (Print)” erzeugt (wie dein Screenshot).</small>
              </div>
              <div class="bd">
                <div class="preview">
                  <div class="kv"><span>Rechnungs-Nr:</span><b class="mono" id="pNo">MS-2026-0001</b></div>
                  <div class="kv"><span>Datum:</span><b id="pDate">01.02.2026</b></div>
                  <div class="kv"><span>Zeitraum:</span><b id="pPeriod">—</b></div>
                  <div class="kv"><span>Status:</span><b id="pStatus">Entwurf</b></div>

                  <div style="height:10px"></div>

                  <div class="kv"><span>Kunde:</span><b id="pCustomer">—</b></div>
                  <div class="kv"><span>Kunde E-Mail:</span><b><a class="link" id="pCustomerMail" href="mailto:mursal.abdi000@gmail.com">mursal.abdi000@gmail.com</a></b></div>

                  <div style="height:10px"></div>

                  <div style="color:var(--muted); font-size:12px; margin-bottom:6px;">Leistung</div>
                  <div class="big" id="pService">Sicherheitsdienstleistung — Objektbewachung</div>

                  <div style="height:10px"></div>

                  <div class="kv"><span>Stunden:</span><b class="mono" id="pHours">120,00</b></div>
                  <div class="kv"><span>€/h:</span><b class="mono" id="pRate">22,00</b></div>
                  <div class="kv"><span>Netto:</span><b class="mono" id="pNet">2.640,00 €</b></div>

                  <div style="height:10px"></div>
                  <div class="hint">
                    Hinweis: Gemäß § 19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>

        <!-- KUNDEN -->
        <section id="pageKunden" class="hidden">
          <div class="grid" style="grid-template-columns: .95fr 1.05fr;">
            <div class="card">
              <div class="hd">
                <strong>Kunden speichern</strong>
                <small>Wird lokal gespeichert. Danach in Rechnung auswählbar.</small>
              </div>
              <div class="bd">
                <div class="row">
                  <div>
                    <label>Name</label>
                    <input id="cName" placeholder="Kunde Name">
                  </div>
                  <div>
                    <label>E-Mail</label>
                    <input id="cEmail" placeholder="kunde@email.de">
                  </div>
                </div>
                <div class="sep"></div>
                <div>
                  <label>Adresse</label>
                  <input id="cAddr" placeholder="Straße Hausnr, PLZ Stadt">
                </div>
                <div class="sep"></div>
                <button class="btn good" id="btnAddCustomer" type="button">Kunde speichern</button>
                <button class="btn danger" id="btnClearCustomers" type="button" style="margin-left:10px">Alle Kunden löschen</button>
                <div class="hint">Tip: Kunde auswählen → Rechnung page → Kunde select</div>
              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Gespeicherte Kunden</strong>
                <small id="kundenHint">0 Kunden</small>
              </div>
              <div class="bd">
                <div class="list" id="kundenList"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- FIRMA -->
        <section id="pageFirma" class="hidden">
          <div class="grid" style="grid-template-columns: .95fr 1.05fr;">
            <div class="card">
              <div class="hd">
                <strong>Firma (Absender)</strong>
                <small>Für PDF/Print verwendet. Lokal gespeichert.</small>
              </div>
              <div class="bd">
                <div>
                  <label>Firmenname</label>
                  <input id="fName" value="Masculine Security">
                </div>
                <div class="sep"></div>
                <div>
                  <label>Adresse</label>
                  <input id="fAddr" value="Werschenregerstraße 6 · 28237 Bremen">
                </div>
                <div class="sep"></div>
                <div class="row">
                  <div>
                    <label>E-Mail</label>
                    <input id="fEmail" value="kontakt.mass.bremen@hotmail.com">
                  </div>
                  <div>
                    <label>Steuernummer (optional)</label>
                    <input id="fTax" placeholder="—">
                  </div>
                </div>
                <div class="sep"></div>
                <div class="row">
                  <div>
                    <label>IBAN</label>
                    <input id="fIban" value="DE98 1001 1001 2333 0146 96">
                  </div>
                  <div>
                    <label>BIC</label>
                    <input id="fBic" value="NTSBDEB1XXX">
                  </div>
                </div>
                <div class="sep"></div>
                <button class="btn good" id="btnSaveFirma" type="button">Firma speichern</button>
                <div class="hint">§19 UStG Hinweis + E-Mail clickable (PDF/Print)</div>
              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Vorschau Firma</strong>
                <small>So erscheint es oben im PDF/Print</small>
              </div>
              <div class="bd">
                <div class="preview">
                  <div class="kv"><span>Firma:</span><b id="pfName">Masculine Security</b></div>
                  <div class="kv"><span>Adresse:</span><b id="pfAddr">Werschenregerstraße 6 · 28237 Bremen</b></div>
                  <div class="kv"><span>E-Mail:</span><b><a class="link" id="pfEmail" href="mailto:kontakt.mass.bremen@hotmail.com">kontakt.mass.bremen@hotmail.com</a></b></div>
                  <div class="kv"><span>IBAN:</span><b class="mono" id="pfIban">DE98 1001 1001 2333 0146 96</b></div>
                  <div class="kv"><span>BIC:</span><b class="mono" id="pfBic">NTSBDEB1XXX</b></div>
                  <div class="kv"><span>Steuernummer:</span><b class="mono" id="pfTax">—</b></div>
                </div>
              </div>
            </div>

          </div>
        </section>

      </div>
    </main>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  const K_CUSTOMERS = "ms_customers_v4";
  const K_FIRMA     = "ms_firma_v4";
  const K_INVOICE   = "ms_invoice_v4";

  const pad2 = (x)=>String(x).padStart(2,"0");
  const fmtDE = (n)=>Number(n||0).toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2});
  const euro = (n)=>fmtDE(n) + " €";
  const toDEDate = (iso)=>{
    if(!iso) return "—";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "—";
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
  };
  const escapeHtml = (s)=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  const escapeAttr = (s)=>String(s??"").replaceAll('"',"&quot;");

  let customers = [];
  let firma = null;
  let invoice = null;

  function defaultFirma(){
    return {
      name: "Masculine Security",
      addr: "Werschenregerstraße 6 · 28237 Bremen",
      email:"kontakt.mass.bremen@hotmail.com",
      tax:"",
      iban:"DE98 1001 1001 2333 0146 96",
      bic:"NTSBDEB1XXX"
    };
  }
  function defaultInvoice(){
    return {
      no:"MS-2026-0001",
      date:$("invDate").value || "",
      from:"",
      to:"",
      due:"",
      status:"Entwurf",
      customerId:"",
      customerEmail:$("customerEmail").value || "",
      serviceDesc:$("serviceDesc").value || "",
      days:0,
      hoursPerDay:0,
      hours:Number($("hours").value||0),
      rate:Number($("rate").value||0),
    };
  }

  function loadAll(){
    try{ customers = JSON.parse(localStorage.getItem(K_CUSTOMERS) || "[]"); }catch(e){ customers=[]; }
    try{ firma = JSON.parse(localStorage.getItem(K_FIRMA) || "null"); }catch(e){ firma=null; }
    try{ invoice = JSON.parse(localStorage.getItem(K_INVOICE) || "null"); }catch(e){ invoice=null; }
    if(!firma) firma = defaultFirma();
    if(!invoice) invoice = defaultInvoice();
  }
  function saveCustomers(){ localStorage.setItem(K_CUSTOMERS, JSON.stringify(customers)); }
  function saveFirma(){ localStorage.setItem(K_FIRMA, JSON.stringify(firma)); }
  function saveInvoice(){ localStorage.setItem(K_INVOICE, JSON.stringify(invoice)); }

  function toast(msg){
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id="toast";
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="18px";
      t.style.transform="translateX(-50%)";
      t.style.padding="10px 12px";
      t.style.border="1px solid rgba(255,255,255,.14)";
      t.style.background="rgba(0,0,0,.45)";
      t.style.backdropFilter="blur(10px)";
      t.style.borderRadius="999px";
      t.style.color="white";
      t.style.fontWeight="900";
      t.style.zIndex="9999";
      t.style.boxShadow="0 20px 50px rgba(0,0,0,.35)";
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity="1";
    clearTimeout(window.__t_toast);
    window.__t_toast = setTimeout(()=>{ t.style.opacity="0"; }, 1600);
  }

  function setActivePage(page){
    $("navRechnung").classList.toggle("active", page==="rechnung");
    $("navKunden").classList.toggle("active", page==="kunden");
    $("navFirma").classList.toggle("active", page==="firma");

    $("pageRechnung").classList.toggle("hidden", page!=="rechnung");
    $("pageKunden").classList.toggle("hidden", page!=="kunden");
    $("pageFirma").classList.toggle("hidden", page!=="firma");

    if(page==="rechnung"){
      $("pageTitle").textContent="Rechnung";
      $("pageSub").textContent="Automatisch: Tage × Std/Tag = Stunden • Stunden × €/h = Netto";
    }
    if(page==="kunden"){
      $("pageTitle").textContent="Kunden";
      $("pageSub").textContent="Kunden lokal speichern und in Rechnung auswählen";
    }
    if(page==="firma"){
      $("pageTitle").textContent="Firma";
      $("pageSub").textContent="Absenderdaten lokal speichern (PDF/Print nutzt diese)";
    }
  }

  function refreshCounts(){
    $("countKunden").textContent = String(customers.length);
    $("countRechnungen").textContent = "1";
    $("kundenHint").textContent = `${customers.length} Kunden`;
  }

  function getSelectedCustomer(){
    const id = invoice.customerId || "";
    if(!id) return null;
    return customers.find(c=>c.id===id) || null;
  }

  function refreshCustomerSelect(){
    const sel = $("customerSelect");
    const current = invoice.customerId || "";
    sel.innerHTML = `<option value="">— bitte wählen —</option>`;
    customers.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name || "(ohne Name)";
      sel.appendChild(opt);
    });
    sel.value = current;
  }

  function renderCustomers(){
    const box = $("kundenList");
    box.innerHTML = "";
    if(customers.length===0){
      box.innerHTML = `<div class="hint">Noch keine Kunden gespeichert.</div>`;
      return;
    }
    customers.forEach(c=>{
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <strong>${escapeHtml(c.name || "—")}</strong>
        <small>${escapeHtml(c.addr || "")}</small>
        <small><a class="link" href="mailto:${escapeAttr(c.email||"")}">${escapeHtml(c.email||"")}</a></small>
        <div class="actions">
          <button class="btn small primary" data-use="${c.id}">In Rechnung nutzen</button>
          <button class="btn small danger" data-del="${c.id}">Löschen</button>
        </div>
      `;
      box.appendChild(div);
    });

    box.querySelectorAll("[data-use]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-use");
        invoice.customerId = id;
        const c = customers.find(x=>x.id===id);
        if(c?.email) invoice.customerEmail = c.email;
        saveInvoice();
        hydrateInvoiceToInputs();
        refreshCustomerSelect();
        updatePreview();
        setActivePage("rechnung");
      });
    });
    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        customers = customers.filter(x=>x.id!==id);
        if(invoice.customerId===id) invoice.customerId="";
        saveCustomers(); saveInvoice();
        refreshCounts();
        renderCustomers();
        refreshCustomerSelect();
        updatePreview();
      });
    });
  }

  function hydrateFirmaToInputs(){
    $("fName").value  = firma.name || "";
    $("fAddr").value  = firma.addr || "";
    $("fEmail").value = firma.email || "";
    $("fTax").value   = firma.tax || "";
    $("fIban").value  = firma.iban || "";
    $("fBic").value   = firma.bic || "";
    renderFirmaPreview();
  }

  function renderFirmaPreview(){
    $("pfName").textContent = firma.name || "—";
    $("pfAddr").textContent = firma.addr || "—";
    $("pfIban").textContent = firma.iban || "—";
    $("pfBic").textContent = firma.bic || "—";
    $("pfTax").textContent = firma.tax ? firma.tax : "—";
    const mail = $("pfEmail");
    mail.textContent = firma.email || "—";
    mail.href = firma.email ? "mailto:"+firma.email : "#";
  }

  function hydrateInvoiceToInputs(){
    $("invNo").value        = invoice.no || "";
    $("invDate").value      = invoice.date || "";
    $("periodFrom").value   = invoice.from || "";
    $("periodTo").value     = invoice.to || "";
    $("dueDate").value      = invoice.due || "";
    $("status").value       = invoice.status || "Entwurf";
    $("serviceDesc").value  = invoice.serviceDesc || "";
    $("days").value         = invoice.days || 0;
    $("hoursPerDay").value  = invoice.hoursPerDay || 0;
    $("hours").value        = invoice.hours || 0;
    $("rate").value         = invoice.rate || 0;
    $("customerEmail").value= invoice.customerEmail || "";
    $("pdfDateHint").textContent = toDEDate($("invDate").value);
  }

  function readInputsToInvoice(){
    invoice.no           = $("invNo").value.trim();
    invoice.date         = $("invDate").value || "";
    invoice.from         = $("periodFrom").value || "";
    invoice.to           = $("periodTo").value || "";
    invoice.due          = $("dueDate").value || "";
    invoice.status       = $("status").value || "Entwurf";
    invoice.customerId   = $("customerSelect").value || invoice.customerId || "";
    invoice.customerEmail= $("customerEmail").value.trim();
    invoice.serviceDesc  = $("serviceDesc").value.trim();
    invoice.days         = Number($("days").value || 0);
    invoice.hoursPerDay  = Number($("hoursPerDay").value || 0);
    invoice.hours        = Number($("hours").value || 0);
    invoice.rate         = Number($("rate").value || 0);
    $("pdfDateHint").textContent = toDEDate(invoice.date);
  }

  function calcHours(){
    const days = Number(invoice.days||0);
    const hpd  = Number(invoice.hoursPerDay||0);
    if(days > 0 && hpd > 0) return days*hpd;
    return Number(invoice.hours||0);
  }

  function updatePreview(){
    readInputsToInvoice();
    const c = getSelectedCustomer();
    const hours = calcHours();
    const net = hours * Number(invoice.rate||0);
    const period = (invoice.from && invoice.to) ? `${toDEDate(invoice.from)} – ${toDEDate(invoice.to)}` : "—";

    $("pNo").textContent = invoice.no || "—";
    $("pDate").textContent = toDEDate(invoice.date);
    $("pStatus").textContent = invoice.status || "—";
    $("pPeriod").textContent = period;

    $("pCustomer").textContent = c?.name ? c.name : "—";
    const mail = $("pCustomerMail");
    mail.textContent = invoice.customerEmail || "—";
    mail.href = invoice.customerEmail ? "mailto:"+invoice.customerEmail : "#";

    $("pService").textContent = invoice.serviceDesc || "—";
    $("pHours").textContent = fmtDE(hours);
    $("pRate").textContent  = fmtDE(invoice.rate);
    $("pNet").textContent   = euro(net);
  }

  function openPdfPrint(){
    readInputsToInvoice();
    const c = getSelectedCustomer();
    const hours = calcHours();
    const net = hours * Number(invoice.rate||0);

    const periodText = (invoice.from && invoice.to) ? `${toDEDate(invoice.from)} – ${toDEDate(invoice.to)}` : "";
    const f = firma || defaultFirma();

    const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rechnung ${escapeHtml(invoice.no||"")}</title>
<style>
  @page{ size:A4; margin:16mm; }
  body{ font-family: Arial, system-ui; margin:0; color:#111; }
  a{ color:#0b65ff; text-decoration:none; }
  .top{ display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; }
  h1{ margin:0; font-size:26px; }
  .meta{ font-size:12px; color:#444; margin-top:6px; }
  .company{ font-size:12px; color:#222; line-height:1.35; }
  .company b{ font-size:16px; }
  .kv{ margin-top:4px; display:flex; gap:6px; flex-wrap:wrap; align-items:baseline; }
  .kv span{ font-weight:700; min-width:48px; }
  .kv code{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; letter-spacing:.2px; }
  .boxwrap{ display:flex; gap:14px; flex-wrap:wrap; margin:12px 0 10px; }
  .box{ flex:1 1 320px; border:1px solid #e6e6e6; border-radius:10px; padding:10px 12px; }
  .label{ font-size:12px; color:#666; margin-bottom:6px; }
  .name{ font-weight:800; margin-bottom:2px; }
  .addr,.mail{ font-size:12px; color:#222; margin-top:4px; }
  table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
  th,td{ border-bottom:1px solid #eee; padding:8px 8px; vertical-align:top; }
  th{ background:#fafafa; text-align:left; color:#444; font-weight:800; }
  td.num, th.num{ text-align:right; font-variant-numeric: tabular-nums; }
  .totals{ display:flex; justify-content:flex-end; margin-top:10px; }
  .panel{ min-width:280px; border:1px solid #eee; border-radius:10px; padding:10px 12px; }
  .trow{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed #eee; font-size:12px; color:#444; }
  .trow:last-child{ border-bottom:none; font-weight:900; color:#111; font-size:13px; }
  .note{ margin-top:12px; font-size:11px; color:#444; line-height:1.35; }
</style>
</head>
<body>

<div class="top">
  <div>
    <h1>Rechnung</h1>
    <div class="meta">Rechnungs-Nr: <b>${escapeHtml(invoice.no||"")}</b> · Datum: <b>${escapeHtml(toDEDate(invoice.date))}</b>${periodText?` · Zeitraum: <b>${escapeHtml(periodText)}</b>`:""}</div>
  </div>

  <div class="company">
    <b>${escapeHtml(f.name||"")}</b><br/>
    ${escapeHtml(f.addr||"")}<br/>
    <div class="kv"><span>E-Mail:</span> <a href="mailto:${escapeAttr(f.email||"")}">${escapeHtml(f.email||"")}</a></div>
    <div class="kv"><span>IBAN:</span> <code>${escapeHtml(f.iban||"")}</code></div>
    <div class="kv"><span>BIC:</span> <code>${escapeHtml(f.bic||"")}</code></div>
  </div>
</div>

<div class="boxwrap">
  <div class="box">
    <div class="label">Rechnung von</div>
    <div class="name">${escapeHtml(f.name||"")}</div>
    <div class="addr">${escapeHtml(f.addr||"")}</div>
    <div class="mail">E-Mail: <a href="mailto:${escapeAttr(f.email||"")}">${escapeHtml(f.email||"")}</a></div>
  </div>

  <div class="box">
    <div class="label">Rechnung an</div>
    <div class="name">${escapeHtml(c?.name || "—")}</div>
    <div class="addr">${escapeHtml(c?.addr || "")}</div>
    <div class="mail">E-Mail: <a href="mailto:${escapeAttr(invoice.customerEmail||"")}">${escapeHtml(invoice.customerEmail||"")}</a></div>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Leistung</th>
      <th class="num">Menge (Std.)</th>
      <th class="num">Preis (€/h)</th>
      <th class="num">Netto (€)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>${escapeHtml(invoice.serviceDesc||"")}</td>
      <td class="num">${escapeHtml(fmtDE(hours))}</td>
      <td class="num">${escapeHtml(fmtDE(invoice.rate))}</td>
      <td class="num">${escapeHtml(fmtDE(net))}</td>
    </tr>
  </tbody>
</table>

<div class="totals">
  <div class="panel">
    <div class="trow"><span>Summe Netto</span><span>${escapeHtml(fmtDE(net))} €</span></div>
    <div class="trow"><span>Umsatzsteuer</span><span>0,00 €</span></div>
    <div class="trow"><span>Zu zahlen</span><span>${escapeHtml(fmtDE(net))} €</span></div>
  </div>
</div>

<div class="note">
  Gemäß § 19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).<br/>
  Bitte überweisen Sie den Betrag unter Angabe der Rechnungsnummer.
</div>

<script>window.onload=()=>window.print();<\/script>
</body>
</html>`;

    const w = window.open("", "_blank");
    if(!w){ alert("Popup blockiert. Bitte erlauben."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

  $("btnSave").addEventListener("click", ()=>{ updatePreview(); saveInvoice(); toast("Gespeichert ✅"); });

  $("btnExport").addEventListener("click", ()=>{
    updatePreview();
    const payload = {
      meta:{app:"MasculineSecurity", version: $("ver").textContent || ""},
      exportedAt: new Date().toISOString(),
      firma, customers, invoice
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `ms-backup-${Date.now()}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  $("btnImport").addEventListener("click", ()=> $("fileImport").click());
  $("fileImport").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      if(data.firma) firma = data.firma;
      if(Array.isArray(data.customers)) customers = data.customers;
      if(data.invoice) invoice = data.invoice;

      saveFirma(); saveCustomers(); saveInvoice();
      refreshCounts();
      hydrateFirmaToInputs();
      hydrateInvoiceToInputs();
      refreshCustomerSelect();
      renderCustomers();
      updatePreview();
      toast("Import ok ✅");
    }catch(err){
      toast("Import error ❌");
    }finally{
      e.target.value="";
    }
  });

  $("btnOpenPdf").addEventListener("click", openPdfPrint);

  $("btnCacheFix").addEventListener("click", async ()=>{
    try{
      if("serviceWorker" in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      if("caches" in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
      const u = new URL(location.href);
      u.searchParams.set("v", String(Date.now()));
      location.replace(u.toString());
    }catch(e){
      location.reload();
    }
  });

  $("navRechnung").addEventListener("click", ()=>setActivePage("rechnung"));
  $("navKunden").addEventListener("click", ()=>setActivePage("kunden"));
  $("navFirma").addEventListener("click", ()=>setActivePage("firma"));

  [
    "invNo","invDate","periodFrom","periodTo","dueDate","status","customerEmail",
    "serviceDesc","days","hoursPerDay","hours","rate"
  ].forEach(id=>{
    $(id).addEventListener("input", updatePreview);
    $(id).addEventListener("change", updatePreview);
  });

  $("customerSelect").addEventListener("change", ()=>{
    invoice.customerId = $("customerSelect").value || "";
    const c = getSelectedCustomer();
    if(c?.email) $("customerEmail").value = c.email;
    updatePreview();
    saveInvoice();
  });

  $("btnAddCustomer").addEventListener("click", ()=>{
    const name = $("cName").value.trim();
    const email = $("cEmail").value.trim();
    const addr = $("cAddr").value.trim();
    if(!name){ toast("Name fehlt ❗"); return; }
    const id = "c_" + Math.random().toString(36).slice(2,10);
    customers.unshift({id, name, email, addr});
    saveCustomers();
    refreshCounts();
    renderCustomers();
    refreshCustomerSelect();
    $("cName").value=""; $("cEmail").value=""; $("cAddr").value="";
    toast("Kunde gespeichert ✅");
  });

  $("btnClearCustomers").addEventListener("click", ()=>{
    customers = [];
    invoice.customerId = "";
    saveCustomers(); saveInvoice();
    refreshCounts();
    renderCustomers();
    refreshCustomerSelect();
    updatePreview();
    toast("Kunden gelöscht ✅");
  });

  $("btnSaveFirma").addEventListener("click", ()=>{
    firma = {
      name: $("fName").value.trim(),
      addr: $("fAddr").value.trim(),
      email: $("fEmail").value.trim(),
      tax: $("fTax").value.trim(),
      iban: $("fIban").value.trim(),
      bic: $("fBic").value.trim()
    };
    saveFirma();
    renderFirmaPreview();
    toast("Firma gespeichert ✅");
  });

  loadAll();
  refreshCounts();
  hydrateFirmaToInputs();
  hydrateInvoiceToInputs();
  refreshCustomerSelect();
  renderCustomers();
  updatePreview();
  setActivePage("rechnung");
})();
</script>
</body>
</html>

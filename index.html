<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    :root[data-theme="light"]{
      --bg:#f5f7fb; --panel:#ffffff; --card:#ffffff; --line:#e7ecf6;
      --text:#0b1220; --muted:#52607f; --accent:#2563eb; --good:#059669; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.18), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.16), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
      background-color:var(--bg);
    }
    :root[data-theme="light"] body{
      background: linear-gradient(180deg, #f5f7fb 0%, #eef2ff 100%);
    }

    .app{min-height:100vh; display:grid; grid-template-columns:280px 1fr; gap:16px; padding:16px; max-width:1320px; margin:0 auto}
    .sidebar{
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      background: rgba(255,255,255,.03);
      padding:14px; position:sticky; top:14px; height:calc(100vh - 28px);
      display:flex; flex-direction:column; box-shadow:0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    :root[data-theme="light"] .sidebar{border-color:rgba(0,0,0,.08); background:rgba(255,255,255,.85)}

    .brand{display:flex; gap:12px; align-items:center; padding:10px; border-radius:var(--r2); border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10)}
    :root[data-theme="light"] .brand{border-color:rgba(0,0,0,.10); background:rgba(245,247,251,.9)}
    .logo{
      width:42px; height:42px; border-radius:14px; display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px; color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      transition:.15s ease;
    }
    :root[data-theme="light"] .nav button{border-color:rgba(0,0,0,.10); background:rgba(245,247,251,.85)}
    .nav button:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.45)}
    .nav button.active{border-color: rgba(58,166,255,.65); background: rgba(58,166,255,.14)}

    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      white-space:nowrap;
    }
    :root[data-theme="light"] .pill{border-color:rgba(0,0,0,.10); background:#fff}

    .foot{margin-top:auto; padding:10px; border-top:1px solid rgba(255,255,255,.10); color:var(--muted); font-size:12px}
    :root[data-theme="light"] .foot{border-top-color:rgba(0,0,0,.10)}

    .main{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      overflow:hidden; display:flex; flex-direction:column; min-height:calc(100vh - 32px);
      box-shadow:0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    :root[data-theme="light"] .main{border-color:rgba(0,0,0,.10); background:rgba(255,255,255,.85)}

    .topbar{
      padding:14px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.08);
    }
    :root[data-theme="light"] .topbar{border-bottom-color:rgba(0,0,0,.10); background:rgba(245,247,251,.75)}

    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color:var(--text);
      padding:9px 12px; border-radius: 12px; cursor:pointer;
      transition:.15s ease; font-weight:800; font-size:13px;
    }
    :root[data-theme="light"] .btn{border-color:rgba(0,0,0,.12); background:#fff}
    .btn:hover{transform:translateY(-1px); border-color: rgba(58,166,255,.45)}
    .btn.primary{border-color: rgba(58,166,255,.65); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.55); background: rgba(255,77,109,.12)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns:1.1fr .9fr; gap:14px}
    .grid3{display:grid; grid-template-columns:repeat(3, 1fr); gap:14px}

    .card{background: rgba(0,0,0,.10); border:1px solid rgba(255,255,255,.10); border-radius:var(--r2); padding:14px}
    :root[data-theme="light"] .card{background:#fff; border-color:rgba(0,0,0,.10)}
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input,.field select,.field textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14); color:var(--text); outline:none;
    }
    :root[data-theme="light"] .field input,
    :root[data-theme="light"] .field select,
    :root[data-theme="light"] .field textarea{
      border-color:rgba(0,0,0,.12); background:#fff; color:#0b1220;
    }

    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    .table th,.table td{padding:10px; border-bottom:1px solid rgba(255,255,255,.10); text-align:left; font-size:13px; vertical-align:top}
    :root[data-theme="light"] .table th,:root[data-theme="light"] .table td{border-bottom-color:rgba(0,0,0,.08)}
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}

    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.10); margin:10px 0}
    :root[data-theme="light"] .hr{background:rgba(0,0,0,.10)}
    .note{border:1px dashed rgba(58,166,255,.55); background: rgba(58,166,255,.10); padding:12px; border-radius:12px; font-size:13px}

    .kpi{display:flex; align-items:flex-end; justify-content:space-between; gap:10px}
    .kpi .value{font-size:22px; font-weight:1000}
    .kpi .label{color:var(--muted); font-size:12px; font-weight:900}

    .statusbar{
      display:flex; align-items:center; gap:10px; font-size:12px; color:var(--muted);
      padding:6px 14px; border-top:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.08);
    }
    :root[data-theme="light"] .statusbar{border-top-color:rgba(0,0,0,.10); background:rgba(245,247,251,.75)}

    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.35)}
    :root[data-theme="light"] .dot.off{background:rgba(0,0,0,.25)}

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;height:auto}
      .grid2,.grid3{grid-template-columns:1fr}
    }

    /* PRINT */
    @media print{
      body{background:#fff;color:#000}
      .app,.sidebar,.topbar,.statusbar{display:none!important}
      #printArea{display:block!important}
    }
    #printArea{display:none}
    .printDoc{font-family: Arial, sans-serif; padding:20px; color:#000;}
    .printHeader{display:flex; justify-content:space-between; gap:20px; align-items:flex-start; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:10px;}
    .printHeader h1{margin:0; font-size:18px}
    .printBox{border:1px solid #ddd; padding:10px; margin:10px 0}
    .printTable{width:100%; border-collapse:collapse}
    .printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:12px}
    .printRight{text-align:right}
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">MS</div>
      <div>
        <h1>Masculine Security</h1>
        <small>Mini Office ‚Ä¢ Offline ‚Ä¢ Auto-Save</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="dashboard" class="active"><span>üè† Dashboard</span><span class="pill" id="pillDash">‚Äì</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="invoices"><span>üßæ Rechnungen</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Einstellungen</span><span class="pill">Theme</span></button>
    </div>

    <div class="foot">
      <div><b>Speichern:</b> Auto (Browser)</div>
      <div class="muted">Email: <b>kontakt.mass.bremen@hotmail.com</b></div>
      <div class="muted">PDF: Rechnung ‚Üí PDF √∂ffnen ‚Üí Print ‚Üí Save as PDF</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Dashboard</h2>
        <small id="pageSub" class="muted">Auto-Save ‚Ä¢ PDF Print</small>
      </div>
      <div class="actions">
        <button class="btn" id="btnExport">Export</button>
        <button class="btn" id="btnImport">Import</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
      </div>
    </div>

    <div class="content">
      <section id="page-dashboard">
        <div class="grid3">
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Umsatz (Monat)</div>
                <div class="value" id="kpiRevenueMonth">0,00 ‚Ç¨</div>
              </div>
              <span class="pill">¬ß19 UStG</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Kunden</div>
                <div class="value" id="kpiCustomers">0</div>
              </div>
              <span class="pill">Auto</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Rechnungen</div>
                <div class="value" id="kpiInvoices">0</div>
              </div>
              <span class="pill">Auto</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Letzte Aktivit√§ten</h3>
            <table class="table">
              <thead><tr><th>Typ</th><th>Text</th><th>Datum</th><th class="right">Betrag</th></tr></thead>
              <tbody id="recentList"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Hinweis</h3>
            <div class="note">
              Rechnung Datum: <b>nur Von ‚Ä¶ bis</b><br/>
              Settings: <b>Steuernummer + Theme</b><br/>
              PDF: <b>PDF √∂ffnen</b> ‚Üí Print ‚Üí Save as PDF
            </div>
          </div>
        </div>
      </section>

      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="name/email..." /></div>
            <div class="hr"></div>
            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><input id="c_addr" placeholder="Stra√üe, PLZ Ort"/></div>
            <button class="btn primary" onclick="Customers.add()">Speichern</button>
            <button class="btn danger" onclick="Customers.clear()">Leeren</button>
          </div>
          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-invoices" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung</h3>
            <div class="split">
              <div class="field"><label>Rechnungs-Nr. (auto)</label><input id="i_no" disabled/></div>
              <div class="field"><label>Zeitraum (Von ‚Ä¶ bis)</label><input id="i_vonbis" placeholder="Von 01.02.2026 bis 10.02.2026"/></div>
            </div>

            <div class="field"><label>Kunde</label><select id="i_customer"></select></div>
            <div class="field"><label>Leistung / Beschreibung</label><input id="i_desc" placeholder="z.B. Objektschutz / Werkschutz"/></div>

            <div class="split">
              <div class="field"><label>Netto (‚Ç¨)</label><input id="i_net" type="number" step="0.01" placeholder="0.00"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option value="Entwurf">Entwurf</option>
                  <option value="Gesendet">Gesendet</option>
                  <option value="Bezahlt">Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="note" id="i_previewNote">Gesamt: 0,00 ‚Ç¨ ‚Ä¢ Umsatzsteuer: 0,00 ‚Ç¨ ‚Ä¢ ¬ß19 UStG</div>

            <button class="btn primary" onclick="Invoices.add()">Speichern</button>
            <button class="btn" onclick="Invoices.print()">PDF √∂ffnen</button>
            <button class="btn danger" onclick="Invoices.clear()">Leeren</button>
          </div>

          <div class="card">
            <h3>Rechnungen</h3>
            <div class="split">
              <div class="field"><label>Suche</label><input id="i_search" placeholder="Nr / Kunde..." /></div>
              <div class="field"><label>Status</label>
                <select id="i_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>
            <table class="table">
              <thead><tr><th>Nr.</th><th>Kunde</th><th>Von‚Ä¶Bis</th><th>Status</th><th class="right">Netto</th><th class="right">Aktion</th></tr></thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Einstellungen</h3>

            <div class="field"><label>Firma</label><input id="s_company" placeholder="Masculine Security"/></div>
            <div class="field"><label>Adresse</label><input id="s_address" placeholder="Werschenregerstra√üe 6, 28237 Bremen"/></div>

            <div class="split">
              <div class="field"><label>Email</label><input id="s_email" placeholder="kontakt.mass.bremen@hotmail.com"/></div>
              <div class="field"><label>Telefon</label><input id="s_phone" placeholder=""/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuernummer</label><input id="s_steuernummer" placeholder="z.B. 12/345/67890"/></div>
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
            </div>

            <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>

            <div class="field"><label>Theme</label>
              <select id="s_theme">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>

            <button class="btn primary" onclick="Settings.save()">Speichern</button>
            <button class="btn danger" onclick="App.resetAll()">Reset (Delete local data)</button>
          </div>

          <div class="card">
            <h3>Info</h3>
            <div class="note">
              ‚úî Wax kasta auto-save buu yahay.<br/>
              ‚úî Rechnung: Von‚Ä¶bis kaliya.<br/>
              ‚úî PDF: Wax aanad rabin sida <b>'''</b> ama characters kale, waan ka saarnay.
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dotOnline"></span>
      <span id="stOnline">Online</span>
      <span>‚Ä¢</span>
      <span id="stSaved">Saved</span>
    </div>
  </main>
</div>

<div id="printArea"></div>

<script>
  const KEY = "ms-mini-office-onefile-v1";

  function nowISO(){ return new Date().toISOString(); }
  function euro(n){ return (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2})+" ‚Ç¨"; }
  function safeId(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
  function escapeHTML(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
  function el(id){ return document.getElementById(id); }
  function val(id){ return (el(id)?.value || "").trim(); }
  function setVal(id,v){ if(el(id)) el(id).value = v; }

  const Store = {
    load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    },
    save(db){
      localStorage.setItem(KEY, JSON.stringify(db));
      UI.setSaved("Saved "+new Date().toLocaleTimeString());
    }
  };

  const App = {
    db: null,
    init(){
      this.db = Store.load() || {
        meta:{createdAt: nowISO(), version: 1},
        settings:{
          company:"Masculine Security",
          address:"Werschenregerstra√üe 6, 28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"",
          steuernummer:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          theme:"dark"
        },
        customers:[],
        invoices:[]
      };

      Settings.applyTheme(this.db.settings.theme);
      UI.bindNav();
      UI.bindTop();
      UI.bindOnline();

      Customers.bind();
      Invoices.bind();

      UI.refreshAll();
      UI.go("dashboard");
      Invoices.ensureInvoiceNo();
    },
    resetAll(){
      if(!confirm("Delete all local data?")) return;
      localStorage.removeItem(KEY);
      location.reload();
    },
    exportJSON(){
      const blob = new Blob([JSON.stringify(this.db,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ms-mini-office-export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    },
    importJSON(file){
      const r = new FileReader();
      r.onload = () => {
        try{
          const obj = JSON.parse(r.result);
          if(!obj || !obj.settings || !obj.invoices || !obj.customers) throw new Error("Format falsch");
          this.db = obj;
          Store.save(this.db);
          location.reload();
        }catch(e){
          alert("Import failed: "+e.message);
        }
      };
      r.readAsText(file);
    }
  };

  const UI = {
    go(page){
      document.querySelectorAll("section[id^='page-']").forEach(s => s.classList.add("hide"));
      const target = el("page-"+page);
      if(target) target.classList.remove("hide");

      document.querySelectorAll("#nav button").forEach(b => b.classList.toggle("active", b.dataset.page===page));

      const titles = {
        dashboard:["Dashboard","Auto-Save ‚Ä¢ PDF Print"],
        customers:["Kunden","CRM"],
        invoices:["Rechnungen","Von‚Ä¶bis + PDF"],
        settings:["Einstellungen","Steuernummer + Theme"]
      };
      el("pageTitle").textContent = titles[page]?.[0] || page;
      el("pageSub").textContent = titles[page]?.[1] || "";
      UI.refreshAll();
    },
    bindNav(){
      el("nav").addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-page]");
        if(!btn) return;
        UI.go(btn.dataset.page);
      });
    },
    bindTop(){
      el("btnExport").onclick = ()=>App.exportJSON();
      el("btnImport").onclick = ()=>el("fileImport").click();
      el("fileImport").addEventListener("change",(e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        App.importJSON(f);
      });
    },
    bindOnline(){
      const update = ()=>{
        const online = navigator.onLine;
        el("dotOnline").classList.toggle("off", !online);
        el("stOnline").textContent = online ? "Online" : "Offline";
      };
      window.addEventListener("online", update);
      window.addEventListener("offline", update);
      update();
    },
    setSaved(txt){ el("stSaved").textContent = txt; },
    refreshAll(){
      el("pillCustomers").textContent = App.db.customers.length;
      el("pillInvoices").textContent  = App.db.invoices.length;

      el("kpiCustomers").textContent = App.db.customers.length;
      el("kpiInvoices").textContent  = App.db.invoices.length;

      const ym = new Date().toISOString().slice(0,7);
      const rev = App.db.invoices
        .filter(x => (x.createdAt||"").slice(0,7)===ym && x.status!=="Entwurf")
        .reduce((s,x)=>s+Number(x.net||0),0);

      el("kpiRevenueMonth").textContent = euro(rev);

      Customers.render();
      Invoices.render();
      Settings.loadToUI();
      UI.renderRecent();
    },
    renderRecent(){
      const rows = App.db.invoices.slice(-8).reverse().map(i=>({
        type:"Rechnung",
        text:`${i.no} ‚Ä¢ ${i.customerName||""}`,
        date:(i.createdAt||"").slice(0,10),
        amount:euro(i.net||0)
      }));

      el("recentList").innerHTML = rows.map(r=>`
        <tr>
          <td>${r.type}</td>
          <td>${escapeHTML(r.text)}</td>
          <td>${r.date}</td>
          <td class="right">${r.amount}</td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Noch keine Daten.</td></tr>`;
    }
  };

  const Customers = {
    bind(){
      el("c_search").addEventListener("input", ()=>Customers.render());
    },
    add(){
      const name = val("c_name"); if(!name){alert("Name required"); return;}
      const obj = {id:safeId(), name, email:val("c_email"), phone:val("c_phone"), addr:val("c_addr"), createdAt:nowISO()};
      App.db.customers.push(obj);
      Store.save(App.db);
      Customers.clear();
      UI.refreshAll();
    },
    clear(){
      setVal("c_name",""); setVal("c_email",""); setVal("c_phone",""); setVal("c_addr","");
    },
    remove(id){
      if(!confirm("Delete customer?")) return;
      App.db.customers = App.db.customers.filter(c=>c.id!==id);
      Store.save(App.db);
      UI.refreshAll();
    },
    render(){
      const q = (val("c_search")||"").toLowerCase();
      const list = App.db.customers.filter(c =>
        !q || (c.name||"").toLowerCase().includes(q) || (c.email||"").toLowerCase().includes(q)
      );

      el("customersList").innerHTML = list.map(c=>`
        <tr>
          <td>${escapeHTML(c.name)}</td>
          <td>${escapeHTML(c.email||"")}</td>
          <td>${escapeHTML(c.addr||"")}</td>
          <td class="right"><button class="btn danger" onclick="Customers.remove('${c.id}')">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Keine Kunden.</td></tr>`;

      const sel = el("i_customer");
      const cur = sel.value;
      sel.innerHTML = `<option value="">‚Äî Bitte w√§hlen ‚Äî</option>` + App.db.customers.map(c=>`<option value="${c.id}">${escapeHTML(c.name)}</option>`).join("");
      if(cur) sel.value = cur;
    }
  };

  const Invoices = {
    bind(){
      el("i_net").addEventListener("input", ()=>Invoices.preview());
      el("i_search").addEventListener("input", ()=>Invoices.render());
      el("i_filter").addEventListener("change", ()=>Invoices.render());
      el("i_customer").addEventListener("change", ()=>Invoices.render());
      Invoices.preview();
    },
    ensureInvoiceNo(){
      const year = new Date().getFullYear();
      const prefix = `MS-${year}-`;
      const max = App.db.invoices
        .filter(i => (i.no||"").startsWith(prefix))
        .map(i => parseInt((i.no||"").split("-").pop()||"0",10))
        .reduce((m,n)=>Math.max(m,n||0),0);
      const next = String(max+1).padStart(4,"0");
      setVal("i_no", prefix+next);
    },
    preview(){
      const net = Number(val("i_net")||0);
      el("i_previewNote").textContent = `Gesamt: ${euro(net)} ‚Ä¢ Umsatzsteuer: 0,00 ‚Ç¨ ‚Ä¢ Hinweis: ¬ß19 UStG`;
    },
    add(){
      const customerId = val("i_customer"); if(!customerId){alert("Kunde w√§hlen"); return;}
      const customer = App.db.customers.find(c=>c.id===customerId);
      const no = el("i_no").value || "";
      const vonbis = val("i_vonbis"); if(!vonbis){alert("Zeitraum (Von‚Ä¶bis) required"); return;}
      const desc = val("i_desc"); if(!desc){alert("Beschreibung required"); return;}
      const net = Number(val("i_net")||0);

      const obj = {
        id:safeId(),
        no,
        vonbis,
        customerId,
        customerName: customer?.name || "",
        customerAddr: customer?.addr || "",
        customerEmail: customer?.email || "",
        desc,
        net,
        status: val("i_status"),
        createdAt: nowISO()
      };

      App.db.invoices.push(obj);
      Store.save(App.db);

      Invoices.clear();
      Invoices.ensureInvoiceNo();
      UI.refreshAll();
    },
    clear(){
      setVal("i_vonbis","");
      setVal("i_customer","");
      setVal("i_desc","");
      setVal("i_net","");
      setVal("i_status","Entwurf");
      Invoices.preview();
    },
    remove(id){
      if(!confirm("Delete invoice?")) return;
      App.db.invoices = App.db.invoices.filter(i=>i.id!==id);
      Store.save(App.db);
      Invoices.ensureInvoiceNo();
      UI.refreshAll();
    },
    render(){
      const q = (val("i_search")||"").toLowerCase();
      const st = val("i_filter");
      const list = App.db.invoices.filter(i=>{
        const hit = !q || (i.no||"").toLowerCase().includes(q) || (i.customerName||"").toLowerCase().includes(q);
        const ok  = !st || i.status===st;
        return hit && ok;
      }).slice().reverse();

      el("invoicesList").innerHTML = list.map(i=>`
        <tr>
          <td>${escapeHTML(i.no)}</td>
          <td>${escapeHTML(i.customerName||"")}</td>
          <td>${escapeHTML(i.vonbis||"")}</td>
          <td>${escapeHTML(i.status||"")}</td>
          <td class="right">${euro(i.net||0)}</td>
          <td class="right">
            <button class="btn" onclick="Invoices.print('${i.id}')">PDF</button>
            <button class="btn danger" onclick="Invoices.remove('${i.id}')">Delete</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="6" class="muted">Keine Rechnungen.</td></tr>`;
    },
    print(id){
      const inv = id ? App.db.invoices.find(x=>x.id===id) : null;
      const s = App.db.settings;

      const data = inv || {
        no: el("i_no").value,
        vonbis: val("i_vonbis"),
        customerName: (App.db.customers.find(c=>c.id===val("i_customer"))||{}).name || "",
        customerAddr: (App.db.customers.find(c=>c.id===val("i_customer"))||{}).addr || "",
        customerEmail: (App.db.customers.find(c=>c.id===val("i_customer"))||{}).email || "",
        desc: val("i_desc"),
        net: Number(val("i_net")||0),
        status: val("i_status")
      };

      const today = new Date().toISOString().slice(0,10);

      const html =
        `<div class="printDoc">
          <div class="printHeader">
            <div>
              <h1>Rechnung</h1>
              <div><b>${escapeHTML(s.company||"")}</b></div>
              <div>${escapeHTML(s.address||"")}</div>
              <div>E-Mail: ${escapeHTML(s.email||"")}</div>
              ${s.phone ? `<div>Tel: ${escapeHTML(s.phone)}</div>` : ``}
              ${s.steuernummer ? `<div>Steuernummer: ${escapeHTML(s.steuernummer)}</div>` : ``}
              ${s.iban ? `<div>IBAN: ${escapeHTML(s.iban)} ‚Ä¢ BIC: ${escapeHTML(s.bic||"")}</div>` : ``}
            </div>
            <div style="text-align:right">
              <div><b>Rechnungs-Nr.:</b> ${escapeHTML(data.no||"")}</div>
              <div><b>Datum:</b> ${escapeHTML(today)}</div>
              <div><b>Zeitraum:</b> ${escapeHTML(data.vonbis||"")}</div>
              <div><b>Status:</b> ${escapeHTML(data.status||"")}</div>
            </div>
          </div>

          <div class="printBox">
            <div><b>Kunde</b></div>
            <div>${escapeHTML(data.customerName||"")}</div>
            ${data.customerAddr ? `<div>${escapeHTML(data.customerAddr)}</div>` : ``}
            ${data.customerEmail ? `<div>${escapeHTML(data.customerEmail)}</div>` : ``}
          </div>

          <table class="printTable">
            <thead><tr><th>Leistung</th><th class="printRight">Netto</th></tr></thead>
            <tbody>
              <tr>
                <td>${escapeHTML(data.desc||"")}</td>
                <td class="printRight">${euro(data.net||0)}</td>
              </tr>
            </tbody>
          </table>

          <div style="margin-top:12px; text-align:right">
            <div>Zwischensumme: ${euro(data.net||0)}</div>
            <div>Umsatzsteuer: 0,00 ‚Ç¨</div>
            <div><b>Gesamt: ${euro(data.net||0)}</b></div>
          </div>

          <div style="margin-top:12px">
            Hinweis: Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.
          </div>
        </div>`;

      const pa = el("printArea");
      pa.innerHTML = html;
      pa.style.display = "block";
      window.print();
      pa.style.display = "none";
      pa.innerHTML = "";
    }
  };

  const Settings = {
    loadToUI(){
      const s = App.db.settings;
      setVal("s_company", s.company||"");
      setVal("s_address", s.address||"");
      setVal("s_email", s.email||"");
      setVal("s_phone", s.phone||"");
      setVal("s_steuernummer", s.steuernummer||"");
      setVal("s_iban", s.iban||"");
      setVal("s_bic", s.bic||"");
      setVal("s_theme", s.theme||"dark");
    },
    save(){
      App.db.settings.company = val("s_company");
      App.db.settings.address = val("s_address");
      App.db.settings.email = val("s_email");
      App.db.settings.phone = val("s_phone");
      App.db.settings.steuernummer = val("s_steuernummer");
      App.db.settings.iban = val("s_iban");
      App.db.settings.bic = val("s_bic");
      App.db.settings.theme = val("s_theme");
      Store.save(App.db);
      Settings.applyTheme(App.db.settings.theme);
      UI.refreshAll();
      alert("Saved");
    },
    applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme==="light" ? "light" : "dark");
    }
  };

  window.Customers = Customers;
  window.Invoices = Invoices;
  window.Settings = Settings;
  window.App = App;
  window.UI = UI;

  App.init();
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Dienstplan</title>
  <meta name="theme-color" content="#0a3e78"/>

  <style>
    :root{
      --bg1:#06213f;
      --bg2:#0a3e78;
      --panel: rgba(255,255,255,.10);
      --panel2: rgba(255,255,255,.14);
      --line: rgba(255,255,255,.18);

      --text:#ffffff;
      --muted:#e6f2ff;

      --accent:#59b0ff;
      --accent2:#2c7dff;
      --good:#2bd4bd;
      --warn:#ffd166;
      --bad:#ff4d6d;

      --shadow: 0 18px 45px rgba(0,0,0,.25);
      --r:18px;
      --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(89,176,255,.35), transparent 60%),
        radial-gradient(900px 600px at 120% 10%, rgba(44,125,255,.25), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    a{color:var(--text); text-decoration:none}
    .wrap{max-width:1180px; margin:22px auto; padding:0 14px 40px}
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 16px; border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius:22px; box-shadow:var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .logo{
      width:54px; height:54px; border-radius:14px; overflow:hidden;
      border:1px solid var(--line); background:rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .brand h1{font-size:16px; margin:0 0 4px 0; letter-spacing:.6px}
    .brand .meta{font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background:rgba(255,255,255,.10); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }

    .nav{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end}
    .btn{
      cursor:pointer; border:1px solid var(--line);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px; border-radius:999px; font-weight:700;
      display:inline-flex; gap:8px; align-items:center;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.14)}
    .btn.primary{background:linear-gradient(180deg, rgba(89,176,255,.35), rgba(44,125,255,.25))}
    .btn.good{background:linear-gradient(180deg, rgba(43,212,189,.35), rgba(43,212,189,.18))}
    .btn.warn{background:linear-gradient(180deg, rgba(255,209,102,.35), rgba(255,209,102,.18))}
    .btn.bad{background:linear-gradient(180deg, rgba(255,77,109,.35), rgba(255,77,109,.18))}
    .btn.small{padding:8px 10px; font-size:12px}

    .grid{
      margin-top:14px;
      display:grid; grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
      .nav{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius:22px; box-shadow:var(--shadow);
      padding:16px;
      min-height:120px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:15px; letter-spacing:.4px;
    }
    .sub{font-size:12px; color:var(--muted); margin-top:-6px; margin-bottom:12px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:7px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(230,242,255,.65)}
    textarea{min-height:92px; resize:vertical}

    .daychips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      cursor:pointer;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .chip.active{background:rgba(89,176,255,.35); border-color:rgba(89,176,255,.65)}
    .chip:active{transform:translateY(1px)}

    .inline{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .status{
      font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:9px; height:9px; border-radius:50%; background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    thead th{
      font-size:12px;
      text-align:left;
      color:var(--muted);
      padding:12px 12px;
      background:rgba(255,255,255,.06);
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      display:inline-flex; align-items:center; gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      font-weight:800;
      font-size:12px;
    }

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px}
    .tab{
      cursor:pointer; border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px; border-radius:999px; font-weight:900;
    }
    .tab.active{background:rgba(89,176,255,.35); border-color:rgba(89,176,255,.65)}

    /* PRINT / PDF STYLE (looks like real Dienstplan) */
    @media print{
      body{background:#fff !important; color:#111 !important}
      .wrap{max-width:100%; margin:0; padding:0}
      .top, .grid, .no-print{display:none !important}
      #printArea{display:block !important}
    }

    #printArea{display:none}
    .paper{
      padding:18mm 16mm;
      font-family: "Times New Roman", Times, serif;
      color:#111;
    }
    .paperHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10mm;
    }
    .paperBrand{
      display:flex; align-items:center; gap:10px;
    }
    .paperLogo{
      width:26mm; height:26mm; border:1px solid #ccc; border-radius:6mm; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .paperLogo img{width:100%; height:100%; object-fit:cover}
    .paperTitle{
      text-align:center;
      font-size:18px;
      font-weight:900;
      color:#0a3e78;
      flex:1;
    }
    .paperMeta{
      font-size:11px;
      text-align:right;
      line-height:1.25;
    }
    .paperBoxTitle{
      text-align:center;
      font-size:15px;
      font-weight:900;
      margin:8mm 0 3mm;
      color:#c21f2b; /* similar red like sample */
    }
    .paperTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:4mm;
    }
    .paperTable th, .paperTable td{
      border:1px solid #444;
      padding:6px;
      vertical-align:top;
    }
    .paperTable th{
      background:#e9f3ff;
      color:#0a3e78;
      font-weight:900;
      text-align:center;
    }
    .paperNote{
      margin-top:10mm;
      font-size:11px;
      line-height:1.35;
      text-align:center;
    }
    .paperFooter{
      margin-top:10mm;
      display:flex; justify-content:space-between; align-items:flex-end;
      font-size:10px;
      color:#444;
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- TOP BAR -->
  <div class="top no-print">
    <div class="brand">
      <div class="logo"><img id="topLogo" src="logo.png" alt="Logo" onerror="this.style.display='none'"/></div>
      <div>
        <h1>MASCULINE SECURITY — Dienstplan</h1>
        <div class="meta">
          <span class="pill" id="metaAddr">Adresse: Werschenregerstraße 6 • 28237 Bremen</span>
          <span class="pill" id="metaTel">Tel: 015778697052</span>
          <span class="pill" id="metaMail">E-Mail: Kontakt.mass.bremen@hotmail.com</span>
        </div>
        <div class="meta" style="margin-top:8px;">
          <span class="pill"><b>Auto-Update:</b> <span id="autoState">AN</span></span>
          <span class="pill"><b>Status:</b> <span id="statusText">Bereit.</span></span>
        </div>
      </div>
    </div>

    <div class="nav">
      <button class="btn tab active" id="tabPlan">Wochenplan</button>
      <button class="btn tab" id="tabDocs">Dokumentation</button>
      <button class="btn primary" id="btnPrint">Drucken</button>
      <button class="btn primary" id="btnPDF">PDF</button>
      <button class="btn good" id="btnWA">WhatsApp senden</button>
      <button class="btn" id="btnCSV">Export CSV</button>
      <button class="btn bad" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid no-print" id="viewPlan">

    <!-- LEFT: FORM -->
    <div class="card">
      <h2>Wöchentlicher Mitarbeiter-Dienstplan</h2>
      <div class="sub">Arbeitstage dooro adigoo <b>gujinaya</b>. Schicht (Tag/Nacht) + Uhrzeit waa <b>automatic</b> (Objekt-ka ku saleeya), laakiin waad beddeli kartaa.</div>

      <div class="row">
        <div class="field">
          <label>Firmenname</label>
          <input id="companyName" placeholder="Masculine Security" value="Masculine Security"/>
        </div>
        <div class="field">
          <label>Logo (optional) — Upload (wuu xasuusanayaa)</label>
          <input id="logoFile" type="file" accept="image/*"/>
        </div>

        <div class="field">
          <label>Adresse</label>
          <input id="companyAddr" placeholder="Werschenregerstraße 6, 28237 Bremen" value="Werschenregerstraße 6, 28237 Bremen"/>
        </div>
        <div class="field">
          <label>Telefon</label>
          <input id="companyPhone" placeholder="015778697052" value="015778697052"/>
        </div>

        <div class="field">
          <label>E-Mail</label>
          <input id="companyEmail" placeholder="Kontakt.mass.bremen@hotmail.com" value="Kontakt.mass.bremen@hotmail.com"/>
        </div>
        <div class="field">
          <label>KW (optional)</label>
          <input id="kw" placeholder="z.B. 32"/>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="row">
        <div class="field">
          <label>Mitarbeiter-Nr. (optional)</label>
          <input id="empNo" placeholder="z.B. MS-001"/>
        </div>
        <div class="field">
          <label>Mitarbeiter Name</label>
          <input id="empName" placeholder="z.B. Mustafa Mursal Abdi"/>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label>Arbeitstage (kala dooro — click)</label>
        <div class="daychips" id="dayChips"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Objekt / Einsatz</label>
          <input id="objekt" placeholder="z.B. LAST Birkenfels"/>
        </div>
        <div class="field">
          <label>Notiz (optional)</label>
          <input id="note" placeholder="z.B. Tor 2 / Schlüssel / Uniform"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Schicht (Tag/Nacht) — automatisch</label>
          <select id="shift">
            <option value="auto">Automatisch</option>
            <option value="tag">Tag</option>
            <option value="nacht">Nacht</option>
          </select>
        </div>
        <div class="field">
          <label>Uhrzeit — automatisch</label>
          <input id="time" placeholder="z.B. 07:00–19:00" />
        </div>
      </div>

      <div class="inline" style="margin-top:14px">
        <div class="status"><span class="dot" id="dot"></span><span id="status">Bereit.</span></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="btn small" id="btnAuto">Auto-Update: AN/AUS</button>
          <button class="btn good" id="btnSave">+ Eintrag speichern</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: PREVIEW + TABLE -->
    <div class="card">
      <h2>Vorschau (Text an Mitarbeiter senden)</h2>
      <div class="sub">Kopieren & direkt in WhatsApp/Email einfügen — oder Button „WhatsApp senden“.</div>

      <div class="field">
        <label>Vorschau</label>
        <textarea id="msgPreview" readonly></textarea>
      </div>

      <div class="inline" style="margin-top:10px">
        <div class="actions">
          <button class="btn" id="btnCopy">Text kopieren</button>
          <button class="btn good" id="btnWA2">WhatsApp (Text)</button>
        </div>
        <span class="pill">PDF wuxuu ka soo baxaa button: <b>PDF</b></span>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <h2>Gespeicherte Wochenpläne</h2>
      <div class="sub">Qoraalkan ayaa PDF-ga si otomaatig ah ugu muuqanaya.</div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Mitarbeiter</th>
              <th>Nr</th>
              <th>Tage</th>
              <th>Schicht</th>
              <th>Uhrzeit</th>
              <th>Objekt</th>
              <th>Notiz</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- DOCUMENTATION VIEW -->
  <div class="grid no-print" id="viewDocs" style="display:none">
    <div class="card">
      <h2>Dokumentation</h2>
      <div class="sub">Halkan ku qor “Ereignisse / Vorfälle / Notizen” — waa la keydinayaa (LocalStorage).</div>

      <div class="row">
        <div class="field">
          <label>Titel</label>
          <input id="docTitle" placeholder="z.B. Vorfall / Übergabe / Kontrolle"/>
        </div>
        <div class="field">
          <label>Datum</label>
          <input id="docDate" placeholder="z.B. 2026-02-15"/>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label>Beschreibung</label>
        <textarea id="docText" placeholder="Kurze Beschreibung..."></textarea>
      </div>

      <div class="inline" style="margin-top:12px">
        <div class="status"><span class="dot" id="docDot"></span><span id="docStatus">Bereit.</span></div>
        <div class="actions">
          <button class="btn good" id="btnDocAdd">+ Speichern</button>
          <button class="btn" id="btnDocPrint">Drucken</button>
          <button class="btn" id="btnDocExport">Export JSON</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Gespeicherte Dokumentation</h2>
      <div class="sub">Waxaad ka delete-gareyn kartaa hal item ama dhamaantood.</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Datum</th>
              <th>Titel</th>
              <th>Text</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="docBody"></tbody>
        </table>
      </div>

      <div class="inline" style="margin-top:12px">
        <span class="pill">Tip: PDF u samee adigoo <b>Drucken</b> → Save as PDF</span>
        <button class="btn bad" id="btnDocReset">Dokumentation löschen</button>
      </div>
    </div>
  </div>

  <!-- PRINT AREA (PDF DESIGN LIKE SAMPLE) -->
  <div id="printArea">
    <div class="paper">
      <div class="paperHeader">
        <div class="paperBrand">
          <div class="paperLogo"><img id="paperLogo" src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
          <div style="font-family:Arial, sans-serif; font-size:12px; line-height:1.25">
            <div style="font-weight:900; color:#0a3e78" id="pCompany">Masculine Security</div>
            <div id="pAddr">Werschenregerstraße 6, 28237 Bremen</div>
            <div id="pContact">Tel: 015778697052 • E-Mail: Kontakt.mass.bremen@hotmail.com</div>
          </div>
        </div>

        <div class="paperTitle">Vorläufiger Dienstplan</div>

        <div class="paperMeta">
          <div><b>Dienstplan KW</b> <span id="pKW">—</span></div>
          <div><b>Datum:</b> <span id="pDate">—</span></div>
        </div>
      </div>

      <table class="paperTable">
        <thead>
          <tr>
            <th style="width:28mm">Mitarbeiter</th>
            <th style="width:20mm">Nr</th>
            <th style="width:26mm">Tage</th>
            <th style="width:18mm">Schicht</th>
            <th style="width:22mm">Uhrzeit</th>
            <th>Objekt / Einsatz</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody id="paperRows"></tbody>
      </table>

      <div class="paperBoxTitle">DRINGEND BEACHTEN:</div>
      <div class="paperNote" id="pRules">
        Dienstantritt ist 20 Minuten vor Dienstbeginn!<br/>
        Verspätungen und Ausfälle des Dienstantritts sind unverzüglich telefonisch zu melden!<br/>
        Freiwünsche werden spätestens am Donnerstag schriftlich der Einsatzleitung mitgeteilt!<br/>
        Der Stundenzettel wird 2 Tage vor Monatsende bei der Einsatzleitung eingereicht!
      </div>

      <div class="paperFooter">
        <div>Seite 1 von 1</div>
        <div id="pFooterRight">Erstellt mit Masculine Security Dienstplan</div>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id)=>document.getElementById(id);
  const days = [
    {key:"Mo", label:"Montag"},
    {key:"Di", label:"Dienstag"},
    {key:"Mi", label:"Mittwoch"},
    {key:"Do", label:"Donnerstag"},
    {key:"Fr", label:"Freitag"},
    {key:"Sa", label:"Samstag"},
    {key:"So", label:"Sonntag"},
  ];

  const STORAGE_KEY = "ms_dienstplan_v9";
  const DOC_KEY = "ms_docs_v1";
  const LOGO_KEY = "ms_logo_dataurl";
  const META_KEY = "ms_company_meta_v1";

  const SHIFT_TIMES = {
    tag: "07:00–19:00",
    nacht: "19:00–07:00"
  };

  const isNightByObjekt = (obj) => {
    const s = (obj || "").toLowerCase();
    // keywords for night
    return /(nacht|night|n8|ns|nachtdienst|nachtschicht)/.test(s);
  };

  const normalizeTime = (t) => (t || "").replace(/\s+/g,"").replaceAll("-", "–");

  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  function setStatus(text, type="good"){
    $("status").textContent = text;
    $("statusText").textContent = text;
    const dot = $("dot");
    dot.className = "dot";
    if(type==="warn") dot.classList.add("warn");
    if(type==="bad") dot.classList.add("bad");
  }

  function setDocStatus(text, type="good"){
    $("docStatus").textContent = text;
    const dot = $("docDot");
    dot.className = "dot";
    if(type==="warn") dot.classList.add("warn");
    if(type==="bad") dot.classList.add("bad");
  }

  // ---------- State ----------
  let state = {
    autoUpdate: true,
    selectedDays: ["Mo"],
    entries: []
  };

  let docs = [];

  // ---------- Day chips ----------
  function renderDayChips(){
    const wrap = $("dayChips");
    wrap.innerHTML = "";
    for(const d of days){
      const b = document.createElement("button");
      b.type="button";
      b.className = "chip" + (state.selectedDays.includes(d.key) ? " active" : "");
      b.textContent = d.label;
      b.addEventListener("click", () => {
        const idx = state.selectedDays.indexOf(d.key);
        if(idx >= 0) state.selectedDays.splice(idx,1);
        else state.selectedDays.push(d.key);
        // keep stable order
        state.selectedDays.sort((a,b)=> days.findIndex(x=>x.key===a) - days.findIndex(x=>x.key===b));
        renderDayChips();
        buildMessagePreview();
        autosaveSoon();
      });
      wrap.appendChild(b);
    }
  }

  // ---------- Meta / Logo ----------
  function applyMetaToHeader(){
    const name = $("companyName").value.trim() || "Masculine Security";
    const addr = $("companyAddr").value.trim() || "—";
    const phone = $("companyPhone").value.trim() || "—";
    const email = $("companyEmail").value.trim() || "—";

    $("metaAddr").textContent = `Adresse: ${addr}`;
    $("metaTel").textContent = `Tel: ${phone}`;
    $("metaMail").textContent = `E-Mail: ${email}`;

    // paper
    $("pCompany").textContent = name;
    $("pAddr").textContent = addr;
    $("pContact").textContent = `Tel: ${phone} • E-Mail: ${email}`;
  }

  function loadLogo(){
    const dataUrl = localStorage.getItem(LOGO_KEY);
    if(dataUrl){
      $("topLogo").src = dataUrl;
      $("paperLogo").src = dataUrl;
    }else{
      $("topLogo").src = "logo.png";
      $("paperLogo").src = "logo.png";
    }
  }

  async function handleLogoUpload(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      localStorage.setItem(LOGO_KEY, dataUrl);
      loadLogo();
      setStatus("Logo gespeichert.", "good");
    };
    reader.readAsDataURL(file);
  }

  function saveMeta(){
    const meta = {
      companyName: $("companyName").value,
      companyAddr: $("companyAddr").value,
      companyPhone: $("companyPhone").value,
      companyEmail: $("companyEmail").value,
      kw: $("kw").value
    };
    localStorage.setItem(META_KEY, JSON.stringify(meta));
  }

  function loadMeta(){
    const raw = localStorage.getItem(META_KEY);
    if(!raw) return;
    try{
      const meta = JSON.parse(raw);
      if(meta.companyName) $("companyName").value = meta.companyName;
      if(meta.companyAddr) $("companyAddr").value = meta.companyAddr;
      if(meta.companyPhone) $("companyPhone").value = meta.companyPhone;
      if(meta.companyEmail) $("companyEmail").value = meta.companyEmail;
      if(meta.kw) $("kw").value = meta.kw;
    }catch{}
  }

  // ---------- Auto shift/time ----------
  function applyAutoShiftAndTime(){
    const obj = $("objekt").value.trim();
    const shiftSel = $("shift").value;

    // if manual tag/nacht selected, use that
    let shift;
    if(shiftSel === "tag") shift = "tag";
    else if(shiftSel === "nacht") shift = "nacht";
    else shift = isNightByObjekt(obj) ? "nacht" : "tag";

    // set time automatic if empty OR if currently equals one of default values OR shift is auto
    const timeEl = $("time");
    const cur = normalizeTime(timeEl.value.trim());
    const curIsDefault = (cur === SHIFT_TIMES.tag || cur === SHIFT_TIMES.nacht || cur === "" );

    if(curIsDefault || shiftSel === "auto"){
      timeEl.value = SHIFT_TIMES[shift];
    }

    // Show status line in form as hint (optional)
    // nothing printed to page bottom
  }

  // ---------- Message preview ----------
  function buildMessagePreview(){
    applyMetaToHeader();

    const name = $("companyName").value.trim() || "Masculine Security";
    const addr = $("companyAddr").value.trim() || "—";
    const phone = $("companyPhone").value.trim() || "—";
    const email = $("companyEmail").value.trim() || "—";
    const kw = ($("kw").value.trim() || "—");

    const empName = $("empName").value.trim() || "—";
    const empNo = $("empNo").value.trim() || "—";
    const objekt = $("objekt").value.trim() || "—";
    const note = $("note").value.trim() || "—";

    const shiftSel = $("shift").value;
    let shift;
    if(shiftSel==="tag") shift = "Tag";
    else if(shiftSel==="nacht") shift = "Nacht";
    else shift = isNightByObjekt(objekt) ? "Nacht" : "Tag";

    const time = normalizeTime($("time").value.trim()) || (shift==="Nacht" ? SHIFT_TIMES.nacht : SHIFT_TIMES.tag);
    const dayLabels = state.selectedDays.map(k => days.find(d=>d.key===k)?.label).filter(Boolean);
    const dayShort = state.selectedDays.join(", ");

    const text =
`${name} — Dienstplan (KW ${kw})

Mitarbeiter: ${empName}
Mitarbeiter-Nr: ${empNo}
Tage: ${dayLabels.join(", ")} (${dayShort})
Schicht: ${shift}
Uhrzeit: ${time}
Objekt: ${objekt}
Notiz: ${note}

Kontakt:
Adresse: ${addr}
Tel: ${phone}
E-Mail: ${email}`;

    $("msgPreview").value = text;
  }

  // ---------- Entries table ----------
  function escapeHTML(s){
    return (s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function renderEntries(){
    const tb = $("tbody");
    tb.innerHTML = "";

    if(state.entries.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="9" style="color:var(--muted)">Noch keine Einträge.</td>`;
      tb.appendChild(tr);
      return;
    }

    state.entries.forEach((e, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHTML(e.empName)}</td>
        <td>${escapeHTML(e.empNo || "—")}</td>
        <td>${escapeHTML(e.daysText)}</td>
        <td><span class="tag">${escapeHTML(e.shift)}</span></td>
        <td>${escapeHTML(e.time)}</td>
        <td>${escapeHTML(e.objekt)}</td>
        <td>${escapeHTML(e.note || "—")}</td>
        <td>
          <div class="actions">
            <button class="btn small" data-act="wa" data-i="${idx}">WA</button>
            <button class="btn small" data-act="del" data-i="${idx}">Delete</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    // actions
    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const act = btn.getAttribute("data-act");
        const i = Number(btn.getAttribute("data-i"));
        if(Number.isNaN(i)) return;

        if(act==="del"){
          state.entries.splice(i,1);
          saveState();
          renderEntries();
          buildMessagePreview();
          setStatus("Eintrag gelöscht.", "warn");
        }
        if(act==="wa"){
          const msg = buildWhatsAppTextFromEntry(state.entries[i]);
          openWhatsAppWeb(msg);
        }
      });
    });
  }

  function buildWhatsAppTextFromEntry(e){
    const name = $("companyName").value.trim() || "Masculine Security";
    const addr = $("companyAddr").value.trim() || "—";
    const phone = $("companyPhone").value.trim() || "—";
    const email = $("companyEmail").value.trim() || "—";
    const kw = ($("kw").value.trim() || "—");

    return `${name} — Dienstplan (KW ${kw})

Mitarbeiter: ${e.empName}
Mitarbeiter-Nr: ${e.empNo || "—"}
Tage: ${e.daysText}
Schicht: ${e.shift}
Uhrzeit: ${e.time}
Objekt: ${e.objekt}
Notiz: ${e.note || "—"}

Kontakt:
Adresse: ${addr}
Tel: ${phone}
E-Mail: ${email}`;
  }

  // ---------- Save entry ----------
  function addEntry(){
    applyAutoShiftAndTime();
    buildMessagePreview();

    const empName = $("empName").value.trim();
    if(!empName){
      setStatus("Bitte Mitarbeiter Name eingeben.", "bad");
      return;
    }

    const objekt = $("objekt").value.trim();
    if(!objekt){
      setStatus("Bitte Objekt / Einsatz eingeben.", "bad");
      return;
    }

    const empNo = $("empNo").value.trim();
    const note = $("note").value.trim();
    const shiftSel = $("shift").value;

    let shift = "Tag";
    if(shiftSel==="tag") shift = "Tag";
    else if(shiftSel==="nacht") shift = "Nacht";
    else shift = isNightByObjekt(objekt) ? "Nacht" : "Tag";

    const time = normalizeTime($("time").value.trim()) || (shift==="Nacht" ? SHIFT_TIMES.nacht : SHIFT_TIMES.tag);

    const daysText = state.selectedDays.map(k => days.find(d=>d.key===k)?.label).filter(Boolean).join(", ");

    state.entries.push({
      empName,
      empNo,
      days: [...state.selectedDays],
      daysText,
      shift,
      time,
      objekt,
      note
    });

    saveState();
    renderEntries();
    setStatus("Eintrag gespeichert.", "good");
  }

  // ---------- PDF / Print ----------
  function buildPaper(){
    applyMetaToHeader();
    loadLogo();

    $("pKW").textContent = ($("kw").value.trim() || "—");
    $("pDate").textContent = todayISO();

    const rows = $("paperRows");
    rows.innerHTML = "";

    if(state.entries.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="text-align:center; padding:10px;">Keine Einträge</td>`;
      rows.appendChild(tr);
      return;
    }

    state.entries.forEach(e=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(e.empName)}</td>
        <td>${escapeHTML(e.empNo || "—")}</td>
        <td>${escapeHTML(e.daysText)}</td>
        <td style="text-align:center; font-weight:900; color:#0a3e78">${escapeHTML(e.shift)}</td>
        <td style="text-align:center">${escapeHTML(e.time)}</td>
        <td>${escapeHTML(e.objekt)}</td>
        <td>${escapeHTML(e.note || "—")}</td>
      `;
      rows.appendChild(tr);
    });
  }

  function doPrintPDF(){
    buildPaper();
    window.print(); // user chooses "Save as PDF"
  }

  // ---------- WhatsApp ----------
  function openWhatsAppWeb(text){
    if(!text) return;
    // Mobile share if available
    if(navigator.share){
      navigator.share({title:"Dienstplan", text}).catch(()=>{});
      return;
    }
    const url = "https://web.whatsapp.com/send?text=" + encodeURIComponent(text);
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function sendWhatsAppFromPreview(){
    const text = ($("msgPreview").value || "").trim();
    if(!text){
      setStatus("Kein Text vorhanden.", "bad");
      return;
    }
    openWhatsAppWeb(text);
    setStatus("WhatsApp Web geöffnet (Text).", "good");
  }

  // ---------- CSV ----------
  function exportCSV(){
    if(state.entries.length===0){
      setStatus("Keine Daten für CSV.", "warn");
      return;
    }
    const headers = ["Mitarbeiter","Nr","Tage","Schicht","Uhrzeit","Objekt","Notiz"];
    const lines = [headers.join(";")];
    state.entries.forEach(e=>{
      const row = [
        e.empName,
        e.empNo || "",
        e.daysText,
        e.shift,
        e.time,
        e.objekt,
        e.note || ""
      ].map(v => `"${String(v).replaceAll('"','""')}"`);
      lines.push(row.join(";"));
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dienstplan.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setStatus("CSV exportiert.", "good");
  }

  // ---------- Docs ----------
  function loadDocs(){
    const raw = localStorage.getItem(DOC_KEY);
    if(!raw){ docs = []; return; }
    try{ docs = JSON.parse(raw) || []; }catch{ docs = []; }
  }
  function saveDocs(){
    localStorage.setItem(DOC_KEY, JSON.stringify(docs));
  }
  function renderDocs(){
    const tb = $("docBody");
    tb.innerHTML = "";
    if(docs.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" style="color:var(--muted)">Noch keine Dokumentation.</td>`;
      tb.appendChild(tr);
      return;
    }
    docs.forEach((d, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHTML(d.date)}</td>
        <td>${escapeHTML(d.title)}</td>
        <td>${escapeHTML(d.text).slice(0,140)}${d.text.length>140?"…":""}</td>
        <td><button class="btn small" data-docdel="${idx}">Delete</button></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("button[data-docdel]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = Number(b.getAttribute("data-docdel"));
        docs.splice(i,1);
        saveDocs();
        renderDocs();
        setDocStatus("Eintrag gelöscht.", "warn");
      });
    });
  }

  function addDoc(){
    const title = $("docTitle").value.trim();
    const date = ($("docDate").value.trim() || todayISO());
    const text = $("docText").value.trim();

    if(!title || !text){
      setDocStatus("Titel und Text sind Pflicht.", "bad");
      return;
    }

    docs.unshift({title, date, text});
    saveDocs();
    renderDocs();
    $("docTitle").value = "";
    $("docText").value = "";
    $("docDate").value = "";
    setDocStatus("Gespeichert.", "good");
  }

  function exportDocsJSON(){
    const blob = new Blob([JSON.stringify(docs, null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dokumentation.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setDocStatus("Exportiert (JSON).", "good");
  }

  function printDocs(){
    // simple print: reuse printArea temporarily
    const old = $("paperRows").innerHTML;
    $("pKW").textContent = "Dokumentation";
    $("pDate").textContent = todayISO();

    const rows = $("paperRows");
    rows.innerHTML = "";
    const trHead = document.createElement("tr");
    trHead.innerHTML = `
      <td colspan="7" style="font-weight:900; color:#0a3e78; text-align:center">
        Dokumentation (Auszug)
      </td>`;
    rows.appendChild(trHead);

    if(docs.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="text-align:center; padding:10px;">Keine Dokumentation</td>`;
      rows.appendChild(tr);
    }else{
      docs.slice(0,18).forEach(d=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="2"><b>${escapeHTML(d.date)}</b></td>
          <td colspan="5"><b>${escapeHTML(d.title)}</b><br/>${escapeHTML(d.text)}</td>
        `;
        rows.appendChild(tr);
      });
    }

    window.print();
    $("paperRows").innerHTML = old;
  }

  // ---------- Autosave ----------
  let saveTimer = null;
  function autosaveSoon(){
    if(!state.autoUpdate) return;
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      saveState();
      setStatus("Auto-gespeichert.", "good");
    }, 450);
  }

  function saveState(){
    const payload = {
      autoUpdate: state.autoUpdate,
      selectedDays: state.selectedDays,
      entries: state.entries
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    saveMeta();
    applyMetaToHeader();
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const p = JSON.parse(raw);
      if(typeof p.autoUpdate === "boolean") state.autoUpdate = p.autoUpdate;
      if(Array.isArray(p.selectedDays)) state.selectedDays = p.selectedDays;
      if(Array.isArray(p.entries)) state.entries = p.entries;
    }catch{}
  }

  // ---------- Tabs ----------
  function setTab(which){
    if(which==="plan"){
      $("viewPlan").style.display = "";
      $("viewDocs").style.display = "none";
      $("tabPlan").classList.add("active");
      $("tabDocs").classList.remove("active");
    }else{
      $("viewPlan").style.display = "none";
      $("viewDocs").style.display = "";
      $("tabDocs").classList.add("active");
      $("tabPlan").classList.remove("active");
    }
  }

  // ---------- Events ----------
  function bind(){
    // tabs
    $("tabPlan").addEventListener("click", ()=>setTab("plan"));
    $("tabDocs").addEventListener("click", ()=>setTab("docs"));

    // meta inputs
    ["companyName","companyAddr","companyPhone","companyEmail","kw"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        applyMetaToHeader();
        buildMessagePreview();
        autosaveSoon();
      });
    });

    // logo upload
    $("logoFile").addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      handleLogoUpload(file);
      autosaveSoon();
    });

    // entry inputs
    ["empNo","empName","objekt","note"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        applyAutoShiftAndTime();
        buildMessagePreview();
        autosaveSoon();
      });
    });

    $("shift").addEventListener("change", ()=>{
      applyAutoShiftAndTime();
      buildMessagePreview();
      autosaveSoon();
    });

    $("time").addEventListener("input", ()=>{
      $("time").value = normalizeTime($("time").value);
      buildMessagePreview();
      autosaveSoon();
    });

    $("btnSave").addEventListener("click", addEntry);

    $("btnAuto").addEventListener("click", ()=>{
      state.autoUpdate = !state.autoUpdate;
      $("autoState").textContent = state.autoUpdate ? "AN" : "AUS";
      setStatus(state.autoUpdate ? "Auto-Update AN" : "Auto-Update AUS", state.autoUpdate ? "good" : "warn");
      saveState();
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const t = $("msgPreview").value || "";
      try{
        await navigator.clipboard.writeText(t);
        setStatus("Kopiert.", "good");
      }catch{
        // fallback
        $("msgPreview").focus();
        $("msgPreview").select();
        document.execCommand("copy");
        setStatus("Kopiert.", "good");
      }
    });

    $("btnWA").addEventListener("click", sendWhatsAppFromPreview);
    $("btnWA2").addEventListener("click", sendWhatsAppFromPreview);

    $("btnCSV").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", doPrintPDF);
    $("btnPDF").addEventListener("click", doPrintPDF);

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("Wirklich alles löschen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(LOGO_KEY);
      localStorage.removeItem(META_KEY);
      state.entries = [];
      state.selectedDays = ["Mo"];
      state.autoUpdate = true;
      $("autoState").textContent = "AN";
      loadLogo();
      renderDayChips();
      renderEntries();
      buildMessagePreview();
      setStatus("Reset 완료.", "warn");
    });

    // docs
    $("btnDocAdd").addEventListener("click", addDoc);
    $("btnDocExport").addEventListener("click", exportDocsJSON);
    $("btnDocPrint").addEventListener("click", printDocs);
    $("btnDocReset").addEventListener("click", ()=>{
      if(!confirm("Dokumentation wirklich löschen?")) return;
      docs = [];
      saveDocs();
      renderDocs();
      setDocStatus("Dokumentation gelöscht.", "warn");
    });
  }

  // ---------- Init ----------
  function init(){
    // build chips
    renderDayChips();

    // load meta/logo/state/docs
    loadMeta();
    loadLogo();
    loadState();
    loadDocs();

    // reflect auto state
    $("autoState").textContent = state.autoUpdate ? "AN" : "AUS";

    renderDayChips();
    renderEntries();
    renderDocs();

    // defaults
    if(!$("docDate").value) $("docDate").value = "";

    // apply automatic time now
    applyAutoShiftAndTime();
    applyMetaToHeader();
    buildMessagePreview();

    // bind events
    bind();

    setStatus("Bereit.", "good");
    setDocStatus("Bereit.", "good");
  }

  // prevent any accidental code dump to page:
  // (No document.write. No injecting script text into DOM.)
  document.addEventListener("DOMContentLoaded", init);
})();
</script>

</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office (Rechnung + Mitarbeiter + Payroll/SV + AI Gesetz Update)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1500px;
      margin:0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:auto;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
      user-select:none;
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px; border:1px solid rgba(255,255,255,.06)}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
      white-space:pre-line;
    }
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 640px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
      white-space:pre-line;
    }
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
<!-- VERSION STAMP -->
<div style="position:fixed;left:10px;bottom:10px;z-index:99999;background:#000a;color:#fff;padding:6px 10px;border-radius:10px;font:12px Arial">
  v9-onefile-ai-gesetz-kinder-pv
</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Rechnung ‚Ä¢ Mitarbeiter ‚Ä¢ Payroll/SV ‚Ä¢ AI Gesetz Update ‚Ä¢ Offline Storage</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll / SV</span><span class="pill" id="pillPayroll">PDF</span></button>
      <button data-page="ai"><span>ü§ñ AI / Gesetz</span><span class="pill">Update</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Hinweis:</b> Rechnung ¬ß19 UStG ‚Üí USt = 0.</div>
      <div class="muted">Update nicht sichtbar? √ñffne Link mit <b>?v=999</b> oder Incognito.</div>
      <div class="muted">Export/Import = Backup.</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Tage + Std/Tag + ‚Ç¨/h ‚Üí Stunden ‚Üí Position 1</small>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnNewInvoice">+ Neue Rechnung</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Alles l√∂schen</button>
      </div>
    </div>

    <div class="content">

      <!-- INVOICES -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen / bearbeiten</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr. (auto)</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>F√§llig am</label><input id="i_due" type="date"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Auto Stunden (optional)</h3>
            <div class="split">
              <div class="field"><label>Tage (inta bari)</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag (saacado maalintii)</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h (qiime saacaddii)</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>
            <div class="note">Menge = <b>Stunden</b> ‚Ä¢ Preis = ‚Ç¨/h ‚Ä¢ Netto = Stunden √ó ‚Ç¨/h.</div>

            <div class="hr"></div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <h3 style="margin:0">Positionen</h3>
              <button class="btn" id="btnAddLine">+ Position</button>
            </div>

            <table class="table" style="margin-top:10px">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto (auto)</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
            </div>

            <div class="note" id="i_preview">Positionen: 0 ‚Ä¢ Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSaveInvoice">Speichern</button>
              <button class="btn" id="btnPrintInvoice">PDF Rechnung (A4)</button>
            </div>

            <input id="i_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Rechnungen Liste</h3>

            <div class="split">
              <div class="field"><label>Suche</label><input id="inv_search" placeholder="Nr / Kunde / Status"/></div>
              <div class="field"><label>Status Filter</label>
                <select id="inv_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Status</th>
                  <th class="right">Total</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>

            <div class="hr"></div>
            <div class="note">
              <b>Tip:</b> Wenn Save nicht geht ‚Üí Browser blockiert Storage. √ñffne in normalem Tab, nicht ‚Äúabout:blank‚Äù.
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde anlegen</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..."/></div>
            <div class="hr"></div>

            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCustomerSave">Speichern</button>
              <button class="btn danger" id="btnCustomerClear">Leeren</button>
            </div>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter anlegen</h3>
            <div class="field"><label>Suche</label><input id="m_search" placeholder="Name, PersNr, Steuer-ID..."/></div>
            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Name</label><input id="m_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Pers.-Nr. (Personalnummer)</label><input id="m_persnr" placeholder="z.B. 4943"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Adresse</label><textarea id="m_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>
              <div class="field"><label>Geburtsdatum (optional)</label><input id="m_dob" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="m_taxid" placeholder="optional"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="m_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Familienstand</label>
                <select id="m_family">
                  <option value="single">single</option>
                  <option value="married">married</option>
                </select>
              </div>
              <div class="field"><label>Kinder (optional)</label><input id="m_children" type="number" step="1" placeholder="0"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Krankenkasse (AOK/Barmer/...)</label>
                <select id="m_kasse">
                  <option value="">(bitte w√§hlen)</option>
                  <option>AOK</option>
                  <option>Barmer</option>
                  <option>TK</option>
                  <option>DAK</option>
                  <option>IKK</option>
                  <option>Knappschaft</option>
                  <option>Sonstige</option>
                </select>
              </div>
              <div class="field"><label>Versicherungs-Nr. (optional)</label><input id="m_kasse_no" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>SV aktiv?</label>
                <select id="m_sv">
                  <option value="yes">ja</option>
                  <option value="no">nein</option>
                </select>
              </div>
              <div class="field"><label>Stundenlohn ‚Ç¨/h</label><input id="m_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnEmployeeSave">Speichern</button>
              <button class="btn danger" id="btnEmployeeClear">Leeren</button>
            </div>

            <div class="hr"></div>
            <div class="note">Krankenkasse + Kinder + Steuerklasse ‚Üí wird im Payroll-PDF angezeigt (slip-style). PV Kinder Beitrag wird automatisch (Estimate) berechnet.</div>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Pers.-Nr</th><th>Kasse</th><th>Klasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Payroll / SV (Simulation)</h3>

            <div class="field"><label>Mitarbeiter</label><select id="p_emp"></select></div>

            <div class="split">
              <div class="field"><label>Monat (YYYY-MM)</label><input id="p_month" placeholder="2026-02"/></div>
              <div class="field"><label>Pers.-Nr. (optional override)</label><input id="p_persnr" placeholder="z.B. 4943"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.25" placeholder="z.B. 216"/></div>
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="auto aus Mitarbeiter"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Eintritt (optional)</label><input id="p_entry" type="date"/></div>
              <div class="field"><label>Austritt (optional)</label><input id="p_exit" type="date"/></div>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Abz√ºge (Auto oder manuell)</h3>
            <div class="note">
              Haddii aad rabto ‚Äúsida slip-ka dhabta ah‚Äù ‚Üí ku qor manual: Lohnsteuer + KV/RV/AV/PV.
              Haddii manual = 0 ‚Üí app-ku wuxuu sameynayaa estimate (Gesetz Pack / Settings).
            </div>

            <div class="split">
              <div class="field"><label>Lohnsteuer (manual ‚Ç¨)</label><input id="p_tax_lohn" type="number" step="0.01" value="0"/></div>
              <div class="field"><label>Kirchensteuer (manual ‚Ç¨)</label><input id="p_tax_kirche" type="number" step="0.01" value="0"/></div>
            </div>
            <div class="split">
              <div class="field"><label>Soli (manual ‚Ç¨)</label><input id="p_tax_soli" type="number" step="0.01" value="0"/></div>
              <div class="field"><label>Sonstige Abz√ºge (manual ‚Ç¨)</label><input id="p_other_ded" type="number" step="0.01" value="0"/></div>
            </div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px 0">SV Beitr√§ge (AN) ‚Äì manual ama estimate</h3>
            <div class="split">
              <div class="field"><label>KV Beitrag AN (manual ‚Ç¨)</label><input id="p_sv_kv" type="number" step="0.01" value="0"/></div>
              <div class="field"><label>RV Beitrag AN (manual ‚Ç¨)</label><input id="p_sv_rv" type="number" step="0.01" value="0"/></div>
            </div>
            <div class="split">
              <div class="field"><label>AV Beitrag AN (manual ‚Ç¨)</label><input id="p_sv_av" type="number" step="0.01" value="0"/></div>
              <div class="field"><label>PV Beitrag AN (manual ‚Ç¨)</label><input id="p_sv_pv" type="number" step="0.01" value="0"/></div>
            </div>

            <div class="hr"></div>

            <table class="table">
              <thead><tr><th>Item</th><th class="right">Betrag</th></tr></thead>
              <tbody id="payTable"></tbody>
            </table>

            <div class="hr"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnPayCalc">Berechnen</button>
              <button class="btn" id="btnLohnPDF">Lohnabrechnung (A4)</button>
              <button class="btn" id="btnArbBes">Arbeitbescheinigung (A4)</button>
              <button class="btn" id="btnSteuerBes">Steuerbescheinigung (A4)</button>
            </div>
          </div>

          <div class="card">
            <h3>Firma (Preview)</h3>
            <div class="note" id="firmPreview"></div>

            <div class="hr"></div>
            <h3>Auto-Gesetz Update</h3>
            <div class="note">
              ‚ÄúAI / Gesetz‚Äù page ‚Üí Update rules from <b>rules-de-latest.json</b> in your repo.
              App-ka wuxuu si toos ah ugu wareejinayaa Settings (SV% + PV Kinder rates).
            </div>
          </div>
        </div>
      </section>

      <!-- AI / GESETZ -->
      <section id="page-ai" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>ü§ñ AI / Gesetz Update</h3>
            <div class="note">
              Qaybtan waxay isticmaashaa <b>Rule Pack</b> (JSON) oo repo-gaaga ku jira.
              Markaad Update sameyso ‚Üí Settings (SV/PV) si automatic ah ayaa loo update-gareeyaa.
              (Payroll ‚Äúofficial 100%‚Äù weli wuxuu u baahan yahay ELStAM + Krankenkasse APIs ‚Äî halkan waa estimate/managed rules.)
            </div>

            <div class="hr"></div>

            <div class="field">
              <label>Rule Pack URL (relative)</label>
              <input id="ai_rules_url" placeholder="rules-de-latest.json"/>
              <div class="muted" style="font-size:12px">Talo: samee file repo root: <b>rules-de-latest.json</b></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnRulesCheck">Check & Update</button>
              <button class="btn" id="btnRulesDefault">Use Default</button>
              <button class="btn danger" id="btnRulesResetLocal">Reset to Local Defaults</button>
            </div>

            <div class="hr"></div>

            <h3>AI Assist (Estimate)</h3>
            <div class="note">
              AI Assist = suggestion only (estimate). Haddii aad doorato ‚ÄúApply with confirm‚Äù ‚Üí wuxuu ku weydiinayaa confirm.
            </div>

            <div class="split">
              <div class="field">
                <label>Mode</label>
                <select id="ai_mode">
                  <option value="off">Off</option>
                  <option value="suggest">Suggest only</option>
                  <option value="apply_confirm">Apply with confirm</option>
                </select>
              </div>
              <div class="field">
                <label>Employee (for suggestion)</label>
                <select id="ai_emp_pick"></select>
              </div>
            </div>

            <button class="btn good" id="btnAiSuggest">Generate Suggestion</button>

            <div class="hr"></div>
            <div class="note" id="ai_out">Status: Ready</div>
          </div>

          <div class="card">
            <h3>Active Rules</h3>
            <table class="table"><tbody id="rulesTable"></tbody></table>
            <div class="hr"></div>
            <div class="note">
              ‚úÖ RULE PACK file example (create in your repo as <b>rules-de-latest.json</b>):
              {"version":"DE-2026-01","country":"DE","year":2026,"sv_an_total_pct":20.30,"sv_ag_total_pct":20.30,"pv_base_an_pct":1.70,"pv_childless_extra_an_pct":0.35,"pv_discount_per_child_an_pct":0.25,"pv_discount_max_children":3,"lohnsteuer_factor":0.12,"soli_factor":0.00,"kirche_factor":0.00}
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma Einstellungen</h3>

            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>

            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>

            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
            </div>

            <div class="field">
              <label>Steuernummer / Steuer-ID (Firma)</label>
              <input id="s_taxid" placeholder="z.B. 12/345/67890"/>
            </div>

            <div class="field"><label>¬ß19 Hinweis (Rechnung)</label><input id="s_hint"/></div>

            <div class="hr"></div>
            <h3>SV Prozent (Estimate)</h3>
            <div class="split">
              <div class="field"><label>SV Arbeitnehmer % (gesamt)</label><input id="s_sv_an" type="number" step="0.01"/></div>
              <div class="field"><label>SV Arbeitgeber % (gesamt)</label><input id="s_sv_ag" type="number" step="0.01"/></div>
            </div>

            <div class="hr"></div>
            <h3>Kinder Beitrag (PV) ‚Äì Estimate</h3>
            <div class="note">
              PV Kinder logic:
              - 0 Kinder ‚Üí PV base + ‚ÄúKinderlos Zuschlag‚Äù
              - 1 Kind ‚Üí PV base
              - >=2 Kinder ‚Üí PV base - Rabatt*(kids-1) (limit)
              (Simulation, rates are configurable.)
            </div>

            <div class="split">
              <div class="field"><label>PV Basis AN % (mit Kind)</label><input id="s_pv_base_an" type="number" step="0.01"/></div>
              <div class="field"><label>Kinderlos Zuschlag AN % (0 Kinder)</label><input id="s_pv_childless_extra_an" type="number" step="0.01"/></div>
            </div>

            <div class="split">
              <div class="field"><label>PV Rabatt pro Kind (ab 2. Kind) AN %</label><input id="s_pv_discount_per_child_an" type="number" step="0.01"/></div>
              <div class="field"><label>Max Rabatt Kinder (limit)</label><input id="s_pv_discount_max_children" type="number" step="1"/></div>
            </div>

            <div class="note">Auto update from ‚ÄúAI / Gesetz‚Äù will overwrite these rates when you apply a rules pack.</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSettingsSave">Speichern</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
          </div>
        </div>
      </section>

    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   HARD FIX: disable/unregister service workers + clear caches
============================================================ */
(async () => {
  try{
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

/* =========================
   Utils
========================= */
const $ = (id)=>document.getElementById(id);
const DB_KEY = "ms_onefile_office_v9_ai_gesetz";

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2800);
  }
};

function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

function fmtEUR(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function fmt2(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function todayISO(){
  const d=new Date();
  const p=(x)=>String(x).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(str){
  return String(str??"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function openPrint(html){
  const w=window.open("","_blank");
  if(!w){ alert("Popup blockiert. Popups erlauben."); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* =========================
   Store
========================= */
const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          taxid:"",
          hint:"Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.",
          // SV totals (estimate)
          sv_an:20.30,
          sv_ag:20.30,
          // PV children logic (estimate)
          pv_base_an: 1.70,
          pv_childless_extra_an: 0.35,
          pv_discount_per_child_an: 0.25,
          pv_discount_max_children: 3,
          // Gesetz pack url
          rules_url: "rules-de-latest.json",
          // active rules object (created on boot if missing)
          rules: null
        },
        customers:[],
        employees:[],
        invoices:[]
      };
      this.save(true);
    } else {
      // migrations
      this.data.settings ||= {};
      this.data.customers ||= [];
      this.data.employees ||= [];
      this.data.invoices ||= [];

      if(this.data.settings.sv_an === undefined) this.data.settings.sv_an = 20.30;
      if(this.data.settings.sv_ag === undefined) this.data.settings.sv_ag = 20.30;

      if(this.data.settings.pv_base_an === undefined) this.data.settings.pv_base_an = 1.70;
      if(this.data.settings.pv_childless_extra_an === undefined) this.data.settings.pv_childless_extra_an = 0.35;
      if(this.data.settings.pv_discount_per_child_an === undefined) this.data.settings.pv_discount_per_child_an = 0.25;
      if(this.data.settings.pv_discount_max_children === undefined) this.data.settings.pv_discount_max_children = 3;

      if(this.data.settings.rules_url === undefined) this.data.settings.rules_url = "rules-de-latest.json";
      if(this.data.settings.rules === undefined) this.data.settings.rules = null;
    }

    // ensure rules exist
    Gesetz.ensureRules();
  },
  save(silent=false){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("‚úÖ Gespeichert");
      UI.setStatus("Gespeichert", true);
      UI.updateCounts();
      UI.updateStorageNote();
      return true;
    }catch(e){
      UI.setStatus("Storage ERROR", false);
      Toast.show("‚ùå Speichern nicht m√∂glich.\nBrowser blockiert Storage.\n√ñffne in normalem Tab + erlaube Cookies/Storage.");
      return false;
    }
  },
  wipe(){
    if(!confirm("Alles l√∂schen? (Kunden, Mitarbeiter, Rechnungen, Rules)")) return;
    StorageDriver.removeItem(DB_KEY);
    this.data=null; this.load();
    UI.refreshAll();
    Toast.show("üßπ Alles gel√∂scht");
  }
};

/* =========================
   UI Navigation
========================= */
const UI = {
  page:"invoices",
  go(page){
    this.page = page;
    ["invoices","customers","employees","payroll","ai","settings"].forEach(p=>{
      const el=$("page-"+p);
      if(!el) return;
      el.classList.toggle("hide", p!==page);
    });

    document.querySelectorAll("#nav button").forEach(b=>{
      b.classList.toggle("active", b.dataset.page===page);
    });

    const titles = {
      invoices:["Rechnung","Tage + Std/Tag + ‚Ç¨/h ‚Üí Stunden ‚Üí Position 1"],
      customers:["Kunden","Kunden speichern ‚Ä¢ Auswahl in Rechnung"],
      employees:["Mitarbeiter","Kinder + Krankenkasse + Steuerklasse gespeichert"],
      payroll:["Payroll / SV","Kinder Beitrag (PV) Auto Estimate + Slip-style PDF"],
      ai:["AI / Gesetz","Auto Update √ºber rules-de-latest.json + AI Suggestion"],
      settings:["Firma","Firma Daten + SV/PV Kinder (Estimate)"]
    };
    $("pageTitle").textContent = titles[page][0];
    $("pageSub").textContent = titles[page][1];

    if(page==="ai") Gesetz.renderAiPage();
    this.updateStorageNote();
  },
  setStatus(text, ok=true){
    $("statusText").textContent = text;
    $("dot").classList.toggle("off", !ok);
  },
  updateCounts(){
    $("pillCustomers").textContent = Store.data.customers.length;
    $("pillEmployees").textContent = Store.data.employees.length;
    $("pillInvoices").textContent = Store.data.invoices.length;
    $("pillStore").textContent = StorageDriver.type;
  },
  updateStorageNote(){
    $("storeTag").textContent = "Storage: "+StorageDriver.type;
    $("storageNote").textContent =
      "Storage: "+StorageDriver.type+
      "\nKunden: "+Store.data.customers.length+
      "\nMitarbeiter: "+Store.data.employees.length+
      "\nRechnungen: "+Store.data.invoices.length+
      "\nRules: "+(Store.data.settings?.rules?.version || "local-default");
    $("pillStore").textContent = StorageDriver.type;
  },
  refreshAll(){
    this.updateCounts();
    Customers.render();
    Employees.render();
    Invoices.renderList();
    Invoices.fillCustomerSelect();
    Payroll.fillEmployeeSelect();
    Settings.loadToForm();
    Gesetz.renderRulesTable();
  }
};

/* =========================
   Customers
========================= */
const Customers = {
  clearForm(){
    $("c_name").value="";
    $("c_email").value="";
    $("c_phone").value="";
    $("c_addr").value="";
  },
  save(){
    const name = $("c_name").value.trim();
    if(!name){ Toast.show("Name/Firma fehlt"); return; }
    const email = $("c_email").value.trim();
    const phone = $("c_phone").value.trim();
    const addr = $("c_addr").value.trim();

    Store.data.customers.push({ id: uid(), name, email, phone, addr });
    Store.save();
    this.clearForm();
    this.render();
    Invoices.fillCustomerSelect();
  },
  remove(id){
    if(!confirm("Kunde l√∂schen?")) return;
    Store.data.customers = Store.data.customers.filter(x=>x.id!==id);
    Store.save();
    this.render();
    Invoices.fillCustomerSelect();
  },
  render(){
    const q = ($("c_search").value||"").toLowerCase().trim();
    const rows = Store.data.customers
      .filter(c=>{
        if(!q) return true;
        return (c.name||"").toLowerCase().includes(q) || (c.email||"").toLowerCase().includes(q) || (c.addr||"").toLowerCase().includes(q);
      })
      .map(c=>`
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.email||"")}</td>
          <td style="white-space:pre-line">${escapeHtml(c.addr||"")}</td>
          <td class="right"><button class="btn danger" onclick="Customers.remove('${c.id}')">L√∂schen</button></td>
        </tr>
      `).join("");
    $("customersList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Kunden</td></tr>`;
    UI.updateCounts();
  }
};

/* =========================
   Employees
========================= */
const Employees = {
  clearForm(){
    $("m_name").value="";
    $("m_persnr").value="";
    $("m_addr").value="";
    $("m_dob").value="";
    $("m_taxid").value="";
    $("m_taxclass").value="I";
    $("m_family").value="single";
    $("m_children").value="0";
    $("m_kasse").value="";
    $("m_kasse_no").value="";
    $("m_sv").value="yes";
    $("m_rate").value="";
  },
  save(){
    const name = $("m_name").value.trim();
    if(!name){ Toast.show("Name fehlt"); return; }

    const emp = {
      id: uid(),
      name,
      persnr: $("m_persnr").value.trim(),
      addr: $("m_addr").value.trim(),
      dob: $("m_dob").value,
      taxid: $("m_taxid").value.trim(),
      taxclass: $("m_taxclass").value,
      family: $("m_family").value,
      children: String(Math.max(0, Math.floor(num($("m_children").value||0)))),
      krankenkasse: $("m_kasse").value,
      krankenkasse_no: $("m_kasse_no").value.trim(),
      sv: $("m_sv").value==="yes",
      rate: num($("m_rate").value)
    };
    Store.data.employees.push(emp);
    Store.save();
    this.clearForm();
    this.render();
    Payroll.fillEmployeeSelect();
    Gesetz.fillAiEmployeeSelect();
  },
  remove(id){
    if(!confirm("Mitarbeiter l√∂schen?")) return;
    Store.data.employees = Store.data.employees.filter(x=>x.id!==id);
    Store.save();
    this.render();
    Payroll.fillEmployeeSelect();
    Gesetz.fillAiEmployeeSelect();
  },
  render(){
    const q = ($("m_search").value||"").toLowerCase().trim();
    const rows = Store.data.employees
      .filter(e=>{
        if(!q) return true;
        return (e.name||"").toLowerCase().includes(q) ||
               (e.persnr||"").toLowerCase().includes(q) ||
               (e.taxid||"").toLowerCase().includes(q);
      })
      .map(e=>`
        <tr>
          <td>${escapeHtml(e.name)}</td>
          <td>${escapeHtml(e.persnr||"")}</td>
          <td>${escapeHtml(e.krankenkasse||"")}</td>
          <td>${escapeHtml(e.taxclass||"")}</td>
          <td class="right"><button class="btn danger" onclick="Employees.remove('${e.id}')">L√∂schen</button></td>
        </tr>
      `).join("");
    $("employeesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Mitarbeiter</td></tr>`;
    UI.updateCounts();
  }
};

/* =========================
   Invoices + Lines
========================= */
const Lines = {
  data:[],
  set(lines){
    this.data = (lines||[]).map(l=>({
      id: l.id || uid(),
      desc: l.desc || "",
      qty: num(l.qty),
      price: num(l.price),
      auto: !!l.auto
    }));
    if(this.data.length===0) this.data=[this.newLine(false)];
    this.render();
  },
  get(){
    return this.data.map(l=>({id:l.id, desc:l.desc, qty:num(l.qty), price:num(l.price), auto:!!l.auto}));
  },
  newLine(auto=false){
    return { id: uid(), desc: auto ? "Sicherheitsdienstleistung (Arbeitszeit)" : "", qty:0, price:0, auto };
  },
  ensureAutoLine(hours, rate){
    let line = this.data.find(l=>l.auto);
    if(!line){
      if(this.data.length===0) this.data=[this.newLine(true)];
      this.data[0].auto = true;
      if(!this.data[0].desc) this.data[0].desc = "Sicherheitsdienstleistung (Arbeitszeit)";
      line = this.data[0];
    }
    line.qty = hours;
    line.price = rate;
    this.render();
  },
  add(){ this.data.push(this.newLine(false)); this.render(); },
  remove(id){
    if(!confirm("Position l√∂schen?")) return;
    this.data = this.data.filter(l=>l.id!==id);
    if(this.data.length===0) this.data=[this.newLine(false)];
    this.render();
    this.recalcTotals();
  },
  duplicate(id){
    const l = this.data.find(x=>x.id===id);
    if(!l) return;
    this.data.push({ ...l, id: uid(), auto:false });
    this.render();
    this.recalcTotals();
  },
  render(){
    const rows = this.data.map(l=>{
      const net = round2(num(l.qty)*num(l.price));
      return `
        <tr>
          <td>
            <input style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text)"
              value="${escapeHtml(l.desc)}"
              oninput="Lines.update('${l.id}','desc',this.value)"/>
            ${l.auto?`<div class="muted" style="font-size:11px;margin-top:6px">Auto-Position (Stunden)</div>`:""}
          </td>
          <td class="right">
            <input style="width:110px;text-align:right;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text)"
              value="${fmt2(num(l.qty))}"
              oninput="Lines.update('${l.id}','qty',this.value)"/>
          </td>
          <td class="right">
            <input style="width:110px;text-align:right;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text)"
              value="${fmt2(num(l.price))}"
              oninput="Lines.update('${l.id}','price',this.value)"/>
          </td>
          <td class="right"><b>${fmtEUR(net)}</b></td>
          <td class="right">
            <button class="btn" onclick="Lines.duplicate('${l.id}')">Duplizieren</button>
            <button class="btn danger" onclick="Lines.remove('${l.id}')">L√∂schen</button>
          </td>
        </tr>
      `;
    }).join("");
    $("linesBody").innerHTML = rows;
  },
  update(id, key, val){
    const l = this.data.find(x=>x.id===id);
    if(!l) return;
    if(key==="desc") l.desc = val;
    if(key==="qty") l.qty = num(val);
    if(key==="price") l.price = num(val);
    this.recalcTotals();
  },
  recalcTotals(){
    let sum = 0;
    for(const l of this.data){
      const net = round2(num(l.qty)*num(l.price));
      sum = round2(sum + net);
    }
    $("sum_net").value = fmtEUR(sum);
    $("sum_total").value = fmtEUR(sum);
    $("i_preview").textContent = `Positionen: ${this.data.length} ‚Ä¢ Gesamt: ${fmtEUR(sum)} ‚Ä¢ USt: ${fmtEUR(0)}`;
  }
};

const Invoices = {
  newNo(){
    const year = new Date().getFullYear();
    const n = Store.data.invoices.length + 1;
    return `MS-${year}-${String(n).padStart(4,"0")}`;
  },
  initForm(){
    $("i_no").value = this.newNo();
    $("i_date").value = todayISO();
    $("i_von").value = "";
    $("i_bis").value = "";
    $("i_due").value = "";
    $("i_status").value = "Entwurf";
    $("i_edit_id").value = "";
    $("w_days").value = "";
    $("w_hpd").value = "";
    $("w_rate").value = "";
    $("w_total_hours").value = "";
    Lines.set([]);
    this.calc();
    this.fillCustomerSelect();
  },
  fillCustomerSelect(){
    const sel = $("i_customer");
    const current = sel.value;
    const opts = [`<option value="">Bitte Kunde w√§hlen</option>`].concat(
      Store.data.customers.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`)
    );
    sel.innerHTML = opts.join("");
    if(current) sel.value = current;
  },
  calc(){
    const days = num($("w_days").value);
    const hpd  = num($("w_hpd").value);
    const rate = num($("w_rate").value);
    const totalHours = round2(days * hpd);
    $("w_total_hours").value = totalHours ? fmt2(totalHours) : "";
    if(totalHours>0 && rate>0){
      Lines.ensureAutoLine(totalHours, rate);
    }
    Lines.recalcTotals();
  },
  save(){
    const no = $("i_no").value.trim() || this.newNo();
    const customerId = $("i_customer").value;
    if(!customerId){ Toast.show("Kunde w√§hlen"); return; }

    const inv = {
      id: $("i_edit_id").value || uid(),
      no,
      date: $("i_date").value || todayISO(),
      von: $("i_von").value || "",
      bis: $("i_bis").value || "",
      due: $("i_due").value || "",
      status: $("i_status").value || "Entwurf",
      customerId,
      autoHours:{
        days: num($("w_days").value),
        hpd: num($("w_hpd").value),
        rate: num($("w_rate").value),
        totalHours: num(String($("w_total_hours").value||"").replace(".","").replace(",","."))
      },
      lines: Lines.get()
    };

    const idx = Store.data.invoices.findIndex(x=>x.id===inv.id);
    if(idx>=0) Store.data.invoices[idx]=inv;
    else Store.data.invoices.unshift(inv);

    if(Store.save()){
      this.renderList();
      Toast.show("‚úÖ Rechnung gespeichert");
      $("i_edit_id").value = inv.id;
      $("i_no").value = inv.no;
    }
  },
  edit(id){
    const inv = Store.data.invoices.find(x=>x.id===id);
    if(!inv) return;
    UI.go("invoices");
    $("i_edit_id").value = inv.id;
    $("i_no").value = inv.no;
    $("i_date").value = inv.date||todayISO();
    $("i_von").value = inv.von||"";
    $("i_bis").value = inv.bis||"";
    $("i_due").value = inv.due||"";
    $("i_status").value = inv.status||"Entwurf";
    this.fillCustomerSelect();
    $("i_customer").value = inv.customerId||"";

    $("w_days").value = inv.autoHours?.days ?? "";
    $("w_hpd").value = inv.autoHours?.hpd ?? "";
    $("w_rate").value = inv.autoHours?.rate ?? "";
    $("w_total_hours").value = inv.autoHours?.totalHours ? fmt2(inv.autoHours.totalHours) : "";

    Lines.set(inv.lines||[]);
    Lines.recalcTotals();
  },
  remove(id){
    if(!confirm("Rechnung l√∂schen?")) return;
    Store.data.invoices = Store.data.invoices.filter(x=>x.id!==id);
    Store.save();
    this.renderList();
  },
  renderList(){
    const q = ($("inv_search").value||"").toLowerCase().trim();
    const f = ($("inv_filter").value||"").trim();

    const rows = Store.data.invoices
      .filter(inv=>{
        if(f && inv.status!==f) return false;
        if(!q) return true;
        const c = Store.data.customers.find(x=>x.id===inv.customerId);
        const cname = (c?.name||"").toLowerCase();
        return (inv.no||"").toLowerCase().includes(q) || (inv.status||"").toLowerCase().includes(q) || cname.includes(q);
      })
      .map(inv=>{
        const c = Store.data.customers.find(x=>x.id===inv.customerId);
        const total = round2((inv.lines||[]).reduce((s,l)=>s + round2(num(l.qty)*num(l.price)), 0));
        return `
          <tr>
            <td>${escapeHtml(inv.no)}</td>
            <td>${escapeHtml(c?.name||"")}</td>
            <td>${escapeHtml(inv.status||"")}</td>
            <td class="right">${fmtEUR(total)}</td>
            <td class="right">
              <button class="btn" onclick="Invoices.edit('${inv.id}')">√ñffnen</button>
              <button class="btn danger" onclick="Invoices.remove('${inv.id}')">L√∂schen</button>
            </td>
          </tr>
        `;
      }).join("");

    $("invoicesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Rechnungen</td></tr>`;
    UI.updateCounts();
  },
  print(){
    const inv = {
      id: $("i_edit_id").value,
      no: $("i_no").value.trim(),
      date: $("i_date").value || todayISO(),
      von: $("i_von").value || "",
      bis: $("i_bis").value || "",
      due: $("i_due").value || "",
      status: $("i_status").value || "Entwurf",
      customerId: $("i_customer").value,
      lines: Lines.get()
    };
    if(!inv.customerId){ Toast.show("Kunde w√§hlen"); return; }

    const s = Store.data.settings;
    const c = Store.data.customers.find(x=>x.id===inv.customerId) || {};
    const total = round2(inv.lines.reduce((sum,l)=>sum + round2(num(l.qty)*num(l.price)),0));
    const linesHtml = inv.lines.map((l,i)=>{
      const net = round2(num(l.qty)*num(l.price));
      return `<tr>
        <td>${i+1}</td>
        <td>${escapeHtml(l.desc||"")}</td>
        <td class="right">${fmt2(num(l.qty))}</td>
        <td class="right">${fmtEUR(num(l.price))}</td>
        <td class="right">${fmtEUR(net)}</td>
      </tr>`;
    }).join("");

    const timeframe = (inv.von && inv.bis) ? `${inv.von} ‚Ä¶ ${inv.bis}` : "";

    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>Rechnung ${escapeHtml(inv.no||"")}</title>
<style>
@page{size:A4;margin:12mm}
body{font-family:Arial;color:#000}
h1{margin:0;font-size:18px}
.small{font-size:11px;color:#333}
.row{display:flex;justify-content:space-between;gap:18px;align-items:flex-start}
.col{width:49%}
.hr{border-bottom:1px solid #ddd;margin:10px 0}
table{width:100%;border-collapse:collapse;font-size:11px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:left;vertical-align:top}
th{border-top:1px solid #ddd}
.right{text-align:right}
.box{border:1px solid #ddd;padding:8px;margin-top:8px}
pre{margin:0;font-family:inherit;white-space:pre-line}
</style></head><body>

<div class="row">
  <div class="col">
    <h1>Rechnung</h1>
    <b>${escapeHtml(s.company||"")}</b><br>
    <div class="small"><pre>${escapeHtml(s.addr||"")}</pre></div>
    <div class="small">E-Mail: ${escapeHtml(s.email||"")}</div>
    ${s.phone?`<div class="small">Tel: ${escapeHtml(s.phone)}</div>`:""}
    ${s.taxid?`<div class="small">Steuernummer/Steuer-ID: ${escapeHtml(s.taxid)}</div>`:""}
  </div>
  <div class="col right">
    <div class="small"><b>Rechnungs-Nr.:</b> ${escapeHtml(inv.no||"")}</div>
    <div class="small"><b>Rechnungsdatum:</b> ${escapeHtml(inv.date||"")}</div>
    ${timeframe?`<div class="small"><b>Zeitraum:</b> ${escapeHtml(timeframe)}</div>`:""}
    ${inv.due?`<div class="small"><b>F√§llig am:</b> ${escapeHtml(inv.due)}</div>`:""}
    <div class="small"><b>Status:</b> ${escapeHtml(inv.status||"")}</div>
  </div>
</div>

<div class="hr"></div>

<div class="box">
  <div class="small"><b>Rechnung an:</b></div>
  <div><b>${escapeHtml(c.name||"")}</b></div>
  ${c.addr?`<div class="small"><pre>${escapeHtml(c.addr)}</pre></div>`:""}
  ${c.email?`<div class="small">E-Mail: ${escapeHtml(c.email)}</div>`:""}
</div>

<div class="hr"></div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Leistung</th>
      <th class="right">Menge</th>
      <th class="right">Preis</th>
      <th class="right">Netto</th>
    </tr>
  </thead>
  <tbody>
    ${linesHtml || `<tr><td colspan="5" class="small">Keine Positionen</td></tr>`}
  </tbody>
</table>

<div class="hr"></div>

<div class="row">
  <div class="col">
    <div class="small"><b>Zahlung:</b> Bitte √ºberweisen Sie den Betrag auf folgendes Konto:</div>
    <div class="small">IBAN: ${escapeHtml(s.iban||"")} ‚Ä¢ BIC: ${escapeHtml(s.bic||"")}</div>
    <div class="small"><b>Hinweis:</b> ${escapeHtml(s.hint||"")}</div>
  </div>
  <div class="col">
    <table>
      <tr><td class="right"><b>Summe Netto:</b></td><td class="right"><b>${fmtEUR(total)}</b></td></tr>
      <tr><td class="right">Umsatzsteuer:</td><td class="right">${fmtEUR(0)}</td></tr>
      <tr><td class="right"><b>Zu zahlen:</b></td><td class="right"><b>${fmtEUR(total)}</b></td></tr>
    </table>
  </div>
</div>

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
    openPrint(html);
  }
};

/* =========================
   Payroll (slip-style + Kinder PV)
========================= */
const Payroll = {
  fillEmployeeSelect(){
    const sel = $("p_emp");
    const current = sel.value;
    sel.innerHTML = [`<option value="">Bitte Mitarbeiter w√§hlen</option>`].concat(
      Store.data.employees.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}${e.persnr?` (PersNr ${escapeHtml(e.persnr)})`:""}</option>`)
    ).join("");
    if(current) sel.value = current;
  },
  employeeChanged(){
    const e = Store.data.employees.find(x=>x.id===$("p_emp").value);
    if(e){
      $("p_rate").value = e.rate ? fmt2(e.rate) : "";
      $("p_persnr").value = $("p_persnr").value.trim() || (e.persnr||"");
    }
    this.calc();
  },
  estimateLohnsteuer(brutto, taxclass){
    const rules = Store.data.settings.rules;
    const base = num(rules?.lohnsteuer_factor ?? 0.12);

    // rough adjust by class
    let f = base;
    if(taxclass==="III") f = Math.max(0, round2(f - 0.03));
    if(taxclass==="V" || taxclass==="VI") f = round2(f + 0.06);
    return round2(brutto * f);
  },
  calc(){
    const s = Store.data.settings||{};
    const emp = Store.data.employees.find(x=>x.id===$("p_emp").value);
    const rules = s.rules || {};

    const hours = num($("p_hours").value);
    const rate  = num($("p_rate").value);
    const brutto = round2(hours * rate);

    const m_lohn = num($("p_tax_lohn").value);
    const m_kir  = num($("p_tax_kirche").value);
    const m_soli = num($("p_tax_soli").value);
    const m_other= num($("p_other_ded").value);

    const m_kv = num($("p_sv_kv").value);
    const m_rv = num($("p_sv_rv").value);
    const m_av = num($("p_sv_av").value);
    const m_pv = num($("p_sv_pv").value);

    const tax_est = emp ? this.estimateLohnsteuer(brutto, emp.taxclass||"I") : 0;
    const lohnsteuer = (m_lohn>0) ? m_lohn : tax_est;
    const kirche = (m_kir>0) ? m_kir : round2(brutto * num(rules.kirche_factor||0));
    const soli = (m_soli>0) ? m_soli : round2(brutto * num(rules.soli_factor||0));

    const anyManualSV = (m_kv+m_rv+m_av+m_pv) > 0;

    // ===== Kinder PV logic =====
    let kv=0, rv=0, av=0, pv=0, svAN=0;
    const childrenCount = emp ? Math.max(0, Math.floor(num(emp.children||0))) : 0;

    if(emp && emp.sv){
      if(anyManualSV){
        kv=m_kv; rv=m_rv; av=m_av; pv=m_pv;
        svAN = round2(kv+rv+av+pv);
      }else{
        // total SV estimate from rules (preferred) or settings
        const svAnPct = num(rules.sv_an_total_pct ?? s.sv_an);
        svAN = round2(brutto * (svAnPct/100));

        // PV rates from rules (preferred) or settings
        const basePv = Math.max(0, num(rules.pv_base_an_pct ?? s.pv_base_an));
        const extraChildless = Math.max(0, num(rules.pv_childless_extra_an_pct ?? s.pv_childless_extra_an));
        const discPerChild = Math.max(0, num(rules.pv_discount_per_child_an_pct ?? s.pv_discount_per_child_an));
        const discMaxKids = Math.max(0, Math.floor(num(rules.pv_discount_max_children ?? s.pv_discount_max_children)));

        let pvRate = basePv;
        if(childrenCount === 0){
          pvRate = basePv + extraChildless;
        } else if(childrenCount >= 2){
          const eligible = Math.min(childrenCount - 1, discMaxKids);
          pvRate = Math.max(0, basePv - (discPerChild * eligible));
        }

        pv = round2(brutto * (pvRate/100));

        // split remaining SV (kv/rv/av) from leftover = svAN - pv
        const rest = Math.max(0, round2(svAN - pv));
        kv = round2(rest*0.46);
        rv = round2(rest*0.34);
        av = round2(rest*0.10);
        kv = round2(rest - rv - av); // adjust to exact
      }
    }

    const sumGesAbz = round2(svAN + lohnsteuer + kirche + soli);
    const sumSonst  = round2(m_other);
    const netto = round2(brutto - sumGesAbz - sumSonst);

    const svAgPct = num(rules.sv_ag_total_pct ?? s.sv_ag);
    const svAG = (emp && emp.sv) ? round2(brutto * (svAgPct/100)) : 0;

    $("payTable").innerHTML = `
      <tr><td>Kinder</td><td class="right">${childrenCount}</td></tr>
      <tr><td>Stunden</td><td class="right">${fmt2(hours)}</td></tr>
      <tr><td>‚Ç¨/h</td><td class="right">${fmt2(rate)}</td></tr>
      <tr><td><b>Brutto</b></td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
      <tr><td>SV AN (KV/RV/AV/PV)</td><td class="right">${fmtEUR(svAN)}</td></tr>
      <tr><td>Lohnsteuer</td><td class="right">${fmtEUR(lohnsteuer)}</td></tr>
      <tr><td>Kirchensteuer</td><td class="right">${fmtEUR(kirche)}</td></tr>
      <tr><td>Soli</td><td class="right">${fmtEUR(soli)}</td></tr>
      <tr><td><b>Summe gesetzliche Abz√ºge</b></td><td class="right"><b>${fmtEUR(sumGesAbz)}</b></td></tr>
      <tr><td>Sonstige Abz√ºge</td><td class="right">${fmtEUR(sumSonst)}</td></tr>
      <tr><td><b>Nettoverdienst (estimate)</b></td><td class="right"><b>${fmtEUR(netto)}</b></td></tr>
      <tr><td class="muted">SV Arbeitgeber (estimate)</td><td class="right">${fmtEUR(svAG)}</td></tr>
    `;

    const firm = `${s.company||""}\n${s.addr||""}\n${s.email||""}\nIBAN: ${s.iban||""}\nBIC: ${s.bic||""}\n${s.taxid?("Tax: "+s.taxid):""}\nRules: ${(s.rules?.version||"local-default")}`;
    $("firmPreview").textContent = firm;

    return { emp, s, rules, childrenCount, hours, rate, brutto, kv, rv, av, pv, svAN, lohnsteuer, kirche, soli, sumGesAbz, sumSonst, netto, svAG };
  },
  lohnPDF(){
    const calc = this.calc();
    const emp = calc.emp;
    if(!emp){ Toast.show("Mitarbeiter w√§hlen"); return; }

    const month = ($("p_month").value||"").trim() || todayISO().slice(0,7);
    const persnr = ($("p_persnr").value||"").trim() || (emp.persnr||"");
    const entry = $("p_entry").value || "";
    const exit  = $("p_exit").value || "";
    const s = calc.s;

    const employer = `
      <div><b>${escapeHtml(s.company||"")}</b><br>
      <div style="white-space:pre-line">${escapeHtml(s.addr||"")}</div>
      ${s.email ? `<div>E-Mail: ${escapeHtml(s.email)}</div>`:""}
      ${s.taxid ? `<div>Steuernummer/Steuer-ID: ${escapeHtml(s.taxid)}</div>`:""}
      <div style="margin-top:6px" class="small">Rules: <b>${escapeHtml(s.rules?.version||"local-default")}</b></div>
      </div>
    `;

    const employee = `
      <div><b>${escapeHtml(emp.name||"")}</b><br>
      <div style="white-space:pre-line">${escapeHtml(emp.addr||"")}</div>
      ${emp.taxid ? `<div>Steuer-ID: ${escapeHtml(emp.taxid)}</div>`:""}
      </div>
    `;

    const box = `
      <table class="boxTable">
        <tr>
          <td>Geburtsdatum</td><td>${escapeHtml(emp.dob||"")}</td>
          <td>Eintritt</td><td>${escapeHtml(entry)}</td>
          <td>Austritt</td><td>${escapeHtml(exit)}</td>
          <td class="right"><b>Pers.-Nr.</b></td><td class="right"><b>${escapeHtml(persnr)}</b></td>
        </tr>
        <tr>
          <td>Steuerklasse</td><td>${escapeHtml(emp.taxclass||"I")}</td>
          <td>Familienstand</td><td>${escapeHtml(emp.family||"")}</td>
          <td>Kinder</td><td>${escapeHtml(emp.children||"0")}</td>
          <td>Kasse</td><td>${escapeHtml(emp.krankenkasse||"")}</td>
        </tr>
      </table>
    `;

    const earnings = `
      <table class="t">
        <thead>
          <tr><th>Bezeichnung</th><th class="right">Stunden</th><th class="right">Lohnsatz</th><th class="right">Betrag</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Sicherheitsdienstleistung</td>
            <td class="right">${fmt2(calc.hours)}</td>
            <td class="right">${fmt2(calc.rate)}</td>
            <td class="right">${fmt2(calc.brutto)} ‚Ç¨</td>
          </tr>
        </tbody>
      </table>
    `;

    const abz = `
      <table class="t">
        <tbody>
          <tr><td><b>GESAMTBRUTTO</b></td><td class="right"><b>${fmt2(calc.brutto)} ‚Ç¨</b></td></tr>
          <tr><td>Lohnsteuer</td><td class="right">${fmt2(calc.lohnsteuer)} ‚Ç¨</td></tr>
          <tr><td>KV-Beitrag AN</td><td class="right">${fmt2(calc.kv)} ‚Ç¨</td></tr>
          <tr><td>RV-Beitrag AN</td><td class="right">${fmt2(calc.rv)} ‚Ç¨</td></tr>
          <tr><td>AV-Beitrag AN</td><td class="right">${fmt2(calc.av)} ‚Ç¨</td></tr>
          <tr><td>PV-Beitrag AN (Kinder)</td><td class="right">${fmt2(calc.pv)} ‚Ç¨</td></tr>
          <tr><td><b>Summe gesetzlicher Abz√ºge</b></td><td class="right"><b>${fmt2(calc.sumGesAbz)} ‚Ç¨</b></td></tr>
          <tr><td>Sonstige Abz√ºge</td><td class="right">${fmt2(calc.sumSonst)} ‚Ç¨</td></tr>
          <tr><td><b>NETTOVERDIENST</b></td><td class="right"><b>${fmt2(calc.netto)} ‚Ç¨</b></td></tr>
        </tbody>
      </table>
    `;

    const pay = `
      <div class="payBox">
        <div><b>ZAHLBETRAG:</b> <span style="font-size:14px"><b>${fmt2(calc.netto)} ‚Ç¨</b></span></div>
        <div class="small">IBAN: ${escapeHtml(s.iban||"")} ‚Ä¢ BIC: ${escapeHtml(s.bic||"")}</div>
        <div class="small"><b>Hinweis:</b> Nur interne Simulation ‚Äì keine offizielle Abrechnung.</div>
      </div>
    `;

    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>Lohn- und Gehaltsabrechnung ${escapeHtml(month)}</title>
<style>
@page{size:A4;margin:12mm}
body{font-family:Arial;color:#000}
h1{margin:0;font-size:18px}
.small{font-size:11px;color:#333}
.row{display:flex;justify-content:space-between;gap:18px;align-items:flex-start}
.col{width:49%}
.hr{border-bottom:1px solid #ddd;margin:10px 0}
.boxTable{width:100%;border-collapse:collapse;font-size:10px}
.boxTable td{border:1px solid #ddd;padding:4px}
.t{width:100%;border-collapse:collapse;font-size:11px;margin-top:8px}
.t th,.t td{border-bottom:1px solid #ddd;padding:6px}
.t th{border-top:1px solid #ddd;text-align:left}
.right{text-align:right}
.payBox{border-top:1px solid #ddd;margin-top:10px;padding-top:8px}
</style>
</head><body>

<div class="row">
  <div class="col">${employer}</div>
  <div class="col right">
    <h1>Lohn- und Gehaltsabrechnung</h1>
    <div class="small"><b>${escapeHtml(month)}</b> ‚Ä¢ Bitte aufbewahren (Simulation)</div>
  </div>
</div>

<div class="hr"></div>

<div class="row">
  <div class="col">${employee}</div>
  <div class="col">${box}</div>
</div>

<div class="hr"></div>

${earnings}

<div class="hr"></div>

${abz}

${pay}

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
    openPrint(html);
  },
  arbeitBes(){
    const calc=this.calc();
    const emp=calc.emp; if(!emp){Toast.show("Mitarbeiter w√§hlen");return;}
    const s=calc.s;
    const html = `
<!doctype html><html><head><meta charset="utf-8"><title>Arbeitbescheinigung</title>
<style>@page{size:A4;margin:12mm}body{font-family:Arial;color:#000}h1{margin:0 0 8px 0;font-size:18px}.small{font-size:11px;color:#333}.box{border:1px solid #ddd;padding:10px;margin:10px 0}</style>
</head><body>
<h1>Arbeitbescheinigung (Vorlage)</h1>
<div class="small">Hinweis: Template ‚Äì Daten bitte pr√ºfen. Rules: <b>${escapeHtml(s.rules?.version||"local-default")}</b></div>
<div class="box"><b>Arbeitgeber:</b><br>${escapeHtml(s.company||"")}<br><div style="white-space:pre-line">${escapeHtml(s.addr||"")}</div></div>
<div class="box"><b>Arbeitnehmer:</b><br>${escapeHtml(emp.name||"")}<br><div style="white-space:pre-line">${escapeHtml(emp.addr||"")}</div>
${emp.taxid?`<div class="small">Steuer-ID: ${escapeHtml(emp.taxid)}</div>`:""}
${emp.krankenkasse?`<div class="small">Krankenkasse: ${escapeHtml(emp.krankenkasse)}</div>`:""}
<div class="small">Kinder: ${escapeHtml(emp.children||"0")} ‚Ä¢ Steuerklasse: ${escapeHtml(emp.taxclass||"I")}</div>
</div>
<div class="box"><b>Besch√§ftigung:</b><br>
Stundenlohn: ${fmt2(num(emp.rate))} ‚Ç¨/h<br>
Familienstand: ${escapeHtml(emp.family||"")}<br>
Datum: ${todayISO()}
</div>
<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
    openPrint(ht

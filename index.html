<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1320px;
      margin: 0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:700;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px}

    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r2);
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:800}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:800; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
    }

    .kpi{display:flex; align-items:flex-end; justify-content:space-between; gap:10px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi .label{color:var(--muted); font-size:12px; font-weight:700}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:800; color:var(--muted)}

    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    select option[disabled]{ color: rgba(147,164,198,.9) }

    @media print{
      body{background:#fff; color:#000}
      .app, .sidebar, .topbar, .statusbar{display:none!important}
      #printArea{display:block!important}
    }
    #printArea{display:none}
    .printDoc{font-family: Arial, sans-serif; padding:18px; color:#000;}
    .printHeader{display:flex; justify-content:space-between; gap:20px; align-items:flex-start;
      border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:10px;}
    .printHeader h1{margin:0; font-size:18px}
    .printBox{border:1px solid #ddd; padding:10px; margin:10px 0}
    .printTable{width:100%; border-collapse:collapse}
    .printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:12px}
    .printRight{text-align:right}
    .warn{color:#a00; font-weight:700}

    body.light{
      color:#0b1220;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.20), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.14), transparent 55%),
        linear-gradient(180deg, #f6f8ff 0%, #eef2ff 100%);
    }
    body.light .sidebar,
    body.light .main{
      background: linear-gradient(180deg, rgba(255,255,255,.84), rgba(245,247,255,.84));
      border-color: rgba(0,0,0,.08);
    }
    body.light .card{
      background: rgba(255,255,255,.75);
      border-color: rgba(0,0,0,.08);
    }
    body.light .btn{
      border-color: rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color:#0b1220;
    }
    body.light .field input,
    body.light .field select,
    body.light .field textarea{
      border-color: rgba(0,0,0,.14);
      background: rgba(255,255,255,.85);
      color:#0b1220;
    }
    body.light .muted{color:#4e5c7a}
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">MS</div>
      <div>
        <h1>Masculine Security</h1>
        <small>Mini Office ‚Ä¢ Offline ‚Ä¢ Auto-Save</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="dashboard" class="active"><span>üè† Dashboard</span><span class="pill" id="pillDash">Auto</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="invoices"><span>üßæ Rechnungen</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Einstellungen</span><span class="pill">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Offline:</b> Daten bleiben im Browser (localStorage).</div>
      <div class="muted">Haddii uusan update muuqan: Ctrl+Shift+R (hard refresh).</div>
      <div class="muted"><span class="warn">Hinweis:</span> Rechnung = Einzelunternehmer ‚Ä¢ ¬ß19 UStG (Kleinunternehmer).</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Dashboard</h2>
        <small id="pageSub" class="muted">Auto-Save ‚Ä¢ Kunden w√§hlen fix ‚Ä¢ PDF via Print</small>
      </div>
      <div class="actions" id="topActions">
        <button class="btn primary" id="btnQuickInvoice">+ Rechnung</button>
        <button class="btn" id="btnQuickCustomer">+ Kunde</button>
        <button class="btn" id="btnEmailCompany">‚úâÔ∏è Direkt Email</button>
        <button class="btn" id="btnTheme">üåì Theme</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
      </div>
    </div>

    <div class="content">
      <section id="page-dashboard">
        <div class="grid3">
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Umsatz (Monat)</div>
                <div class="value" id="kpiRevenueMonth">0,00 ‚Ç¨</div>
                <div class="muted" style="font-size:12px">Netto ‚Ä¢ USt=0 (¬ß19 UStG)</div>
              </div>
              <span class="tag">üìà</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Kunden</div>
                <div class="value" id="kpiCustomers">0</div>
                <div class="muted" style="font-size:12px">Kunden werden gespeichert</div>
              </div>
              <span class="tag">üë§</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Rechnungen</div>
                <div class="value" id="kpiInvoices">0</div>
                <div class="muted" style="font-size:12px">PDF via Print</div>
              </div>
              <span class="tag">üßæ</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Letzte Aktivit√§ten</h3>
            <table class="table">
              <thead><tr><th>Typ</th><th>Beschreibung</th><th>Datum</th><th class="right">Betrag</th></tr></thead>
              <tbody id="recentList"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Schnellstart</h3>
            <div class="note">
              <b>1)</b> Kunde speichern ‚Üí <b>2)</b> Rechnung erstellen ‚Üí Kunde ausw√§hlen ‚Üí PDF.<br/>
              <b>Von‚Ä¶Bis</b> waa timeframe, wuxuuna ka soo muuqanayaa PDF.
            </div>
            <div class="hr"></div>
            <button class="btn primary" onclick="UI.go('customers')">+ Kunde</button>
            <button class="btn" onclick="UI.go('invoices')">+ Rechnung</button>
            <button class="btn" onclick="UI.go('settings')">Einstellungen</button>
          </div>
        </div>
      </section>

      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunden</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..." /></div>
            <div class="hr"></div>

            <h3>Neuer Kunde</h3>
            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><input id="c_addr" placeholder="Stra√üe, PLZ Ort"/></div>

            <button class="btn primary" id="btnCustomerSave">Speichern</button>
            <button class="btn danger" id="btnCustomerClear">Leeren</button>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-invoices" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung (Einzelunternehmer)</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr. (auto)</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="field"><label>Leistung / Beschreibung</label>
              <input id="i_desc" placeholder="z.B. Objektschutz / Veranstaltungsschutz"/>
            </div>

            <div class="split">
              <div class="field"><label>Netto (‚Ç¨)</label><input id="i_net" type="number" step="0.01" placeholder="0.00"/></div>
              <div class="field"><label>Zahlungsziel (F√§llig am)</label><input id="i_due" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option value="Entwurf">Entwurf</option>
                  <option value="Gesendet">Gesendet</option>
                  <option value="Bezahlt">Bezahlt</option>
                </select>
              </div>
              <div class="field"><label>Hinweis (¬ß19 UStG)</label>
                <input id="i_hint" value="Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet." readonly/>
              </div>
            </div>

            <div class="note" id="i_previewNote">Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨ ‚Ä¢ Hinweis: ¬ß19 UStG</div>

            <button class="btn primary" id="btnInvoiceSave">Speichern</button>
            <button class="btn" id="btnInvoicePrint">PDF √∂ffnen</button>
            <button class="btn" id="btnInvoiceEmail">Email Rechnung</button>
            <button class="btn danger" id="btnInvoiceClear">Leeren</button>
          </div>

          <div class="card">
            <h3>Rechnungen</h3>
            <div class="split">
              <div class="field"><label>Suche</label><input id="i_search" placeholder="Nr / Kunde..." /></div>
              <div class="field"><label>Status Filter</label>
                <select id="i_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Von‚Ä¶Bis</th>
                  <th>F√§llig</th>
                  <th>Status</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter</h3>
            <div class="field"><label>Suche</label><input id="m_search" placeholder="Name/Steuer-ID..." /></div>
            <div class="hr"></div>

            <h3>Neuer Mitarbeiter</h3>
            <div class="split">
              <div class="field"><label>Name</label><input id="m_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Personal-Nr.</label><input id="m_pnr" placeholder="optional"/></div>
            </div>
            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="m_taxid" placeholder="optional"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="m_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <button class="btn primary" id="btnEmployeeSave">Speichern</button>
            <button class="btn danger" id="btnEmployeeClear">Leeren</button>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Steuer-ID</th><th>Klasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Einstellungen (Firma)</h3>

            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><input id="s_addr"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="..."/></div>
            </div>
            <div class="field"><label>Steuernummer</label><input id="s_taxno" placeholder="..."/></div>

            <button class="btn primary" id="btnSettingsSave">Speichern</button>
            <button class="btn danger" id="btnResetAll">Alles l√∂schen (Reset)</button>

            <div class="hr"></div>
            <div class="note">
              <b>Tip:</b> Settings waxay ka soo muuqanayaan PDF-ga Rechnung.
            </div>
          </div>

          <div class="card">
            <h3>Info</h3>
            <div class="note">
              <b>Rechnung (Einzelunternehmer):</b> USt = 0 haddii aad tahay Kleinunternehmer (¬ß19 UStG).<br/>
              <b>PDF:</b> ‚ÄúPDF √∂ffnen‚Äù ‚Üí Browser Print ‚Üí ‚ÄúSave as PDF‚Äù.
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dotOk"></span>
      <span id="statusText">Bereit.</span>
      <span class="pill" id="verPill">v1</span>
    </div>
  </main>
</div>

<div id="printArea"></div>

<script>
  // ‚úÖ FIX: structuredClone fallback (old browsers/webview)
  if (!window.structuredClone) window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));

  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const fmtEUR = (n) => (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " ‚Ç¨";
  const todayISO = () => new Date().toISOString().slice(0,10);
  const safeId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const Storage = {
    key: "ms_mini_office_v1",
    load(){
      const raw = localStorage.getItem(this.key);
      if(!raw) return null;
      return JSON.parse(raw);
    },
    save(state){
      localStorage.setItem(this.key, JSON.stringify(state));
    },
    wipe(){
      localStorage.removeItem(this.key);
    }
  };

  const Defaults = () => ({
    version: 1,
    theme: "dark",
    settings: {
      company: "Masculine Security",
      addr: "",
      email: "kontakt.mass.bremen@hotmail.com",
      phone: "",
      iban: "",
      bic: "",
      taxno: ""
    },
    customers: [],
    employees: [],
    invoices: [],
    recent: []
  });

  let State = null;

  function setStatus(text, ok=true){
    $("statusText").textContent = text;
    $("dotOk").classList.toggle("off", !ok);
  }

  function commit(){
    Storage.save(State);
    renderAll();
  }

  function addRecent(type, desc, amount=0){
    State.recent.unshift({
      id: safeId(),
      type,
      desc,
      date: new Date().toLocaleString("de-DE"),
      amount: Number(amount||0)
    });
    State.recent = State.recent.slice(0,20);
  }

  function applyTheme(){
    document.body.classList.toggle("light", State.theme === "light");
  }

  function nextInvoiceNo(){
    const year = new Date().getFullYear();
    const prefix = `MS-${year}-`;
    const nums = State.invoices
      .map(i => (i.no||""))
      .filter(no => no.startsWith(prefix))
      .map(no => parseInt(no.split("-").pop(),10))
      .filter(n => Number.isFinite(n));
    const next = (nums.length ? Math.max(...nums) : 0) + 1;
    return prefix + String(next).padStart(4,"0");
  }

  // ---------- UI ----------
  const UI = {
    go(page){
      // nav active
      document.querySelectorAll("#nav button").forEach(b=>{
        b.classList.toggle("active", b.dataset.page === page);
      });
      // sections
      document.querySelectorAll('[id^="page-"]').forEach(sec=>{
        sec.classList.toggle("hide", sec.id !== `page-${page}`);
      });

      // title
      const titleMap = {
        dashboard: "Dashboard",
        customers: "Kunden",
        invoices: "Rechnungen",
        employees: "Mitarbeiter",
        settings: "Einstellungen"
      };
      $("pageTitle").textContent = titleMap[page] || "Mini Office";
      $("pageSub").textContent = "Auto-Save ‚Ä¢ Offline ‚Ä¢ PDF via Print";

      // page-specific refresh
      if(page === "invoices") Invoices.refreshCustomerSelect();
      setStatus("Bereit.");
    }
  };
  window.UI = UI;

  // ---------- Customers ----------
  const Customers = {
    add(){
      const name = $("c_name").value.trim();
      const email = $("c_email").value.trim();
      const phone = $("c_phone").value.trim();
      const addr = $("c_addr").value.trim();

      if(!name){
        setStatus("Bitte Kundenname eingeben.", false);
        return;
      }
      const c = { id: safeId(), name, email, phone, addr };
      State.customers.unshift(c);
      addRecent("Kunde", `Kunde gespeichert: ${name}`, 0);
      this.clearForm();
      commit();
      setStatus("Kunde gespeichert ‚úÖ");
    },
    remove(id){
      State.customers = State.customers.filter(c=>c.id!==id);
      commit();
      setStatus("Kunde gel√∂scht.");
    },
    clearForm(){
      $("c_name").value="";
      $("c_email").value="";
      $("c_phone").value="";
      $("c_addr").value="";
    },
    render(){
      const q = ($("c_search").value||"").toLowerCase();
      const list = State.customers.filter(c=>{
        const blob = `${c.name} ${c.email} ${c.addr}`.toLowerCase();
        return !q || blob.includes(q);
      });
      $("customersList").innerHTML = list.map(c=>`
        <tr>
          <td><b>${escapeHTML(c.name)}</b></td>
          <td>${escapeHTML(c.email||"")}</td>
          <td>${escapeHTML(c.addr||"")}</td>
          <td class="right">
            <button class="btn danger" onclick="Customers.remove('${c.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Noch keine Kunden.</td></tr>`;

      $("pillCustomers").textContent = State.customers.length;
      $("kpiCustomers").textContent = State.customers.length;
    }
  };
  window.Customers = Customers;

  // ---------- Employees ----------
  const Employees = {
    add(){
      const name = $("m_name").value.trim();
      const pnr = $("m_pnr").value.trim();
      const taxid = $("m_taxid").value.trim();
      const taxclass = $("m_taxclass").value;

      if(!name){
        setStatus("Bitte Mitarbeitername eingeben.", false);
        return;
      }
      const m = { id: safeId(), name, pnr, taxid, taxclass };
      State.employees.unshift(m);
      addRecent("Mitarbeiter", `Mitarbeiter gespeichert: ${name}`, 0);
      this.clearForm();
      commit();
      setStatus("Mitarbeiter gespeichert ‚úÖ");
    },
    remove(id){
      State.employees = State.employees.filter(m=>m.id!==id);
      commit();
      setStatus("Mitarbeiter gel√∂scht.");
    },
    clearForm(){
      $("m_name").value="";
      $("m_pnr").value="";
      $("m_taxid").value="";
      $("m_taxclass").value="I";
    },
    render(){
      const q = ($("m_search").value||"").toLowerCase();
      const list = State.employees.filter(m=>{
        const blob = `${m.name} ${m.taxid} ${m.taxclass}`.toLowerCase();
        return !q || blob.includes(q);
      });
      $("employeesList").innerHTML = list.map(m=>`
        <tr>
          <td><b>${escapeHTML(m.name)}</b></td>
          <td>${escapeHTML(m.taxid||"")}</td>
          <td>${escapeHTML(m.taxclass||"")}</td>
          <td class="right">
            <button class="btn danger" onclick="Employees.remove('${m.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Noch keine Mitarbeiter.</td></tr>`;

      $("pillEmployees").textContent = State.employees.length;
    }
  };
  window.Employees = Employees;

  // ---------- Invoices ----------
  const Invoices = {
    refreshCustomerSelect(){
      const sel = $("i_customer");
      const current = sel.value;
      const opts = [
        `<option value="" disabled ${current ? "" : "selected"}>‚Äî Bitte w√§hlen ‚Äî</option>`,
        ...State.customers.map(c => `<option value="${c.id}" ${c.id===current?"selected":""}>${escapeHTML(c.name)}</option>`)
      ];
      sel.innerHTML = opts.join("");
    },
    updatePreview(){
      const net = Number($("i_net").value||0);
      $("i_previewNote").textContent = `Gesamt: ${fmtEUR(net)} ‚Ä¢ USt: ${fmtEUR(0)} ‚Ä¢ Hinweis: ¬ß19 UStG`;
      $("kpiRevenueMonth").textContent = fmtEUR(calcMonthRevenue());
    },
    add(){
      const no = ($("i_no").value||"").trim() || nextInvoiceNo();
      const date = $("i_date").value || todayISO();
      const von = $("i_von").value || "";
      const bis = $("i_bis").value || "";
      const due = $("i_due").value || "";
      const customerId = $("i_customer").value || "";
      const desc = $("i_desc").value.trim();
      const net = Number($("i_net").value||0);
      const status = $("i_status").value || "Entwurf";

      if(!customerId){
        setStatus("Bitte Kunde ausw√§hlen.", false);
        return;
      }
      if(!desc){
        setStatus("Bitte Leistung/Beschreibung eingeben.", false);
        return;
      }
      if(!(net>0)){
        setStatus("Bitte Netto-Betrag eingeben.", false);
        return;
      }

      const customer = State.customers.find(c=>c.id===customerId) || null;

      const inv = {
        id: safeId(),
        no, date, von, bis, due,
        customerId,
        customerName: customer ? customer.name : "",
        customerEmail: customer ? customer.email : "",
        customerAddr: customer ? customer.addr : "",
        desc,
        net,
        vat: 0,
        total: net,
        status,
        note: "Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet."
      };

      State.invoices.unshift(inv);
      addRecent("Rechnung", `Rechnung ${no} an ${inv.customerName}`, net);
      this.clearForm(false);
      commit();
      setStatus("Rechnung gespeichert ‚úÖ");
    },
    clearForm(resetNo=true){
      if(resetNo) $("i_no").value = nextInvoiceNo();
      $("i_date").value = todayISO();
      $("i_von").value = "";
      $("i_bis").value = "";
      $("i_due").value = "";
      $("i_desc").value = "";
      $("i_net").value = "";
      $("i_status").value = "Entwurf";
      this.refreshCustomerSelect();
      this.updatePreview();
    },
    remove(id){
      State.invoices = State.invoices.filter(i=>i.id!==id);
      commit();
      setStatus("Rechnung gel√∂scht.");
    },
    emailToCustomer(id=null){
      let inv = null;
      if(id){
        inv = State.invoices.find(x=>x.id===id);
      }else{
        // current form
        const cid = $("i_customer").value || "";
        const c = State.customers.find(x=>x.id===cid);
        inv = {
          no: ($("i_no").value||"").trim() || nextInvoiceNo(),
          date: $("i_date").value || todayISO(),
          customerEmail: c ? c.email : "",
          customerName: c ? c.name : "",
          total: Number($("i_net").value||0)
        };
      }
      if(!inv || !inv.customerEmail){
        setStatus("Kein Kunden-Email gefunden.", false);
        return;
      }
      const subj = encodeURIComponent(`Rechnung ${inv.no} ‚Äì Masculine Security`);
      const body = encodeURIComponent(
        `Guten Tag ${inv.customerName || ""},\n\nanbei die Rechnung ${inv.no}.\nBetrag: ${fmtEUR(inv.total)}\n\nMit freundlichen Gr√º√üen\n${State.settings.company}\n${State.settings.email}`
      );
      window.location.href = `mailto:${encodeURIComponent(inv.customerEmail)}?subject=${subj}&body=${body}`;
      setStatus("Email-App ge√∂ffnet.");
    },
    print(id=null){
      let inv = null;
      if(id){
        inv = State.invoices.find(x=>x.id===id);
      }else{
        // from form
        const cid = $("i_customer").value || "";
        const c = State.customers.find(x=>x.id===cid) || {};
        inv = {
          no: ($("i_no").value||"").trim() || nextInvoiceNo(),
          date: $("i_date").value || todayISO(),
          von: $("i_von").value || "",
          bis: $("i_bis").value || "",
          due: $("i_due").value || "",
          customerName: c.name||"",
          customerAddr: c.addr||"",
          customerEmail: c.email||"",
          desc: $("i_desc").value.trim(),
          net: Number($("i_net").value||0),
          vat: 0,
          total: Number($("i_net").value||0),
          note: "Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet."
        };
      }

      const daysTxt = dateRangeDays(inv.von, inv.bis);
      const company = State.settings;

      $("printArea").innerHTML = `
        <div class="printDoc">
          <div class="printHeader">
            <div>
              <h1>Rechnung</h1>
              <div><b>${escapeHTML(company.company||"")}</b></div>
              <div>${escapeHTML(company.addr||"")}</div>
              <div>Email: ${escapeHTML(company.email||"")}</div>
              ${company.phone?`<div>Tel: ${escapeHTML(company.phone)}</div>`:""}
            </div>
            <div>
              <div><b>Rechnung Nr.:</b> ${escapeHTML(inv.no||"")}</div>
              <div><b>Rechnungsdatum:</b> ${escapeHTML(inv.date||"")}</div>
              ${inv.due?`<div><b>F√§llig am:</b> ${escapeHTML(inv.due)}</div>`:""}
              ${(inv.von||inv.bis)?`<div><b>Von‚Ä¶Bis:</b> ${escapeHTML(inv.von||"")} ‚Äì ${escapeHTML(inv.bis||"")} ${daysTxt?`(${daysTxt})`:""}</div>`:""}
              ${company.taxno?`<div><b>Steuernummer:</b> ${escapeHTML(company.taxno)}</div>`:""}
            </div>
          </div>

          <div class="printBox">
            <div><b>Kunde:</b> ${escapeHTML(inv.customerName||"")}</div>
            <div>${escapeHTML(inv.customerAddr||"")}</div>
            ${inv.customerEmail?`<div>Email: ${escapeHTML(inv.customerEmail)}</div>`:""}
          </div>

          <table class="printTable">
            <thead>
              <tr><th>Beschreibung</th><th class="printRight">Netto</th><th class="printRight">USt</th><th class="printRight">Gesamt</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${escapeHTML(inv.desc||"")}</td>
                <td class="printRight">${fmtEUR(inv.net||0)}</td>
                <td class="printRight">${fmtEUR(0)}</td>
                <td class="printRight"><b>${fmtEUR(inv.total||0)}</b></td>
              </tr>
            </tbody>
          </table>

          <div class="printBox">
            <div><b>Zahlung:</b></div>
            ${company.iban?`<div>IBAN: ${escapeHTML(company.iban)}</div>`:""}
            ${company.bic?`<div>BIC: ${escapeHTML(company.bic)}</div>`:""}
          </div>

          <div class="printBox">
            <div><b>Hinweis:</b> ${escapeHTML(inv.note||"")}</div>
          </div>
        </div>
      `;
      window.print();
      setStatus("Print ge√∂ffnet (Save as PDF).");
    },
    render(){
      // filters
      const q = ($("i_search").value||"").toLowerCase();
      const st = $("i_filter").value||"";
      const list = State.invoices.filter(inv=>{
        const blob = `${inv.no} ${inv.customerName}`.toLowerCase();
        const okQ = !q || blob.includes(q);
        const okS = !st || inv.status===st;
        return okQ && okS;
      });

      $("invoicesList").innerHTML = list.map(inv=>`
        <tr>
          <td><b>${escapeHTML(inv.no)}</b></td>
          <td>${escapeHTML(inv.customerName||"")}</td>
          <td>${escapeHTML(inv.von||"")} ‚Äì ${escapeHTML(inv.bis||"")}</td>
          <td>${escapeHTML(inv.due||"")}</td>
          <td>${escapeHTML(inv.status||"")}</td>
          <td class="right">${fmtEUR(inv.net||0)}</td>
          <td class="right">
            <button class="btn" onclick="Invoices.print('${inv.id}')">PDF</button>
            <button class="btn" onclick="Invoices.emailToCustomer('${inv.id}')">Email</button>
            <button class="btn danger" onclick="Invoices.remove('${inv.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="7" class="muted">Noch keine Rechnungen.</td></tr>`;

      $("pillInvoices").textContent = State.invoices.length;
      $("kpiInvoices").textContent = State.invoices.length;
      $("kpiRevenueMonth").textContent = fmtEUR(calcMonthRevenue());
    }
  };
  window.Invoices = Invoices;

  // ---------- Dashboard ----------
  function renderRecent(){
    const rows = State.recent.map(r=>`
      <tr>
        <td>${escapeHTML(r.type||"")}</td>
        <td>${escapeHTML(r.desc||"")}</td>
        <td>${escapeHTML(r.date||"")}</td>
        <td class="right">${fmtEUR(r.amount||0)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">Noch keine Aktivit√§ten.</td></tr>`;
    $("recentList").innerHTML = rows;
  }

  function calcMonthRevenue(){
    const now = new Date();
    const ym = now.toISOString().slice(0,7); // YYYY-MM
    return State.invoices
      .filter(i => (i.date||"").slice(0,7) === ym)
      .reduce((sum,i)=>sum + Number(i.net||0), 0);
  }

  function dateRangeDays(von, bis){
    if(!von || !bis) return "";
    const a = new Date(von);
    const b = new Date(bis);
    if(isNaN(a.getTime()) || isNaN(b.getTime())) return "";
    const diff = Math.round((b - a) / (1000*60*60*24)) + 1;
    if(diff <= 0) return "";
    return `${diff} Tage`;
  }

  function escapeHTML(s){
    return String(s??"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ---------- Settings ----------
  const Settings = {
    loadToForm(){
      const s = State.settings;
      $("s_company").value = s.company || "";
      $("s_addr").value = s.addr || "";
      $("s_email").value = s.email || "";
      $("s_phone").value = s.phone || "";
      $("s_iban").value = s.iban || "";
      $("s_bic").value = s.bic || "";
      $("s_taxno").value = s.taxno || "";
    },
    saveFromForm(){
      State.settings.company = $("s_company").value.trim();
      State.settings.addr = $("s_addr").value.trim();
      State.settings.email = $("s_email").value.trim();
      State.settings.phone = $("s_phone").value.trim();
      State.settings.iban = $("s_iban").value.trim();
      State.settings.bic = $("s_bic").value.trim();
      State.settings.taxno = $("s_taxno").value.trim();
      commit();
      setStatus("Einstellungen gespeichert ‚úÖ");
    }
  };

  // ---------- Export / Import ----------
  function exportJSON(){
    const blob = new Blob([JSON.stringify(State, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ms-mini-office-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("Export heruntergeladen.");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(String(reader.result||""));
        if(!data || typeof data !== "object") throw new Error("invalid");
        State = Object.assign(Defaults(), data);
        applyTheme();
        commit();
        setStatus("Import erfolgreich ‚úÖ");
      }catch(e){
        setStatus("Import Fehler: JSON ung√ºltig.", false);
      }
    };
    reader.readAsText(file);
  }

  // ---------- Render ----------
  function renderAll(){
    Customers.render();
    Employees.render();
    Invoices.refreshCustomerSelect();
    Invoices.render();
    renderRecent();
    Settings.loadToForm();
    $("verPill").textContent = "v1";
  }

  // ---------- Init ----------
  function init(){
    try{
      State = Storage.load() || Defaults();

      // default dates
      $("i_date").value = todayISO();

      // Ensure invoice no
      $("i_no").value = nextInvoiceNo();

      applyTheme();
      renderAll();
      Invoices.updatePreview();

      // NAV click
      document.querySelectorAll("#nav button").forEach(btn=>{
        btn.addEventListener("click", ()=> UI.go(btn.dataset.page));
      });

      // Top actions
      $("btnQuickInvoice").addEventListener("click", ()=>{ UI.go("invoices"); });
      $("btnQuickCustomer").addEventListener("click", ()=>{ UI.go("customers"); });
      $("btnTheme").addEventListener("click", ()=>{
        State.theme = (State.theme === "light") ? "dark" : "light";
        applyTheme();
        commit();
        setStatus("Theme ge√§ndert.");
      });

      $("btnEmailCompany").addEventListener("click", ()=>{
        const mail = (State.settings.email||"").trim();
        if(!mail){ setStatus("Kein Firmen-Email in Einstellungen.", false); return; }
        window.location.href = `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent("Masculine Security")}`;
      });

      $("btnExport").addEventListener("click", exportJSON);
      $("btnImport").addEventListener("click", ()=> $("fileImport").click());
      $("fileImport").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(f) importJSON(f);
        e.target.value = "";
      });

      // Customers events
      $("btnCustomerSave").addEventListener("click", ()=> Customers.add());
      $("btnCustomerClear").addEventListener("click", ()=> { Customers.clearForm(); setStatus("Form geleert."); });
      $("c_search").addEventListener("input", ()=> Customers.render());

      // Employees events
      $("btnEmployeeSave").addEventListener("click", ()=> Employees.add());
      $("btnEmployeeClear").addEventListener("click", ()=> { Employees.clearForm(); setStatus("Form geleert."); });
      $("m_search").addEventListener("input", ()=> Employees.render());

      // Invoices events
      $("i_net").addEventListener("input", ()=> Invoices.updatePreview());
      $("i_customer").addEventListener("change", ()=> setStatus("Kunde ausgew√§hlt."));
      $("btnInvoiceSave").addEventListener("click", ()=> Invoices.add());
      $("btnInvoicePrint").addEventListener("click", ()=> Invoices.print());
      $("btnInvoiceEmail").addEventListener("click", ()=> Invoices.emailToCustomer());
      $("btnInvoiceClear").addEventListener("click", ()=> { Invoices.clearForm(); setStatus("Form geleert."); });

      $("i_search").addEventListener("input", ()=> Invoices.render());
      $("i_filter").addEventListener("change", ()=> Invoices.render());

      // Settings events
      $("btnSettingsSave").addEventListener("click", ()=> Settings.saveFromForm());
      $("btnResetAll").addEventListener("click", ()=>{
        if(confirm("Wirklich alles l√∂schen?")){
          Storage.wipe();
          State = Defaults();
          applyTheme();
          commit();
          Invoices.clearForm(true);
          setStatus("Alles gel√∂scht ‚úÖ");
        }
      });

      // Go default page
      UI.go("dashboard");

      setStatus("Bereit ‚úÖ");
    }catch(err){
      console.error(err);
      setStatus("Fehler: " + (err && err.message ? err.message : "unknown"), false);
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>

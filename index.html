<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Dienstplan</title>
  <meta name="theme-color" content="#0b1220"/>

  <!-- PDF generator (works on GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#071225;
      --panel:#0b1a33;
      --panel2:#0c2242;
      --card:#0f2a4f;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --accent2:#71c2ff;
      --good:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:18px; --r2:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 25% -10%, rgba(58,166,255,.35), transparent 60%),
        radial-gradient(900px 600px at 110% 0%, rgba(33,209,159,.25), transparent 55%),
        radial-gradient(800px 500px at 30% 120%, rgba(255,206,84,.15), transparent 55%),
        linear-gradient(180deg, #050b16, #071225);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 50px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px; border:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(15,42,79,.95), rgba(11,26,51,.92));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .logoBox{
      width:58px;height:58px;border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block}
    .brand h1{margin:0;font-size:16px;letter-spacing:.3px}
    .brand .sub{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(7,18,37,.55);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      appearance:none;border:none;cursor:pointer;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;border-radius:999px;
      font-weight:700;font-size:12px;
      letter-spacing:.2px;
      transition:.15s transform,.15s background,.15s border;
    }
    button:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
    .primary{
      background:linear-gradient(180deg, rgba(58,166,255,.95), rgba(26,132,220,.95));
      border-color:rgba(58,166,255,.35);
      color:#071225;
    }
    .danger{background:rgba(255,77,109,.14); border-color:rgba(255,77,109,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .brand{min-width:auto} .topbar{position:static} }
    .card{
      border:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(15,42,79,.85), rgba(11,26,51,.80));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardHead p{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .cardBody{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;
      background:rgba(7,18,37,.5);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    .help{margin-top:8px;font-size:12px;color:var(--muted)}
    .kpi{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:8px
    }
    .kpi .pill b{color:var(--text)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabBtn{background:rgba(255,255,255,.06)}
    .tabBtn.active{background:rgba(58,166,255,.18); border-color:rgba(58,166,255,.35)}
    .hidden{display:none !important}
    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:800}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--text);
      white-space:nowrap;
    }
    .ok{background:rgba(33,209,159,.12);border-color:rgba(33,209,159,.25)}
    .no{background:rgba(255,77,109,.12);border-color:rgba(255,77,109,.25)}
    .footNote{margin-top:10px;font-size:12px;color:var(--muted)}
    .printOnly{display:none}
    @media print{
      body{background:#fff;color:#111}
      .topbar, .noPrint{display:none !important}
      .wrap{max-width:100%;padding:0}
      .card{box-shadow:none;border:1px solid #ddd;background:#fff}
      .printOnly{display:block}
      a{color:#111;text-decoration:none}
    }
  </style>
</head>
<body>
  <div class="wrap" id="appRoot">
    <div class="topbar noPrint">
      <div class="brand">
        <div class="logoBox">
          <img id="logoImg" alt="Logo" src="logo.png" />
        </div>
        <div>
          <h1>MAS‚ÄãCULINE SECURITY ‚Äî Dienstplan</h1>
          <div class="sub">
            Werschenregerstra√üe 6 ¬∑ 28237 Bremen ¬∑ Tel: <a id="telLink" href="tel:+4915778697052">015778697052</a><br/>
            <a id="mailLink" href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a>
            <div class="kpi">
              <span class="pill">Auto-Update: <b id="autoState">ON</b></span>
              <span class="pill">Letztes Speichern: <b id="lastSaved">‚Äî</b></span>
            </div>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="tabBtn active" id="tabPlan">Wochenplan</button>
        <button class="tabBtn" id="tabDocs">Dokumentation</button>
        <button id="btnPrint">Drucken</button>
        <button class="primary" id="btnPDF">PDF</button>
        <button id="btnAutoSheet">Auto-Print Sheet</button>
        <button id="btnCSV">Export CSV</button>
        <button class="primary" id="btnWhatsApp">WhatsApp (PDF teilen)</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- Printable header -->
    <div class="card printOnly" style="margin:10px 0 14px">
      <div class="cardBody" style="display:flex;gap:12px;align-items:center">
        <div style="width:70px;height:70px;border:1px solid #ddd;border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center">
          <img id="logoImgPrint" alt="Logo" src="logo.png" style="width:100%;height:100%;object-fit:cover"/>
        </div>
        <div>
          <div style="font-weight:900;font-size:16px">Masculine Security ‚Äî Dienstplan</div>
          <div style="font-size:12px;color:#333;margin-top:4px">
            Werschenregerstra√üe 6 ¬∑ 28237 Bremen ¬∑ Tel: 015778697052 ¬∑ Kontakt.mass.bremen@hotmail.com
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="panelLeft">
        <div class="cardHead">
          <div>
            <h2 id="leftTitle">W√∂chentlicher Mitarbeiter-Dienstplan</h2>
            <p id="leftDesc">Trage Name, Arbeitstage, Objekt und Schicht ein. Danach ‚ÄûSpeichern‚Äú.</p>
          </div>
          <span class="badge" id="statusBadge">Bereit</span>
        </div>

        <div class="cardBody" id="planBody">
          <div class="row">
            <div>
              <label for="empNo">Mitarbeiter-Nr.</label>
              <input id="empNo" placeholder="z. B. MS-001" />
            </div>
            <div>
              <label for="empName">Name</label>
              <input id="empName" placeholder="z. B. Mustafa" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="empDays">Arbeitstage (z. B. Mo, Di, Mi, Do)</label>
              <input id="empDays" placeholder="Mo, Di, Mi, Do" />
            </div>
            <div>
              <label for="empShift">Schicht</label>
              <select id="empShift">
                <option value="Tag">Tag</option>
                <option value="Nacht">Nacht</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="empObj">Objekt / Einsatzort</label>
              <input id="empObj" placeholder="z. B. Baustelle / Hotel / Lager" />
            </div>
            <div>
              <label for="empTime">Zeit (optional)</label>
              <input id="empTime" placeholder="z. B. 18:00‚Äì06:00" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="empNote">Notiz (optional)</label>
            <input id="empNote" placeholder="z. B. Schl√ºssel / Rundgang / Besonderheiten" />
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
            <button class="primary" id="btnSavePlan">Speichern</button>
            <button id="btnNewPlan">Neu</button>
            <button id="btnClearPlans" class="danger">Alle Wochenpl√§ne l√∂schen</button>
          </div>

          <div class="help">
            ‚úÖ WhatsApp-Text wird automatisch rechts erzeugt.<br/>
            ‚úÖ PDF Button erzeugt eine Datei mit Logo + Firmendaten + Pl√§nen.
          </div>
        </div>

        <div class="cardBody hidden" id="docsBody">
          <div class="row">
            <div>
              <label for="docDate">Datum</label>
              <input id="docDate" type="date"/>
            </div>
            <div>
              <label for="docObj">Objekt</label>
              <input id="docObj" placeholder="z. B. Baustelle Bremen"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="docPresent">Anwesend (1 Zeile pro Mitarbeiter)</label>
              <textarea id="docPresent" placeholder="Mustafa (MS-001)&#10;Ahmed (MS-002)"></textarea>
            </div>
            <div>
              <label for="docAbsent">Abwesend (1 Zeile pro Mitarbeiter)</label>
              <textarea id="docAbsent" placeholder="Ali (MS-010) ‚Äî krank"></textarea>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
            <button class="primary" id="btnSaveDoc">Dokumentation speichern</button>
            <button id="btnNewDoc">Neu</button>
            <button class="danger" id="btnClearDocs">Alle Dokumentationen l√∂schen</button>
          </div>

          <div class="help">
            Dokumentation wird im Browser gespeichert (localStorage). PDF enth√§lt auch Dokumentation, wenn du in diesen Tab wechselst.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardHead">
          <div>
            <h2>Vorschau (an Mitarbeiter senden)</h2>
            <p>Text kopieren & in WhatsApp/Email einf√ºgen. Wird automatisch aktualisiert.</p>
          </div>
          <span class="badge ok" id="previewBadge">Auto</span>
        </div>
        <div class="cardBody">
          <label for="msgPreview">Nachricht</label>
          <textarea id="msgPreview"></textarea>

          <div class="footNote">
            Tipp: Button <b>‚ÄûWhatsApp (PDF teilen)‚Äù</b> erstellt PDF + √∂ffnet WhatsApp-Text.
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0"/>

          <div class="tableWrap">
            <table id="plansTable">
              <thead>
                <tr>
                  <th>Mitarbeiter-Nr.</th>
                  <th>Name</th>
                  <th>Tage</th>
                  <th>Objekt</th>
                  <th>Schicht</th>
                  <th>Zeit</th>
                  <th>Aktion</th>
                </tr>
              </thead>
              <tbody id="plansTbody">
                <tr><td colspan="7" style="color:var(--muted)">Noch keine Wochenpl√§ne gespeichert.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="tableWrap" style="margin-top:14px">
            <table id="docsTable">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Objekt</th>
                  <th>Anwesend</th>
                  <th>Abwesend</th>
                  <th>Aktion</th>
                </tr>
              </thead>
              <tbody id="docsTbody">
                <tr><td colspan="5" style="color:var(--muted)">Noch keine Dokumentation gespeichert.</td></tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Storage keys =========
    const K_PLANS = "MS_PLANS_V1";
    const K_DOCS  = "MS_DOCS_V1";
    const K_META  = "MS_META_V1";

    // ========= Helpers =========
    const $ = (id)=>document.getElementById(id);
    const nowISO = ()=> new Date().toISOString();
    const fmtTime = (iso)=>{
      if(!iso) return "‚Äî";
      try{
        const d = new Date(iso);
        return d.toLocaleString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return "‚Äî"; }
    };
    const safe = (s)=> String(s??"").trim();
    const loadJSON = (k, def)=>{
      try{ return JSON.parse(localStorage.getItem(k) || ""); }catch{ return def; }
    };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
    const setStatus = (text, kind=""){
      const b = $("statusBadge");
      b.textContent = text;
      b.className = "badge" + (kind ? " "+kind : "");
    };
    const touchSaved = ()=>{
      const meta = loadJSON(K_META, { lastSaved: null });
      meta.lastSaved = nowISO();
      saveJSON(K_META, meta);
      $("lastSaved").textContent = fmtTime(meta.lastSaved);
    };

    // ========= Logo fallback =========
    function initLogo(){
      const img = $("logoImg");
      const imgP = $("logoImgPrint");
      const fallback = ()=>{
        // build a simple SVG badge as fallback (no extra files)
        const svg = encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">
            <defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#3aa6ff"/>
                <stop offset="1" stop-color="#21d19f"/>
              </linearGradient>
            </defs>
            <rect width="120" height="120" rx="28" fill="url(#g)"/>
            <text x="60" y="70" text-anchor="middle" font-family="Arial" font-size="44" font-weight="900" fill="#071225">MS</text>
          </svg>
        `);
        const uri = "data:image/svg+xml;charset=utf-8," + svg;
        img.src = uri;
        imgP.src = uri;
      };
      img.addEventListener("error", fallback, { once:true });
      imgP.addEventListener("error", fallback, { once:true });
    }

    // ========= Tabs =========
    function setTab(tab){
      const isPlan = tab==="plan";
      $("tabPlan").classList.toggle("active", isPlan);
      $("tabDocs").classList.toggle("active", !isPlan);
      $("planBody").classList.toggle("hidden", !isPlan);
      $("docsBody").classList.toggle("hidden", isPlan);
      $("leftTitle").textContent = isPlan ? "W√∂chentlicher Mitarbeiter-Dienstplan" : "Dokumentation ‚Äî Anwesend / Abwesend";
      $("leftDesc").textContent  = isPlan
        ? "Trage Name, Arbeitstage, Objekt und Schicht ein. Danach ‚ÄûSpeichern‚Äú."
        : "Trage Anwesenheit/Abwesenheit ein. Danach ‚ÄûDokumentation speichern‚Äú.";
      rebuildPreview();
    }

    // ========= Data =========
    function getPlans(){ return loadJSON(K_PLANS, []); }
    function setPlans(v){ saveJSON(K_PLANS, v); touchSaved(); }
    function getDocs(){ return loadJSON(K_DOCS, []); }
    function setDocs(v){ saveJSON(K_DOCS, v); touchSaved(); }

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    // ========= Rendering =========
    function renderPlans(){
      const rows = getPlans();
      const tb = $("plansTbody");
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="7" style="color:var(--muted)">Noch keine Wochenpl√§ne gespeichert.</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td><span class="badge">${escapeHtml(r.no||"‚Äî")}</span></td>
          <td><b>${escapeHtml(r.name||"")}</b></td>
          <td>${escapeHtml(r.days||"")}</td>
          <td>${escapeHtml(r.obj||"")}</td>
          <td><span class="badge ${r.shift==="Nacht"?"no":"ok"}">${escapeHtml(r.shift||"")}</span></td>
          <td>${escapeHtml(r.time||"")}</td>
          <td><button data-del-plan="${r.id}" class="danger" style="padding:7px 10px;border-radius:12px">L√∂schen</button></td>
        </tr>
      `).join("");
    }

    function renderDocs(){
      const rows = getDocs();
      const tb = $("docsTbody");
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Noch keine Dokumentation gespeichert.</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.date||"")}</td>
          <td>${escapeHtml(r.obj||"")}</td>
          <td>${escapeHtml((r.present||"").split("\n").filter(Boolean).join(", "))}</td>
          <td>${escapeHtml((r.absent||"").split("\n").filter(Boolean).join(", "))}</td>
          <td><button data-del-doc="${r.id}" class="danger" style="padding:7px 10px;border-radius:12px">L√∂schen</button></td>
        </tr>
      `).join("");
    }

    function escapeHtml(s){
      return String(s??"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // ========= Preview =========
    function rebuildPreview(){
      const plans = getPlans();
      const docs  = getDocs();

      let text = "";
      text += "Masculine Security ‚Äî Dienstplan\n";
      text += "Werschenregerstra√üe 6, 28237 Bremen\n";
      text += "Tel: 015778697052 | Email: Kontakt.mass.bremen@hotmail.com\n";
      text += "---------------------------------\n";

      if(plans.length){
        text += "WOCHENPLAN:\n";
        plans.forEach((p,i)=>{
          text += `${i+1}) ${p.name || "‚Äî"} (${p.no||"‚Äî"}): ${p.days || "‚Äî"} ‚Äî ${p.obj || "‚Äî"} ‚Äî ${p.shift || "‚Äî"}`;
          if(p.time) text += ` (${p.time})`;
          if(p.note) text += ` | Notiz: ${p.note}`;
          text += "\n";
        });
      }else{
        text += "WOCHENPLAN: (noch leer)\n";
      }

      text += "\n";

      // include docs only if docs tab active OR docs exist
      if(docs.length){
        text += "DOKUMENTATION:\n";
        docs.slice(0,3).forEach((d,i)=>{
          text += `${i+1}) ${d.date || "‚Äî"} ‚Äî ${d.obj || "‚Äî"}\n`;
          text += `   Anwesend: ${(d.present||"").split("\n").filter(Boolean).join(", ") || "‚Äî"}\n`;
          text += `   Abwesend: ${(d.absent||"").split("\n").filter(Boolean).join(", ") || "‚Äî"}\n`;
        });
        if(docs.length>3) text += `   (+${docs.length-3} weitere Eintr√§ge)\n`;
      }

      $("msgPreview").value = text.trim();
    }

    // ========= PDF / Print =========
    function printNow(){
      window.print();
    }

    async function exportPDF(){
      // Use full appRoot so header + tables show
      const element = $("appRoot");

      setStatus("PDF wird erstellt‚Ä¶", "ok");
      try{
        // useCORS true helps with logo.png on GitHub Pages
        const opt = {
          margin: 8,
          filename: "Masculine_Security_Dienstplan.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
        };
        await html2pdf().set(opt).from(element).save();
        setStatus("PDF gespeichert", "ok");
      }catch(e){
        console.error(e);
        setStatus("PDF Fehler ‚Äî bitte Drucken nutzen", "no");
        alert("PDF konnte nicht erstellt werden. Bitte nutze: Drucken ‚Üí Als PDF speichern.");
      }
    }

    async function whatsappPDF(){
      // 99% automatic:
      // 1) Save PDF (download)
      // 2) Open WhatsApp with prefilled text (user attaches the downloaded PDF)
      await exportPDF();
      const msg = $("msgPreview").value.trim() || "Masculine Security ‚Äî Dienstplan (PDF)";
      window.open("https://wa.me/?text=" + encodeURIComponent(
        msg + "\n\nPDF wurde gespeichert. Bitte in WhatsApp als Dokument anh√§ngen und senden."
      ), "_blank", "noopener,noreferrer");

      alert("‚úÖ PDF gespeichert.\n‚û°Ô∏è WhatsApp Text ge√∂ffnet.\n‚û°Ô∏è Bitte: Attach/üìé ‚Üí Dokument ‚Üí PDF ausw√§hlen ‚Üí Senden.");
    }

    // ========= Auto-print sheet =========
    function autoPrintSheet(){
      // open a clean window and print only tables
      const plans = getPlans();
      const docs = getDocs();
      const html = `
        <!doctype html><html><head><meta charset="utf-8"/>
        <title>Auto-Print Sheet</title>
        <style>
          body{font-family:Arial;margin:18px}
          .head{display:flex;gap:12px;align-items:center}
          .logo{width:64px;height:64px;border:1px solid #ddd;border-radius:14px;overflow:hidden}
          .logo img{width:100%;height:100%;object-fit:cover}
          h1{font-size:16px;margin:0}
          .sub{font-size:12px;color:#333;margin-top:4px}
          table{width:100%;border-collapse:collapse;margin-top:14px}
          th,td{border-bottom:1px solid #ddd;padding:8px;font-size:12px;text-align:left;vertical-align:top}
          th{background:#f3f6ff}
        </style></head><body>
          <div class="head">
            <div class="logo"><img src="logo.png" onerror="this.style.display='none'"/></div>
            <div>
              <h1>Masculine Security ‚Äî Dienstplan</h1>
              <div class="sub">Werschenregerstra√üe 6 ¬∑ 28237 Bremen ¬∑ Tel: 015778697052 ¬∑ Kontakt.mass.bremen@hotmail.com</div>
            </div>
          </div>

          <h2 style="font-size:14px;margin:16px 0 6px">Wochenplan</h2>
          <table>
            <thead><tr><th>Nr.</th><th>Name</th><th>Tage</th><th>Objekt</th><th>Schicht</th><th>Zeit</th></tr></thead>
            <tbody>
              ${plans.length ? plans.map(p=>`
                <tr>
                  <td>${escapeHtml(p.no||"‚Äî")}</td>
                  <td>${escapeHtml(p.name||"‚Äî")}</td>
                  <td>${escapeHtml(p.days||"‚Äî")}</td>
                  <td>${escapeHtml(p.obj||"‚Äî")}</td>
                  <td>${escapeHtml(p.shift||"‚Äî")}</td>
                  <td>${escapeHtml(p.time||"")}</td>
                </tr>`).join("") : `<tr><td colspan="6">‚Äî</td></tr>`
              }
            </tbody>
          </table>

          <h2 style="font-size:14px;margin:16px 0 6px">Dokumentation</h2>
          <table>
            <thead><tr><th>Datum</th><th>Objekt</th><th>Anwesend</th><th>Abwesend</th></tr></thead>
            <tbody>
              ${docs.length ? docs.map(d=>`
                <tr>
                  <td>${escapeHtml(d.date||"‚Äî")}</td>
                  <td>${escapeHtml(d.obj||"‚Äî")}</td>
                  <td>${escapeHtml(d.present||"‚Äî")}</td>
                  <td>${escapeHtml(d.absent||"‚Äî")}</td>
                </tr>`).join("") : `<tr><td colspan="4">‚Äî</td></tr>`
              }
            </tbody>
          </table>

          <script>window.onload=()=>{ window.print(); }</script>
        </body></html>
      `;
      const w = window.open("", "_blank", "noopener,noreferrer");
      if(!w){ alert("Popup blockiert. Bitte Popups erlauben und erneut klicken."); return; }
      w.document.open(); w.document.write(html); w.document.close();
    }

    // ========= CSV =========
    function exportCSV(){
      const plans = getPlans();
      const docs = getDocs();

      const rows = [];
      rows.push(["TYPE","EMP_NO","NAME","DAYS","OBJECT","SHIFT","TIME","NOTE","DOC_DATE","DOC_OBJECT","PRESENT","ABSENT"].join(","));

      plans.forEach(p=>{
        rows.push([
          "PLAN",
          csv(p.no), csv(p.name), csv(p.days), csv(p.obj), csv(p.shift), csv(p.time), csv(p.note),
          "", "", "", ""
        ].join(","));
      });

      docs.forEach(d=>{
        rows.push([
          "DOC",
          "", "", "", "", "", "", "",
          csv(d.date), csv(d.obj), csv(d.present), csv(d.absent)
        ].join(","));
      });

      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Masculine_Security_Dienstplan.csv";
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus("CSV exportiert", "ok");
    }
    function csv(v){
      const s = String(v??"").replace(/\r?\n/g, " | ");
      if(/[",]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    // ========= Save handlers =========
    function savePlan(){
      const no = safe($("empNo").value);
      const name = safe($("empName").value);
      const days = safe($("empDays").value);
      const shift = $("empShift").value;
      const obj = safe($("empObj").value);
      const time = safe($("empTime").value);
      const note = safe($("empNote").value);

      if(!name || !days || !obj){
        setStatus("Bitte Name, Arbeitstage und Objekt ausf√ºllen", "no");
        return;
      }

      const plans = getPlans();
      plans.unshift({ id:uid(), no, name, days, shift, obj, time, note, ts: nowISO() });
      setPlans(plans);

      setStatus("Gespeichert", "ok");
      renderPlans();
      rebuildPreview();
    }

    function newPlan(){
      $("empNo").value="";
      $("empName").value="";
      $("empDays").value="";
      $("empShift").value="Tag";
      $("empObj").value="";
      $("empTime").value="";
      $("empNote").value="";
      setStatus("Neu", "");
    }

    function saveDoc(){
      const date = $("docDate").value;
      const obj = safe($("docObj").value);
      const present = safe($("docPresent").value);
      const absent = safe($("docAbsent").value);

      if(!date || !obj){
        setStatus("Bitte Datum und Objekt ausf√ºllen", "no");
        return;
      }

      const docs = getDocs();
      docs.unshift({ id:uid(), date, obj, present, absent, ts: nowISO() });
      setDocs(docs);

      setStatus("Dokumentation gespeichert", "ok");
      renderDocs();
      rebuildPreview();
    }

    function newDoc(){
      $("docDate").value = new Date().toISOString().slice(0,10);
      $("docObj").value="";
      $("docPresent").value="";
      $("docAbsent").value="";
      setStatus("Neu", "");
    }

    // ========= Auto update =========
    let autoTimer = null;
    function startAuto(){
      $("autoState").textContent = "ON";
      if(autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(()=>{
        // keep preview in sync even if user edits table manually
        rebuildPreview();
      }, 1200);
    }

    // ========= Init =========
    function init(){
      initLogo();

      // last saved
      const meta = loadJSON(K_META, { lastSaved:null });
      $("lastSaved").textContent = meta.lastSaved ? fmtTime(meta.lastSaved) : "‚Äî";

      // defaults
      $("docDate").value = new Date().toISOString().slice(0,10);

      // tabs
      $("tabPlan").addEventListener("click", ()=>setTab("plan"));
      $("tabDocs").addEventListener("click", ()=>setTab("docs"));

      // buttons
      $("btnPrint").addEventListener("click", printNow);
      $("btnPDF").addEventListener("click", exportPDF);
      $("btnAutoSheet").addEventListener("click", autoPrintSheet);
      $("btnCSV").addEventListener("click", exportCSV);
      $("btnWhatsApp").addEventListener("click", whatsappPDF);

      $("btnSavePlan").addEventListener("click", savePlan);
      $("btnNewPlan").addEventListener("click", newPlan);
      $("btnClearPlans").addEventListener("click", ()=>{
        if(!confirm("Alle Wochenpl√§ne wirklich l√∂schen?")) return;
        setPlans([]);
        renderPlans();
        rebuildPreview();
        setStatus("Wochenpl√§ne gel√∂scht", "warn");
      });

      $("btnSaveDoc").addEventListener("click", saveDoc);
      $("btnNewDoc").addEventListener("click", newDoc);
      $("btnClearDocs").addEventListener("click", ()=>{
        if(!confirm("Alle Dokumentationen wirklich l√∂schen?")) return;
        setDocs([]);
        renderDocs();
        rebuildPreview();
        setStatus("Dokumentationen gel√∂scht", "warn");
      });

      $("btnReset").addEventListener("click", ()=>{
        if(!confirm("Reset: Alle Daten l√∂schen?")) return;
        localStorage.removeItem(K_PLANS);
        localStorage.removeItem(K_DOCS);
        localStorage.removeItem(K_META);
        renderPlans(); renderDocs(); rebuildPreview();
        $("lastSaved").textContent = "‚Äî";
        setStatus("Reset ÏôÑÎ£å", "warn");
      });

      // table delete actions (event delegation)
      document.addEventListener("click", (e)=>{
        const btnPlan = e.target.closest("[data-del-plan]");
        if(btnPlan){
          const id = btnPlan.getAttribute("data-del-plan");
          const plans = getPlans().filter(p=>p.id!==id);
          setPlans(plans);
          renderPlans();
          rebuildPreview();
          setStatus("Plan gel√∂scht", "warn");
        }
        const btnDoc = e.target.closest("[data-del-doc]");
        if(btnDoc){
          const id = btnDoc.getAttribute("data-del-doc");
          const docs = getDocs().filter(d=>d.id!==id);
          setDocs(docs);
          renderDocs();
          rebuildPreview();
          setStatus("Dokumentation gel√∂scht", "warn");
        }
      });

      // initial render
      renderPlans();
      renderDocs();
      rebuildPreview();
      startAuto();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

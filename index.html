<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung (Multi-Position)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:14px;border:1px solid rgba(255,255,255,.06);border-radius:var(--r);
      background: rgba(0,0,0,.12);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .top h1{margin:0;font-size:16px}
    .top small{display:block;color:var(--muted);margin-top:4px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;border-radius:12px;cursor:pointer;
      transition:.15s ease;font-weight:900;font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}
    .grid{display:grid;grid-template-columns: 1fr; gap:14px; margin-top:14px}
    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r2);
      padding:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
    }
    .card h2{margin:0 0 10px 0; font-size:14px}
    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:80px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
    }
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
    }
    .table th,.table td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
      font-size:13px;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .row-actions{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18);
      font-size:12px; font-weight:900; color:var(--muted)
    }
    @media (max-width: 820px){
      .split{grid-template-columns:1fr}
      .table{display:block; overflow-x:auto; white-space:nowrap}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Masculine Security — Rechnung</h1>
      <small>Multi-Position • Auto Calc • §19 UStG • PDF (1 Seite) • Offline Save</small>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnSave">Speichern</button>
      <button class="btn" id="btnAddPos">+ Position</button>
      <button class="btn" id="btnPDF">PDF (1 Seite)</button>
      <button class="btn good" id="btnExport">Export JSON</button>
      <button class="btn" id="btnImport">Import JSON</button>
      <input id="fileImport" type="file" accept="application/json" style="display:none"/>
      <button class="btn danger" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <h2>Deine Firma (Absender)</h2>
      <div class="split">
        <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
        <div class="field"><label>E-Mail</label><input id="s_email"/></div>
      </div>
      <div class="split">
        <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>
        <div class="field"><label>Telefon (optional)</label><input id="s_phone" placeholder="+49 ..."/></div>
      </div>
      <div class="split">
        <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
        <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
      </div>
      <div class="field"><label>Hinweis (§19 UStG)</label><input id="s_hint"/></div>
    </div>

    <div class="card">
      <h2>Kunde</h2>
      <div class="split">
        <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
        <div class="field"><label>E-Mail</label><input id="c_email" placeholder="kunde@email.de"/></div>
      </div>
      <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Straße, PLZ Ort"></textarea></div>
    </div>

    <div class="card">
      <h2>Rechnung</h2>
      <div class="split">
        <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
        <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
      </div>
      <div class="split">
        <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
        <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
      </div>

      <div class="split">
        <div class="field"><label>Rabatt Gesamt (%) optional</label><input id="g_disc_pct" type="number" step="0.01" placeholder="0.00"/></div>
        <div class="field"><label>Rabatt Gesamt (€) optional</label><input id="g_disc_eur" type="number" step="0.01" placeholder="0.00"/></div>
      </div>

      <div class="split">
        <div class="field"><label>Netto (auto)</label><input id="sum_net" readonly/></div>
        <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
      </div>

      <div class="note" id="preview">
        Positionen: 0 • Gesamt: 0,00 € • USt: 0,00 € • Hinweis: §19 UStG
      </div>
    </div>

    <div class="card">
      <h2>Positionen</h2>
      <table class="table" aria-label="Positionen Tabelle">
        <thead>
          <tr>
            <th style="min-width:260px">Beschreibung</th>
            <th style="min-width:110px" class="right">Menge</th>
            <th style="min-width:140px" class="right">Preis/Einheit (€)</th>
            <th style="min-width:140px" class="right">Rabatt (€)</th>
            <th style="min-width:140px" class="right">Summe Netto</th>
            <th style="min-width:170px" class="right">Aktion</th>
          </tr>
        </thead>
        <tbody id="posBody"></tbody>
      </table>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
        <span class="pill" id="storagePill">Storage: ...</span>
        <span class="muted" style="font-size:12px">
          Tipp: Menge=Stunden, Preis=€/Stunde. Rabatt pro Position = € (optional).
        </span>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const DB_KEY="ms_rechnung_multi_v1";
const $=(id)=>document.getElementById(id);

const Toast={t:null,show(m){const el=$("toast");el.textContent=m;el.style.display="block";clearTimeout(this.t);this.t=setTimeout(()=>el.style.display="none",2400);}};

function storageWorks(which){try{const k="__t"+Math.random();which.setItem(k,"1");which.removeItem(k);return true;}catch(e){return false;}}
const StorageDriver=(()=>{const canLocal=storageWorks(localStorage);const canSession=storageWorks(sessionStorage);
  const driver=canLocal?localStorage:(canSession?sessionStorage:null);
  return {
    type:canLocal?"localStorage":(canSession?"sessionStorage":"memory"),
    getItem:(k)=>driver?driver.getItem(k):null,
    setItem:(k,v)=>{ if(driver) driver.setItem(k,v); else window.__MEM=v; },
    removeItem:(k)=>{ if(driver) driver.removeItem(k); else window.__MEM=null; },
    canPersist:()=>Boolean(driver)
  };
})();

const fmtEUR=(n)=>Number(n||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" €";
const todayISO=()=>{const d=new Date();const p=(x)=>String(x).padStart(2,"0");return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());};
const n=(v)=>{const x=Number(String(v||"").replace(",", "."));return Number.isFinite(x)?x:0;};
const round2=(x)=>Math.round((x+Number.EPSILON)*100)/100;
const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);

function escapeHtml(str){
  return String(str??"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}

/* =========================
   STORE
========================= */
const Store={
  data:null,
  load(){
    const raw=StorageDriver.getItem(DB_KEY);
    if(raw){ try{this.data=JSON.parse(raw);}catch(e){this.data=null;} }
    if(!this.data){
      this.data={
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstraße 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          hint:"Gemäß § 19 UStG wird keine Umsatzsteuer berechnet."
        },
        customer:{name:"",email:"",addr:""},
        invoice:{
          no:"",
          date:todayISO(),
          von:"",
          bis:"",
          globalDiscPct:"",
          globalDiscEur:"",
          sums:{net:"0.00",total:"0.00"}
        },
        positions:[
          // {id, desc, qty, unit, discEur}
        ]
      };
      // start with one row
      this.data.positions.push({id:uid(), desc:"Sicherheitsdienstleistung", qty:"", unit:"", discEur:""});
      this.save(true);
    }
    return this.data;
  },
  save(silent=false){
    try{ StorageDriver.setItem(DB_KEY, JSON.stringify(this.data)); if(!silent) Toast.show("Gespeichert ✔"); }
    catch(e){ console.error(e); Toast.show("Speichern Fehler: Storage blockiert"); }
  },
  reset(){ StorageDriver.removeItem(DB_KEY); location.reload(); }
};

/* =========================
   FORM <-> STORE
========================= */
function readFormToStore(){
  const d=Store.data;
  d.settings.company=$("s_company").value.trim();
  d.settings.addr=$("s_addr").value.trim();
  d.settings.email=$("s_email").value.trim();
  d.settings.phone=$("s_phone").value.trim();
  d.settings.iban=$("s_iban").value.trim();
  d.settings.bic=$("s_bic").value.trim();
  d.settings.hint=$("s_hint").value.trim();

  d.customer.name=$("c_name").value.trim();
  d.customer.email=$("c_email").value.trim();
  d.customer.addr=$("c_addr").value.trim();

  d.invoice.no=$("i_no").value.trim();
  d.invoice.date=$("i_date").value;
  d.invoice.von=$("i_von").value;
  d.invoice.bis=$("i_bis").value;
  d.invoice.globalDiscPct=$("g_disc_pct").value;
  d.invoice.globalDiscEur=$("g_disc_eur").value;

  // positions read (from DOM inputs)
  const rows=document.querySelectorAll("[data-pos-row]");
  const newPos=[];
  rows.forEach(row=>{
    const id=row.getAttribute("data-pos-row");
    const desc=row.querySelector("[data-pos='desc']")?.value ?? "";
    const qty=row.querySelector("[data-pos='qty']")?.value ?? "";
    const unit=row.querySelector("[data-pos='unit']")?.value ?? "";
    const disc=row.querySelector("[data-pos='disc']")?.value ?? "";
    newPos.push({id, desc:String(desc), qty:String(qty), unit:String(unit), discEur:String(disc)});
  });
  d.positions=newPos;

  // sums stored
  d.invoice.sums.net=$("sum_net").value || "0.00";
  d.invoice.sums.total=$("sum_total").value || "0.00";
}

function writeStoreToForm(){
  const d=Store.data;
  $("s_company").value=d.settings.company||"";
  $("s_addr").value=d.settings.addr||"";
  $("s_email").value=d.settings.email||"";
  $("s_phone").value=d.settings.phone||"";
  $("s_iban").value=d.settings.iban||"";
  $("s_bic").value=d.settings.bic||"";
  $("s_hint").value=d.settings.hint||"";

  $("c_name").value=d.customer.name||"";
  $("c_email").value=d.customer.email||"";
  $("c_addr").value=d.customer.addr||"";

  $("i_no").value=d.invoice.no||"";
  $("i_date").value=d.invoice.date||todayISO();
  $("i_von").value=d.invoice.von||"";
  $("i_bis").value=d.invoice.bis||"";
  $("g_disc_pct").value=d.invoice.globalDiscPct||"";
  $("g_disc_eur").value=d.invoice.globalDiscEur||"";

  renderPositions();
  calcAll(); // updates sums + preview
  $("sum_net").value=String(d.invoice.sums.net||"0.00");
  $("sum_total").value=String(d.invoice.sums.total||"0.00");
}

/* =========================
   POSITIONS UI
========================= */
function posLineNet(p){
  const qty=n(p.qty);
  const unit=n(p.unit);
  const disc=n(p.discEur);
  let net=qty*unit - disc;
  if(net<0) net=0;
  return round2(net);
}

function renderPositions(){
  const d=Store.data;
  const body=$("posBody");
  body.innerHTML="";

  if(!Array.isArray(d.positions) || d.positions.length===0){
    d.positions=[{id:uid(), desc:"Sicherheitsdienstleistung", qty:"", unit:"", discEur:""}];
  }

  for(const p of d.positions){
    const lineNet = posLineNet(p);

    const tr=document.createElement("tr");
    tr.setAttribute("data-pos-row", p.id);

    tr.innerHTML=`
      <td>
        <input data-pos="desc" value="${escapeHtml(p.desc||"")}" placeholder="z.B. Objektschutz / Veranstaltungsschutz"
               style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); color:var(--text); outline:none"/>
      </td>
      <td class="right">
        <input data-pos="qty" type="number" step="0.01" value="${escapeHtml(p.qty||"")}" placeholder="0.00"
               style="width:120px; text-align:right; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); color:var(--text); outline:none"/>
      </td>
      <td class="right">
        <input data-pos="unit" type="number" step="0.01" value="${escapeHtml(p.unit||"")}" placeholder="0.00"
               style="width:140px; text-align:right; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); color:var(--text); outline:none"/>
      </td>
      <td class="right">
        <input data-pos="disc" type="number" step="0.01" value="${escapeHtml(p.discEur||"")}" placeholder="0.00"
               style="width:140px; text-align:right; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); color:var(--text); outline:none"/>
      </td>
      <td class="right" data-pos="linenetto" style="font-weight:900">${fmtEUR(lineNet)}</td>
      <td class="right">
        <div class="row-actions">
          <button class="btn" type="button" data-act="dup">Duplizieren</button>
          <button class="btn danger" type="button" data-act="del">Löschen</button>
        </div>
      </td>
    `;

    body.appendChild(tr);
  }

  // bind row events
  body.querySelectorAll("tr[data-pos-row]").forEach(tr=>{
    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", ()=>{ calcAll(); autoSave(); });
      inp.addEventListener("change", ()=>{ calcAll(); autoSave(); });
    });

    tr.querySelector("[data-act='del']").addEventListener("click", ()=>{
      const id=tr.getAttribute("data-pos-row");
      deletePosition(id);
    });
    tr.querySelector("[data-act='dup']").addEventListener("click", ()=>{
      const id=tr.getAttribute("data-pos-row");
      duplicatePosition(id);
    });
  });
}

function addPosition(){
  readFormToStore();
  Store.data.positions.push({id:uid(), desc:"", qty:"", unit:"", discEur:""});
  Store.save(true);
  renderPositions();
  calcAll();
  Toast.show("Position hinzugefügt");
}

function deletePosition(id){
  readFormToStore();
  Store.data.positions = Store.data.positions.filter(p=>p.id!==id);
  if(Store.data.positions.length===0){
    Store.data.positions.push({id:uid(), desc:"Sicherheitsdienstleistung", qty:"", unit:"", discEur:""});
  }
  Store.save(true);
  renderPositions();
  calcAll();
  Toast.show("Position gelöscht");
}

function duplicatePosition(id){
  readFormToStore();
  const p=Store.data.positions.find(x=>x.id===id);
  if(!p) return;
  Store.data.positions.push({id:uid(), desc:p.desc, qty:p.qty, unit:p.unit, discEur:p.discEur});
  Store.save(true);
  renderPositions();
  calcAll();
  Toast.show("Dupliziert");
}

/* =========================
   CALC TOTALS
========================= */
function calcAll(){
  // update line nets in table
  const rows=document.querySelectorAll("tr[data-pos-row]");
  let sumNet=0;

  rows.forEach(tr=>{
    const desc=tr.querySelector("[data-pos='desc']")?.value ?? "";
    const qty=tr.querySelector("[data-pos='qty']")?.value ?? "";
    const unit=tr.querySelector("[data-pos='unit']")?.value ?? "";
    const disc=tr.querySelector("[data-pos='disc']")?.value ?? "";

    const line=posLineNet({desc, qty, unit, discEur:disc});
    const cell=tr.querySelector("[data-pos='linenetto']");
    if(cell) cell.textContent=fmtEUR(line);
    sumNet += line;
  });

  sumNet=round2(sumNet);

  // global discount
  const discPct=n($("g_disc_pct").value);
  const discEur=n($("g_disc_eur").value);
  let total=sumNet;

  if(discPct>0) total = total - (total*(discPct/100));
  if(discEur>0) total = total - discEur;
  if(total<0) total=0;

  total=round2(total);

  $("sum_net").value=sumNet.toFixed(2);
  $("sum_total").value=total.toFixed(2);

  const count=rows.length;
  $("preview").textContent = `Positionen: ${count} • Gesamt: ${fmtEUR(total)} • USt: 0,00 € • Hinweis: §19 UStG`;

  // store sums (so save/export keeps correct values)
  readFormToStore();
  Store.data.invoice.sums.net=sumNet.toFixed(2);
  Store.data.invoice.sums.total=total.toFixed(2);
}

/* =========================
   SAVE (debounced)
========================= */
let saveT=null;
function autoSave(){
  clearTimeout(saveT);
  saveT=setTimeout(()=>{
    readFormToStore();
    Store.save(true);
  }, 350);
}

/* =========================
   EXPORT / IMPORT
========================= */
function exportJSON(){
  calcAll();
  readFormToStore();
  Store.save(true);

  const blob=new Blob([JSON.stringify(Store.data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="rechnung-multi-backup.json";
  a.click();
  URL.revokeObjectURL(url);
  Toast.show("Export gestartet");
}

function importJSON(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(!data||typeof data!=="object") throw new Error("bad");
      // minimal normalization
      data.settings=data.settings||Store.data.settings;
      data.customer=data.customer||{name:"",email:"",addr:""};
      data.invoice=data.invoice||{no:"",date:todayISO(),von:"",bis:"",globalDiscPct:"",globalDiscEur:"",sums:{net:"0.00",total:"0.00"}};
      data.positions=Array.isArray(data.positions)?data.positions:[];
      if(data.positions.length===0) data.positions.push({id:uid(), desc:"Sicherheitsdienstleistung", qty:"", unit:"", discEur:""});

      Store.data=data;
      Store.save(true);
      writeStoreToForm();
      Toast.show("Import OK");
    }catch(e){
      console.error(e);
      Toast.show("Import Fehler: JSON ungültig");
    }
  };
  r.readAsText(file);
}

/* =========================
   PDF (1 Seite) - multi positions
========================= */
function printOnePagePDF(){
  calcAll();
  readFormToStore();
  const d=Store.data;
  const s=d.settings, c=d.customer, inv=d.invoice;

  if(!s.company || !s.addr){ Toast.show("Firma (Name/Adresse) fehlt"); return; }
  if(!c.name){ Toast.show("Kunde Name fehlt"); return; }
  if(!inv.no){ Toast.show("Rechnungs-Nr. fehlt"); return; }
  if(n(inv.sums.total)<=0){ Toast.show("Betrag fehlt"); return; }

  // Build positions rows HTML
  const posRows = (d.positions||[]).map((p,idx)=>{
    const line=posLineNet(p);
    return `
      <tr>
        <td>${idx+1}</td>
        <td><b>${escapeHtml(p.desc||"")}</b></td>
        <td class="right">${escapeHtml(p.qty||"")}</td>
        <td class="right">${fmtEUR(p.unit||0)}</td>
        <td class="right">${fmtEUR(p.discEur||0)}</td>
        <td class="right">${fmtEUR(line)}</td>
      </tr>
    `;
  }).join("");

  const html = `
<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rechnung ${escapeHtml(inv.no)}</title>
<style>
  @page { size:A4; margin: 10mm; }
  html,body{margin:0;padding:0;font-family:Arial,sans-serif;color:#000;}
  .hdr{display:flex;justify-content:space-between;gap:10mm;border-bottom:1px solid #ddd;padding-bottom:4mm;margin-bottom:4mm;}
  h1{margin:0;font-size:15px;}
  .small{font-size:10.5px;color:#333;}
  .right{text-align:right}
  .box{border:1px solid #eee;padding:4.5mm;margin-bottom:4mm;}
  table{width:100%;border-collapse:collapse;font-size:10.5px;}
  th,td{padding:4px 5px;border-bottom:1px solid #eee;vertical-align:top;}
  th{color:#333;text-align:left;}
  .noBreak{break-inside:avoid;page-break-inside:avoid;}
  /* keep single page: smaller padding + slight zoom */
  @media print{ body{zoom:0.96;} }
</style>
</head><body>
  <div class="hdr noBreak">
    <div>
      <h1>Rechnung</h1>
      <div><b>${escapeHtml(s.company)}</b></div>
      <div class="small" style="white-space:pre-line">${escapeHtml(s.addr)}</div>
      <div class="small">E-Mail: <a href="mailto:${encodeURIComponent(s.email||"")}">${escapeHtml(s.email||"")}</a></div>
      ${s.phone?`<div class="small">Tel: ${escapeHtml(s.phone)}</div>`:""}
    </div>
    <div class="small right">
      <div><b>Rechnungs-Nr.:</b> ${escapeHtml(inv.no)}</div>
      <div><b>Rechnungsdatum:</b> ${escapeHtml(inv.date||"")}</div>
      <div><b>Zeitraum:</b> ${escapeHtml(inv.von||"")}…${escapeHtml(inv.bis||"")}</div>
    </div>
  </div>

  <div class="box noBreak">
    <div class="small"><b>Rechnung an:</b></div>
    <div><b>${escapeHtml(c.name)}</b></div>
    <div class="small" style="white-space:pre-line">${escapeHtml(c.addr||"")}</div>
    ${c.email?`<div class="small">E-Mail: <a href="mailto:${encodeURIComponent(c.email)}">${escapeHtml(c.email)}</a></div>`:""}
  </div>

  <div class="noBreak">
    <table>
      <thead>
        <tr>
          <th style="width:4%">#</th>
          <th style="width:44%">Leistung</th>
          <th style="width:10%" class="right">Menge</th>
          <th style="width:14%" class="right">Preis</th>
          <th style="width:14%" class="right">Rabatt</th>
          <th style="width:14%" class="right">Netto</th>
        </tr>
      </thead>
      <tbody>
        ${posRows}
      </tbody>
    </table>
  </div>

  <div class="box noBreak small" style="margin-top:4mm">
    <div class="right"><b>Summe Netto:</b> ${fmtEUR(inv.sums.net||0)}</div>
    <div class="right">Umsatzsteuer: 0,00 €</div>
    <div class="right"><b>Zu zahlen:</b> ${fmtEUR(inv.sums.total||0)}</div>
    <div style="margin-top:3mm">
      <b>Zahlung:</b> Bitte überweisen Sie den Betrag auf folgendes Konto:<br/>
      IBAN: <b>${escapeHtml(s.iban||"")}</b> • BIC: <b>${escapeHtml(s.bic||"")}</b><br/><br/>
      <b>Hinweis:</b> ${escapeHtml(s.hint||"")}
    </div>
  </div>

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;

  const w=window.open("", "_blank");
  if(!w){ Toast.show("Popup blockiert. Popups erlauben."); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* =========================
   BIND
========================= */
function bind(){
  // autosave for normal fields
  document.querySelectorAll("input,textarea").forEach(el=>{
    el.addEventListener("input", ()=>{ autoSave(); });
    el.addEventListener("change", ()=>{ autoSave(); });
  });

  // calc triggers (global discount)
  ["g_disc_pct","g_disc_eur"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ calcAll(); autoSave(); });
    $(id).addEventListener("change", ()=>{ calcAll(); autoSave(); });
  });

  $("btnSave").addEventListener("click", ()=>{
    calcAll();
    readFormToStore();
    Store.save();
    if(!StorageDriver.canPersist()){
      Toast.show("Browser wuxuu xidhay storage → Export JSON samee si uusan u lumin.");
    }
  });

  $("btnAddPos").addEventListener("click", addPosition);

  $("btnPDF").addEventListener("click", printOnePagePDF);

  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", ()=>$("fileImport").click());
  $("fileImport").addEventListener("change",(e)=>{
    const f=e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value="";
  });

  $("btnReset").addEventListener("click", ()=>{
    const ok=confirm("Reset? Daten werden gelöscht.");
    if(ok) Store.reset();
  });
}

/* =========================
   INIT
========================= */
(function init(){
  Store.load();
  $("storagePill").textContent = "Storage: " + StorageDriver.type;

  if(StorageDriver.type!=="localStorage"){
    Toast.show("Speichern: "+StorageDriver.type+" (Export JSON samee haddii data lumayo)");
  }

  writeStoreToForm();
  bind();
})();
</script>
</body>
</html>

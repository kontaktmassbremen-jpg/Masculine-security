<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office (Offline, Auto)</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1320px;
      margin: 0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}
    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:700;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}
    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px}
    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r2);
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}
    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:800}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:800; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
    }
    .kpi{display:flex; align-items:flex-end; justify-content:space-between; gap:10px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi .label{color:var(--muted); font-size:12px; font-weight:700}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:800; color:var(--muted)}
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    /* ‚úÖ FIX: placeholder option (nicht editierbar) */
    select option[disabled]{ color: rgba(147,164,198,.9) }

    /* PRINT */
    @media print{
      body{background:#fff; color:#000}
      .app, .sidebar, .topbar, .statusbar{display:none!important}
      #printArea{display:block!important}
    }
    #printArea{display:none}
    .printDoc{font-family: Arial, sans-serif; padding:18px; color:#000;}
    .printHeader{display:flex; justify-content:space-between; gap:20px; align-items:flex-start;
      border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:10px;}
    .printHeader h1{margin:0; font-size:18px}
    .printBox{border:1px solid #ddd; padding:10px; margin:10px 0}
    .printTable{width:100%; border-collapse:collapse}
    .printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:12px}
    .printRight{text-align:right}
    .warn{color:#a00; font-weight:700}

    /* LIGHT THEME */
    body.light{
      color:#0b1220;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.20), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.14), transparent 55%),
        linear-gradient(180deg, #f6f8ff 0%, #eef2ff 100%);
    }
    body.light .sidebar,
    body.light .main{
      background: linear-gradient(180deg, rgba(255,255,255,.84), rgba(245,247,255,.84));
      border-color: rgba(0,0,0,.08);
    }
    body.light .card{
      background: rgba(255,255,255,.75);
      border-color: rgba(0,0,0,.08);
    }
    body.light .btn{
      border-color: rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color:#0b1220;
    }
    body.light .field input,
    body.light .field select,
    body.light .field textarea{
      border-color: rgba(0,0,0,.14);
      background: rgba(255,255,255,.85);
      color:#0b1220;
    }
    body.light .muted{color:#4e5c7a}
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">MS</div>
      <div>
        <h1>Masculine Security</h1>
        <small>Mini Office ‚Ä¢ Offline ‚Ä¢ Auto-Save</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="dashboard" class="active"><span>üè† Dashboard</span><span class="pill" id="pillDash">Auto</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="invoices"><span>üßæ Rechnungen</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="expenses"><span>üí≥ Ausgaben</span><span class="pill" id="pillExpenses">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üíº Lohnabrechnung</span><span class="pill" id="pillPayroll">0</span></button>
      <button data-page="taxcert"><span>üìÑ Lohnsteuerbescheinigung</span><span class="pill">Auto</span></button>
      <button data-page="tax"><span>üßæ Steuern</span><span class="pill">ESt/LSt</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Einstellungen</span><span class="pill">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Offline:</b> Daten bleiben im Browser (local).</div>
      <div class="muted">Auto-Save: wax kasta markaad qorto si toos ah ayuu u kaydiyaa.</div>
      <div class="muted"><span class="warn">Hinweis:</span> ESt/LSt waa estimate. Official ‚Üí ELSTER/Steuerberater.</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Dashboard</h2>
        <small id="pageSub" class="muted">Auto-Totals ‚Ä¢ Auto-Save ‚Ä¢ PDF via Print</small>
      </div>
      <div class="actions" id="topActions">
        <button class="btn primary" id="btnQuickInvoice">+ Rechnung</button>
        <button class="btn" id="btnQuickCustomer">+ Kunde</button>
        <button class="btn" id="btnQuickExpense">+ Ausgabe</button>
        <button class="btn" id="btnQuickPayroll">+ Lohn</button>
        <button class="btn" id="btnEmailCompany">‚úâÔ∏è Direkt Email</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
      </div>
    </div>

    <div class="content">
      <!-- DASHBOARD -->
      <section id="page-dashboard">
        <div class="grid3">
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Umsatz (Monat)</div>
                <div class="value" id="kpiRevenueMonth">0,00 ‚Ç¨</div>
                <div class="muted" style="font-size:12px">Kleinunternehmer: USt = 0</div>
              </div>
              <span class="tag">üìà</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Ausgaben (Monat)</div>
                <div class="value" id="kpiExpensesMonth">0,00 ‚Ç¨</div>
                <div class="muted" style="font-size:12px">Auto-Totals</div>
              </div>
              <span class="tag">üí≥</span>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div>
                <div class="label">Lohn (Monat)</div>
                <div class="value" id="kpiPayrollMonth">0,00 ‚Ç¨</div>
                <div class="muted" style="font-size:12px">Netto Summe (manual)</div>
              </div>
              <span class="tag">üíº</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Letzte Aktivit√§ten</h3>
            <table class="table">
              <thead><tr><th>Typ</th><th>Beschreibung</th><th>Datum</th><th class="right">Betrag</th></tr></thead>
              <tbody id="recentList"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Schnellstart</h3>
            <div class="note">
              <b>Kunden w√§hlen:</b> Erst Kunde speichern ‚Üí dann in Rechnung ausw√§hlen.<br/>
              <b>Mitarbeiter w√§hlen:</b> Erst Mitarbeiter speichern ‚Üí dann in Payroll ausw√§hlen.<br/>
              <b>Direkt Email:</b> √ñffnet dein Mail-Programm (mailto).
            </div>
            <div class="hr"></div>
            <button class="btn primary" onclick="UI.go('customers')">+ Kunde</button>
            <button class="btn" onclick="UI.go('invoices')">+ Rechnung</button>
            <button class="btn" onclick="UI.go('employees')">+ Mitarbeiter</button>
            <button class="btn good" onclick="UI.go('tax')">Steuern</button>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunden</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..." /></div>
            <div class="hr"></div>
            <h3>Neuer Kunde</h3>
            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><input id="c_addr" placeholder="Stra√üe, PLZ Ort"/></div>
            <button class="btn primary" onclick="Customers.add()">Speichern</button>
            <button class="btn danger" onclick="Customers.clearForm()">Leeren</button>
          </div>
          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVOICES -->
      <section id="page-invoices" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr. (auto)</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="field"><label>Kunde</label><select id="i_customer"></select></div>
            <div class="field"><label>Leistung / Beschreibung</label><input id="i_desc" placeholder="z.B. Objektschutz 12h"/></div>

            <div class="split">
              <div class="field"><label>Netto (‚Ç¨)</label><input id="i_net" type="number" step="0.01" placeholder="0.00"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option value="Entwurf">Entwurf</option>
                  <option value="Gesendet">Gesendet</option>
                  <option value="Bezahlt">Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Lohnsteuer (optional) ‚Ç¨</label><input id="i_lost" type="number" step="0.01" placeholder="0.00"/></div>
              <div class="field"><label>Einkommensteuer Reserve (optional) ‚Ç¨</label><input id="i_est" type="number" step="0.01" placeholder="0.00"/></div>
            </div>

            <div class="note" id="i_previewNote">Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨ ‚Ä¢ Hinweis: ¬ß19 UStG</div>

            <button class="btn primary" onclick="Invoices.add()">Speichern</button>
            <button class="btn" onclick="Invoices.print()">PDF √∂ffnen</button>
            <button class="btn" onclick="Invoices.emailToCustomer()">Email Rechnung</button>
            <button class="btn danger" onclick="Invoices.clearForm()">Leeren</button>
          </div>

          <div class="card">
            <h3>Rechnungen</h3>
            <div class="split">
              <div class="field"><label>Suche</label><input id="i_search" placeholder="Nr / Kunde..." /></div>
              <div class="field"><label>Status Filter</label>
                <select id="i_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>
            <table class="table">
              <thead><tr><th>Nr.</th><th>Kunde</th><th>Von‚Ä¶Bis</th><th>Status</th><th class="right">Netto</th><th class="right">Aktion</th></tr></thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EXPENSES -->
      <section id="page-expenses" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Ausgabe</h3>
            <div class="split">
              <div class="field"><label>Datum</label><input id="e_date" type="date"/></div>
              <div class="field"><label>Betrag (‚Ç¨)</label><input id="e_amount" type="number" step="0.01" placeholder="0.00"/></div>
            </div>
            <div class="field"><label>Kategorie</label>
              <select id="e_cat">
                <option>B√ºromaterial</option>
                <option>Fahrtkosten</option>
                <option>Versicherung</option>
                <option>Telefon/Internet</option>
                <option>Lohnkosten</option>
                <option>Sonstiges</option>
              </select>
            </div>
            <div class="field"><label>Notiz</label><input id="e_note" placeholder="z.B. Quittung #123"/></div>
            <button class="btn primary" onclick="Expenses.add()">Speichern</button>
            <button class="btn danger" onclick="Expenses.clearForm()">Leeren</button>
          </div>

          <div class="card">
            <h3>Ausgabenliste</h3>
            <div class="field"><label>Suche</label><input id="e_search" placeholder="Kategorie/Notiz..." /></div>
            <table class="table">
              <thead><tr><th>Datum</th><th>Kategorie</th><th>Notiz</th><th class="right">Betrag</th><th class="right">Aktion</th></tr></thead>
              <tbody id="expensesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter</h3>
            <div class="field"><label>Suche</label><input id="m_search" placeholder="Name/Steuer-ID..." /></div>
            <div class="hr"></div>
            <h3>Neuer Mitarbeiter</h3>

            <div class="split">
              <div class="field"><label>Name</label><input id="m_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Personal-Nr. (optional)</label><input id="m_pnr" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="m_taxid" placeholder="optional"/></div>
              <div class="field"><label>SV-Nr. (optional)</label><input id="m_svnr" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Adresse</label><input id="m_addr" placeholder="Stra√üe, PLZ Ort"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="m_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>KV-Kasse (optional)</label><input id="m_kasse" placeholder="z.B. Barmer"/></div>
              <div class="field"><label>Besch√§ftigung</label>
                <select id="m_type"><option>Vollzeit/Teilzeit</option><option>Minijob</option><option>Kurzfristig</option></select>
              </div>
            </div>

            <button class="btn primary" onclick="Employees.add()">Speichern</button>
            <button class="btn danger" onclick="Employees.clearForm()">Leeren</button>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Steuerklasse</th><th>Steuer-ID</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Lohnabrechnung</h3>
            <div class="field"><label>Mitarbeiter</label><select id="p_employee"></select></div>

            <div class="split">
              <div class="field"><label>Monat</label><input id="p_month" type="month"/></div>
              <div class="field"><label>Netto (‚Ç¨)</label><input id="p_net" type="number" step="0.01" placeholder="0.00"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Lohnsteuer (‚Ç¨) (optional)</label><input id="p_lost" type="number" step="0.01" placeholder="0.00"/></div>
              <div class="field"><label>Notiz</label><input id="p_note" placeholder="z.B. 18 Tage √ó 12h"/></div>
            </div>

            <button class="btn primary" onclick="Payroll.add()">Speichern</button>
            <button class="btn" onclick="Payroll.print()">PDF √∂ffnen</button>
            <button class="btn danger" onclick="Payroll.clearForm()">Leeren</button>
          </div>

          <div class="card">
            <h3>Payroll Liste</h3>
            <table class="table">
              <thead><tr><th>Monat</th><th>Mitarbeiter</th><th class="right">Netto</th><th class="right">LSt</th><th class="right">Aktion</th></tr></thead>
              <tbody id="payrollList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TAXCERT -->
      <section id="page-taxcert" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Lohnsteuerbescheinigung (Summary)</h3>
            <div class="field"><label>Jahr</label><input id="t_year" type="number" min="2000" max="2100"/></div>
            <div class="field"><label>Mitarbeiter</label><select id="t_employee"></select></div>
            <div class="note" id="t_summary">W√§hle Jahr & Mitarbeiter.</div>
            <button class="btn primary" onclick="TaxCert.print()">PDF √∂ffnen</button>
          </div>
          <div class="card">
            <h3>Hinweis</h3>
            <div class="note">Official Lohnsteuerbescheinigung ‚Üí ELSTER/Steuerberater.</div>
          </div>
        </div>
      </section>

      <!-- TAX -->
      <section id="page-tax" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Steuern (Einkommensteuer / Lohnsteuer)</h3>
            <div class="note">
              <b>Einkommensteuer (ESt):</b> Gewinn (Umsatz - Ausgaben) ‚Üí estimate (Satz in Einstellungen).<br/>
              <b>Lohnsteuer (LSt):</b> aus Payroll summiert (oder manuell).<br/>
              <span class="warn">Hinweis:</span> Orientierung ‚Äì keine amtliche Berechnung.
            </div>
            <div class="hr"></div>
            <div class="split">
              <div class="field"><label>Jahr</label><input id="x_year" type="number" min="2000" max="2100"/></div>
              <div class="field"><label>Monat (optional)</label><input id="x_month" type="month"/></div>
            </div>
            <button class="btn primary" onclick="Tax.render()">Berechnen</button>
            <div class="hr"></div>
            <div class="card" style="padding:12px">
              <div class="split">
                <div><div class="muted">Umsatz</div><div style="font-weight:900;font-size:18px" id="x_rev">0,00 ‚Ç¨</div></div>
                <div><div class="muted">Ausgaben</div><div style="font-weight:900;font-size:18px" id="x_exp">0,00 ‚Ç¨</div></div>
              </div>
              <div class="hr"></div>
              <div class="split">
                <div><div class="muted">Gewinn</div><div style="font-weight:900;font-size:18px" id="x_profit">0,00 ‚Ç¨</div></div>
                <div><div class="muted">ESt (estimate)</div><div style="font-weight:900;font-size:18px" id="x_est_calc">0,00 ‚Ç¨</div></div>
              </div>
              <div class="hr"></div>
              <div class="split">
                <div><div class="muted">Lohnsteuer Summe (Payroll)</div><div style="font-weight:900;font-size:18px" id="x_lost_sum">0,00 ‚Ç¨</div></div>
                <div><div class="muted">ESt-Satz</div><div class="muted" id="x_rate">‚Äî</div></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Deutsche Steuerklassen</h3>
            <div class="note">
              <b>I</b> ledig / getrennt<br/>
              <b>II</b> Alleinerziehend<br/>
              <b>III</b> verheiratet (Partner V/IV)<br/>
              <b>IV</b> verheiratet (√§hnliche Einkommen)<br/>
              <b>V</b> verheiratet (Partner III/IV)<br/>
              <b>VI</b> zweite Arbeit / Nebenjob
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Einstellungen</h3>

            <div class="field"><label>Firmenname</label><input id="s_company" placeholder="Masculine Security"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr" placeholder="Werschenregerstra√üe 6&#10;28237 Bremen"></textarea></div>

            <div class="split">
              <div class="field"><label>E-Mail</label><input id="s_email" placeholder="kontakt.mass.bremen@hotmail.com"/></div>
              <div class="field"><label>Telefon</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>

            <div class="field"><label>Steuernummer</label><input id="s_steuernr" placeholder="z.B. 123/456/78901"/></div>

            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="..."/></div>
            </div>

            <div class="split">
              <div class="field"><label>Theme</label>
                <select id="s_theme"><option value="dark">Dark</option><option value="light">Light</option></select>
              </div>
              <div class="field"><label>Kleinunternehmer (¬ß19 UStG)</label>
                <select id="s_klein"><option value="1">Ja (USt=0)</option><option value="0">Nein</option></select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Einkommensteuer Satz (estimate %) </label><input id="s_est_rate" type="number" step="0.01" placeholder="z.B. 20"/></div>
              <div class="field"><label>Standard Lohnsteuer Satz (estimate %) </label><input id="s_lost_rate" type="number" step="0.01" placeholder="z.B. 10"/></div>
            </div>

            <button class="btn primary" onclick="Settings.save()">Speichern</button>
            <button class="btn danger" onclick="Settings.resetAll()">Alles zur√ºcksetzen</button>
          </div>

          <div class="card">
            <h3>Daten</h3>
            <div class="note">Export/Import JSON waa backup. Dhammaan data localStorage ayuu ku jiraa.</div>
            <div class="hr"></div>
            <button class="btn good" onclick="App.exportJson()">Export JSON</button>
            <button class="btn" onclick="document.getElementById('fileImport').click()">Import JSON</button>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dotSave"></span>
      <span id="saveState">Auto-Save bereit</span>
      <span class="muted">‚Ä¢</span>
      <span class="muted" id="buildInfo">Build v1.2.0</span>
    </div>
  </main>
</div>

<div id="printArea"></div>

<script>
  const $ = (id)=>document.getElementById(id);

  const Money = {
    fmtEUR(n){
      const x = Number(n||0);
      return x.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2}) + " ‚Ç¨";
    }
  };

  const Dates = {
    todayISO(){
      const d=new Date();
      const z=(n)=>String(n).padStart(2,"0");
      return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate());
    },
    ymNow(){
      const d=new Date();
      return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    },
    monthKey(dISO){
      if(!dISO) return "";
      return dISO.slice(0,7);
    },
    fmt(iso){
      if(!iso) return "‚Äî";
      if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
      const y=iso.slice(0,4), m=iso.slice(5,7), d=iso.slice(8,10);
      return d+"."+m+"."+y;
    }
  };

  const Store = {
    key:"ms-mini-office-v12",
    load(){
      try{
        const raw = localStorage.getItem(this.key);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    },
    save(state){
      localStorage.setItem(this.key, JSON.stringify(state));
      UI.flashSaved();
    }
  };

  const App = {
    state: null,

    defaultState(){
      return {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"",
          steuernr:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          theme:"dark",
          klein:"1",
          estRate: 20,
          lostRate: 10
        },
        customers:[],
        invoices:[],
        expenses:[],
        employees:[],
        payroll:[]
      };
    },

    init(){
      this.state = Store.load() || this.defaultState();
      Settings.applyTheme();
      UI.bindNav();
      UI.bindTopActions();
      UI.bindInputs();
      UI.go("dashboard");
      this.autoFillDefaults();
      UI.refreshAll();
    },

    autoFillDefaults(){
      if(!$("i_date").value) $("i_date").value = Dates.todayISO();
      if(!$("e_date").value) $("e_date").value = Dates.todayISO();
      if(!$("t_year").value) $("t_year").value = new Date().getFullYear();
      if(!$("x_year").value) $("x_year").value = new Date().getFullYear();
      if(!$("x_month").value) $("x_month").value = Dates.ymNow();
      if(!$("p_month").value) $("p_month").value = Dates.ymNow();
      Invoices.ensureInvoiceNo();
      Invoices.recalcPreview();
    },

    commit(){
      Store.save(this.state);
      UI.refreshAll();
    },

    exportJson(){
      const blob = new Blob([JSON.stringify(this.state,null,2)], {type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="ms-mini-office-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    },

    importJson(file){
      const fr=new FileReader();
      fr.onload=()=>{
        try{
          const data=JSON.parse(fr.result);
          if(!data || typeof data!=="object") throw new Error("Invalid");
          this.state = Object.assign(this.defaultState(), data);
          Store.save(this.state);
          Settings.applyTheme();
          UI.go("dashboard");
          UI.refreshAll();
        }catch(e){
          alert("Import fehlgeschlagen: Datei ist nicht g√ºltig.");
        }
      };
      fr.readAsText(file);
    }
  };

  const UI = {
    page:"dashboard",
    bindNav(){
      $("nav").addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-page]");
        if(!btn) return;
        this.go(btn.dataset.page);
      });
    },
    go(page){
      this.page = page;

      document.querySelectorAll("#nav button").forEach(b=>b.classList.remove("active"));
      const active = document.querySelector(`#nav button[data-page="${page}"]`);
      if(active) active.classList.add("active");

      document.querySelectorAll("[id^='page-']").forEach(s=>s.classList.add("hide"));
      const sec = $("page-"+page);
      if(sec) sec.classList.remove("hide");

      const titles = {
        dashboard:["Dashboard","Auto-Totals ‚Ä¢ Auto-Save ‚Ä¢ PDF via Print"],
        customers:["Kunden","Kundenliste ‚Ä¢ Auto-Save"],
        invoices:["Rechnungen","Auto-Save ‚Ä¢ Offline ‚Ä¢ PDF via Print"],
        expenses:["Ausgaben","Kosten erfassen ‚Ä¢ Auto-Totals"],
        employees:["Mitarbeiter","Personal + Steuerklasse"],
        payroll:["Lohnabrechnung","Netto (manual) + LSt optional"],
        taxcert:["Lohnsteuerbescheinigung","Auto-Summary aus Payroll (year)"],
        tax:["Steuern","Einkommensteuer (estimate) + Lohnsteuer Summe"],
        settings:["Einstellungen","Firma ‚Ä¢ Bank ‚Ä¢ Steuernummer ‚Ä¢ Theme"]
      };
      $("pageTitle").textContent = titles[page]?.[0] || "Mini Office";
      $("pageSub").textContent   = titles[page]?.[1] || "";

      this.refreshAll();
      if(page==="tax") Tax.render();
    },

    refreshAll(){
      Pills.update();
      Dashboard.render();
      Customers.render();
      Invoices.render();
      Expenses.render();
      Employees.render();
      Payroll.render();
      TaxCert.syncSelectors();
      Settings.applyToUI();
    },

    flashSaved(){
      $("saveState").textContent = "Gespeichert";
      clearTimeout(this._t);
      this._t=setTimeout(()=> $("saveState").textContent="Auto-Save bereit", 700);
    },

    bindTopActions(){
      $("btnQuickInvoice").onclick=()=>this.go("invoices");
      $("btnQuickCustomer").onclick=()=>this.go("customers");
      $("btnQuickExpense").onclick=()=>this.go("expenses");
      $("btnQuickPayroll").onclick=()=>this.go("payroll");

      $("btnEmailCompany").onclick=()=>{
        const s = App.state.settings;
        const to = s.email || "kontakt.mass.bremen@hotmail.com";
        const subject = encodeURIComponent("Kontakt ‚Äî "+(s.company||"Masculine Security"));
        const body = encodeURIComponent("Hallo,\n\n");
        location.href = "mailto:"+encodeURIComponent(to)+"?subject="+subject+"&body="+body;
      };

      $("btnExport").onclick=()=>App.exportJson();
      $("btnImport").onclick=()=>$("fileImport").click();
      $("fileImport").addEventListener("change",(e)=>{
        const f=e.target.files?.[0];
        if(f) App.importJson(f);
        e.target.value="";
      });
    },

    bindInputs(){
      $("c_search").addEventListener("input", ()=>Customers.render());
      $("i_search").addEventListener("input", ()=>Invoices.render());
      $("i_filter").addEventListener("change", ()=>Invoices.render());
      $("e_search").addEventListener("input", ()=>Expenses.render());
      $("m_search").addEventListener("input", ()=>Employees.render());

      ["i_net","i_desc","i_status","i_customer","i_date","i_von","i_bis","i_lost","i_est"].forEach(id=>{
        $(id).addEventListener("input", ()=>Invoices.recalcPreview());
        $(id).addEventListener("change", ()=>Invoices.recalcPreview());
      });

      $("t_year").addEventListener("input", ()=>TaxCert.updateSummary());
      $("t_employee").addEventListener("change", ()=>TaxCert.updateSummary());

      $("x_year").addEventListener("input", ()=>Tax.render());
      $("x_month").addEventListener("change", ()=>Tax.render());
    }
  };

  const Pills = {
    update(){
      $("pillCustomers").textContent = App.state.customers.length;
      $("pillInvoices").textContent = App.state.invoices.length;
      $("pillExpenses").textContent = App.state.expenses.length;
      $("pillEmployees").textContent = App.state.employees.length;
      $("pillPayroll").textContent = App.state.payroll.length;
    }
  };

  const Customers = {
    add(){
      const name = $("c_name").value.trim();
      if(!name){ alert("Bitte Kundenname eingeben."); return; }
      const c = {
        id: crypto.randomUUID(),
        name,
        email: $("c_email").value.trim(),
        phone: $("c_phone").value.trim(),
        addr: $("c_addr").value.trim()
      };
      App.state.customers.unshift(c);
      this.clearForm();
      App.commit();
      this.fillInvoiceSelect(true);
    },

    remove(id){
      App.state.customers = App.state.customers.filter(x=>x.id!==id);
      App.state.invoices = App.state.invoices.map(inv=>{
        if(inv.customerId===id) inv.customerId="";
        return inv;
      });
      App.commit();
      this.fillInvoiceSelect(true);
    },

    clearForm(){
      ["c_name","c_email","c_phone","c_addr"].forEach(id=>$(id).value="");
      $("c_name").focus();
    },

    render(){
      const q = ($("c_search").value||"").toLowerCase();
      const list = App.state.customers.filter(c=>{
        return !q || (c.name||"").toLowerCase().includes(q) || (c.email||"").toLowerCase().includes(q);
      });

      $("customersList").innerHTML = list.map(c=>`
        <tr>
          <td><b>${esc(c.name)}</b>${c.phone?`<div class="muted" style="font-size:12px">${esc(c.phone)}</div>`:""}</td>
          <td>${c.email?`<a href="mailto:${escAttr(c.email)}">${esc(c.email)}</a>`:"<span class='muted'>‚Äî</span>"}</td>
          <td>${c.addr?esc(c.addr):"<span class='muted'>‚Äî</span>"}</td>
          <td class="right"><button class="btn danger" onclick="Customers.remove('${c.id}')">L√∂schen</button></td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Keine Kunden.</td></tr>`;

      this.fillInvoiceSelect(true);
    },

    fillInvoiceSelect(keepSelection){
      const sel = $("i_customer");
      if(!sel) return;
      const old = sel.value;

      sel.innerHTML = `
        <option value="" disabled selected>‚Äî Bitte w√§hlen ‚Äî</option>
        ${App.state.customers.map(c=>`<option value="${escAttr(c.id)}">${esc(c.name)}</option>`).join("")}
      `;

      if(keepSelection && old && App.state.customers.some(c=>c.id===old)) sel.value = old;
    },

    get(id){ return App.state.customers.find(x=>x.id===id) || null; },
    getName(id){ return this.get(id)?.name || ""; }
  };

  const Invoices = {
    ensureInvoiceNo(){
      const y = new Date().getFullYear();
      const prefix = "MS-"+y+"-";
      const sameYear = App.state.invoices.filter(i=>(i.no||"").startsWith(prefix));
      const next = String(sameYear.length+1).padStart(4,"0");
      const no = prefix+next;
      if(!$("i_no").value) $("i_no").value = no;
    },

    recalcPreview(){
      const net = Number($("i_net").value||0);
      const ust = (App.state.settings.klein==="1") ? 0 : 0;
      const total = net + ust;

      const lost = Number($("i_lost").value||0);
      const est  = Number($("i_est").value||0);
      const payout = Math.max(0, total - lost - est);

      $("i_previewNote").textContent =
        `Gesamt: ${Money.fmtEUR(total)} ‚Ä¢ USt: ${Money.fmtEUR(ust)} ‚Ä¢ LSt: ${Money.fmtEUR(lost)} ‚Ä¢ ESt: ${Money.fmtEUR(est)} ‚Ä¢ Auszahlung: ${Money.fmtEUR(payout)} ‚Ä¢ ¬ß19 UStG`;
    },

    clearForm(){
      $("i_no").value="";
      $("i_date").value=Dates.todayISO();
      $("i_von").value="";
      $("i_bis").value="";
      $("i_customer").value="";
      $("i_desc").value="";
      $("i_net").value="";
      $("i_lost").value="";
      $("i_est").value="";
      $("i_status").value="Entwurf";
      this.ensureInvoiceNo();
      this.recalcPreview();
    },

    add(){
      const no = $("i_no").value.trim() || "";
      if(!no){ alert("Rechnungsnummer fehlt."); return; }

      const inv = {
        id: crypto.randomUUID(),
        no,
        date: $("i_date").value || Dates.todayISO(),
        von: $("i_von").value || "",
        bis: $("i_bis").value || "",
        customerId: $("i_customer").value || "",
        desc: $("i_desc").value.trim(),
        net: Number($("i_net").value||0),
        status: $("i_status").value || "Entwurf",
        lost: Number($("i_lost").value||0),
        est: Number($("i_est").value||0)
      };
      App.state.invoices.unshift(inv);
      this.clearForm();
      App.commit();
    },

    remove(id){
      App.state.invoices = App.state.invoices.filter(x=>x.id!==id);
      App.commit();
    },

    render(){
      Customers.fillInvoiceSelect(true);

      const q = ($("i_search").value||"").toLowerCase();
      const f = $("i_filter").value || "";

      const list = App.state.invoices.filter(inv=>{
        const cname = Customers.getName(inv.customerId).toLowerCase();
        const hit = !q || (inv.no||"").toLowerCase().includes(q) || cname.includes(q);
        const ok = !f || (inv.status===f);
        return hit && ok;
      });

      $("invoicesList").innerHTML = list.map(inv=>{
        const cname = Customers.getName(inv.customerId) || "‚Äî";
        const vonbis = (inv.von || inv.bis) ? `${Dates.fmt(inv.von)}‚Ä¶${Dates.fmt(inv.bis)}` : "‚Äî";
        return `
          <tr>
            <td><b>${esc(inv.no)}</b></td>
            <td>${esc(cname)}</td>
            <td>${esc(vonbis)}</td>
            <td>${esc(inv.status||"")}</td>
            <td class="right">${Money.fmtEUR(inv.net||0)}</td>
            <td class="right">
              <button class="btn" onclick="Invoices.loadToForm('${inv.id}')">√ñffnen</button>
              <button class="btn" onclick="Invoices.printById('${inv.id}')">PDF</button>
              <button class="btn danger" onclick="Invoices.remove('${inv.id}')">L√∂schen</button>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="muted">Keine Rechnungen.</td></tr>`;

      this.recalcPreview();
    },

    loadToForm(id){
      const inv = App.state.invoices.find(x=>x.id===id);
      if(!inv) return;
      $("i_no").value = inv.no || "";
      $("i_date").value = inv.date || Dates.todayISO();
      $("i_von").value = inv.von || "";
      $("i_bis").value = inv.bis || "";
      Customers.fillInvoiceSelect(true);
      $("i_customer").value = inv.customerId || "";
      $("i_desc").value = inv.desc || "";
      $("i_net").value = Number(inv.net||0) ? String(inv.net) : "";
      $("i_lost").value = Number(inv.lost||0) ? String(inv.lost) : "";
      $("i_est").value  = Number(inv.est||0) ? String(inv.est) : "";
      $("i_status").value = inv.status || "Entwurf";
      this.recalcPreview();
      UI.go("invoices");
    },

    emailToCustomer(){
      const cust = Customers.get($("i_customer").value||"");
      if(!cust || !cust.email){
        alert("Kunde hat keine Email. Bitte Kunden Email eintragen.");
        return;
      }
      const s = App.state.settings;
      const no = $("i_no").value || "";
      const net = Number($("i_net").value||0);
      const subject = encodeURIComponent("Rechnung " + no);
      const body = encodeURIComponent(
        "Hallo " + (cust.name||"") + ",\n\n" +
        "anbei die Rechnung " + no + ".\n" +
        "Betrag (Netto): " + Money.fmtEUR(net) + "\n\n" +
        "Bank:\nIBAN: " + (s.iban||"") + "\nBIC: " + (s.bic||"") + "\n\n" +
        "Viele Gr√º√üe\n" + (s.company||"Masculine Security") + "\n" +
        (s.email||"kontakt.mass.bremen@hotmail.com")
      );
      location.href = "mailto:"+encodeURIComponent(cust.email)+"?subject="+subject+"&body="+body;
    },

    print(){
      const inv = this.formToTempInvoice();
      this.renderPrintInvoice(inv);
      window.print();
    },

    printById(id){
      const inv = App.state.invoices.find(x=>x.id===id);
      if(!inv) return;
      this.renderPrintInvoice(inv);
      window.print();
    },

    formToTempInvoice(){
      return {
        no: $("i_no").value.trim(),
        date: $("i_date").value || Dates.todayISO(),
        von: $("i_von").value || "",
        bis: $("i_bis").value || "",
        customerId: $("i_customer").value || "",
        desc: $("i_desc").value.trim(),
        net: Number($("i_net").value||0),
        status: $("i_status").value || "Entwurf",
        lost: Number($("i_lost").value||0),
        est: Number($("i_est").value||0)
      };
    },

    renderPrintInvoice(inv){
      const s = App.state.settings;
      const c = Customers.get(inv.customerId) || {};
      const ust = (s.klein==="1") ? 0 : 0;
      const total = Number(inv.net||0) + ust;
      const payout = Math.max(0, total - Number(inv.lost||0) - Number(inv.est||0));
      const vonbis = (inv.von||inv.bis) ? (Dates.fmt(inv.von)+" ‚Äî "+Dates.fmt(inv.bis)) : "‚Äî";

      $("printArea").innerHTML = `
        <div class="printDoc">
          <div class="printHeader">
            <div>
              <h1>Rechnung</h1>
              <div><b>${esc(s.company||"")}</b></div>
              <div style="white-space:pre-line">${esc(s.addr||"")}</div>
              <div>E-Mail: <a href="mailto:${escAttr(s.email||"")}">${esc(s.email||"")}</a></div>
              ${s.phone?`<div>Tel: ${esc(s.phone)}</div>`:""}
              ${s.steuernr?`<div>Steuernummer: ${esc(s.steuernr)}</div>`:"<div>Steuernummer: ‚Äî</div>"}
              <div>IBAN: ${esc(s.iban||"")} ‚Ä¢ BIC: ${esc(s.bic||"")}</div>
            </div>
            <div>
              <div><b>Rechnungs-Nr.:</b> ${esc(inv.no||"")}</div>
              <div><b>Datum:</b> ${esc(Dates.fmt(inv.date))}</div>
              <div><b>Von‚Ä¶Bis:</b> ${esc(vonbis)}</div>
              <div><b>Status:</b> ${esc(inv.status||"")}</div>
            </div>
          </div>

          <div class="printBox">
            <div><b>Kunde</b></div>
            <div><b>${esc(c.name||"‚Äî")}</b></div>
            ${c.addr?`<div>${esc(c.addr)}</div>`:""}
            ${c.email?`<div>Email: <a href="mailto:${escAttr(c.email)}">${esc(c.email)}</a></div>`:""}
          </div>

          <table class="printTable">
            <thead><tr><th>Leistung / Beschreibung</th><th class="printRight">Netto</th></tr></thead>
            <tbody>
              <tr><td>${inv.desc?esc(inv.desc):"‚Äî"}</td><td class="printRight">${Money.fmtEUR(inv.net||0)}</td></tr>
            </tbody>
          </table>

          <div class="printBox">
            <div>Zwischensumme: <b>${Money.fmtEUR(inv.net||0)}</b></div>
            <div>Umsatzsteuer: <b>${Money.fmtEUR(ust)}</b></div>
            <div>Gesamt: <b>${Money.fmtEUR(total)}</b></div>
            <div>Lohnsteuer (optional): <b>${Money.fmtEUR(inv.lost||0)}</b></div>
            <div>Einkommensteuer Reserve (optional): <b>${Money.fmtEUR(inv.est||0)}</b></div>
            <div>Auszahlungsbetrag: <b>${Money.fmtEUR(payout)}</b></div>
          </div>

          <div style="font-size:12px">Hinweis: Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.</div>
        </div>
      `;
    }
  };

  const Expenses = {
    add(){
      const date = $("e_date").value || Dates.todayISO();
      const amount = Number($("e_amount").value||0);
      if(amount<=0){ alert("Bitte Betrag > 0 eingeben."); return; }
      const exp = { id: crypto.randomUUID(), date, amount, cat: $("e_cat").value, note: $("e_note").value.trim() };
      App.state.expenses.unshift(exp);
      this.clearForm();
      App.commit();
    },
    remove(id){
      App.state.expenses = App.state.expenses.filter(x=>x.id!==id);
      App.commit();
    },
    clearForm(){
      $("e_date").value = Dates.todayISO();
      $("e_amount").value="";
      $("e_note").value="";
    },
    render(){
      const q = ($("e_search").value||"").toLowerCase();
      const list = App.state.expenses.filter(e=>{
        return !q || (e.cat||"").toLowerCase().includes(q) || (e.note||"").toLowerCase().includes(q);
      });
      $("expensesList").innerHTML = list.map(e=>`
        <tr>
          <td>${esc(Dates.fmt(e.date))}</td>
          <td>${esc(e.cat||"")}</td>
          <td>${e.note?esc(e.note):"<span class='muted'>‚Äî</span>"}</td>
          <td class="right">${Money.fmtEUR(e.amount||0)}</td>
          <td class="right"><button class="btn danger" onclick="Expenses.remove('${e.id}')">L√∂schen</button></td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="muted">Keine Ausgaben.</td></tr>`;
    }
  };

  const Employees = {
    add(){
      const name = $("m_name").value.trim();
      if(!name){ alert("Bitte Name eingeben."); return; }
      const emp = {
        id: crypto.randomUUID(),
        name,
        pnr: $("m_pnr").value.trim(),
        taxid: $("m_taxid").value.trim(),
        svnr: $("m_svnr").value.trim(),
        addr: $("m_addr").value.trim(),
        taxclass: $("m_taxclass").value,
        kasse: $("m_kasse").value.trim(),
        type: $("m_type").value
      };
      App.state.employees.unshift(emp);
      this.clearForm();
      App.commit();
      this.fillEmployeeSelects(true);
    },
    remove(id){
      App.state.employees = App.state.employees.filter(x=>x.id!==id);
      App.state.payroll = App.state.payroll.map(p=>{
        if(p.employeeId===id) p.employeeId="";
        return p;
      });
      App.commit();
      this.fillEmployeeSelects(true);
    },
    clearForm(){
      ["m_name","m_pnr","m_taxid","m_svnr","m_addr","m_kasse"].forEach(id=>$(id).value="");
      $("m_taxclass").value="I";
      $("m_type").value="Vollzeit/Teilzeit";
    },
    render(){
      const q = ($("m_search").value||"").toLowerCase();
      const list = App.state.employees.filter(m=>{
        return !q || (m.name||"").toLowerCase().includes(q) || (m.taxid||"").toLowerCase().includes(q);
      });
      $("employeesList").innerHTML = list.map(m=>`
        <tr>
          <td><b>${esc(m.name)}</b><div class="muted" style="font-size:12px">${esc(m.type||"")}</div></td>
          <td>${esc(m.taxclass||"")}</td>
          <td>${m.taxid?esc(m.taxid):"<span class='muted'>‚Äî</span>"}</td>
          <td class="right"><button class="btn danger" onclick="Employees.remove('${m.id}')">L√∂schen</button></td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Keine Mitarbeiter.</td></tr>`;

      this.fillEmployeeSelects(true);
    },

    fillEmployeeSelects(keep){
      const make = (selId, placeholderText)=>{
        const sel = $(selId);
        if(!sel) return;
        const old = sel.value;

        sel.innerHTML = `
          <option value="" disabled selected>${placeholderText}</option>
          ${App.state.employees.map(e=>`<option value="${escAttr(e.id)}">${esc(e.name)}</option>`).join("")}
        `;

        if(keep && old && App.state.employees.some(e=>e.id===old)) sel.value = old;
      };

      make("p_employee","‚Äî Mitarbeiter w√§hlen ‚Äî");
      make("t_employee","‚Äî Mitarbeiter w√§hlen ‚Äî");
    },

    get(id){ return App.state.employees.find(x=>x.id===id) || null; },
    getName(id){ return this.get(id)?.name || ""; }
  };

  const Payroll = {
    add(){
      const employeeId = $("p_employee").value || "";
      if(!employeeId){ alert("Bitte Mitarbeiter w√§hlen."); return; }
      const month = $("p_month").value || "";
      if(!month){ alert("Bitte Monat w√§hlen."); return; }
      const net = Number($("p_net").value||0);
      if(net<=0){ alert("Bitte Netto > 0 eingeben."); return; }
      const lost = Number($("p_lost").value||0);
      const note = $("p_note").value.trim();

      const p = { id: crypto.randomUUID(), employeeId, month, net, lost, note };
      App.state.payroll.unshift(p);
      this.clearForm();
      App.commit();
      TaxCert.updateSummary();
    },
    clearForm(){
      $("p_employee").value="";
      $("p_month").value = Dates.ymNow();
      $("p_net").value="";
      $("p_lost").value="";
      $("p_note").value="";
    },
    remove(id){
      App.state.payroll = App.state.payroll.filter(x=>x.id!==id);
      App.commit();
      TaxCert.updateSummary();
    },
    render(){
      Employees.fillEmployeeSelects(true);
      $("payrollList").innerHTML = App.state.payroll.map(p=>{
        const name = Employees.getName(p.employeeId) || "‚Äî";
        return `
          <tr>
            <td>${esc(p.month||"")}</td>
            <td>${esc(name)}</td>
            <td class="right">${Money.fmtEUR(p.net||0)}</td>
            <td class="right">${Money.fmtEUR(p.lost||0)}</td>
            <td class="right">
              <button class="btn" onclick="Payroll.printById('${p.id}')">PDF</button>
              <button class="btn danger" onclick="Payroll.remove('${p.id}')">L√∂schen</button>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="5" class="muted">Keine Lohnabrechnungen.</td></tr>`;
    },
    print(){ alert("Bitte Eintrag in Liste w√§hlen ‚Üí PDF."); },
    printById(id){
      const p = App.state.payroll.find(x=>x.id===id);
      if(!p) return;
      const s = App.state.settings;
      const e = Employees.get(p.employeeId)||{};
      $("printArea").innerHTML = `
        <div class="printDoc">
          <div class="printHeader">
            <div>
              <h1>Lohnabrechnung (intern)</h1>
              <div><b>${esc(s.company||"")}</b></div>
              <div style="white-space:pre-line">${esc(s.addr||"")}</div>
              <div>E-Mail: <a href="mailto:${escAttr(s.email||"")}">${esc(s.email||"")}</a></div>
              ${s.steuernr?`<div>Steuernummer: ${esc(s.steuernr)}</div>`:""}
            </div>
            <div>
              <div><b>Monat:</b> ${esc(p.month||"")}</div>
              <div><b>Mitarbeiter:</b> ${esc(e.name||"‚Äî")}</div>
              <div><b>Steuerklasse:</b> ${esc(e.taxclass||"‚Äî")}</div>
            </div>
          </div>

          <div class="printBox">
            <div>Netto: <b>${Money.fmtEUR(p.net||0)}</b></div>
            <div>Lohnsteuer (optional): <b>${Money.fmtEUR(p.lost||0)}</b></div>
            ${p.note?`<div>Notiz: ${esc(p.note)}</div>`:""}
          </div>

          <div style="font-size:12px">Hinweis: Intern (nicht amtlich). Official ‚Üí ELSTER/Steuerberater.</div>
        </div>
      `;
      window.print();
    }
  };

  const TaxCert = {
    syncSelectors(){
      Employees.fillEmployeeSelects(true);
      this.updateSummary();
    },
    updateSummary(){
      const year = Number($("t_year").value||0);
      const employeeId = $("t_employee").value || "";
      if(!year || !employeeId){
        $("t_summary").textContent = "W√§hle Jahr & Mitarbeiter.";
        return;
      }
      const rows = App.state.payroll.filter(p=>{
        return p.employeeId===employeeId && String(p.month||"").startsWith(String(year));
      });
      const sumNet = rows.reduce((a,b)=>a+Number(b.net||0),0);
      const sumLSt = rows.reduce((a,b)=>a+Number(b.lost||0),0);
      const name = Employees.getName(employeeId) || "‚Äî";

      $("t_summary").innerHTML =
        `<b>${esc(name)}</b> ‚Ä¢ Jahr ${year}<br/>
         Netto Summe: <b>${Money.fmtEUR(sumNet)}</b><br/>
         Lohnsteuer Summe: <b>${Money.fmtEUR(sumLSt)}</b><br/>
         Eintr√§ge: <b>${rows.length}</b>`;
    },
    print(){
      const year = Number($("t_year").value||0);
      const employeeId = $("t_employee").value || "";
      if(!year || !employeeId){ alert("Bitte Jahr & Mitarbeiter w√§hlen."); return; }
      const s = App.state.settings;
      const e = Employees.get(employeeId)||{};
      const rows = App.state.payroll.filter(p=>p.employeeId===employeeId && String(p.month||"").startsWith(String(year)));
      const sumNet = rows.reduce((a,b)=>a+Number(b.net||0),0);
      const sumLSt = rows.reduce((a,b)=>a+Number(b.lost||0),0);

      $("printArea").innerHTML = `
        <div class="printDoc">
          <div class="printHeader">
            <div>
              <h1>Lohnsteuerbescheinigung (Summary)</h1>
              <div><b>${esc(s.company||"")}</b></div>
              <div style="white-space:pre-line">${esc(s.addr||"")}</div>
              <div>E-Mail: <a href="mailto:${escAttr(s.email||"")}">${esc(s.email||"")}</a></div>
            </div>
            <div>
              <div><b>Jahr:</b> ${year}</div>
              <div><b>Mitarbeiter:</b> ${esc(e.name||"‚Äî")}</div>
              <div><b>Steuerklasse:</b> ${esc(e.taxclass||"‚Äî")}</div>
            </div>
          </div>

          <div class="printBox">
            <div>Netto Summe: <b>${Money.fmtEUR(sumNet)}</b></div>
            <div>Lohnsteuer Summe: <b>${Money.fmtEUR(sumLSt)}</b></div>
            <div>Eintr√§ge: <b>${rows.length}</b></div>
          </div>

          <div style="font-size:12px">Hinweis: Nur Summary (intern). Official ‚Üí ELSTER/Steuerberater.</div>
        </div>
      `;
      window.print();
    }
  };

  const Tax = {
    render(){
      const s = App.state.settings;
      const year = Number($("x_year").value||0) || new Date().getFullYear();
      const month = ($("x_month").value||"").trim();

      const inv = App.state.invoices.filter(i=>{
        if(month) return Dates.monthKey(i.date)===month;
        return String(i.date||"").startsWith(String(year));
      });
      const exp = App.state.expenses.filter(e=>{
        if(month) return Dates.monthKey(e.date)===month;
        return String(e.date||"").startsWith(String(year));
      });
      const pay = App.state.payroll.filter(p=>{
        if(month) return String(p.month||"")===month;
        return String(p.month||"").startsWith(String(year));
      });

      const revenue = inv.reduce((a,b)=>a+Number(b.net||0),0);
      const expenses = exp.reduce((a,b)=>a+Number(b.amount||0),0);
      const profit = revenue - expenses;
      const est = Math.max(0, profit * (Number(s.estRate||0)/100));
      const lost = pay.reduce((a,b)=>a+Number(b.lost||0),0);

      $("x_rev").textContent = Money.fmtEUR(revenue);
      $("x_exp").textContent = Money.fmtEUR(expenses);
      $("x_profit").textContent = Money.fmtEUR(profit);
      $("x_est_calc").textContent = Money.fmtEUR(est);
      $("x_lost_sum").textContent = Money.fmtEUR(lost);
      $("x_rate").textContent = (Number(s.estRate||0).toFixed(2)) + " %";
    }
  };

  const Dashboard = {
    render(){
      const ym = Dates.ymNow();

      const revenue = App.state.invoices
        .filter(i=>Dates.monthKey(i.date)===ym)
        .reduce((a,b)=>a+Number(b.net||0),0);

      const expenses = App.state.expenses
        .filter(e=>Dates.monthKey(e.date)===ym)
        .reduce((a,b)=>a+Number(b.amount||0),0);

      const payroll = App.state.payroll
        .filter(p=>String(p.month||"")===ym)
        .reduce((a,b)=>a+Number(b.net||0),0);

      $("kpiRevenueMonth").textContent = Money.fmtEUR(revenue);
      $("kpiExpensesMonth").textContent = Money.fmtEUR(expenses);
      $("kpiPayrollMonth").textContent = Money.fmtEUR(payroll);

      $("recentList").innerHTML = `<tr><td colspan="4" class="muted">Noch keine Aktivit√§ten.</td></tr>`;
    }
  };

  const Settings = {
    applyToUI(){
      const s = App.state.settings;
      $("s_company").value = s.company||"";
      $("s_addr").value = s.addr||"";
      $("s_email").value = s.email||"";
      $("s_phone").value = s.phone||"";
      $("s_steuernr").value = s.steuernr||"";
      $("s_iban").value = s.iban||"";
      $("s_bic").value = s.bic||"";
      $("s_theme").value = s.theme||"dark";
      $("s_klein").value = s.klein||"1";
      $("s_est_rate").value = (s.estRate ?? 20);
      $("s_lost_rate").value = (s.lostRate ?? 10);
    },
    save(){
      const s = App.state.settings;
      s.company = $("s_company").value.trim();
      s.addr = $("s_addr").value.trim();
      s.email = $("s_email").value.trim();
      s.phone = $("s_phone").value.trim();
      s.steuernr = $("s_steuernr").value.trim();
      s.iban = $("s_iban").value.trim();
      s.bic = $("s_bic").value.trim();
      s.theme = $("s_theme").value;
      s.klein = $("s_klein").value;
      s.estRate = Number($("s_est_rate").value||0);
      s.lostRate = Number($("s_lost_rate").value||0);
      this.applyTheme();
      App.commit();
      alert("Gespeichert.");
    },
    applyTheme(){
      const theme = App.state.settings.theme || "dark";
      document.body.classList.toggle("light", theme==="light");
    },
    resetAll(){
      if(!confirm("Alles l√∂schen? (Daten gehen verloren)")) return;
      localStorage.removeItem(Store.key);
      App.state = App.defaultState();
      this.applyTheme();
      App.commit();
      UI.go("dashboard");
    }
  };

  function esc(s){
    return String(s||"").replace(/[&<>"']/g,(c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }
  function escAttr(s){
    return esc(s).replace(/"/g,"&quot;");
  }

  window.App = App;
  window.UI = UI;
  window.Customers = Customers;
  window.Invoices = Invoices;
  window.Expenses = Expenses;
  window.Employees = Employees;
  window.Payroll = Payroll;
  window.TaxCert = TaxCert;
  window.Tax = Tax;
  window.Settings = Settings;

  App.init();
</script>
</body>
</html>

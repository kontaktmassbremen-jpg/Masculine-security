<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security</title>
  <meta name="robots" content="noindex,nofollow"/>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin:0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3,1fr); gap:14px}

    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px; border:1px solid rgba(255,255,255,.06)}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
      color: var(--text);
    }
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
    }
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }

    /* PRINT (PDF) */
    @media print{
      body{background:#fff; color:#000}
      .app{display:none!important}
      #printArea{display:block!important}
    }
    #printArea{display:none}
    .pdoc{font-family: Arial, sans-serif; color:#000; padding:18px}
    .pTopLine{display:flex; justify-content:space-between; font-size:12px; color:#444}
    .pTitle{font-size:20px; margin:8px 0 4px}
    .pSub{color:#555; font-size:12px; margin:0 0 12px}
    .pBoxes{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:10px 0}
    .pBox{border:1px solid #d9d9d9; padding:10px; font-size:12px}
    .pBox b{font-size:13px}
    .pTable{width:100%; border-collapse:collapse; margin-top:10px; font-size:12px}
    .pTable th,.pTable td{border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top}
    .pTable th{color:#444}
    .pRight{text-align:right}
    .pSumRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    .pSum{border:1px solid #d9d9d9; padding:10px; font-size:12px}
    .pSum h4{margin:0 0 8px; font-size:13px}
    .pSum .row{display:flex; justify-content:space-between; gap:10px; padding:3px 0}
    .pStrong{font-weight:700}
    .pLink a{color:#000; text-decoration:underline}
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Rechnung ‚Ä¢ Mitarbeiter ‚Ä¢ Payroll ‚Ä¢ Bescheinigungen</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll</span><span class="pill">PDF</span></button>
      <button data-page="docs"><span>üìÑ Bescheinigungen</span><span class="pill">PDF</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Auto-Save:</b> localStorage.</div>
      <div class="muted">Update nicht sichtbar? √ñffne Link mit <b>?v=20260206</b> oder Incognito.</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Tage + Std/Tag + ‚Ç¨/h ‚Üí Auto</small>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnNewInvoice">+ Neue</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Alles l√∂schen</button>
      </div>
    </div>

    <div class="content">

      <!-- INVOICES -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen / bearbeiten</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>F√§llig am</label><input id="i_due" type="date"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Arbeitszeit (Auto)</h3>
            <div class="split">
              <div class="field"><label>Tage</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>
            <div class="note">
              <b>Auto:</b> Menge = Stunden, Preis = ‚Ç¨/h, Netto = Stunden √ó ‚Ç¨/h (Position 1).
            </div>

            <div class="hr"></div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <h3 style="margin:0">Positionen</h3>
              <button class="btn" id="btnAddLine">+ Position</button>
            </div>

            <table class="table" style="margin-top:10px">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto (auto)</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
            </div>

            <div class="note" id="i_preview">Positionen: 0 ‚Ä¢ Gesamt: 0,00 ‚Ç¨</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSaveInvoice">Speichern</button>
              <button class="btn" id="btnPrintInvoice">PDF Rechnung (A4)</button>
            </div>

            <input id="i_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Rechnungen Liste</h3>

            <div class="split">
              <div class="field"><label>Suche</label><input id="inv_search" placeholder="Nr / Kunde / Status"/></div>
              <div class="field"><label>Status</label>
                <select id="inv_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Status</th>
                  <th class="right">Total</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde anlegen</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..."/></div>
            <div class="hr"></div>

            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCustomerSave">Speichern</button>
              <button class="btn danger" id="btnCustomerClear">Leeren</button>
            </div>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter anlegen</h3>
            <div class="field"><label>Suche</label><input id="e_search" placeholder="Name / Steuer-ID / SV..."/></div>
            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Name</label><input id="e_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Pers.-Nr. (intern)</label><input id="e_pnr" placeholder="z.B. 55"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Adresse</label><input id="e_addr" placeholder="Stra√üe, PLZ Ort"/></div>
              <div class="field"><label>Geburtsdatum</label><input id="e_dob" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuer-ID</label><input id="e_taxid" placeholder="11-stellig"/></div>
              <div class="field"><label>SV-Nr. (optional)</label><input id="e_svn" placeholder="Sozialversicherungsnummer"/></div>
            </div>

            <div class="split">
              <div class="field">
                <label>Steuerklasse</label>
                <select id="e_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
              <div class="field">
                <label>Familienstand</label>
                <select id="e_family">
                  <option value="single">single</option>
                  <option value="married">married</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Kinder (Anzahl)</label><input id="e_children" type="number" step="1" min="0" value="0"/></div>
              <div class="field"><label>Krankenkasse (AOK/Barmer/...)</label>
                <select id="e_insurer">
                  <option value="AOK">AOK</option>
                  <option value="Barmer">Barmer</option>
                  <option value="TK">TK</option>
                  <option value="DAK">DAK</option>
                  <option value="KKH">KKH</option>
                  <option value="IKK">IKK</option>
                  <option value="Sonstige">Sonstige</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Krankenkasse-Nr. (optional)</label><input id="e_ins_no" placeholder="z.B. 3424434"/></div>
              <div class="field"><label>Beitragssatz KV (AN+AG, %)</label><input id="e_kv_rate" type="number" step="0.01" value="14.60"/></div>
            </div>

            <div class="split">
              <div class="field"><label>RV % (AN+AG)</label><input id="e_rv_rate" type="number" step="0.01" value="18.60"/></div>
              <div class="field"><label>AV % (AN+AG)</label><input id="e_av_rate" type="number" step="0.01" value="2.60"/></div>
            </div>

            <div class="split">
              <div class="field"><label>PV % (AN+AG)</label><input id="e_pv_rate" type="number" step="0.01" value="3.40"/></div>
              <div class="field"><label>Pflege-Zusatz (kinderlos, AN %) </label><input id="e_pv_childless_add" type="number" step="0.01" value="0.60"/></div>
            </div>

            <div class="note">
              SV-S√§tze sind <b>Sch√§tzung</b> (k√∂nnen sich √§ndern). F√ºr offizielle Abrechnung: Steuerberater/Payroll/ELSTER.
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnEmployeeSave">Speichern</button>
              <button class="btn danger" id="btnEmployeeClear">Leeren</button>
            </div>

            <input id="e_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Steuerklasse</th><th>Kasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Lohn- und Gehaltsabrechnung</h3>

            <div class="split">
              <div class="field">
                <label>Mitarbeiter</label>
                <select id="p_emp"></select>
              </div>
              <div class="field">
                <label>Monat (YYYY-MM)</label>
                <input id="p_month" type="month"/>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.01" placeholder="z.B. 216"/></div>
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="z.B. 14"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Brutto (auto)</label><input id="p_brutto" readonly/></div>
              <div class="field"><label>Netto (Sch√§tzung)</label><input id="p_netto" readonly/></div>
            </div>

            <div class="note" id="p_note">
              Enth√§lt SV-Sch√§tzung (AN/AG) + vereinfachte Lohnsteuer-Sch√§tzung. F√ºr <b>offizielle</b> Werte: Payroll/Steuerberater.
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="btnPrintPayroll">PDF Lohnabrechnung</button>
            </div>
          </div>

          <div class="card">
            <h3>Firma Links</h3>
            <div class="note" id="linksBox"></div>
          </div>
        </div>
      </section>

      <!-- DOCS -->
      <section id="page-docs" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Bescheinigungen (Entwurf)</h3>

            <div class="field">
              <label>Mitarbeiter</label>
              <select id="d_emp"></select>
            </div>

            <div class="split">
              <div class="field"><label>Zeitraum Von</label><input id="d_von" type="date"/></div>
              <div class="field"><label>Zeitraum Bis</label><input id="d_bis" type="date"/></div>
            </div>

            <div class="note">
              Diese PDFs sind <b>Entw√ºrfe</b> (Vorlage). Offizielle Dokumente werden je nach Zweck √ºber zust√§ndige Stellen erstellt.
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="btnPrintArbeit">PDF Arbeitbescheinigung (Entwurf)</button>
              <button class="btn" id="btnPrintTax">PDF Lohnsteuerbescheinigung (Entwurf)</button>
            </div>
          </div>

          <div class="card">
            <h3>Hinweis</h3>
            <div class="note">
              Waxaan ka dhigay <b>clickable</b>: email ‚Üí mailto, telefon ‚Üí tel.  
              ‚ÄúMuster / Mini Office / GitHub‚Äù text app-ka kama muuqanayo.
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma</h3>
            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>

            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>

            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
            </div>

            <div class="field"><label>Steuernummer (Firma)</label><input id="s_taxno" placeholder="z.B. 12/345/67890"/></div>
            <div class="field"><label>¬ß19 Hinweis (Rechnung)</label><input id="s_hint"/></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSettingsSave">Speichern</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<!-- PRINT AREA -->
<div id="printArea"></div>

<script>
/* ============================================================
   HARD FIX: Unregister any old Service Worker + clear caches
   (This ensures GitHub Pages updates show immediately)
============================================================ */
(async () => {
  try{
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

/* =========================
   Utils
========================= */
const $ = (id)=>document.getElementById(id);
const DB_KEY = "ms_office_v7_nosw_clickable";

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2200);
  }
};

function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function fmtEUR(n){
  const v = round2(num(n||0));
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function todayISO(){
  const d=new Date();
  const p=(x)=>String(x).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
}
function nowDE(){
  const d=new Date();
  return d.toLocaleString("de-DE");
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function esc(s){
  return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function mailto(email){ return email ? `mailto:${email}` : "#"; }
function telto(phone){ return phone ? `tel:${phone.replace(/\s+/g,"")}` : "#"; }

/* =========================
   Store
========================= */
const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"+4915778697052",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          taxno:"",
          hint:"Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet."
        },
        customers:[],
        employees:[],
        invoices:[]
      };
      this.save(true);
    } else {
      // ensure new fields exist
      this.data.settings ||= {};
      for(const k of ["company","addr","email","phone","iban","bic","taxno","hint"]){
        if(this.data.settings[k]===undefined) this.data.settings[k] = "";
      }
      this.data.customers ||= [];
      this.data.employees ||= [];
      this.data.invoices ||= [];
      this.save(true);
    }
  },
  save(silent=false){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("Gespeichert");
      UI.setStatus("Gespeichert", true);
    }catch(e){
      UI.setStatus("Speichern fehlgeschlagen", false);
      Toast.show("Speichern fehlgeschlagen");
    }
    UI.refreshPills();
  },
  wipe(){
    StorageDriver.removeItem(DB_KEY);
    this.data=null;
    this.load();
    UI.renderAll();
    Toast.show("Alles gel√∂scht");
  }
};

/* =========================
   UI Navigation
========================= */
const UI = {
  go(page){
    for(const s of document.querySelectorAll("[id^='page-']")){
      s.classList.add("hide");
    }
    const el = $("page-"+page);
    if(el) el.classList.remove("hide");

    for(const b of document.querySelectorAll("#nav button")){
      b.classList.toggle("active", b.dataset.page===page);
    }
    const titles = {
      invoices:["Rechnung","Tage + Std/Tag + ‚Ç¨/h ‚Üí Auto"],
      customers:["Kunden","Speichern / Liste"],
      employees:["Mitarbeiter","Krankenkasse ‚Ä¢ Steuerklasse ‚Ä¢ Kinder"],
      payroll:["Payroll","Lohn- und Gehaltsabrechnung"],
      docs:["Bescheinigungen","Arbeitbescheinigung / Lohnsteuerbescheinigung (Entwurf)"],
      settings:["Firma","Daten & Bank"]
    };
    $("pageTitle").textContent = titles[page]?.[0] || "";
    $("pageSub").textContent = titles[page]?.[1] || "";
  },
  setStatus(txt, ok=true){
    $("statusText").textContent = txt;
    $("dot").classList.toggle("off", !ok);
  },
  refreshPills(){
    $("pillCustomers").textContent = Store.data.customers.length;
    $("pillEmployees").textContent = Store.data.employees.length;
    $("pillInvoices").textContent = Store.data.invoices.length;
    $("pillStore").textContent = StorageDriver.type;
    $("storeTag").textContent = StorageDriver.type;
    $("storageNote").textContent = "Storage: " + StorageDriver.type + " ‚Ä¢ Key: " + DB_KEY;
  },
  renderAll(){
    this.refreshPills();
    renderSettings();
    renderCustomers();
    renderEmployees();
    renderInvoiceForm();
    renderInvoiceList();
    renderEmployeeSelectors();
    renderLinksBox();
  }
};

/* =========================
   Customers
========================= */
function clearCustomerForm(){
  $("c_name").value=""; $("c_email").value=""; $("c_phone").value=""; $("c_addr").value="";
}
function renderCustomers(){
  const q = ($("c_search").value||"").toLowerCase().trim();
  const rows = Store.data.customers
    .filter(c=>{
      const t=(c.name+" "+c.email+" "+c.addr).toLowerCase();
      return !q || t.includes(q);
    })
    .map(c=>`
      <tr>
        <td>${esc(c.name||"")}</td>
        <td>${c.email?`<a href="${mailto(esc(c.email))}">${esc(c.email)}</a>`:""}</td>
        <td>${esc(c.addr||"")}</td>
        <td class="right">
          <button class="btn" onclick="pickCustomer('${c.id}')">W√§hlen</button>
          <button class="btn danger" onclick="delCustomer('${c.id}')">L√∂schen</button>
        </td>
      </tr>
    `).join("");
  $("customersList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Kunden</td></tr>`;
  renderCustomerSelect();
}
function pickCustomer(id){
  $("i_customer").value = id;
  Toast.show("Kunde gew√§hlt");
}
function delCustomer(id){
  Store.data.customers = Store.data.customers.filter(c=>c.id!==id);
  Store.save();
  UI.renderAll();
}
function renderCustomerSelect(){
  const opts = Store.data.customers.map(c=>`<option value="${c.id}">${esc(c.name||"(ohne Name)")}</option>`).join("");
  $("i_customer").innerHTML = `<option value="" disabled selected>Bitte Kunde w√§hlen</option>` + opts;
}

/* =========================
   Employees
========================= */
function clearEmployeeForm(){
  $("e_name").value="";
  $("e_pnr").value="";
  $("e_addr").value="";
  $("e_dob").value="";
  $("e_taxid").value="";
  $("e_svn").value="";
  $("e_taxclass").value="I";
  $("e_family").value="single";
  $("e_children").value="0";
  $("e_insurer").value="AOK";
  $("e_ins_no").value="";
  $("e_kv_rate").value="14.60";
  $("e_rv_rate").value="18.60";
  $("e_av_rate").value="2.60";
  $("e_pv_rate").value="3.40";
  $("e_pv_childless_add").value="0.60";
  $("e_edit_id").value="";
}
function renderEmployees(){
  const q = ($("e_search").value||"").toLowerCase().trim();
  const rows = Store.data.employees
    .filter(e=>{
      const t=(e.name+" "+e.taxid+" "+e.svn+" "+e.insurer+" "+e.pnr).toLowerCase();
      return !q || t.includes(q);
    })
    .map(e=>`
      <tr>
        <td>${esc(e.name||"")}</td>
        <td>${esc(e.taxclass||"")}</td>
        <td>${esc(e.insurer||"")}</td>
        <td class="right">
          <button class="btn" onclick="editEmployee('${e.id}')">Bearbeiten</button>
          <button class="btn danger" onclick="delEmployee('${e.id}')">L√∂schen</button>
        </td>
      </tr>
    `).join("");
  $("employeesList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Mitarbeiter</td></tr>`;
}
function editEmployee(id){
  const e = Store.data.employees.find(x=>x.id===id);
  if(!e) return;
  $("e_name").value=e.name||"";
  $("e_pnr").value=e.pnr||"";
  $("e_addr").value=e.addr||"";
  $("e_dob").value=e.dob||"";
  $("e_taxid").value=e.taxid||"";
  $("e_svn").value=e.svn||"";
  $("e_taxclass").value=e.taxclass||"I";
  $("e_family").value=e.family||"single";
  $("e_children").value=String(e.children??0);
  $("e_insurer").value=e.insurer||"AOK";
  $("e_ins_no").value=e.insNo||"";
  $("e_kv_rate").value=String(e.kvRate??14.60);
  $("e_rv_rate").value=String(e.rvRate??18.60);
  $("e_av_rate").value=String(e.avRate??2.60);
  $("e_pv_rate").value=String(e.pvRate??3.40);
  $("e_pv_childless_add").value=String(e.pvChildlessAdd??0.60);
  $("e_edit_id").value=e.id;
  UI.go("employees");
  Toast.show("Mitarbeiter geladen");
}
function delEmployee(id){
  Store.data.employees = Store.data.employees.filter(e=>e.id!==id);
  Store.save();
  UI.renderAll();
}
function renderEmployeeSelectors(){
  const opts = Store.data.employees.map(e=>`<option value="${e.id}">${esc(e.name||"(ohne Name)")}</option>`).join("");
  $("p_emp").innerHTML = `<option value="" disabled selected>Bitte Mitarbeiter w√§hlen</option>` + opts;
  $("d_emp").innerHTML = `<option value="" disabled selected>Bitte Mitarbeiter w√§hlen</option>` + opts;
}

/* =========================
   Invoices
========================= */
function defaultInvoice(){
  $("i_edit_id").value="";
  $("i_no").value = nextInvoiceNo();
  $("i_date").value = todayISO();
  $("i_von").value = "";
  $("i_bis").value = "";
  $("i_due").value = "";
  $("i_status").value = "Entwurf";
  $("w_days").value = "";
  $("w_hpd").value = "";
  $("w_rate").value = "";
  $("w_total_hours").value = "";
  State.lines = [ newLine({desc:"Sicherheitsdienstleistung (Arbeitszeit)", qty:0, price:0}) ];
  renderLines();
  calcAll();
}
function nextInvoiceNo(){
  const year = new Date().getFullYear();
  const prefix = "MS-"+year+"-";
  const nums = Store.data.invoices
    .map(i=>i.no||"")
    .filter(no=>no.startsWith(prefix))
    .map(no=>parseInt(no.slice(prefix.length),10))
    .filter(n=>Number.isFinite(n));
  const next = (nums.length?Math.max(...nums):0)+1;
  return prefix + String(next).padStart(4,"0");
}
const State = { lines:[] };

function newLine(partial={}){
  return { id: uid(), desc: partial.desc||"", qty: num(partial.qty), price: num(partial.price) };
}
function renderInvoiceForm(){
  renderCustomerSelect();
  if(!$("i_date").value) $("i_date").value=todayISO();
}
function renderLines(){
  const rows = State.lines.map((l,idx)=>{
    const net = round2(num(l.qty)*num(l.price));
    return `
    <tr>
      <td><input value="${esc(l.desc)}" oninput="lineChange('${l.id}','desc',this.value)"/></td>
      <td class="right"><input type="number" step="0.01" value="${l.qty}" oninput="lineChange('${l.id}','qty',this.value)"/></td>
      <td class="right"><input type="number" step="0.01" value="${l.price}" oninput="lineChange('${l.id}','price',this.value)"/></td>
      <td class="right">${fmtEUR(net)}</td>
      <td class="right">
        <button class="btn" onclick="dupLine('${l.id}')">Dupl.</button>
        <button class="btn danger" onclick="delLine('${l.id}')">L√∂schen</button>
      </td>
    </tr>`;
  }).join("");
  $("linesBody").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Positionen</td></tr>`;
}
function lineChange(id,key,val){
  const l = State.lines.find(x=>x.id===id);
  if(!l) return;
  if(key==="desc") l.desc = val;
  if(key==="qty") l.qty = num(val);
  if(key==="price") l.price = num(val);
  calcAll();
}
function dupLine(id){
  const l = State.lines.find(x=>x.id===id);
  if(!l) return;
  State.lines.push(newLine({desc:l.desc, qty:l.qty, price:l.price}));
  renderLines(); calcAll();
}
function delLine(id){
  State.lines = State.lines.filter(x=>x.id!==id);
  if(State.lines.length===0) State.lines=[newLine()];
  renderLines(); calcAll();
}

function autoWorkCalc(){
  const days = num($("w_days").value);
  const hpd  = num($("w_hpd").value);
  const rate = num($("w_rate").value);
  const hours = round2(days*hpd);
  $("w_total_hours").value = hours ? String(hours.toFixed(2)) : "";
  // fill line 1
  if(State.lines.length===0) State.lines=[newLine({desc:"Sicherheitsdienstleistung (Arbeitszeit)"})];
  State.lines[0].qty = hours;
  State.lines[0].price = rate;
  renderLines();
  calcAll();
}

function calcAll(){
  const total = round2(State.lines.reduce((s,l)=>s+round2(num(l.qty)*num(l.price)),0));
  $("sum_net").value = total.toFixed(2);
  $("sum_total").value = total.toFixed(2);
  $("i_preview").textContent = `Positionen: ${State.lines.length} ‚Ä¢ Gesamt: ${fmtEUR(total)}`;
}

function saveInvoice(){
  const inv = {
    id: $("i_edit_id").value || uid(),
    no: $("i_no").value.trim(),
    date: $("i_date").value,
    von: $("i_von").value,
    bis: $("i_bis").value,
    due: $("i_due").value,
    status: $("i_status").value,
    customerId: $("i_customer").value,
    work: { days: $("w_days").value, hpd: $("w_hpd").value, rate: $("w_rate").value, hours: $("w_total_hours").value },
    lines: State.lines.map(l=>({desc:l.desc, qty:num(l.qty), price:num(l.price)})),
    total: num($("sum_total").value)
  };

  if(!inv.no){ Toast.show("Rechnungs-Nr fehlt"); return; }
  if(!inv.date){ Toast.show("Rechnungsdatum fehlt"); return; }
  if(!inv.customerId){ Toast.show("Kunde w√§hlen"); return; }

  const idx = Store.data.invoices.findIndex(x=>x.id===inv.id);
  if(idx>=0) Store.data.invoices[idx]=inv;
  else Store.data.invoices.unshift(inv);

  Store.save();
  $("i_edit_id").value = inv.id;
  renderInvoiceList();
}
function renderInvoiceList(){
  const q = ($("inv_search").value||"").toLowerCase().trim();
  const st = $("inv_filter").value;
  const rows = Store.data.invoices
    .filter(i=>{
      const cust = Store.data.customers.find(c=>c.id===i.customerId);
      const t = (i.no+" "+(cust?.name||"")+" "+i.status).toLowerCase();
      return (!q || t.includes(q)) && (!st || i.status===st);
    })
    .map(i=>{
      const cust = Store.data.customers.find(c=>c.id===i.customerId);
      return `
      <tr>
        <td>${esc(i.no)}</td>
        <td>${esc(cust?.name||"")}</td>
        <td>${esc(i.status||"")}</td>
        <td class="right">${fmtEUR(i.total||0)}</td>
        <td class="right">
          <button class="btn" onclick="editInvoice('${i.id}')">√ñffnen</button>
          <button class="btn danger" onclick="delInvoice('${i.id}')">L√∂schen</button>
        </td>
      </tr>`;
    }).join("");
  $("invoicesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Rechnungen</td></tr>`;
}
function editInvoice(id){
  const i = Store.data.invoices.find(x=>x.id===id);
  if(!i) return;
  $("i_edit_id").value = i.id;
  $("i_no").value = i.no||"";
  $("i_date").value = i.date||"";
  $("i_von").value = i.von||"";
  $("i_bis").value = i.bis||"";
  $("i_due").value = i.due||"";
  $("i_status").value = i.status||"Entwurf";
  $("i_customer").value = i.customerId||"";
  $("w_days").value = i.work?.days||"";
  $("w_hpd").value = i.work?.hpd||"";
  $("w_rate").value = i.work?.rate||"";
  $("w_total_hours").value = i.work?.hours||"";
  State.lines = (i.lines||[]).map(l=>newLine({desc:l.desc, qty:l.qty, price:l.price}));
  if(State.lines.length===0) State.lines=[newLine()];
  renderLines(); calcAll();
  UI.go("invoices");
  Toast.show("Rechnung geladen");
}
function delInvoice(id){
  Store.data.invoices = Store.data.invoices.filter(i=>i.id!==id);
  Store.save();
  UI.renderAll();
}

/* =========================
   Payroll calc (simplified estimate)
========================= */
function payrollCalc(){
  const empId = $("p_emp").value;
  const e = Store.data.employees.find(x=>x.id===empId);
  const hours = num($("p_hours").value);
  const rate  = num($("p_rate").value);
  const brutto = round2(hours*rate);
  $("p_brutto").value = brutto ? brutto.toFixed(2) : "";

  // SV estimate (split AN/AG roughly half of total rate; PV childless add on AN)
  let kv = (num(e?.kvRate)||14.6)/100;
  let rv = (num(e?.rvRate)||18.6)/100;
  let av = (num(e?.avRate)||2.6)/100;
  let pv = (num(e?.pvRate)||3.4)/100;

  const totalSV = brutto*(kv+rv+av+pv);
  let an = totalSV/2;
  let ag = totalSV/2;

  const childCount = num(e?.children||0);
  const pvChildlessAdd = (num(e?.pvChildlessAdd)||0)/100;
  if(childCount===0){
    an += brutto*pvChildlessAdd; // approximate extra AN
  }

  // very simplified Lohnsteuer estimate by class (NOT official)
  const tc = (e?.taxclass||"I");
  const family = (e?.family||"single");
  let taxRate = 0.10; // base
  if(tc==="I") taxRate = 0.10;
  if(tc==="II") taxRate = 0.09;
  if(tc==="III") taxRate = 0.06;
  if(tc==="IV") taxRate = 0.10;
  if(tc==="V") taxRate = 0.16;
  if(tc==="VI") taxRate = 0.20;

  // small adjustment for children (estimate)
  taxRate = Math.max(0.03, taxRate - (childCount*0.005));
  // married small relief
  if(family==="married") taxRate = Math.max(0.03, taxRate - 0.01);

  const lohnsteuer = round2(brutto * taxRate);
  const netto = round2(brutto - an - lohnsteuer);

  $("p_netto").value = netto ? netto.toFixed(2) : "";
  $("p_note").innerHTML =
    `SV-Sch√§tzung AN: <b>${fmtEUR(an)}</b> ‚Ä¢ SV-Sch√§tzung AG: <b>${fmtEUR(ag)}</b> ‚Ä¢ Lohnsteuer-Sch√§tzung: <b>${fmtEUR(lohnsteuer)}</b>`;
}

/* =========================
   Print (PDF)
========================= */
function openPrint(html, title="PDF"){
  const w = window.open("", "_blank");
  if(!w){ alert("Popup blockiert. Bitte Popups erlauben."); return; }
  w.document.open();
  w.document.write(`
  <!doctype html><html><head><meta charset="utf-8"/><title>${esc(title)}</title>
  <style>${document.querySelector("style").innerHTML}</style>
  </head><body>
    <div id="printArea" style="display:block">${html}</div>
    <script>window.onload=()=>{setTimeout(()=>window.print(), 50)}<\/script>
  </body></html>`);
  w.document.close();
}

function buildInvoicePrint(inv){
  const S = Store.data.settings;
  const cust = Store.data.customers.find(c=>c.id===inv.customerId) || {};
  const lines = (inv.lines||[]).map((l,idx)=>{
    const net = round2(num(l.qty)*num(l.price));
    return `<tr>
      <td>${idx+1}</td>
      <td>${esc(l.desc||"")}</td>
      <td class="pRight">${num(l.qty).toFixed(2)}</td>
      <td class="pRight">${fmtEUR(l.price)}</td>
      <td class="pRight">${fmtEUR(net)}</td>
    </tr>`;
  }).join("");

  const total = round2(inv.total||0);

  const emailLink = S.email ? `<a href="${mailto(esc(S.email))}">${esc(S.email)}</a>` : "";
  const phoneLink = S.phone ? `<a href="${telto(esc(S.phone))}">${esc(S.phone)}</a>` : "";
  const custEmail = cust.email ? `<a href="${mailto(esc(cust.email))}">${esc(cust.email)}</a>` : "";
  const custPhone = cust.phone ? `<a href="${telto(esc(cust.phone))}">${esc(cust.phone)}</a>` : "";

  return `
  <div class="pdoc">
    <div class="pTopLine">
      <div>${esc(inv.date||todayISO())}</div>
      <div>${esc(inv.no||"")}</div>
      <div>${nowDE()}</div>
    </div>

    <div class="pTitle">Rechnung</div>
    <div class="pSub">Zeitraum: ${esc(inv.von||"")} ‚Äì ${esc(inv.bis||"")} ‚Ä¢ F√§llig: ${esc(inv.due||"")} ‚Ä¢ Status: ${esc(inv.status||"")}</div>

    <div class="pBoxes">
      <div class="pBox pLink">
        <b>${esc(S.company||"")}</b><br/>
        ${esc(S.addr||"").replace(/\n/g,"<br/>")}<br/>
        ${S.email?`E-Mail: ${emailLink}<br/>`:""}
        ${S.phone?`Tel: ${phoneLink}<br/>`:""}
        ${S.taxno?`Steuernummer: ${esc(S.taxno)}<br/>`:""}
      </div>
      <div class="pBox pLink">
        <b>Rechnung an</b><br/>
        ${esc(cust.name||"")}<br/>
        ${esc(cust.addr||"").replace(/\n/g,"<br/>")}<br/>
        ${cust.email?`E-Mail: ${custEmail}<br/>`:""}
        ${cust.phone?`Tel: ${custPhone}<br/>`:""}
      </div>
    </div>

    <table class="pTable">
      <thead>
        <tr>
          <th>#</th><th>Leistung</th>
          <th class="pRight">Menge</th>
          <th class="pRight">Preis</th>
          <th class="pRight">Netto</th>
        </tr>
      </thead>
      <tbody>${lines}</tbody>
    </table>

    <div class="pSumRow">
      <div class="pSum">
        <h4>Zahlung</h4>
        <div class="row"><span>IBAN</span><span class="pStrong">${esc(S.iban||"")}</span></div>
        <div class="row"><span>BIC</span><span class="pStrong">${esc(S.bic||"")}</span></div>
        <div style="margin-top:8px;font-size:12px;color:#444">${esc(S.hint||"")}</div>
      </div>
      <div class="pSum">
        <h4>Summe</h4>
        <div class="row"><span>Summe Netto</span><span class="pStrong">${fmtEUR(total)}</span></div>
        <div class="row"><span>Zu zahlen</span><span class="pStrong">${fmtEUR(total)}</span></div>
      </div>
    </div>
  </div>`;
}

function buildPayrollPrint(){
  const S = Store.data.settings;
  const empId = $("p_emp").value;
  const e = Store.data.employees.find(x=>x.id===empId) || {};
  const month = $("p_month").value || "";
  const hours = num($("p_hours").value);
  const rate  = num($("p_rate").value);
  const brutto = round2(hours*rate);

  // same calc as payrollCalc()
  let kv = (num(e.kvRate)||14.6)/100;
  let rv = (num(e.rvRate)||18.6)/100;
  let av = (num(e.avRate)||2.6)/100;
  let pv = (num(e.pvRate)||3.4)/100;

  const totalSV = brutto*(kv+rv+av+pv);
  let an = totalSV/2;
  let ag = totalSV/2;

  const childCount = num(e.children||0);
  const pvChildlessAdd = (num(e.pvChildlessAdd)||0)/100;
  if(childCount===0) an += brutto*pvChildlessAdd;

  const tc = (e.taxclass||"I");
  const family = (e.family||"single");
  let taxRate = 0.10;
  if(tc==="I") taxRate=0.10;
  if(tc==="II") taxRate=0.09;
  if(tc==="III") taxRate=0.06;
  if(tc==="IV") taxRate=0.10;
  if(tc==="V") taxRate=0.16;
  if(tc==="VI") taxRate=0.20;
  taxRate = Math.max(0.03, taxRate - (childCount*0.005));
  if(family==="married") taxRate = Math.max(0.03, taxRate - 0.01);
  const lohnsteuer = round2(brutto*taxRate);

  const netto = round2(brutto - an - lohnsteuer);

  const emailLink = S.email ? `<a href="${mailto(esc(S.email))}">${esc(S.email)}</a>` : "";
  const phoneLink = S.phone ? `<a href="${telto(esc(S.phone))}">${esc(S.phone)}</a>` : "";

  return `
  <div class="pdoc">
    <div class="pTopLine">
      <div>${nowDE()}</div>
      <div>Lohn- und Gehaltsabrechnung</div>
      <div>${month}</div>
    </div>

    <div class="pTitle">Lohn- und Gehaltsabrechnung</div>
    <div class="pSub">Monat: ${esc(month)}</div>

    <div class="pBoxes">
      <div class="pBox pLink">
        <b>Arbeitgeber</b><br/>
        <b>${esc(S.company||"")}</b><br/>
        ${esc(S.addr||"").replace(/\n/g,"<br/>")}<br/>
        ${S.email?`E-Mail: ${emailLink}<br/>`:""}
        ${S.phone?`Tel: ${phoneLink}<br/>`:""}
        ${S.taxno?`Steuernummer: ${esc(S.taxno)}<br/>`:""}
      </div>

      <div class="pBox">
        <b>Arbeitnehmer</b><br/>
        <b>${esc(e.name||"")}</b> ‚Ä¢ Pers.-Nr.: ${esc(e.pnr||"")}<br/>
        ${esc(e.addr||"")}<br/>
        Steuer-ID: ${esc(e.taxid||"")}<br/>
        Krankenkasse: ${esc(e.insurer||"")} ${e.insNo?("‚Ä¢ Nr.: "+esc(e.insNo)):""}<br/>
        SV-Nr.: ${esc(e.svn||"")}<br/>
        Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Familienstand: ${esc(e.family||"")} ‚Ä¢ Kinder: ${esc(e.children??0)}
      </div>
    </div>

    <table class="pTable">
      <thead><tr><th>Posten</th><th class="pRight">Betrag</th></tr></thead>
      <tbody>
        <tr><td>Stunden</td><td class="pRight">${hours.toFixed(2)}</td></tr>
        <tr><td>‚Ç¨/h</td><td class="pRight">${fmtEUR(rate)}</td></tr>
        <tr><td class="pStrong">Brutto</td><td class="pRight pStrong">${fmtEUR(brutto)}</td></tr>
        <tr><td>SV Arbeitnehmer (Sch√§tzung)</td><td class="pRight">${fmtEUR(an)}</td></tr>
        <tr><td>Lohnsteuer (Sch√§tzung)</td><td class="pRight">${fmtEUR(lohnsteuer)}</td></tr>
        <tr><td class="pStrong">Netto</td><td class="pRight pStrong">${fmtEUR(netto)}</td></tr>
        <tr><td>SV Arbeitgeber (Sch√§tzung)</td><td class="pRight">${fmtEUR(ag)}</td></tr>
      </tbody>
    </table>
  </div>`;
}

function buildArbeitbescheinigungPrint(){
  const S = Store.data.settings;
  const empId = $("d_emp").value;
  const e = Store.data.employees.find(x=>x.id===empId) || {};
  const von = $("d_von").value || "";
  const bis = $("d_bis").value || "";
  const emailLink = S.email ? `<a href="${mailto(esc(S.email))}">${esc(S.email)}</a>` : "";
  const phoneLink = S.phone ? `<a href="${telto(esc(S.phone))}">${esc(S.phone)}</a>` : "";

  return `
  <div class="pdoc">
    <div class="pTopLine">
      <div>${nowDE()}</div>
      <div>Arbeitbescheinigung (Entwurf)</div>
      <div>${von} ‚Äì ${bis}</div>
    </div>
    <div class="pTitle">Arbeitbescheinigung</div>
    <div class="pSub">Zeitraum: ${esc(von)} ‚Äì ${esc(bis)}</div>

    <div class="pBoxes">
      <div class="pBox pLink">
        <b>Arbeitgeber</b><br/>
        <b>${esc(S.company||"")}</b><br/>
        ${esc(S.addr||"").replace(/\n/g,"<br/>")}<br/>
        ${S.email?`E-Mail: ${emailLink}<br/>`:""}
        ${S.phone?`Tel: ${phoneLink}<br/>`:""}
        ${S.taxno?`Steuernummer: ${esc(S.taxno)}<br/>`:""}
      </div>
      <div class="pBox">
        <b>Arbeitnehmer</b><br/>
        <b>${esc(e.name||"")}</b> ‚Ä¢ Pers.-Nr.: ${esc(e.pnr||"")}<br/>
        ${esc(e.addr||"")}<br/>
        Steuer-ID: ${esc(e.taxid||"")}<br/>
        Krankenkasse: ${esc(e.insurer||"")} ${e.insNo?("‚Ä¢ Nr.: "+esc(e.insNo)):""}<br/>
        SV-Nr.: ${esc(e.svn||"")}<br/>
        Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Familienstand: ${esc(e.family||"")} ‚Ä¢ Kinder: ${esc(e.children??0)}
      </div>
    </div>

    <div class="pSum" style="margin-top:10px">
      <h4>Angaben</h4>
      <div class="row"><span>Besch√§ftigungszeitraum</span><span class="pStrong">${esc(von)} ‚Äì ${esc(bis)}</span></div>
      <div class="row"><span>T√§tigkeit</span><span class="pStrong">Sicherheitsdienstleistung</span></div>
      <div class="row"><span>Hinweis</span><span class="pStrong">Entwurf / Vorlage</span></div>
    </div>
  </div>`;
}

function buildLohnsteuerbescheinigungPrint(){
  const S = Store.data.settings;
  const empId = $("d_emp").value;
  const e = Store.data.employees.find(x=>x.id===empId) || {};
  const year = (new Date().getFullYear());
  const emailLink = S.email ? `<a href="${mailto(esc(S.email))}">${esc(S.email)}</a>` : "";
  const phoneLink = S.phone ? `<a href="${telto(esc(S.phone))}">${esc(S.phone)}</a>` : "";

  return `
  <div class="pdoc">
    <div class="pTopLine">
      <div>${nowDE()}</div>
      <div>Lohnsteuerbescheinigung (Entwurf)</div>
      <div>${year}</div>
    </div>
    <div class="pTitle">Lohnsteuerbescheinigung</div>
    <div class="pSub">Jahr: ${year}</div>

    <div class="pBoxes">
      <div class="pBox pLink">
        <b>Arbeitgeber</b><br/>
        <b>${esc(S.company||"")}</b><br/>
        ${esc(S.addr||"").replace(/\n/g,"<br/>")}<br/>
        ${S.email?`E-Mail: ${emailLink}<br/>`:""}
        ${S.phone?`Tel: ${phoneLink}<br/>`:""}
        ${S.taxno?`Steuernummer: ${esc(S.taxno)}<br/>`:""}
      </div>
      <div class="pBox">
        <b>Arbeitnehmer</b><br/>
        <b>${esc(e.name||"")}</b> ‚Ä¢ Pers.-Nr.: ${esc(e.pnr||"")}<br/>
        Steuer-ID: ${esc(e.taxid||"")}<br/>
        Steuerklasse: ${esc(e.taxclass||"")} ‚Ä¢ Kinder: ${esc(e.children??0)}<br/>
        Krankenkasse: ${esc(e.insurer||"")}<br/>
        SV-Nr.: ${esc(e.svn||"")}
      </div>
    </div>

    <div class="pSum" style="margin-top:10px">
      <h4>Werte (manuell pflegen)</h4>
      <div class="row"><span>Bruttoarbeitslohn</span><span class="pStrong">__________</span></div>
      <div class="row"><span>Einbehaltene Lohnsteuer</span><span class="pStrong">__________</span></div>
      <div class="row"><span>Solidarit√§tszuschlag</span><span class="pStrong">__________</span></div>
      <div class="row"><span>Kirchensteuer</span><span class="pStrong">__________</span></div>
      <div class="row"><span>Hinweis</span><span class="pStrong">Entwurf / Vorlage</span></div>
    </div>
  </div>`;
}

/* =========================
   Links Box (clickable)
========================= */
function renderLinksBox(){
  const S = Store.data.settings;
  const parts = [];
  if(S.email) parts.push(`E-Mail: <a href="${mailto(esc(S.email))}">${esc(S.email)}</a>`);
  if(S.phone) parts.push(`Tel: <a href="${telto(esc(S.phone))}">${esc(S.phone)}</a>`);
  if(S.iban) parts.push(`IBAN: <b>${esc(S.iban)}</b>`);
  if(S.bic) parts.push(`BIC: <b>${esc(S.bic)}</b>`);
  $("linksBox").innerHTML = parts.length ? parts.join("<br/>") : "‚Äî";
}

/* =========================
   Settings
========================= */
function renderSettings(){
  const S = Store.data.settings;
  $("s_company").value = S.company||"";
  $("s_addr").value = S.addr||"";
  $("s_email").value = S.email||"";
  $("s_phone").value = S.phone||"";
  $("s_iban").value = S.iban||"";
  $("s_bic").value = S.bic||"";
  $("s_taxno").value = S.taxno||"";
  $("s_hint").value = S.hint||"";
  $("brandTitle").textContent = S.company||"";
}

/* =========================
   Export / Import
========================= */
function doExport(){
  const blob = new Blob([JSON.stringify(Store.data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ms-office-export.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function doImport(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(String(r.result||""));
      if(!data || typeof data!=="object") throw new Error("bad");
      Store.data = data;
      Store.save(true);
      UI.renderAll();
      Toast.show("Import OK");
    }catch(e){
      Toast.show("Import Fehler");
    }
  };
  r.readAsText(file);
}

/* =========================
   Events
========================= */
function wire(){
  // nav
  document.querySelectorAll("#nav button").forEach(b=>{
    b.addEventListener("click", ()=>UI.go(b.dataset.page));
  });

  // invoice
  $("btnNewInvoice").addEventListener("click", ()=>{ defaultInvoice(); UI.go("invoices"); });
  $("btnAddLine").addEventListener("click", ()=>{ State.lines.push(newLine()); renderLines(); calcAll(); });
  $("btnSaveInvoice").addEventListener("click", saveInvoice);
  $("btnPrintInvoice").addEventListener("click", ()=>{
    const id = $("i_edit_id").value;
    const inv = id ? Store.data.invoices.find(x=>x.id===id) : null;
    if(!inv){ Toast.show("Erst speichern"); return; }
    openPrint(buildInvoicePrint(inv), "Rechnung "+inv.no);
  });

  $("w_days").addEventListener("input", autoWorkCalc);
  $("w_hpd").addEventListener("input", autoWorkCalc);
  $("w_rate").addEventListener("input", autoWorkCalc);

  $("inv_search").addEventListener("input", renderInvoiceList);
  $("inv_filter").addEventListener("change", renderInvoiceList);

  // customers
  $("c_search").addEventListener("input", renderCustomers);
  $("btnCustomerSave").addEventListener("click", ()=>{
    const c = {
      id: uid(),
      name: $("c_name").value.trim(),
      email: $("c_email").value.trim(),
      phone: $("c_phone").value.trim(),
      addr: $("c_addr").value.trim()
    };
    if(!c.name){ Toast.show("Name fehlt"); return; }
    Store.data.customers.unshift(c);
    Store.save();
    clearCustomerForm();
    renderCustomers();
  });
  $("btnCustomerClear").addEventListener("click", clearCustomerForm);

  // employees
  $("e_search").addEventListener("input", renderEmployees);
  $("btnEmployeeSave").addEventListener("click", ()=>{
    const id = $("e_edit_id").value || uid();
    const obj = {
      id,
      name: $("e_name").value.trim(),
      pnr: $("e_pnr").value.trim(),
      addr: $("e_addr").value.trim(),
      dob: $("e_dob").value,
      taxid: $("e_taxid").value.trim(),
      svn: $("e_svn").value.trim(),
      taxclass: $("e_taxclass").value,
      family: $("e_family").value,
      children: num($("e_children").value),
      insurer: $("e_insurer").value,
      insNo: $("e_ins_no").value.trim(),
      kvRate: num($("e_kv_rate").value),
      rvRate: num($("e_rv_rate").value),
      avRate: num($("e_av_rate").value),
      pvRate: num($("e_pv_rate").value),
      pvChildlessAdd: num($("e_pv_childless_add").value),
    };
    if(!obj.name){ Toast.show("Name fehlt"); return; }
    const idx = Store.data.employees.findIndex(x=>x.id===id);
    if(idx>=0) Store.data.employees[idx]=obj;
    else Store.data.employees.unshift(obj);

    Store.save();
    clearEmployeeForm();
    UI.renderAll();
    Toast.show("Mitarbeiter gespeichert");
  });
  $("btnEmployeeClear").addEventListener("click", clearEmployeeForm);

  // payroll
  $("p_emp").addEventListener("change", payrollCalc);
  $("p_hours").addEventListener("input", payrollCalc);
  $("p_rate").addEventListener("input", payrollCalc);
  $("p_month").value = (()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; })();
  $("btnPrintPayroll").addEventListener("click", ()=>{
    if(!$("p_emp").value){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(buildPayrollPrint(), "Lohnabrechnung");
  });

  // docs
  $("d_von").value = "";
  $("d_bis").value = "";
  $("btnPrintArbeit").addEventListener("click", ()=>{
    if(!$("d_emp").value){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(buildArbeitbescheinigungPrint(), "Arbeitbescheinigung");
  });
  $("btnPrintTax").addEventListener("click", ()=>{
    if(!$("d_emp").value){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(buildLohnsteuerbescheinigungPrint(), "Lohnsteuerbescheinigung");
  });

  // settings
  $("btnSettingsSave").addEventListener("click", ()=>{
    const S = Store.data.settings;
    S.company = $("s_company").value.trim();
    S.addr = $("s_addr").value.trim();
    S.email = $("s_email").value.trim();
    S.phone = $("s_phone").value.trim();
    S.iban = $("s_iban").value.trim();
    S.bic = $("s_bic").value.trim();
    S.taxno = $("s_taxno").value.trim();
    S.hint = $("s_hint").value.trim();
    Store.save();
    UI.renderAll();
  });

  // export/import/wipe
  $("btnExport").addEventListener("click", doExport);
  $("btnImport").addEventListener("click", ()=>$("fileImport").click());
  $("fileImport").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) doImport(f);
    e.target.value="";
  });
  $("btnWipe").addEventListener("click", ()=>{
    if(confirm("Wirklich alles l√∂schen?")) Store.wipe();
  });
}

/* =========================
   Init
========================= */
(function init(){
  Store.load();
  wire();
  UI.renderAll();
  defaultInvoice();
  UI.go("invoices");
  UI.setStatus("Bereit", true);
})();
</script>
</body>
</html>

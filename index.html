<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masculine Security — Mini Office (Kunde-Rechnung)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(43,212,189,.12), transparent 55%),
                  var(--bg);
    }
    header{
      padding:20px 16px 8px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1100px; margin:0 auto;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .wrap{max-width:1100px; margin:0 auto; padding:12px 16px 28px}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
    }
    .panel .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .hd h2{margin:0; font-size:14px}
    .panel .bd{padding:14px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px}
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }

    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px; resize:vertical}
    .hint{font-size:11px; color:var(--muted); margin-top:6px}
    .btns{display:flex; flex-wrap:wrap; gap:10px}
    button{
      border:1px solid var(--line);
      background: rgba(58,166,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary{background: rgba(255,255,255,.06)}
    button.good{background: rgba(43,212,189,.14)}
    button.bad{background: rgba(255,77,109,.12)}
    button:active{transform: translateY(1px)}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:12px; color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
    }
    .chip strong{color:var(--good)}
    .sep{height:1px; background:var(--line); margin:12px 0}

    /* Invoice preview */
    .invoice{
      background: #ffffff;
      color:#0b1220;
      border-radius: var(--r);
      padding:18px;
      border: 1px solid rgba(0,0,0,.08);
    }
    .inv-top{display:flex; justify-content:space-between; gap:20px; align-items:flex-start}
    .inv-top .left{max-width:62%}
    .inv-top .right{text-align:right}
    .inv-title{margin:0; font-size:18px}
    .inv-sub{margin:4px 0 0; font-size:12px; color:#334155}
    .inv-meta{margin-top:10px; font-size:12px; color:#334155; line-height:1.45}
    .inv-block{margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    .inv-box{
      border:1px solid rgba(15,23,42,.14);
      border-radius:12px;
      padding:12px;
      background: rgba(15,23,42,.03);
    }
    .inv-box h3{margin:0 0 8px; font-size:12px; color:#0f172a; text-transform:uppercase; letter-spacing:.06em}
    .inv-box p{margin:0; font-size:12px; color:#0f172a; line-height:1.45; white-space:pre-line}
    table{width:100%; border-collapse:collapse; margin-top:14px; font-size:12px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(15,23,42,.12); vertical-align:top}
    th{text-align:left; color:#0f172a; background: rgba(15,23,42,.03)}
    td.num, th.num{text-align:right; white-space:nowrap}
    .totals{display:flex; justify-content:flex-end; margin-top:10px}
    .totals .box{min-width:280px; border:1px solid rgba(15,23,42,.14); border-radius:12px; padding:12px}
    .totals .line{display:flex; justify-content:space-between; font-size:12px; padding:4px 0}
    .totals .line strong{font-size:14px}
    .footer-note{margin-top:10px; font-size:11px; color:#334155}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid rgba(15,23,42,.14); background: rgba(15,23,42,.03)}
    .muted{color:#334155}

    /* Internal details (not printed in Kunde invoice) */
    .internal{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(15,23,42,.28);
      background: rgba(15,23,42,.03);
    }
    .internal h4{margin:0 0 6px; font-size:12px}
    .internal p{margin:0; font-size:12px; color:#0f172a; white-space:pre-line}

    /* Print: print only invoice */
    @media print {
      body{background:#fff}
      header, .wrap .grid .panel:first-child, .no-print{display:none !important}
      .wrap{padding:0}
      .panel{box-shadow:none; border:none}
      .invoice{border:none}
      .hide-in-print{display:none !important}
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>Mini Office — Kunde-Rechnung</h1>
      <p>3+ Mitarbeiter → automatisch Gesamtstunden & Gesamtbetrag • Kunde sieht nur Zusammenfassung</p>
    </div>
    <div class="chips no-print">
      <span class="chip">Kleinunternehmer: <strong id="kuStatus">Ja</strong></span>
      <span class="chip">Gesamtstunden: <strong id="chipHours">0</strong></span>
      <span class="chip">Summe: <strong id="chipTotal">0,00 €</strong></span>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- FORM PANEL -->
      <section class="panel no-print">
        <div class="hd">
          <h2>Eingaben (Auftrag → Rechnung)</h2>
          <div class="btns">
            <button class="secondary" id="btnReset" type="button">Reset</button>
            <button class="good" id="btnSave" type="button">Speichern</button>
            <button class="secondary" id="btnLoad" type="button">Laden</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Rechnungsnummer</label>
              <input id="invNo" placeholder="MS-2026-0001" />
              <div class="hint">Tipp: jährlich fortlaufend.</div>
            </div>
            <div>
              <label>Rechnungsdatum</label>
              <input id="invDate" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Zeitraum (von)</label>
              <input id="fromDate" type="date" />
            </div>
            <div>
              <label>Zeitraum (bis)</label>
              <input id="toDate" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Kunde (Name / Firma)</label>
              <input id="kundeName" placeholder="z.B. Muster GmbH" />
            </div>
            <div>
              <label>Kunde (Adresse)</label>
              <input id="kundeAddr" placeholder="Straße, PLZ Ort" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Einsatzort</label>
              <input id="einsatzOrt" placeholder="z.B. Bremen – Gröpelingen" />
            </div>
            <div>
              <label>Leistung (Kurzbeschreibung)</label>
              <input id="leistung" placeholder="Sicherheitsdienstleistung – Eventabsicherung" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Anzahl Sicherheitskräfte (Mitarbeiter)</label>
              <input id="anzahl" type="number" min="1" step="1" value="3" />
            </div>
            <div>
              <label>Stunden pro Mitarbeiter</label>
              <input id="stundenPro" type="number" min="0" step="0.25" value="8" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Preis pro Stunde (€)</label>
              <input id="preis" type="number" min="0" step="0.01" value="22" />
            </div>
            <div>
              <label>Kleinunternehmerregelung (§19 UStG)</label>
              <select id="ku">
                <option value="yes" selected>Ja (keine USt)</option>
                <option value="no">Nein (mit USt)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>USt-Satz (%) (nur wenn nicht Kleinunternehmer)</label>
              <input id="ust" type="number" min="0" step="0.1" value="19" />
              <div class="hint">Wird nur genutzt, wenn Kleinunternehmer = Nein.</div>
            </div>
            <div>
              <label>Zahlungsziel / Hinweise</label>
              <input id="payHint" placeholder="Zahlbar innerhalb von 7 Tagen ohne Abzug." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Deine Firma (Absender)</label>
              <textarea id="absender">Masculine Security
Werschenregerstraße 6
28237 Bremen</textarea>
            </div>
            <div>
              <label>Bankdaten</label>
              <textarea id="bank">IBAN: DE98 1001 1001 2333 0146 96
BIC: NTSBDEB1XXX
Bank: N26</textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Steuerliche Angaben (optional)</label>
              <textarea id="tax">Steuernummer: (eintragen)</textarea>
              <div class="hint">Wenn du Kleinunternehmer bist: der §19 Text kommt automatisch unten.</div>
            </div>
            <div>
              <label>Interne Notiz (Kunde sieht das NICHT)</label>
              <textarea id="intern">Interne Info:
- Team: 3 Personen
- Pausen/Briefing: …</textarea>
            </div>
          </div>

          <div class="sep"></div>

          <div class="btns">
            <button id="btnPrint" type="button">Rechnung drucken / als PDF speichern</button>
            <button class="secondary" id="btnCopy" type="button">Rechnungstext kopieren</button>
          </div>
          <div class="hint">
            Hinweis: Beim Drucken wird nur die Kunde-Rechnung gedruckt (interne Details werden ausgeblendet).
          </div>
        </div>
      </section>

      <!-- PREVIEW PANEL -->
      <section class="panel">
        <div class="hd">
          <h2>Vorschau (Kunde sieht nur Zusammenfassung)</h2>
          <span class="badge" id="badgeMode">Kunde-Rechnung</span>
        </div>
        <div class="bd">
          <div class="invoice" id="invoice">
            <div class="inv-top">
              <div class="left">
                <h3 class="inv-title">Rechnung</h3>
                <p class="inv-sub" id="invSub">Sicherheitsdienstleistung</p>
                <div class="inv-meta" id="metaLeft"></div>
              </div>
              <div class="right">
                <div class="inv-meta" id="metaRight"></div>
              </div>
            </div>

            <div class="inv-block">
              <div class="inv-box">
                <h3>Rechnung an</h3>
                <p id="outKunde"></p>
              </div>
              <div class="inv-box">
                <h3>Von</h3>
                <p id="outAbsender"></p>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Leistung</th>
                  <th class="num">Menge</th>
                  <th class="num">Preis</th>
                  <th class="num">Gesamt</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="lineDesc"></td>
                  <td class="num" id="lineQty"></td>
                  <td class="num" id="linePrice"></td>
                  <td class="num" id="lineTotal"></td>
                </tr>
              </tbody>
            </table>

            <div class="totals">
              <div class="box">
                <div class="line"><span>Zwischensumme</span><span id="subTotal">0,00 €</span></div>
                <div class="line" id="vatLine"><span>USt</span><span id="vatAmount">0,00 €</span></div>
                <div class="line"><strong>Gesamtbetrag</strong><strong id="grandTotal">0,00 €</strong></div>
              </div>
            </div>

            <div class="footer-note" id="kuText"></div>
            <div class="footer-note muted" id="payText"></div>

            <div class="inv-box" style="margin-top:12px">
              <h3>Bankverbindung</h3>
              <p id="outBank"></p>
            </div>

            <!-- Internal section: visible on screen, hidden in print -->
            <div class="internal hide-in-print" id="internalBox">
              <h4>Interne Details (nicht für den Kunden / nicht im Druck)</h4>
              <p id="outInternal"></p>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const fmtEUR = (n) => {
      const x = Number.isFinite(n) ? n : 0;
      return x.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    };
    const clampNum = (v, min=0) => {
      const n = Number(String(v).replace(",", "."));
      return Number.isFinite(n) ? Math.max(min, n) : min;
    };
    const safeText = (s) => (s ?? "").toString().trim();

    // ---------- state ----------
    const fields = [
      "invNo","invDate","fromDate","toDate","kundeName","kundeAddr","einsatzOrt","leistung",
      "anzahl","stundenPro","preis","ku","ust","payHint","absender","bank","tax","intern"
    ];

    function getData(){
      const d = {};
      for(const f of fields){
        d[f] = $(f).value;
      }
      return d;
    }

    function setData(d){
      for(const f of fields){
        if(d[f] !== undefined) $(f).value = d[f];
      }
      render();
    }

    function calc(d){
      const anzahl = Math.round(clampNum(d.anzahl, 1));
      const stundenPro = clampNum(d.stundenPro, 0);
      const preis = clampNum(d.preis, 0);
      const totalHours = anzahl * stundenPro;
      const net = totalHours * preis;

      const isKU = d.ku === "yes";
      const ustRate = clampNum(d.ust, 0) / 100;
      const vat = isKU ? 0 : net * ustRate;
      const gross = net + vat;

      return { anzahl, stundenPro, preis, totalHours, net, vat, gross, isKU, ustRate };
    }

    // ---------- render ----------
    function render(){
      const d = getData();
      const c = calc(d);

      // chips
      $("kuStatus").textContent = c.isKU ? "Ja" : "Nein";
      $("chipHours").textContent = (c.totalHours % 1 === 0) ? String(c.totalHours) : c.totalHours.toLocaleString("de-DE");
      $("chipTotal").textContent = fmtEUR(c.gross);

      // invoice header
      $("invSub").textContent = safeText(d.leistung) || "Sicherheitsdienstleistung";
      const invNo = safeText(d.invNo) || "—";
      const invDate = safeText(d.invDate) ? new Date(d.invDate).toLocaleDateString("de-DE") : "—";

      $("metaRight").textContent =
        `Rechnungsnummer: ${invNo}\nRechnungsdatum: ${invDate}`;

      // left meta
      const from = safeText(d.fromDate) ? new Date(d.fromDate).toLocaleDateString("de-DE") : "—";
      const to = safeText(d.toDate) ? new Date(d.toDate).toLocaleDateString("de-DE") : "—";
      const ort = safeText(d.einsatzOrt) || "—";
      const tax = safeText(d.tax);
      $("metaLeft").textContent =
        `Zeitraum: ${from} – ${to}\nEinsatzort: ${ort}` + (tax ? `\n${tax}` : "");

      // addresses
      const kunde = `${safeText(d.kundeName) || "—"}\n${safeText(d.kundeAddr) || ""}`.trim();
      $("outKunde").textContent = kunde;

      $("outAbsender").textContent = safeText(d.absender) || "—";
      $("outBank").textContent = safeText(d.bank) || "—";

      // line item (Kunde summary only)
      // Kunde sees: Einsatz: X Sicherheitskräfte, Gesamtstunden, Zeitraum/Ort
      const descParts = [];
      descParts.push(safeText(d.leistung) || "Sicherheitsdienstleistung");
      descParts.push(`Einsatz: ${c.anzahl} Sicherheitskräfte`);
      descParts.push(`Gesamtstunden: ${ (c.totalHours % 1 === 0) ? c.totalHours : c.totalHours.toLocaleString("de-DE") } Std`);
      descParts.push(`Zeitraum: ${from} – ${to}`);
      if(ort && ort !== "—") descParts.push(`Ort: ${ort}`);

      $("lineDesc").textContent = descParts.join(" • ");

      // quantity = total hours, price = hourly rate
      $("lineQty").textContent = (c.totalHours % 1 === 0) ? String(c.totalHours) : c.totalHours.toLocaleString("de-DE");
      $("linePrice").textContent = fmtEUR(c.preis) + " / Std";
      $("lineTotal").textContent = fmtEUR(c.net);

      // totals
      $("subTotal").textContent = fmtEUR(c.net);

      if(c.isKU){
        $("vatLine").style.display = "none";
        $("kuText").textContent = "Gemäß §19 UStG wird keine Umsatzsteuer berechnet.";
      }else{
        $("vatLine").style.display = "flex";
        $("vatAmount").textContent = fmtEUR(c.vat);
        const ratePct = (c.ustRate * 100);
        $("vatLine").firstElementChild.textContent = `USt (${ratePct % 1 === 0 ? ratePct.toFixed(0) : ratePct.toLocaleString("de-DE")}%)`;
        $("kuText").textContent = "";
      }
      $("grandTotal").textContent = fmtEUR(c.gross);

      // payment hint
      const payHint = safeText(d.payHint);
      $("payText").textContent = payHint ? payHint : "";

      // internal (screen only)
      $("outInternal").textContent = safeText(d.intern) || "—";
    }

    // ---------- actions ----------
    function resetAll(){
      // defaults
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      setData({
        invNo: "MS-2026-0001",
        invDate: iso,
        fromDate: iso,
        toDate: iso,
        kundeName: "",
        kundeAddr: "",
        einsatzOrt: "Bremen",
        leistung: "Sicherheitsdienstleistung – Event/Objektschutz",
        anzahl: "3",
        stundenPro: "8",
        preis: "22",
        ku: "yes",
        ust: "19",
        payHint: "Zahlbar innerhalb von 7 Tagen ohne Abzug.",
        absender: "Masculine Security\nWerschenregerstraße 6\n28237 Bremen",
        bank: "IBAN: DE98 1001 1001 2333 0146 96\nBIC: NTSBDEB1XXX\nBank: N26",
        tax: "Steuernummer: (eintragen)",
        intern: "Interne Info:\n- Team: 3 Personen\n- Pausen/Briefing: …"
      });
    }

    function saveLocal(){
      const d = getData();
      localStorage.setItem("ms_mini_office_invoice_v2", JSON.stringify(d));
      alert("Gespeichert ✅");
    }

    function loadLocal(){
      const raw = localStorage.getItem("ms_mini_office_invoice_v2");
      if(!raw){
        alert("Keine gespeicherten Daten gefunden.");
        return;
      }
      try{
        const d = JSON.parse(raw);
        setData(d);
        alert("Geladen ✅");
      }catch(e){
        alert("Fehler beim Laden.");
      }
    }

    function copyInvoiceText(){
      // copy the visible invoice text summary (Kunde)
      const d = getData();
      const c = calc(d);

      const invNo = safeText(d.invNo) || "—";
      const invDate = safeText(d.invDate) ? new Date(d.invDate).toLocaleDateString("de-DE") : "—";
      const from = safeText(d.fromDate) ? new Date(d.fromDate).toLocaleDateString("de-DE") : "—";
      const to = safeText(d.toDate) ? new Date(d.toDate).toLocaleDateString("de-DE") : "—";
      const ort = safeText(d.einsatzOrt) || "—";

      const text =
`RECHNUNG

Rechnungsnummer: ${invNo}
Rechnungsdatum: ${invDate}

Kunde:
${safeText(d.kundeName) || "—"}
${safeText(d.kundeAddr) || ""}

Leistung:
${safeText(d.leistung) || "Sicherheitsdienstleistung"}
Zeitraum: ${from} – ${to}
Einsatzort: ${ort}
Einsatz: ${c.anzahl} Sicherheitskräfte
Gesamtstunden: ${ (c.totalHours % 1 === 0) ? c.totalHours : c.totalHours.toLocaleString("de-DE") } Std
Preis: ${fmtEUR(c.preis)} / Std

Zwischensumme: ${fmtEUR(c.net)}
${c.isKU ? "" : `USt: ${fmtEUR(c.vat)}`}
Gesamtbetrag: ${fmtEUR(c.gross)}

${c.isKU ? "Gemäß §19 UStG wird keine Umsatzsteuer berechnet.\n" : ""}
${safeText(d.payHint) || ""}

Bankverbindung:
${safeText(d.bank) || ""}

Von:
${safeText(d.absender) || ""}`.trim();

      navigator.clipboard.writeText(text)
        .then(()=>alert("Rechnungstext kopiert ✅"))
        .catch(()=>alert("Kopieren nicht möglich (Browser Rechte)."));
    }

    function printPDF(){
      // Print dialog -> user can "Save as PDF"
      window.print();
    }

    // ---------- init ----------
    function init(){
      // Set today if empty
      const todayIso = new Date().toISOString().slice(0,10);
      if(!$("invDate").value) $("invDate").value = todayIso;
      if(!$("fromDate").value) $("fromDate").value = todayIso;
      if(!$("toDate").value) $("toDate").value = todayIso;

      // listeners
      for(const f of fields){
        $(f).addEventListener("input", render);
        $(f).addEventListener("change", render);
      }

      $("btnReset").addEventListener("click", resetAll);
      $("btnSave").addEventListener("click", saveLocal);
      $("btnLoad").addEventListener("click", loadLocal);
      $("btnCopy").addEventListener("click", copyInvoiceText);
      $("btnPrint").addEventListener("click", printPDF);

      // try auto-load if present
      const raw = localStorage.getItem("ms_mini_office_invoice_v2");
      if(raw){
        try{ setData(JSON.parse(raw)); }
        catch{ resetAll(); }
      } else {
        resetAll();
      }

      render();
    }

    init();
  </script>
</body>
</html>

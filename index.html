<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>

  <style>
    :root{
      --bg:#081426;
      --panel:#0b1a33;
      --panel2:#0c2242;
      --card:#0f2a4f;
      --card2:#0d2445;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --good:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:16px;
      --r2:12px;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(58,166,255,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 15%, rgba(33,209,159,.14), transparent 55%),
        var(--bg);
    }
    a{color:inherit}
    a.link{color:var(--accent); text-decoration:none}
    a.link:hover{text-decoration:underline}

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:14px;
      padding:14px;
      height:100%;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr; height:auto}
    }

    /* Sidebar */
    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 600px;
    }
    .sb-top{
      display:flex;
      gap:10px;
      align-items:center;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
    }
    .sb-logo{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      font-weight:900;
      background:linear-gradient(135deg, rgba(58,166,255,.35), rgba(33,209,159,.22));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .sb-title{line-height:1.1}
    .sb-title strong{display:block; font-size:14px}
    .sb-title small{display:block; font-size:12px; color:var(--muted); margin-top:3px}
    .sb-nav{padding:12px}
    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      margin-bottom:10px;
      text-align:left;
      transition: background .15s ease, border-color .15s ease;
    }
    .navbtn:hover{background:rgba(255,255,255,.06); border-color:rgba(58,166,255,.35)}
    .navbtn.active{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.45)}
    .navbadge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      padding:4px 9px;
      border-radius:999px;
    }

    /* Main */
    .main{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 600px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .top-left strong{display:block; font-size:16px}
    .top-left small{display:block; font-size:12px; color:var(--muted); margin-top:3px}

    .btns{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.06); border-color:rgba(58,166,255,.35)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.35)}
    .btn.primary:hover{background:rgba(58,166,255,.22)}
    .btn.good{background:rgba(33,209,159,.16); border-color:rgba(33,209,159,.35)}
    .btn.good:hover{background:rgba(33,209,159,.22)}
    .btn.danger{background:rgba(255,77,109,.14); border-color:rgba(255,77,109,.35)}
    .btn.danger:hover{background:rgba(255,77,109,.20)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .mono{font-family:var(--mono)}

    /* Content grid */
    .content{
      padding:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.10);
    }
    .card .hd strong{display:block}
    .card .hd small{display:block;color:var(--muted); margin-top:4px; font-size:12px}
    .card .bd{padding:14px}

    /* Form */
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background:rgba(5,12,25,.45);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(58,166,255,.45);
      box-shadow:0 0 0 3px rgba(58,166,255,.12);
    }
    textarea{min-height:90px; resize:vertical}

    .hint{font-size:12px;color:var(--muted); margin-top:8px}
    .sep{height:10px}

    /* Preview */
    .preview{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.12);
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
      font-size:12px;
      color:var(--muted);
    }
    .kv:last-child{border-bottom:none}
    .kv b{color:var(--text)}
    .big{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }

    /* Tables for Kunden/Firma */
    .list{
      display:grid;
      gap:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .item strong{display:block}
    .item small{display:block;color:var(--muted); margin-top:4px}
    .item .actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
    .btn.small{padding:8px 10px; font-weight:900; border-radius:10px}
    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="sb-logo">MS</div>
        <div class="sb-title">
          <strong>Masculine Security</strong>
          <small>Rechnung • Kunden • Firma</small>
        </div>
      </div>

      <div class="sb-nav">
        <button class="navbtn active" id="navRechnung" type="button">
          <span>Rechnung</span>
          <span class="navbadge" id="countRechnungen">1</span>
        </button>
        <button class="navbtn" id="navKunden" type="button">
          <span>Kunden</span>
          <span class="navbadge" id="countKunden">0</span>
        </button>
        <button class="navbtn" id="navFirma" type="button">
          <span>Firma</span>
          <span class="navbadge">local</span>
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- TOPBAR -->
      <div class="topbar">
        <div class="top-left">
          <strong id="pageTitle">Rechnung</strong>
          <small id="pageSub">Automatisch: Tage × Std/Tag = Stunden • Stunden × €/h = Netto</small>
        </div>

        <div class="btns">
          <span class="pill"><span class="dot good"></span>Deploy: Auto</span>
          <span class="pill"><span class="dot warn"></span>Cache: Controlled</span>
          <span class="pill">Version: <b class="mono" id="ver">…</b></span>

          <button class="btn primary" id="btnExport" type="button">Export JSON</button>
          <button class="btn" id="btnImport" type="button">Import JSON</button>
          <button class="btn good" id="btnSave" type="button">Speichern</button>
          <button class="btn" id="btnOpenPdf" type="button">Open PDF (Print)</button>
          <button class="btn danger" id="btnCacheFix" type="button">Cache Fix</button>

          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </div>
      </div>

      <!-- CONTENT -->
      <div class="content">

        <!-- PAGE: RECHNUNG -->
        <section id="pageRechnung">
          <div class="grid">
            <div class="card">
              <div class="hd">
                <strong>Rechnung erstellen / bearbeiten</strong>
                <small>Datum-Format im PDF: <span class="mono">DD.MM.YYYY</span> (z.B. 07.02.2026) • E-Mail oben &amp; bei Kunde ist klickbar.</small>
              </div>
              <div class="bd">

                <div class="row">
                  <div>
                    <label>Rechnungs-Nr.</label>
                    <input id="invNo" value="MS-2026-0001">
                  </div>
                  <div>
                    <label>Rechnungsdatum</label>
                    <input id="invDate" type="date" value="2026-02-08">
                    <div class="hint">PDF Format: <span class="mono" id="pdfDateHint">08.02.2026</span></div>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Von</label>
                    <input id="periodFrom" type="date">
                  </div>
                  <div>
                    <label>Bis</label>
                    <input id="periodTo" type="date">
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Fällig am</label>
                    <input id="dueDate" type="date">
                  </div>
                  <div>
                    <label>Status</label>
                    <select id="status">
                      <option value="Entwurf" selected>Entwurf</option>
                      <option value="Gesendet">Gesendet</option>
                      <option value="Bezahlt">Bezahlt</option>
                      <option value="Storniert">Storniert</option>
                    </select>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Kunde auswählen (gespeichert)</label>
                    <select id="customerSelect">
                      <option value="">— bitte wählen —</option>
                    </select>
                  </div>
                  <div>
                    <label>Kunde E-Mail (für PDF)</label>
                    <input id="customerEmail" value="kunde@email.de">
                  </div>
                </div>

                <div class="sep"></div>

                <div>
                  <label>Leistungsbeschreibung (100% writing)</label>
                  <input id="serviceDesc" value="Sicherheitsdienstleistung — Objektbewachung">
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Automatisch (optional)</label>
                    <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                      <div>
                        <label style="margin-top:0">Tage</label>
                        <input id="days" type="number" step="1" min="0" value="0">
                      </div>
                      <div>
                        <label style="margin-top:0">Std/Tag</label>
                        <input id="hoursPerDay" type="number" step="0.01" min="0" value="0">
                      </div>
                    </div>
                    <div class="hint">Stunden = Tage × Std/Tag (wenn Tage &gt; 0)</div>
                  </div>

                  <div>
                    <label>Manuell</label>
                    <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                      <div>
                        <label style="margin-top:0">Stunden</label>
                        <input id="hours" type="number" step="0.01" min="0" value="0">
                      </div>
                      <div>
                        <label style="margin-top:0">€/h</label>
                        <input id="rate" type="number" step="0.01" min="0" value="0">
                      </div>
                    </div>
                    <div class="hint">Netto = Stunden × €/h</div>
                  </div>
                </div>

              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Vorschau (live)</strong>
                <small>Diese Vorschau ist nur für App — PDF wird über “Open PDF (Print)” erzeugt.</small>
              </div>
              <div class="bd">
                <div class="preview">
                  <div class="kv"><span>Rechnungs-Nr:</span><b class="mono" id="pNo">MS-2026-0001</b></div>
                  <div class="kv"><span>Datum:</span><b id="pDate">08.02.2026</b></div>
                  <div class="kv"><span>Zeitraum:</span><b id="pPeriod">—</b></div>
                  <div class="kv"><span>Status:</span><b id="pStatus">Entwurf</b></div>

                  <div style="height:10px"></div>

                  <div class="kv"><span>Kunde:</span><b id="pCustomer">—</b></div>
                  <div class="kv"><span>Kunde E-Mail:</span><b><a class="link" id="pCustomerMail" href="mailto:kunde@email.de">kunde@email.de</a></b></div>

                  <div style="height:10px"></div>

                  <div style="color:var(--muted); font-size:12px; margin-bottom:6px;">Leistung</div>
                  <div class="big" id="pService">Sicherheitsdienstleistung — Objektbewachung</div>

                  <div style="height:10px"></div>

                  <div class="kv"><span>Stunden:</span><b class="mono" id="pHours">0,00</b></div>
                  <div class="kv"><span>€/h:</span><b class="mono" id="pRate">0,00</b></div>
                  <div class="kv"><span>Netto:</span><b class="mono" id="pNet">0,00 €</b></div>

                  <div style="height:10px"></div>
                  <div class="hint">
                    Hinweis: Gemäß § 19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>

        <!-- PAGE: KUNDEN -->
        <section id="pageKunden" class="hidden">
          <div class="grid" style="grid-template-columns: .95fr 1.05fr;">
            <div class="card">
              <div class="hd">
                <strong>Kunden speichern</strong>
                <small>Wird lokal (Browser) gespeichert. Danach in Rechnung auswählbar.</small>
              </div>
              <div class="bd">
                <div class="row">
                  <div>
                    <label>Name</label>
                    <input id="cName" placeholder="Kunde Name">
                  </div>
                  <div>
                    <label>E-Mail</label>
                    <input id="cEmail" placeholder="kunde@email.de">
                  </div>
                </div>
                <div class="sep"></div>
                <div>
                  <label>Adresse</label>
                  <input id="cAddr" placeholder="Straße Hausnr, PLZ Stadt">
                </div>
                <div class="sep"></div>
                <button class="btn good" id="btnAddCustomer" type="button">Kunde speichern</button>
                <button class="btn danger" id="btnClearCustomers" type="button" style="margin-left:10px">Alle Kunden löschen</button>
                <div class="hint">Tip: Kunde auswählen → Rechnung page → Kunde select</div>
              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Gespeicherte Kunden</strong>
                <small id="kundenHint">0 Kunden</small>
              </div>
              <div class="bd">
                <div class="list" id="kundenList"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- PAGE: FIRMA -->
        <section id="pageFirma" class="hidden">
          <div class="grid" style="grid-template-columns: .95fr 1.05fr;">
            <div class="card">
              <div class="hd">
                <strong>Firma (Absender)</strong>
                <small>Wird für PDF/Print verwendet. Lokal gespeichert.</small>
              </div>
              <div class="bd">
                <div>
                  <label>Firmenname</label>
                  <input id="fName" value="Masculine Security">
                </div>
                <div class="sep"></div>
                <div>
                  <label>Adresse</label>
                  <input id="fAddr" value="Werschenregerstraße 6 · 28237 Bremen">
                </div>
                <div class="sep"></div>
                <div class="row">
                  <div>
                    <label>E-Mail</label>
                    <input id="fEmail" value="kontakt.mass.bremen@hotmail.com">
                  </div>
                  <div>
                    <label>Steuernummer (optional)</label>
                    <input id="fTax" placeholder="—">
                  </div>
                </div>
                <div class="sep"></div>
                <div class="row">
                  <div>
                    <label>IBAN</label>
                    <input id="fIban" value="DE98 1001 1001 2333 0146 96">
                  </div>
                  <div>
                    <label>BIC</label>
                    <input id="fBic" value="NTSBDEB1XXX">
                  </div>
                </div>
                <div class="sep"></div>
                <button class="btn good" id="btnSaveFirma" type="button">Firma speichern</button>
                <div class="hint">PDF/Print: E-Mail clickable + §19 UStG Hinweis</div>
              </div>
            </div>

            <div class="card">
              <div class="hd">
                <strong>Vorschau Firma</strong>
                <small>So erscheint es oben im PDF/Print</small>
              </div>
              <div class="bd">
                <div class="preview">
                  <div class="kv"><span>Firma:</span><b id="pfName">Masculine Security</b></div>
                  <div class="kv"><span>Adresse:</span><b id="pfAddr">Werschenregerstraße 6 · 28237 Bremen</b></div>
                  <div class="kv"><span>E-Mail:</span><b><a class="link" id="pfEmail" href="mailto:kontakt.mass.bremen@hotmail.com">kontakt.mass.bremen@hotmail.com</a></b></div>
                  <div class="kv"><span>IBAN:</span><b class="mono" id="pfIban">DE98 1001 1001 2333 0146 96</b></div>
                  <div class="kv"><span>BIC:</span><b class="mono" id="pfBic">NTSBDEB1XXX</b></div>
                  <div class="kv"><span>Steuernummer:</span><b class="mono" id="pfTax">—</b></div>
                </div>
              </div>
            </div>

          </div>
        </section>

      </div>
    </main>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // ---------- Storage keys
  const K_CUSTOMERS = "ms_customers_v1";
  const K_FIRMA = "ms_firma_v1";
  const K_INVOICE = "ms_invoice_v1";

  // ---------- Helpers
  const fmtDE = (n)=>Number(n||0).toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2});
  const euro = (n)=>fmtDE(n) + " €";
  const pad2 = (x)=>String(x).padStart(2,"0");
  const toDEDate = (iso)=>{
    if(!iso) return "—";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "—";
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
  };

  // ---------- State
  let customers = [];
  let firma = null;
  let invoice = null;

  // ---------- Default firma
  function defaultFirma(){
    return {
      name: "Masculine Security",
      addr: "Werschenregerstraße 6 · 28237 Bremen",
      email: "kontakt.mass.bremen@hotmail.com",
      tax: "",
      iban: "DE98 1001 1001 2333 0146 96",
      bic: "NTSBDEB1XXX"
    };
  }

  // ---------- Load/Save
  function loadAll(){
    try{ customers = JSON.parse(localStorage.getItem(K_CUSTOMERS) || "[]"); }catch(e){ customers=[]; }
    try{ firma = JSON.parse(localStorage.getItem(K_FIRMA) || "null"); }catch(e){ firma=null; }
    try{ invoice = JSON.parse(localStorage.getItem(K_INVOICE) || "null"); }catch(e){ invoice=null; }

    if(!firma) firma = defaultFirma();
    if(!invoice){
      invoice = {
        no: "MS-2026-0001",
        date: $("invDate").value || "",
        from: "",
        to: "",
        due: "",
        status: "Entwurf",
        customerId: "",
        customerEmail: "kunde@email.de",
        serviceDesc: "Sicherheitsdienstleistung — Objektbewachung",
        days: 0,
        hoursPerDay: 0,
        hours: 0,
        rate: 0
      };
    }
  }

  function saveCustomers(){ localStorage.setItem(K_CUSTOMERS, JSON.stringify(customers)); }
  function saveFirma(){ localStorage.setItem(K_FIRMA, JSON.stringify(firma)); }
  function saveInvoice(){ localStorage.setItem(K_INVOICE, JSON.stringify(invoice)); }

  // ---------- UI Navigation
  function setActivePage(page){
    // buttons
    $("navRechnung").classList.toggle("active", page==="rechnung");
    $("navKunden").classList.toggle("active", page==="kunden");
    $("navFirma").classList.toggle("active", page==="firma");

    // pages
    $("pageRechnung").classList.toggle("hidden", page!=="rechnung");
    $("pageKunden").classList.toggle("hidden", page!=="kunden");
    $("pageFirma").classList.toggle("hidden", page!=="firma");

    // titles
    if(page==="rechnung"){
      $("pageTitle").textContent="Rechnung";
      $("pageSub").textContent="Automatisch: Tage × Std/Tag = Stunden • Stunden × €/h = Netto";
    }
    if(page==="kunden"){
      $("pageTitle").textContent="Kunden";
      $("pageSub").textContent="Kunden lokal speichern und in Rechnung auswählen";
    }
    if(page==="firma"){
      $("pageTitle").textContent="Firma";
      $("pageSub").textContent="Absenderdaten lokal speichern (PDF/Print nutzt diese)";
    }
  }

  // ---------- Counts
  function refreshCounts(){
    $("countKunden").textContent = String(customers.length);
    $("countRechnungen").textContent = "1";
    $("kundenHint").textContent = `${customers.length} Kunden`;
  }

  // ---------- Customers UI
  function renderCustomers(){
    const box = $("kundenList");
    box.innerHTML = "";
    if(customers.length===0){
      box.innerHTML = `<div class="hint">Noch keine Kunden gespeichert.</div>`;
      return;
    }
    customers.forEach((c, idx)=>{
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <strong>${escapeHtml(c.name || "—")}</strong>
        <small>${escapeHtml(c.addr || "")}</small>
        <small><a class="link" href="mailto:${escapeAttr(c.email||"")}">${escapeHtml(c.email||"")}</a></small>
        <div class="actions">
          <button class="btn small primary" data-use="${c.id}">In Rechnung nutzen</button>
          <button class="btn small danger" data-del="${c.id}">Löschen</button>
        </div>
      `;
      box.appendChild(div);
    });

    // actions
    box.querySelectorAll("[data-use]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-use");
        invoice.customerId = id;
        const c = customers.find(x=>x.id===id);
        if(c && c.email) invoice.customerEmail = c.email;
        saveInvoice();
        hydrateInvoiceToInputs();
        refreshCustomerSelect();
        updatePreview();
        setActivePage("rechnung");
      });
    });
    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        customers = customers.filter(x=>x.id!==id);
        if(invoice.customerId===id) invoice.customerId="";
        saveCustomers();
        saveInvoice();
        refreshCounts();
        renderCustomers();
        refreshCustomerSelect();
        updatePreview();
      });
    });
  }

  function refreshCustomerSelect(){
    const sel = $("customerSelect");
    const current = invoice.customerId || "";
    sel.innerHTML = `<option value="">— bitte wählen —</option>`;
    customers.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name || "(ohne Name)";
      sel.appendChild(opt);
    });
    sel.value = current;
  }

  // ---------- Firma UI
  function hydrateFirmaToInputs(){
    $("fName").value = firma.name || "";
    $("fAddr").value = firma.addr || "";
    $("fEmail").value = firma.email || "";
    $("fTax").value = firma.tax || "";
    $("fIban").value = firma.iban || "";
    $("fBic").value = firma.bic || "";
    renderFirmaPreview();
  }

  function renderFirmaPreview(){
    $("pfName").textContent = firma.name || "—";
    $("pfAddr").textContent = firma.addr || "—";
    $("pfIban").textContent = firma.iban || "—";
    $("pfBic").textContent = firma.bic || "—";
    $("pfTax").textContent = firma.tax ? firma.tax : "—";
    const mail = $("pfEmail");
    mail.textContent = firma.email || "—";
    mail.href = firma.email ? "mailto:"+firma.email : "#";
  }

  // ---------- Invoice UI
  function hydrateInvoiceToInputs(){
    $("invNo").value = invoice.no || "";
    $("invDate").value = invoice.date || "";
    $("periodFrom").value = invoice.from || "";
    $("periodTo").value = invoice.to || "";
    $("dueDate").value = invoice.due || "";
    $("status").value = invoice.status || "Entwurf";
    $("serviceDesc").value = invoice.serviceDesc || "";
    $("days").value = invoice.days || 0;
    $("hoursPerDay").value = invoice.hoursPerDay || 0;
    $("hours").value = invoice.hours || 0;
    $("rate").value = invoice.rate || 0;
    $("customerEmail").value = invoice.customerEmail || "kunde@email.de";

    $("pdfDateHint").textContent = toDEDate($("invDate").value);
  }

  function readInputsToInvoice(){
    invoice.no = $("invNo").value.trim();
    invoice.date = $("invDate").value || "";
    invoice.from = $("periodFrom").value || "";
    invoice.to = $("periodTo").value || "";
    invoice.due = $("dueDate").value || "";
    invoice.status = $("status").value || "Entwurf";
    invoice.serviceDesc = $("serviceDesc").value.trim();
    invoice.days = Number($("days").value || 0);
    invoice.hoursPerDay = Number($("hoursPerDay").value || 0);
    invoice.hours = Number($("hours").value || 0);
    invoice.rate = Number($("rate").value || 0);
    invoice.customerEmail = $("customerEmail").value.trim();

    $("pdfDateHint").textContent = toDEDate(invoice.date);
  }

  function calcHours(){
    const days = Number(invoice.days||0);
    const hpd  = Number(invoice.hoursPerDay||0);
    if(days > 0 && hpd > 0){
      return days * hpd;
    }
    return Number(invoice.hours||0);
  }

  function getSelectedCustomer(){
    const id = invoice.customerId || "";
    if(!id) return null;
    return customers.find(c=>c.id===id) || null;
  }

  function updatePreview(){
    readInputsToInvoice();

    const c = getSelectedCustomer();
    const hours = calcHours();
    const net = hours * Number(invoice.rate||0);

    // preview text
    $("pNo").textContent = invoice.no || "—";
    $("pDate").textContent = toDEDate(invoice.date);
    $("pStatus").textContent = invoice.status || "—";
    const period = (invoice.from && invoice.to) ? `${toDEDate(invoice.from)} – ${toDEDate(invoice.to)}` : "—";
    $("pPeriod").textContent = period;

    const cname = c ? (c.name || "—") : "—";
    $("pCustomer").textContent = cname;

    const mail = $("pCustomerMail");
    mail.textContent = invoice.customerEmail || "—";
    mail.href = invoice.customerEmail ? "mailto:"+invoice.customerEmail : "#";

    $("pService").textContent = invoice.serviceDesc || "—";
    $("pHours").textContent = fmtDE(hours);
    $("pRate").textContent = fmtDE(invoice.rate);
    $("pNet").textContent = euro(net);
  }

  // ---------- Buttons
  $("btnSave").addEventListener("click", ()=>{
    readInputsToInvoice();
    saveInvoice();
    // also save firma + customers already saved separately
    toast("Gespeichert ✅");
  });

  $("btnExport").addEventListener("click", ()=>{
    readInputsToInvoice();
    const payload = {
      meta:{app:"MasculineSecurity", version: $("ver").textContent || ""},
      exportedAt: new Date().toISOString(),
      firma, customers, invoice
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `ms-backup-${Date.now()}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  $("btnImport").addEventListener("click", ()=> $("fileImport").click());
  $("fileImport").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);

      if(data.firma) firma = data.firma;
      if(Array.isArray(data.customers)) customers = data.customers;
      if(data.invoice) invoice = data.invoice;

      saveFirma(); saveCustomers(); saveInvoice();
      refreshCounts();
      refreshCustomerSelect();
      hydrateFirmaToInputs();
      hydrateInvoiceToInputs();
      renderCustomers();
      updatePreview();
      toast("Import ok ✅");
    }catch(err){
      toast("Import error ❌");
    }finally{
      e.target.value = "";
    }
  });

  // Open PDF (Print) — tries pdf.html first (if you already have it)
  $("btnOpenPdf").addEventListener("click", ()=>{
    readInputsToInvoice();
    const c = getSelectedCustomer();
    const hours = calcHours();
    const net = hours * Number(invoice.rate||0);

    // If you have a dedicated pdf.html (old PDF format), we keep it:
    // It will receive params via query string.
    const pdfUrl = `pdf.html?no=${enc(invoice.no)}&date=${enc(invoice.date)}&from=${enc(invoice.from)}&to=${enc(invoice.to)}&due=${enc(invoice.due)}&status=${enc(invoice.status)}&cname=${enc(c?c.name:"")}&caddr=${enc(c?c.addr:"")}&cmail=${enc(invoice.customerEmail)}&desc=${enc(invoice.serviceDesc)}&hours=${enc(hours)}&rate=${enc(invoice.rate)}&net=${enc(net)}`;
    // Try to open pdf.html; if it 404s in your project, fallback to print template.
    openPdfWithFallback(pdfUrl, {c, hours, net});
  });

  // Cache Fix (best possible in browser)
  $("btnCacheFix").addEventListener("click", async ()=>{
    try{
      // unregister SW
      if("serviceWorker" in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      // clear caches
      if("caches" in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
      // bump version query to force reload
      const u = new URL(location.href);
      u.searchParams.set("v", String(Date.now()));
      location.replace(u.toString());
    }catch(e){
      location.reload();
    }
  });

  // ---------- Nav handlers
  $("navRechnung").addEventListener("click", ()=>setActivePage("rechnung"));
  $("navKunden").addEventListener("click", ()=>setActivePage("kunden"));
  $("navFirma").addEventListener("click", ()=>setActivePage("firma"));

  // ---------- Rechnung listeners (live)
  [
    "invNo","invDate","periodFrom","periodTo","dueDate","status","customerEmail",
    "serviceDesc","days","hoursPerDay","hours","rate"
  ].forEach(id=>{
    $(id).addEventListener("input", ()=>{ updatePreview(); });
    $(id).addEventListener("change", ()=>{ updatePreview(); });
  });

  $("customerSelect").addEventListener("change", ()=>{
    invoice.customerId = $("customerSelect").value || "";
    const c = getSelectedCustomer();
    if(c && c.email) $("customerEmail").value = c.email;
    updatePreview();
    saveInvoice();
  });

  // ---------- Kunden handlers
  $("btnAddCustomer").addEventListener("click", ()=>{
    const name = $("cName").value.trim();
    const email = $("cEmail").value.trim();
    const addr = $("cAddr").value.trim();
    if(!name){
      toast("Name fehlt ❗");
      return;
    }
    const id = "c_" + Math.random().toString(36).slice(2,10);
    customers.unshift({id, name, email, addr});
    saveCustomers();
    refreshCounts();
    renderCustomers();
    refreshCustomerSelect();
    $("cName").value=""; $("cEmail").value=""; $("cAddr").value="";
    toast("Kunde gespeichert ✅");
  });

  $("btnClearCustomers").addEventListener("click", ()=>{
    customers = [];
    invoice.customerId = "";
    saveCustomers();
    saveInvoice();
    refreshCounts();
    renderCustomers();
    refreshCustomerSelect();
    updatePreview();
    toast("Kunden gelöscht ✅");
  });

  // ---------- Firma handlers
  $("btnSaveFirma").addEventListener("click", ()=>{
    firma = {
      name: $("fName").value.trim(),
      addr: $("fAddr").value.trim(),
      email: $("fEmail").value.trim(),
      tax: $("fTax").value.trim(),
      iban: $("fIban").value.trim(),
      bic: $("fBic").value.trim()
    };
    saveFirma();
    renderFirmaPreview();
    toast("Firma gespeichert ✅");
  });

  // ---------- Version badge (from version.txt) + auto reload on change
  async function getVersion(){
    const r = await fetch("./version.txt?ts=" + Date.now(), {cache:"no-store"});
    return (await r.text()).trim();
  }
  async function initVersion(){
    try{
      const v = await getVersion();
      $("ver").textContent = v || "v?";
      // poll for changes
      let last = v || "";
      setInterval(async ()=>{
        try{
          const nv = await getVersion();
          if(nv && last && nv !== last) location.reload();
          last = nv || last;
        }catch(e){}
      }, 20000);
    }catch(e){
      $("ver").textContent = "no version";
    }
  }

  // ---------- Init
  loadAll();
  refreshCounts();
  hydrateFirmaToInputs();
  hydrateInvoiceToInputs();
  refreshCustomerSelect();
  renderCustomers();
  updatePreview();
  initVersion();
  setActivePage("rechnung");

  // ---------- Utilities
  function escapeHtml(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return String(s||"").replaceAll('"',"&quot;");
  }
  function enc(s){ return encodeURIComponent(String(s??"")); }

  function toast(msg){
    // lightweight toast
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id="toast";
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="18px";
      t.style.transform="translateX(-50%)";
      t.style.padding="10px 12px";
      t.style.border="1px solid rgba(255,255,255,.14)";
      t.style.background="rgba(0,0,0,.45)";
      t.style.backdropFilter="blur(10px)";
      t.style.borderRadius="999px";
      t.style.color="white";
      t.style.fontWeight="900";
      t.style.zIndex="9999";
      t.style.boxShadow="0 20px 50px rgba(0,0,0,.35)";
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity="1";
    clearTimeout(window.__t_toast);
    window.__t_toast = setTimeout(()=>{ t.style.opacity="0"; }, 1600);
  }

  async function openPdfWithFallback(pdfUrl, meta){
    // Try pdf.html in a new tab; if it exists it will open fine.
    // If it doesn't exist, fallback to internal print template.
    // We can't reliably detect 404 cross-window, so we provide a fallback button.
    const w = window.open(pdfUrl, "_blank");
    if(!w){
      // popup blocked
      fallbackPrint(meta);
      return;
    }
    // Also provide: if user sees blank, they can use Print fallback quickly:
    setTimeout(()=>{
      try{
        // If user still wants fallback, show toast with instruction
        toast("Wenn PDF leer ist: Cache Fix oder nochmal Open PDF");
      }catch(e){}
    }, 700);
  }

  function fallbackPrint({c, hours, net}){
    // Print template (keeps layout consistent; does not touch your external PDF template)
    const f = firma || defaultFirma();
    const cname = c ? (c.name||"") : "";
    const caddr = c ? (c.addr||"") : "";
    const cmail = invoice.customerEmail || "";

    const html = `
<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rechnung ${escapeHtml(invoice.no||"")}</title>
<style>
  body{font-family: Arial, system-ui; margin:18px; color:#111}
  .top{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap}
  h1{margin:0 0 8px; font-size:26px}
  .box{border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0}
  .muted{color:#555; font-size:12px}
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th,td{border-bottom:1px solid #eee; padding:8px; font-size:12px}
  th{background:#fafafa; text-align:left; color:#444}
  td.num{text-align:right; font-variant-numeric: tabular-nums}
  .right{text-align:right}
  a{color:#0b65ff; text-decoration:none}
</style></head><body>

<div class="top">
  <div>
    <h1>Rechnung</h1>
    <div class="muted">Rechnungs-Nr: <b>${escapeHtml(invoice.no||"")}</b></div>
    <div class="muted">Datum: <b>${escapeHtml(toDEDate(invoice.date))}</b></div>
    <div class="muted">Zeitraum: <b>${escapeHtml((invoice.from&&invoice.to)?(toDEDate(invoice.from)+" – "+toDEDate(invoice.to)):"—")}</b></div>
  </div>
  <div class="right">
    <b>${escapeHtml(f.name||"")}</b><br/>
    <span class="muted">${escapeHtml(f.addr||"")}</span><br/>
    <span class="muted">E-Mail: <a href="mailto:${escapeAttr(f.email||"")}">${escapeHtml(f.email||"")}</a></span><br/>
    <span class="muted">IBAN: ${escapeHtml(f.iban||"")}</span><br/>
    <span class="muted">BIC: ${escapeHtml(f.bic||"")}</span>
  </div>
</div>

<div class="box">
  <div style="display:flex; gap:12px; flex-wrap:wrap">
    <div style="flex:1 1 280px">
      <div class="muted">Rechnung von</div>
      <b>${escapeHtml(f.name||"")}</b><br/>
      <span class="muted">${escapeHtml(f.addr||"")}</span><br/>
      <span class="muted">E-Mail: <a href="mailto:${escapeAttr(f.email||"")}">${escapeHtml(f.email||"")}</a></span>
    </div>
    <div style="flex:1 1 280px">
      <div class="muted">Rechnung an</div>
      <b>${escapeHtml(cname||"—")}</b><br/>
      <span class="muted">${escapeHtml(caddr||"")}</span><br/>
      <span class="muted">E-Mail: <a href="mailto:${escapeAttr(cmail||"")}">${escapeHtml(cmail||"")}</a></span>
    </div>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Leistung</th>
      <th class="num">Stunden</th>
      <th class="num">€/h</th>
      <th class="num">Netto</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>${escapeHtml(invoice.serviceDesc||"")}</td>
      <td class="num">${escapeHtml(fmtDE(hours))}</td>
      <td class="num">${escapeHtml(fmtDE(invoice.rate))}</td>
      <td class="num">${escapeHtml(euro(net))}</td>
    </tr>
  </tbody>
</table>

<div class="box right">
  <div><b>Zu zahlen (Netto): ${escapeHtml(euro(net))}</b></div>
  <div class="muted" style="margin-top:6px">Gemäß § 19 UStG wird keine Umsatzsteuer berechnet.</div>
</div>

<script>window.onload=()=>window.print();<\/script>
</body></html>`;

    const w = window.open("", "_blank");
    if(!w){ alert("Popup blockiert. Bitte erlauben."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

})();
</script>
</body>
</html>

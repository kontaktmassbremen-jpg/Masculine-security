<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Office (Rechnung + Payroll)</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit}
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin:0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
      user-select:none;
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .foot .warn{color:#ff9aa9; font-weight:900}

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px}
    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px; border:1px solid rgba(255,255,255,.06)}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
      line-height:1.35;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)
    }
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:8px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
      white-space:pre-line;
    }

    /* Print document base */
    @media print{
      body{background:#fff;color:#000}
      .app{display:none!important}
      #printRoot{display:block!important}
      a{color:#000; text-decoration:underline}
    }
    #printRoot{display:none}
    .pdoc{font-family: Arial, sans-serif; padding:18px; color:#000}
    .phead{display:flex; justify-content:space-between; gap:18px; align-items:flex-start; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:10px}
    .phead h1{margin:0; font-size:18px}
    .pbox{border:1px solid #ddd; padding:10px; margin:10px 0}
    .ptable{width:100%; border-collapse:collapse}
    .ptable th,.ptable td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:12px}
    .pright{text-align:right}
    .pmeta{font-size:12px; color:#222}
    .psub{font-size:12px; color:#444; margin-top:2px}
    .pgrid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .pgrid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
    .ptitle{font-size:16px; font-weight:800; margin:0 0 6px 0}
    .psmall{font-size:11px; color:#444}
    .psec{margin-top:10px}
    .pbadge{display:inline-block; padding:4px 8px; border:1px solid #bbb; border-radius:999px; font-size:11px}
    .pwater{display:none!important} /* signatures/marks removed globally */

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
    }

    /* VERSION STAMP (visual check) */
    .vstamp{
      position:fixed; left:10px; bottom:10px; z-index:99999;
      background:#000a; color:#fff; padding:6px 10px; border-radius:10px;
      font:12px Arial; user-select:none;
    }
  </style>
</head>
<body>

<div class="vstamp">v10-no-signatures-auto-date</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Rechnung ‚Ä¢ Kunden ‚Ä¢ Mitarbeiter ‚Ä¢ Payroll</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll</span><span class="pill" id="pillPayroll">PDF</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Offline:</b> Daten bleiben im Browser (Storage).</div>
      <div class="muted">Update nicht sichtbar? √ñffne Link mit <b>?v=9999</b> oder Incognito.</div>
      <div class="muted"><span class="warn">Wichtig:</span> Payroll/ Bescheinigungen sind <b>Entwurf/Vorschau</b> (keine amtliche Erstellung).</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Auto: Tage + Std/Tag + ‚Ç¨/h ‚Üí Stunden & Betrag</small>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnNew">+ Neu</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Alles l√∂schen</button>
      </div>
    </div>

    <div class="content">

      <!-- INVOICES -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen / bearbeiten</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>
            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>
            <div class="split">
              <div class="field"><label>F√§llig am</label><input id="i_due" type="date"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Auto Stunden</h3>
            <div class="split">
              <div class="field"><label>Tage (inta bari)</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag (saacado maalintii)</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h (qiime saacaddii)</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>
            <div class="note">
              <b>Menge = Stunden</b> ‚Ä¢ <b>Preis = ‚Ç¨/h</b> ‚Ä¢ <b>Netto = Stunden √ó ‚Ç¨/h</b><br>
              (Waxaad wali ku dari kartaa positiono kale.)
            </div>

            <div class="hr"></div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <h3 style="margin:0">Positionen</h3>
              <button class="btn" id="btnAddLine">+ Position</button>
            </div>

            <table class="table" style="margin-top:10px">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto (auto)</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
            </div>

            <div class="note" id="i_preview">Positionen: 0 ‚Ä¢ Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSaveInvoice">Speichern</button>
              <button class="btn" id="btnPrintInvoice">PDF Rechnung (A4)</button>
            </div>

            <input id="i_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Rechnungen Liste</h3>

            <div class="split">
              <div class="field"><label>Suche</label><input id="inv_search" placeholder="Nr / Kunde / Status"/></div>
              <div class="field"><label>Status Filter</label>
                <select id="inv_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Status</th>
                  <th class="right">Total</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde anlegen</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..."/></div>
            <div class="hr"></div>

            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCustomerSave">Speichern</button>
              <button class="btn danger" id="btnCustomerClear">Leeren</button>
            </div>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter anlegen</h3>
            <div class="field"><label>Suche</label><input id="m_search" placeholder="Name / Pers.-Nr. / Steuer-ID"/></div>
            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Name</label><input id="m_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Pers.-Nr. (intern)</label><input id="m_pnr" placeholder="z.B. 4943"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="m_taxid" placeholder="11-stellig (optional)"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="m_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Familienstand</label>
                <select id="m_family">
                  <option value="single">single</option>
                  <option value="married">married</option>
                </select>
              </div>
              <div class="field"><label>Kinder (Anzahl)</label><input id="m_children" type="number" step="1" min="0" placeholder="0"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Krankenkasse (AOK/Barmer/...)</label><input id="m_insurer" placeholder="z.B. AOK"/></div>
              <div class="field"><label>Vers.-Nr. (optional)</label><input id="m_insno" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Standard ‚Ç¨/h</label><input id="m_rate" type="number" step="0.01" placeholder="z.B. 14.00"/></div>
              <div class="field"><label>Status</label>
                <select id="m_status">
                  <option value="aktiv">aktiv</option>
                  <option value="inaktiv">inaktiv</option>
                </select>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnEmployeeSave">Speichern</button>
              <button class="btn danger" id="btnEmployeeClear">Leeren</button>
            </div>

            <input id="m_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Pers.-Nr.</th><th>Kasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Payroll (Entwurf)</h3>

            <div class="field"><label>Mitarbeiter w√§hlen</label>
              <select id="p_emp"></select>
            </div>

            <div class="split">
              <div class="field"><label>Monat (YYYY-MM)</label><input id="p_month" type="month"/></div>
              <div class="field"><label>Pers.-Nr. (auto)</label><input id="p_pnr" readonly/></div>
            </div>

            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.25" placeholder="z.B. 216"/></div>
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="auto aus Mitarbeiter"/></div>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">SV & Steuer (Sch√§tzung)</h3>
            <div class="note">
              Diese Berechnung ist eine <b>Sch√§tzung</b> (offline, ohne ELStAM/DATEV).<br>
              F√ºr <b>amtliche</b> Abrechnung: zertifizierte Lohnsoftware / Steuerberater nutzen.
            </div>

            <div class="split">
              <div class="field"><label>SV Arbeitnehmer (%)</label><input id="r_sv_an" type="number" step="0.01"/></div>
              <div class="field"><label>SV Arbeitgeber (%)</label><input id="r_sv_ag" type="number" step="0.01"/></div>
            </div>
            <div class="split">
              <div class="field"><label>Lohnsteuer (Sch√§tzung %)</label><input id="r_tax" type="number" step="0.01"/></div>
              <div class="field"><label>Kinderlos-Zuschlag Pflege? (ja/nein)</label>
                <select id="r_childless">
                  <option value="nein">nein</option>
                  <option value="ja">ja</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid3">
              <div class="card">
                <div class="muted" style="font-size:12px;font-weight:900">Brutto</div>
                <div style="font-size:20px;font-weight:900" id="k_brutto">0,00 ‚Ç¨</div>
              </div>
              <div class="card">
                <div class="muted" style="font-size:12px;font-weight:900">Abz√ºge (AN)</div>
                <div style="font-size:20px;font-weight:900" id="k_abzuege">0,00 ‚Ç¨</div>
              </div>
              <div class="card">
                <div class="muted" style="font-size:12px;font-weight:900">Netto</div>
                <div style="font-size:20px;font-weight:900" id="k_netto">0,00 ‚Ç¨</div>
              </div>
            </div>

            <div class="hr"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnPayrollCalc">Berechnen</button>
              <button class="btn" id="btnPrintPayslip">PDF Lohnabrechnung</button>
              <button class="btn" id="btnPrintArbeits">PDF Arbeitbescheinigung</button>
              <button class="btn" id="btnPrintTax">PDF Lohnsteuerbescheinigung</button>
            </div>
          </div>

          <div class="card">
            <h3>Firma Links (clickable)</h3>
            <div class="note" id="firmLinks"></div>
            <div class="hr"></div>
            <h3>Hinweis</h3>
            <div class="note">
              Unterschrift/Ort-Datum wurden <b>√ºberall entfernt</b> (wie gew√ºnscht).<br>
              Datum ist <b>automatisch</b> (heute).<br>
              PDF = Browser Print ‚Üí ‚ÄúSave as PDF‚Äù.
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma Einstellungen</h3>
            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
            </div>
            <div class="field"><label>Steuernummer / Steuer-ID (Firma)</label><input id="s_taxid" placeholder="z.B. 12/345/67890"/></div>
            <div class="field"><label>¬ß19 Hinweis</label><input id="s_hint"/></div>

            <div class="hr"></div>
            <h3>Default Payroll Raten (Sch√§tzung)</h3>
            <div class="split">
              <div class="field"><label>SV Arbeitnehmer (%)</label><input id="s_r_sv_an" type="number" step="0.01"/></div>
              <div class="field"><label>SV Arbeitgeber (%)</label><input id="s_r_sv_ag" type="number" step="0.01"/></div>
            </div>
            <div class="field"><label>Lohnsteuer (Sch√§tzung %)</label><input id="s_r_tax" type="number" step="0.01"/></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSettingsSave">Speichern</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
          </div>
        </div>
      </section>

    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
      <span class="tag" id="countsTag">‚Äî</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<div id="printRoot"></div>

<script>
/* ============================================================
   FIX: Service Worker off + clear caches (prevents "not updated")
============================================================ */
(async () => {
  try{
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

/* =========================
   Utils
========================= */
const $ = (id)=>document.getElementById(id);
const DB_KEY = "ms_office_v10";

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2200);
  }
};

function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

function fmtEUR(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function pad2(x){ return String(x).padStart(2,"0"); }
function todayISO(){
  const d=new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function todayDE(){
  const d=new Date();
  return d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"});
}
function nowDE(){
  const d=new Date();
  return d.toLocaleString("de-DE");
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(str){
  return String(str??"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}

/* =========================
   Store
========================= */
const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"+4915778697052",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          taxid:"",
          hint:"Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.",
          rates:{
            sv_an: 19.95,
            sv_ag: 19.95,
            tax: 10.00
          }
        },
        customers:[],
        employees:[],
        invoices:[]
      };
      this.save(true);
    }else{
      this.data.settings ??= {};
      this.data.settings.rates ??= {sv_an:19.95, sv_ag:19.95, tax:10.00};
      if(this.data.settings.rates.sv_an==null) this.data.settings.rates.sv_an=19.95;
      if(this.data.settings.rates.sv_ag==null) this.data.settings.rates.sv_ag=19.95;
      if(this.data.settings.rates.tax==null) this.data.settings.rates.tax=10.00;
      this.data.customers ??= [];
      this.data.employees ??= [];
      this.data.invoices ??= [];
      this.save(true);
    }
  },
  save(silent=false){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("Gespeichert ‚úÖ");
      UI.setStatus("Gespeichert", true);
      UI.renderCounts();
    }catch(e){
      UI.setStatus("Speichern fehlgeschlagen", false);
      Toast.show("Speichern fehlgeschlagen (Storage blockiert).");
    }
  },
  wipe(){
    StorageDriver.removeItem(DB_KEY);
    this.data=null;
    this.load();
    UI.renderAll();
    Toast.show("Alles gel√∂scht.");
  }
};

/* =========================
   UI Router
========================= */
const UI = {
  page:"invoices",
  init(){
    Store.load();
    this.bindNav();
    this.bindTop();
    this.bindInvoices();
    this.bindCustomers();
    this.bindEmployees();
    this.bindPayroll();
    this.bindSettings();
    this.renderAll();
    this.go("invoices");
  },
  go(page){
    this.page=page;
    const pages=["invoices","customers","employees","payroll","settings"];
    for(const p of pages){
      const el=$("page-"+p);
      if(el) el.classList.toggle("hide", p!==page);
    }
    // nav highlight
    [...$("nav").querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.dataset.page===page);
    });
    // titles
    const titles={
      invoices:["Rechnung","Auto: Tage + Std/Tag + ‚Ç¨/h ‚Üí Stunden & Betrag"],
      customers:["Kunden","Speichern ‚Ä¢ Suchen ‚Ä¢ Ausw√§hlen in Rechnung"],
      employees:["Mitarbeiter","Kasse/Steuerklasse/Kinder speichern"],
      payroll:["Payroll","Entwurf: Sch√§tzung SV & Lohnsteuer ‚Ä¢ PDF via Print"],
      settings:["Firma","IBAN/BIC/Steuer-ID ‚Ä¢ Default Payroll Raten"]
    };
    $("pageTitle").textContent=titles[page][0];
    $("pageSub").textContent=titles[page][1];
    this.renderAll();
  },
  setStatus(txt, ok){
    $("statusText").textContent=txt;
    $("dot").classList.toggle("off", !ok);
  },
  renderCounts(){
    $("pillCustomers").textContent=Store.data.customers.length;
    $("pillEmployees").textContent=Store.data.employees.length;
    $("pillInvoices").textContent=Store.data.invoices.length;
    $("pillStore").textContent=StorageDriver.type;
    $("storeTag").textContent="Storage: "+StorageDriver.type;
    $("countsTag").textContent=`Kunden: ${Store.data.customers.length} ‚Ä¢ Mitarbeiter: ${Store.data.employees.length} ‚Ä¢ Rechnungen: ${Store.data.invoices.length}`;
    $("storageNote").textContent="Storage: "+StorageDriver.type+" ‚Ä¢ DB_KEY: "+DB_KEY;
  },
  renderAll(){
    this.renderCounts();
    this.renderCustomerSelect();
    this.renderCustomersList();
    this.renderEmployeesList();
    this.renderEmployeeSelect();
    this.renderInvoicesList();
    this.refreshFirmLinks();
    this.fillSettings();
    this.refreshInvoicePreview();
    this.refreshPayrollPreview();
  },
  toast(msg){ Toast.show(msg); },

  bindNav(){
    $("nav").addEventListener("click",(e)=>{
      const btn=e.target.closest("button[data-page]");
      if(!btn) return;
      this.go(btn.dataset.page);
    });
  },
  bindTop(){
    $("btnNew").onclick=()=>{
      if(this.page==="invoices") Inv.clear(true);
      else if(this.page==="customers") Cust.clear();
      else if(this.page==="employees") Emp.clear();
      else if(this.page==="payroll") Pay.clear();
      else if(this.page==="settings") Settings.fill();
      Toast.show("Neu ‚úÖ");
    };

    $("btnExport").onclick=()=>{
      const blob = new Blob([JSON.stringify(Store.data,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="ms-office-backup.json";
      a.click();
      URL.revokeObjectURL(url);
      Toast.show("Export gestartet.");
    };

    $("btnImport").onclick=()=> $("fileImport").click();
    $("fileImport").addEventListener("change",(e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const json=JSON.parse(String(r.result||""));
          if(!json || typeof json!=="object") throw new Error("bad");
          // minimal shape
          json.settings ??= Store.data.settings;
          json.customers ??= [];
          json.employees ??= [];
          json.invoices ??= [];
          Store.data=json;
          Store.save(true);
          UI.renderAll();
          Toast.show("Import OK ‚úÖ");
        }catch(err){
          Toast.show("Import Fehler ‚ùå");
        }
      };
      r.readAsText(f);
      e.target.value="";
    });

    $("btnWipe").onclick=()=>{
      if(confirm("Wirklich alles l√∂schen?")) Store.wipe();
    };
  },

  refreshFirmLinks(){
    const s=Store.data.settings;
    const email=escapeHtml(s.email||"");
    const phone=escapeHtml(s.phone||"");
    const mail = email ? `<a href="mailto:${email}">${email}</a>` : "‚Äî";
    const tel = phone ? `<a href="tel:${phone.replace(/\s+/g,"")}">${phone}</a>` : "‚Äî";
    $("firmLinks").innerHTML =
      `<b>${escapeHtml(s.company||"")}</b><br>`+
      `<div class="muted">${escapeHtml(s.addr||"").replace(/\n/g,"<br>")}</div><br>`+
      `<b>E-Mail:</b> ${mail}<br>`+
      `<b>Tel:</b> ${tel}<br>`+
      `<b>IBAN:</b> ${escapeHtml(s.iban||"")}<br>`+
      `<b>BIC:</b> ${escapeHtml(s.bic||"")}<br>`+
      `<b>Steuer:</b> ${escapeHtml(s.taxid||"‚Äî")}<br>`;
  },

  /* ===== Selects ===== */
  renderCustomerSelect(){
    const sel=$("i_customer");
    if(!sel) return;
    sel.innerHTML="";
    const opt0=document.createElement("option");
    opt0.value=""; opt0.textContent="Bitte Kunde w√§hlen";
    sel.appendChild(opt0);
    for(const c of Store.data.customers){
      const o=document.createElement("option");
      o.value=c.id;
      o.textContent=c.name+(c.email?` ‚Ä¢ ${c.email}`:"");
      sel.appendChild(o);
    }
  },
  renderEmployeeSelect(){
    const sel=$("p_emp");
    if(!sel) return;
    sel.innerHTML="";
    const o0=document.createElement("option");
    o0.value=""; o0.textContent="Bitte Mitarbeiter w√§hlen";
    sel.appendChild(o0);
    for(const m of Store.data.employees){
      const o=document.createElement("option");
      o.value=m.id;
      o.textContent=`${m.name} ‚Ä¢ Pers.-Nr: ${m.pnr||"‚Äî"} ‚Ä¢ ${m.insurer||"Kasse?"}`;
      sel.appendChild(o);
    }
  }
};

/* =========================
   Customers
========================= */
const Cust = {
  bind(){
    $("btnCustomerSave").onclick=()=>{
      const id = uid();
      const name=$("c_name").value.trim();
      if(!name) return Toast.show("Name fehlt.");
      const email=$("c_email").value.trim();
      const phone=$("c_phone").value.trim();
      const addr=$("c_addr").value.trim();
      Store.data.customers.push({id,name,email,phone,addr});
      Store.save(true);
      UI.renderAll();
      Cust.clear();
    };
    $("btnCustomerClear").onclick=()=>Cust.clear();
    $("c_search").addEventListener("input",()=>UI.renderCustomersList());
  },
  clear(){
    $("c_name").value="";
    $("c_email").value="";
    $("c_phone").value="";
    $("c_addr").value="";
    $("c_search").value="";
  }
};
UI.bindCustomers = ()=>Cust.bind();

UI.renderCustomersList = ()=>{
  const q=($("c_search").value||"").toLowerCase().trim();
  const tb=$("customersList");
  tb.innerHTML="";
  const rows = Store.data.customers.filter(c=>{
    if(!q) return true;
    return (c.name||"").toLowerCase().includes(q) ||
           (c.email||"").toLowerCase().includes(q) ||
           (c.addr||"").toLowerCase().includes(q);
  });
  for(const c of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(c.name)}</td>
      <td>${c.email ? `<a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a>` : "‚Äî"}</td>
      <td class="muted">${escapeHtml(c.addr||"").replace(/\n/g,"<br>")}</td>
      <td class="right">
        <button class="btn" data-act="use" data-id="${c.id}">W√§hlen</button>
        <button class="btn danger" data-act="del" data-id="${c.id}">L√∂schen</button>
      </td>
    `;
    tb.appendChild(tr);
  }
  tb.onclick=(e)=>{
    const b=e.target.closest("button[data-act]");
    if(!b) return;
    const id=b.dataset.id;
    const act=b.dataset.act;
    if(act==="use"){
      UI.go("invoices");
      $("i_customer").value=id;
      Toast.show("Kunde gew√§hlt.");
    }
    if(act==="del"){
      if(confirm("Kunde l√∂schen?")){
        Store.data.customers = Store.data.customers.filter(x=>x.id!==id);
        // also detach from invoices (optional)
        for(const inv of Store.data.invoices){
          if(inv.customerId===id) inv.customerId="";
        }
        Store.save(true);
        UI.renderAll();
      }
    }
  };
};

/* =========================
   Employees
========================= */
const Emp = {
  bind(){
    $("btnEmployeeSave").onclick=()=>{
      const editing = $("m_edit_id").value.trim();
      const m = {
        id: editing || uid(),
        name: $("m_name").value.trim(),
        pnr: $("m_pnr").value.trim(),
        taxid: $("m_taxid").value.trim(),
        taxclass: $("m_taxclass").value,
        family: $("m_family").value,
        children: Math.max(0, Math.round(num($("m_children").value))),
        insurer: $("m_insurer").value.trim(),
        insno: $("m_insno").value.trim(),
        rate: round2(num($("m_rate").value)),
        status: $("m_status").value
      };
      if(!m.name) return Toast.show("Name fehlt.");
      if(editing){
        const idx=Store.data.employees.findIndex(x=>x.id===editing);
        if(idx>=0) Store.data.employees[idx]=m;
      }else{
        Store.data.employees.push(m);
      }
      Store.save(true);
      UI.renderAll();
      Emp.clear();
    };

    $("btnEmployeeClear").onclick=()=>Emp.clear();
    $("m_search").addEventListener("input",()=>UI.renderEmployeesList());
  },
  clear(){
    $("m_edit_id").value="";
    $("m_name").value="";
    $("m_pnr").value="";
    $("m_taxid").value="";
    $("m_taxclass").value="I";
    $("m_family").value="single";
    $("m_children").value="0";
    $("m_insurer").value="";
    $("m_insno").value="";
    $("m_rate").value="";
    $("m_status").value="aktiv";
    $("m_search").value="";
  },
  edit(id){
    const m=Store.data.employees.find(x=>x.id===id);
    if(!m) return;
    UI.go("employees");
    $("m_edit_id").value=m.id;
    $("m_name").value=m.name||"";
    $("m_pnr").value=m.pnr||"";
    $("m_taxid").value=m.taxid||"";
    $("m_taxclass").value=m.taxclass||"I";
    $("m_family").value=m.family||"single";
    $("m_children").value=String(m.children??0);
    $("m_insurer").value=m.insurer||"";
    $("m_insno").value=m.insno||"";
    $("m_rate").value=String(m.rate??"");
    $("m_status").value=m.status||"aktiv";
    Toast.show("Bearbeiten ‚úèÔ∏è");
  }
};
UI.bindEmployees = ()=>Emp.bind();

UI.renderEmployeesList = ()=>{
  const q=($("m_search").value||"").toLowerCase().trim();
  const tb=$("employeesList");
  tb.innerHTML="";
  const rows = Store.data.employees.filter(m=>{
    if(!q) return true;
    return (m.name||"").toLowerCase().includes(q) ||
           (m.pnr||"").toLowerCase().includes(q) ||
           (m.taxid||"").toLowerCase().includes(q);
  });
  for(const m of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(m.name)}</td>
      <td>${escapeHtml(m.pnr||"‚Äî")}</td>
      <td>${escapeHtml(m.insurer||"‚Äî")}</td>
      <td class="right">
        <button class="btn" data-act="edit" data-id="${m.id}">Edit</button>
        <button class="btn danger" data-act="del" data-id="${m.id}">L√∂schen</button>
      </td>
    `;
    tb.appendChild(tr);
  }
  tb.onclick=(e)=>{
    const b=e.target.closest("button[data-act]");
    if(!b) return;
    const id=b.dataset.id;
    const act=b.dataset.act;
    if(act==="edit") Emp.edit(id);
    if(act==="del"){
      if(confirm("Mitarbeiter l√∂schen?")){
        Store.data.employees=Store.data.employees.filter(x=>x.id!==id);
        Store.save(true);
        UI.renderAll();
      }
    }
  };
};

/* =========================
   Invoices
========================= */
const Inv = {
  bind(){
    // defaults
    $("i_date").value = todayISO();

    // auto hours inputs
    ["w_days","w_hpd","w_rate"].forEach(id=>{
      $(id).addEventListener("input", ()=>Inv.applyAutoHours());
    });

    $("btnAddLine").onclick=()=>Inv.addLine();

    $("btnSaveInvoice").onclick=()=>Inv.save();
    $("btnPrintInvoice").onclick=()=>Inv.print();

    $("inv_search").addEventListener("input", ()=>UI.renderInvoicesList());
    $("inv_filter").addEventListener("change", ()=>UI.renderInvoicesList());
  },

  nextInvoiceNo(){
    const year = new Date().getFullYear();
    const prefix = "MS-"+year+"-";
    // find max
    let max=0;
    for(const inv of Store.data.invoices){
      if((inv.no||"").startsWith(prefix)){
        const n=parseInt(inv.no.slice(prefix.length),10);
        if(Number.isFinite(n)) max=Math.max(max,n);
      }
    }
    const next = String(max+1).padStart(4,"0");
    return prefix+next;
  },

  clear(withNo=false){
    $("i_edit_id").value="";
    $("i_no").value = withNo ? this.nextInvoiceNo() : "";
    $("i_date").value = todayISO();
    $("i_von").value = "";
    $("i_bis").value = "";
    $("i_due").value = "";
    $("i_status").value = "Entwurf";
    $("i_customer").value = "";
    $("w_days").value="";
    $("w_hpd").value="";
    $("w_rate").value="";
    $("w_total_hours").value="";
    $("linesBody").innerHTML="";
    this.addLine({desc:"Sicherheitsdienstleistung (Arbeitszeit)", qty:0, price:0});
    this.refreshTotals();
    Toast.show("Rechnung neu.");
  },

  addLine(line){
    const l = line || {desc:"", qty:0, price:0};
    const id=uid();
    const tr=document.createElement("tr");
    tr.dataset.id=id;
    tr.innerHTML=`
      <td><input class="li_desc" placeholder="Beschreibung" value="${escapeHtml(l.desc)}" style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); color: var(--text)"></td>
      <td class="right"><input class="li_qty" type="number" step="0.01" value="${String(l.qty??0)}" style="width:110px; text-align:right; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); color: var(--text)"></td>
      <td class="right"><input class="li_price" type="number" step="0.01" value="${String(l.price??0)}" style="width:110px; text-align:right; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); color: var(--text)"></td>
      <td class="right"><span class="li_net">0,00 ‚Ç¨</span></td>
      <td class="right">
        <button class="btn danger li_del" type="button">L√∂schen</button>
      </td>
    `;
    $("linesBody").appendChild(tr);

    const update=()=>this.refreshTotals();
    tr.querySelector(".li_desc").addEventListener("input", update);
    tr.querySelector(".li_qty").addEventListener("input", update);
    tr.querySelector(".li_price").addEventListener("input", update);
    tr.querySelector(".li_del").onclick=()=>{
      tr.remove();
      this.refreshTotals();
    };

    this.refreshTotals();
  },

  getLines(){
    const rows=[...$("linesBody").querySelectorAll("tr")];
    return rows.map(r=>{
      const desc=r.querySelector(".li_desc").value.trim();
      const qty=num(r.querySelector(".li_qty").value);
      const price=num(r.querySelector(".li_price").value);
      const net=round2(qty*price);
      return {desc, qty, price, net};
    });
  },

  applyAutoHours(){
    const days=num($("w_days").value);
    const hpd=num($("w_hpd").value);
    const rate=num($("w_rate").value);
    const hours = round2(days*hpd);
    $("w_total_hours").value = hours ? String(hours) : "";

    // fill first line (if exists)
    const first=$("linesBody").querySelector("tr");
    if(first){
      const qty=first.querySelector(".li_qty");
      const price=first.querySelector(".li_price");
      if(days>0 && hpd>0){
        qty.value = String(hours);
      }
      if(rate>0){
        price.value = String(round2(rate));
      }
    }
    this.refreshTotals();
  },

  refreshTotals(){
    const rows=[...$("linesBody").querySelectorAll("tr")];
    let sum=0;
    for(const r of rows){
      const qty=num(r.querySelector(".li_qty").value);
      const price=num(r.querySelector(".li_price").value);
      const net=round2(qty*price);
      r.querySelector(".li_net").textContent=fmtEUR(net);
      sum += net;
    }
    sum=round2(sum);
    $("sum_net").value = fmtEUR(sum);
    $("sum_total").value = fmtEUR(sum); // ¬ß19, no VAT
    $("i_preview").textContent = `Positionen: ${rows.length} ‚Ä¢ Gesamt: ${fmtEUR(sum)} ‚Ä¢ USt: 0,00 ‚Ç¨`;
    UI.renderCounts();
  },

  save(){
    const inv = {
      id: $("i_edit_id").value.trim() || uid(),
      no: $("i_no").value.trim() || this.nextInvoiceNo(),
      date: $("i_date").value || todayISO(),
      von: $("i_von").value || "",
      bis: $("i_bis").value || "",
      due: $("i_due").value || "",
      status: $("i_status").value || "Entwurf",
      customerId: $("i_customer").value || "",
      auto: {
        days: num($("w_days").value),
        hpd: num($("w_hpd").value),
        rate: num($("w_rate").value),
        hours: num($("w_total_hours").value)
      },
      lines: this.getLines()
    };
    // minimal validation
    if(!inv.customerId) return Toast.show("Kunde w√§hlen.");
    if(inv.lines.length===0) return Toast.show("Position fehlt.");

    // upsert
    const idx=Store.data.invoices.findIndex(x=>x.id===inv.id);
    if(idx>=0) Store.data.invoices[idx]=inv;
    else Store.data.invoices.unshift(inv);

    $("i_edit_id").value=inv.id;
    $("i_no").value=inv.no;
    Store.save(true);
    UI.renderInvoicesList();
    Toast.show("Rechnung gespeichert ‚úÖ");
  },

  load(id){
    const inv=Store.data.invoices.find(x=>x.id===id);
    if(!inv) return;
    UI.go("invoices");
    $("i_edit_id").value=inv.id;
    $("i_no").value=inv.no||"";
    $("i_date").value=inv.date||todayISO();
    $("i_von").value=inv.von||"";
    $("i_bis").value=inv.bis||"";
    $("i_due").value=inv.due||"";
    $("i_status").value=inv.status||"Entwurf";
    $("i_customer").value=inv.customerId||"";

    $("w_days").value=inv.auto?.days??"";
    $("w_hpd").value=inv.auto?.hpd??"";
    $("w_rate").value=inv.auto?.rate??"";
    $("w_total_hours").value=inv.auto?.hours??"";

    $("linesBody").innerHTML="";
    for(const l of (inv.lines||[])){
      this.addLine({desc:l.desc, qty:l.qty, price:l.price});
    }
    this.refreshTotals();
    Toast.show("Rechnung geladen.");
  },

  del(id){
    if(!confirm("Rechnung l√∂schen?")) return;
    Store.data.invoices=Store.data.invoices.filter(x=>x.id!==id);
    Store.save(true);
    UI.renderInvoicesList();
    Toast.show("Gel√∂scht.");
  },

  print(){
    const invId=$("i_edit_id").value.trim();
    if(!invId) return Toast.show("Erst Speichern.");
    const inv=Store.data.invoices.find(x=>x.id===invId);
    if(!inv) return Toast.show("Rechnung nicht gefunden.");

    const s=Store.data.settings;
    const c=Store.data.customers.find(x=>x.id===inv.customerId);

    const lines=inv.lines||[];
    const sum = round2(lines.reduce((a,b)=>a+num(b.net??(num(b.qty)*num(b.price))),0));

    const customerBlock = `
      <div class="pbox">
        <div class="psmall"><b>Rechnung an:</b></div>
        <div><b>${escapeHtml(c?.name||"")}</b></div>
        <div class="psmall">${escapeHtml(c?.addr||"").replace(/\n/g,"<br>")}</div>
        <div class="psmall">${c?.email?`E-Mail: <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a>`:""}</div>
      </div>
    `;

    const period = (inv.von && inv.bis) ? `${inv.von} ‚Äì ${inv.bis}` : "‚Äî";
    const phtml = `
      <div class="pdoc">
        <div class="phead">
          <div>
            <h1>Rechnung</h1>
            <div class="pmeta"><b>${escapeHtml(s.company||"")}</b></div>
            <div class="psub">${escapeHtml(s.addr||"").replace(/\n/g,"<br>")}</div>
            <div class="psub">E-Mail: <a href="mailto:${escapeHtml(s.email||"")}">${escapeHtml(s.email||"")}</a></div>
            ${s.phone?`<div class="psub">Tel: <a href="tel:${escapeHtml((s.phone||"").replace(/\s+/g,""))}">${escapeHtml(s.phone||"")}</a></div>`:""}
            ${s.taxid?`<div class="psub">Steuer: ${escapeHtml(s.taxid)}</div>`:""}
          </div>
          <div class="pmeta">
            <div><b>Rechnungs-Nr.:</b> ${escapeHtml(inv.no||"")}</div>
...

[Message clipped]  View entire message

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security â€” Dienstplan</title>
  <meta name="theme-color" content="#0b4ea2"/>

  <style>
    :root{
      --bg1:#041a34; --bg2:#0b4ea2;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.16);
      --text:#fff;
      --muted:rgba(255,255,255,.78);
      --accent:#2aa8ff;
      --good:#27d6a6;
      --warn:#ffd166;
      --bad:#ff5b7a;
      --r:18px;
      --shadow: 0 16px 45px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(42,168,255,.25), transparent 55%),
        radial-gradient(1000px 650px at 90% 10%, rgba(87,179,255,.18), transparent 55%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:24px auto;padding:0 14px}
    .topbar{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 16px;
      box-shadow:var(--shadow);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logoBadge{
      width:48px;height:48px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logoBadge img{width:100%;height:100%;object-fit:cover;display:none}
    .logoFallback{font-weight:900;letter-spacing:.6px;color:#fff;font-size:14px}
    .brandTitle{line-height:1.2}
    .brandTitle b{font-size:15px;letter-spacing:.5px;text-transform:uppercase}
    .brandTitle small{display:block;color:var(--muted);font-size:12px;margin-top:4px}
    .tabs{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tabBtn{
      appearance:none;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:800;
    }
    .tabBtn.active{background:rgba(42,168,255,.22);border-color:rgba(42,168,255,.6)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:900;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.primary{background:rgba(42,168,255,.22);border-color:rgba(42,168,255,.65)}
    .btn.good{background:rgba(39,214,166,.18);border-color:rgba(39,214,166,.55)}
    .btn.warn{background:rgba(255,209,102,.18);border-color:rgba(255,209,102,.55);color:#0b1630}
    .btn.bad{background:rgba(255,91,122,.18);border-color:rgba(255,91,122,.55)}
    .grid{margin-top:14px;display:grid;gap:14px;grid-template-columns:1.05fr .95fr}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:640px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:105px;resize:vertical}
    input::placeholder,textarea::placeholder{color:rgba(255,255,255,.6)}
    .wkDays{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .dayChip{
      user-select:none;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:9px 11px;border-radius:999px;
      font-weight:900;cursor:pointer;
    }
    .dayChip.on{background:rgba(42,168,255,.22);border-color:rgba(42,168,255,.6)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:16px}
    th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:10px 10px;font-size:13px;text-align:left;vertical-align:top}
    th{font-size:12px;color:rgba(255,255,255,.85);text-transform:uppercase;letter-spacing:.4px}
    tr:last-child td{border-bottom:none}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.14);font-weight:900;font-size:12px}
    .muted{color:var(--muted)}
    .noteBox{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      padding:12px;border-radius:16px;
      line-height:1.45;font-size:13px;color:rgba(255,255,255,.92);
    }
    .doc{display:none}
    .doc.active{display:block}
    .kbd{display:inline-block;padding:2px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.16);font-weight:900;font-size:12px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logoBadge" id="logoBadge">
        <img id="appLogoImg" alt="Logo">
        <span id="logoFallback" class="logoFallback">MS</span>
      </div>
      <div class="brandTitle">
        <b id="companyNameHdr">Masculine Security â€” Dienstplan</b>
        <small>
          <span id="companyAddrHdr">WerschenregerstraÃŸe 6, 28237 Bremen</span> â€¢
          Tel: <span id="companyPhoneHdr">015778697052</span><br/>
          E-Mail: <span id="companyEmailHdr">Kontakt.mass.bremen@hotmail.com</span>
        </small>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabPlan" type="button">Wochenplan</button>
      <button class="tabBtn" id="tabDoc" type="button">Dokumentation</button>
    </div>

    <div class="actions">
      <button class="btn bad" id="btnReset" type="button">Reset</button>
      <button class="btn good" id="btnSaveEntry" type="button">Eintrag speichern</button>
      <button class="btn primary" id="btnPdf" type="button">PDF</button>
      <button class="btn warn" id="btnWhatsPdf" type="button">WhatsApp (PDF)</button>
    </div>
  </div>

  <!-- PLAN -->
  <div id="planView" class="grid">
    <div class="card">
      <h2>WÃ¶chentlicher Mitarbeiter-Dienstplan</h2>

      <div class="row">
        <div>
          <label>Mitarbeiter Name</label>
          <input id="empName" placeholder="z.B. Mustafa" autocomplete="off">
        </div>
        <div>
          <label>Mitarbeiter-Nr (optional)</label>
          <input id="empNr" placeholder="z.B. MS-001" autocomplete="off">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Objekt / Einsatz</label>
          <input id="objekt" placeholder="z.B. Hotel / Baustelle / Asylheim" autocomplete="off">
        </div>
        <div>
          <label>Logo (optional) â€” fÃ¼r App & PDF</label>
          <input type="file" id="logoFile" accept="image/*">
          <div class="muted" style="font-size:12px;margin-top:6px">Logo wird gespeichert und immer angezeigt.</div>
        </div>
      </div>

      <div class="hr"></div>

      <label>Arbeitstage (klicken)</label>
      <div class="wkDays" id="daysWrap"></div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Schicht (Tag/Nacht) â€” automatisch</label>
          <select id="shift" disabled>
            <option value="Tag">Tag</option>
            <option value="Nacht">Nacht</option>
          </select>
          <div class="muted" style="font-size:12px;margin-top:6px">Regel: Tag=07:00â€“19:00, Nacht=19:00â€“07:00</div>
        </div>
        <div>
          <label>Uhrzeit â€” automatisch</label>
          <input id="time" readonly>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Datum (fÃ¼r PDF)</label>
          <input id="pdfDate" placeholder="16.02.2026" autocomplete="off">
          <div class="muted" style="font-size:12px;margin-top:6px">Format: <span class="kbd">TT.MM.JJJJ</span></div>
        </div>
        <div>
          <label>Notiz â€” automatisch</label>
          <input id="note" placeholder="z.B. Rundgang / SchlÃ¼ssel" autocomplete="off">
          <div class="muted" style="font-size:12px;margin-top:6px">Wenn leer: Notiz wird automatisch gesetzt.</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="noteBox">
        <b>Hinweis:</b> Browser kann WhatsApp <u>kein PDF automatisch anhÃ¤ngen</u> (Sicherheit).<br>
        Button macht: <b>PDF Download</b> + <b>WhatsApp Chat Ã¶ffnen</b> + Text fertig.<br>
        âžœ Du fÃ¼gst nur noch die Datei im Chat an (ðŸ“Ž).
      </div>
    </div>

    <div class="card">
      <h2>Vorschau + Gespeicherte EintrÃ¤ge</h2>

      <label>Vorschau (WhatsApp Text)</label>
      <textarea id="preview" readonly></textarea>

      <div class="hr"></div>

      <table>
        <thead>
          <tr>
            <th>Mitarbeiter</th>
            <th>Tage</th>
            <th>Objekt</th>
            <th>Schicht</th>
            <th>Uhrzeit</th>
            <th>Notiz</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Noch keine EintrÃ¤ge.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- DOC -->
  <div id="docView" class="card doc">
    <h2>Dokumentation</h2>

    <div class="noteBox">
      <b>1) Dienstplan erstellen</b>
      <ol style="margin:8px 0 0;padding-left:18px">
        <li>Mitarbeiter + Objekt eingeben.</li>
        <li>Arbeitstage anklicken (Moâ€“So).</li>
        <li>Schicht & Uhrzeit sind automatisch.</li>
        <li>Notiz wird automatisch gesetzt (du kannst Ã¤ndern).</li>
        <li><b>Eintrag speichern</b> drÃ¼cken.</li>
      </ol>
    </div>

    <div class="hr"></div>

    <div class="noteBox">
      <b>2) PDF speichern</b>
      <ol style="margin:8px 0 0;padding-left:18px">
        <li>Button <b>PDF</b> â†’ PDF wird als Datei gespeichert.</li>
        <li>Optional: Druck (Print) Ã¼ber PDF Viewer.</li>
      </ol>
    </div>

    <div class="hr"></div>

    <div class="noteBox">
      <b>3) WhatsApp PDF senden</b>
      <ol style="margin:8px 0 0;padding-left:18px">
        <li>Button <b>WhatsApp (PDF)</b> drÃ¼cken.</li>
        <li>PDF wird gespeichert (Downloads).</li>
        <li>WhatsApp Ã¶ffnet sich mit Text.</li>
        <li>Im Chat â†’ ðŸ“Ž â†’ Dokument â†’ PDF auswÃ¤hlen â†’ Senden.</li>
      </ol>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const STORE_KEY = "ms_dienstplan_single_v1";
const META_KEY  = "ms_meta_single_v1";

const COMPANY = {
  name: "Masculine Security",
  address: "WerschenregerstraÃŸe 6, 28237 Bremen",
  phone: "015778697052",
  email: "Kontakt.mass.bremen@hotmail.com"
};

const DAYS = [
  {k:"Mo", label:"Montag"},
  {k:"Di", label:"Dienstag"},
  {k:"Mi", label:"Mittwoch"},
  {k:"Do", label:"Donnerstag"},
  {k:"Fr", label:"Freitag"},
  {k:"Sa", label:"Samstag"},
  {k:"So", label:"Sonntag"},
];

const SHIFT_TIMES = {
  Tag: "07:00â€“19:00",
  Nacht: "19:00â€“07:00"
};

let meta = {
  logoDataUrl: ""
};

let state = {
  entries: [],
  selectedDays: new Set(["Mo","Di","Mi","Do"])
};

const $ = (id)=>document.getElementById(id);
const norm = (s)=>String(s||"").trim().replace(/\s+/g," ");
function todayDE(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function escHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeParse(x,fallback){ try{return JSON.parse(x);}catch{return fallback;}}

function saveAll(){
  localStorage.setItem(STORE_KEY, JSON.stringify({ entries: state.entries }));
  localStorage.setItem(META_KEY, JSON.stringify(meta));
}
function loadAll(){
  const s = safeParse(localStorage.getItem(STORE_KEY), null);
  const m = safeParse(localStorage.getItem(META_KEY), null);
  if(s?.entries) state.entries = s.entries;
  if(m) meta = {...meta, ...m};
}

/* =========================
   LOGO (always visible)
========================= */
function setLogo(src){
  const img = $("appLogoImg");
  const fb  = $("logoFallback");
  if(!img || !fb) return;

  img.onload = ()=>{ img.style.display="block"; fb.style.display="none"; };
  img.onerror = ()=>{ img.style.display="none"; fb.style.display="block"; };

  img.src = src;
}
function initLogo(){
  if(meta.logoDataUrl){
    setLogo(meta.logoDataUrl);
  }else{
    // fallback to "MS" (no external files needed)
    setLogo("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==");
  }
}

/* =========================
   DAYS UI
========================= */
function renderDays(){
  const wrap = $("daysWrap");
  wrap.innerHTML = "";
  for(const d of DAYS){
    const b = document.createElement("button");
    b.type="button";
    b.className = "dayChip" + (state.selectedDays.has(d.k) ? " on" : "");
    b.textContent = d.k;
    b.title = d.label;
    b.addEventListener("click", ()=>{
      if(state.selectedDays.has(d.k)) state.selectedDays.delete(d.k);
      else state.selectedDays.add(d.k);
      renderDays();
      autoShiftTimeNote();
      buildPreview();
    });
    wrap.appendChild(b);
  }
}

/* =========================
   AUTO RULES
========================= */
function autoShiftByObjekt(obj){
  const t = norm(obj).toLowerCase();
  // Nacht keywords
  if(/nacht|night|hotel|heim|asyl|unterkunft/.test(t)) return "Nacht";
  return "Tag";
}
function autoNoteByObjekt(obj){
  const t = norm(obj).toLowerCase();
  if(!t) return "Rundgang / SchlÃ¼ssel";
  if(/hotel|hostel|pension/.test(t)) return "Rundgang / SchlÃ¼ssel";
  if(/baustelle|construction/.test(t)) return "Tor / Kontrolle / Sicherheit";
  if(/asyl|heim|unterkunft/.test(t)) return "Eingang / Kontrolle / Rundgang";
  return "Rundgang / SchlÃ¼ssel";
}
function autoShiftTimeNote(){
  const obj = $("objekt").value;
  const shift = autoShiftByObjekt(obj);
  $("shift").value = shift;
  $("time").value = SHIFT_TIMES[shift];

  if(!norm($("note").value)){
    $("note").value = autoNoteByObjekt(obj);
  }
}

/* =========================
   PREVIEW + TABLE
========================= */
function buildWhatsAppText(entry){
  const date = norm($("pdfDate").value) || todayDE();
  return `${COMPANY.name} â€” Dienstplan
Datum: ${date}

Mitarbeiter: ${entry.empName}${entry.empNr ? " ("+entry.empNr+")" : ""}
Tage: ${entry.days.join(", ")}
Objekt: ${entry.objekt}
Schicht: ${entry.shift} | Uhrzeit: ${entry.time}
Notiz: ${entry.note}

Kontakt: ${COMPANY.phone} | ${COMPANY.email}`;
}
function buildPreview(){
  const empName = norm($("empName").value) || "Mitarbeiter";
  const empNr   = norm($("empNr").value);
  const objekt  = norm($("objekt").value) || "Objekt";
  autoShiftTimeNote();
  const shift = $("shift").value;
  const time  = $("time").value;
  const note  = norm($("note").value) || "â€”";
  const days  = Array.from(state.selectedDays);

  const entry = { empName, empNr, objekt, days, shift, time, note };
  $("preview").value = buildWhatsAppText(entry);
}
function renderTable(){
  const tb = $("tbody");
  tb.innerHTML = "";
  if(!state.entries.length){
    tb.innerHTML = '<tr><td colspan="7" class="muted">Noch keine EintrÃ¤ge.</td></tr>';
    return;
  }
  state.entries.forEach((e, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escHtml(e.empName)}${e.empNr?`<div class="muted">${escHtml(e.empNr)}</div>`:""}</td>
      <td>${escHtml(e.days.join(", "))}</td>
      <td>${escHtml(e.objekt)}</td>
      <td><span class="tag">${escHtml(e.shift)}</span></td>
      <td>${escHtml(e.time)}</td>
      <td>${escHtml(e.note)}</td>
      <td><button class="btn bad" data-del="${i}" type="button">Delete</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-del");
      state.entries.splice(i,1);
      saveAll();
      renderTable();
      buildPreview();
    });
  });
}

/* =========================
   SAVE ENTRY
========================= */
function saveEntry(){
  const empName = norm($("empName").value);
  const objekt  = norm($("objekt").value);
  if(!empName){ alert("Bitte Mitarbeiter Name eingeben."); return; }
  if(!objekt){ alert("Bitte Objekt / Einsatz eingeben."); return; }
  const days = Array.from(state.selectedDays);
  if(!days.length){ alert("Bitte mindestens einen Arbeitstag anklicken (Moâ€“So)."); return; }

  autoShiftTimeNote();
  const entry = {
    empName,
    empNr: norm($("empNr").value),
    objekt,
    days,
    shift: $("shift").value,
    time: $("time").value,
    note: norm($("note").value) || "â€”"
  };
  state.entries.push(entry);
  saveAll();
  renderTable();
  $("preview").value = buildWhatsAppText(entry);
  alert("Gespeichert âœ…");
}

/* =========================
   PDF (REAL FILE DOWNLOAD)
========================= */
function buildPdfHtml(){
  const date = norm($("pdfDate").value) || todayDE();
  const logo = meta.logoDataUrl
    ? `<img src="${meta.logoDataUrl}" style="width:52px;height:52px;border-radius:10px;object-fit:cover;border:1px solid #cfe2ff">`
    : `<div style="width:52px;height:52px;border-radius:10px;background:#0b4ea2;color:#fff;display:grid;place-items:center;font-weight:900">MS</div>`;

  // Table rows by day from saved entries
  const byDay = new Map(DAYS.map(d=>[d.k, []]));
  for(const e of state.entries){
    for(const d of e.days){
      if(byDay.has(d)) byDay.get(d).push(e);
    }
  }
  const rows = DAYS.map(d=>{
    const list = byDay.get(d.k) || [];
    if(!list.length){
      return `<tr><td>${d.k}</td><td>â€”</td><td>â€”</td><td>â€”</td></tr>`;
    }
    // show first + extras
    const first = list[0];
    let html = `<tr><td>${d.k}</td><td>${escHtml(first.time)}</td><td>${escHtml(first.objekt)}</td><td>${escHtml(first.note)}</td></tr>`;
    for(let i=1;i<list.length;i++){
      const x = list[i];
      html += `<tr style="background:#f7fbff;color:#204569"><td>${d.k}</td><td>${escHtml(x.time)}</td><td>${escHtml(x.objekt)}</td><td>${escHtml(x.note)}</td></tr>`;
    }
    return html;
  }).join("");

  return `<!doctype html>
<html><head><meta charset="utf-8"><title>Dienstplan ${escHtml(date)}</title>
<style>
@page{size:A4;margin:16mm}
body{font-family:Arial,Helvetica,sans-serif;color:#0a1b2e}
.head{border:2px solid #1f6fd8;border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:14px}
.title{font-size:18px;font-weight:900;color:#0b4ea2;margin:0}
.sub{font-size:12px;color:#204569;line-height:1.35}
.date{margin-left:auto;font-size:12px;color:#204569}
.sep{height:3px;background:#1f6fd8;margin:14px 0 10px;border-radius:999px;opacity:.75}
.center{ text-align:center;font-size:18px;font-weight:900;color:#0b4ea2;margin:0 0 10px}
table{width:100%;border-collapse:collapse;font-size:12.5px}
th,td{border:1px solid #d7e6ff;padding:8px}
th{background:#eaf3ff;color:#0b4ea2;text-transform:uppercase;letter-spacing:.4px;font-size:11px}
.warnTitle{text-align:center;font-weight:900;color:#c0162b;margin:14px 0 6px;font-size:12px}
.warnText{text-align:center;font-size:11px;color:#203044;line-height:1.35}
.foot{margin-top:10px;font-size:10px;color:#5a6b7b;display:flex;justify-content:space-between}
</style></head>
<body>
  <div class="head">
    ${logo}
    <div>
      <div class="title">${escHtml(COMPANY.name)}</div>
      <div class="sub">
        Adresse: ${escHtml(COMPANY.address)}<br>
        Tel: ${escHtml(COMPANY.phone)}<br>
        E-Mail: ${escHtml(COMPANY.email)}
      </div>
    </div>
    <div class="date"><b>Datum:</b> ${escHtml(date)}</div>
  </div>

  <div class="sep"></div>
  <div class="center">VorlÃ¤ufiger Dienstplan</div>

  <table>
    <thead><tr><th>TAG</th><th>UHRZEIT</th><th>OBJEKT</th><th>NOTIZ</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>

  <div class="warnTitle">DRINGEND BEACHTEN:</div>
  <div class="warnText">
    Dienstantritt ist 20 Minuten vor Dienstbeginn!<br>
    VerspÃ¤tungen und AusfÃ¤lle sind unverzÃ¼glich telefonisch zu melden!<br>
    Stundenzettel spÃ¤testens 2 Tage vor Monatsende einreichen.
  </div>

  <div class="foot"><div>${escHtml(COMPANY.name)} â€” Dienstplan</div><div>Seite 1 von 1</div></div>
</body></html>`;
}

function downloadPdf(){
  if(!state.entries.length){
    alert("Bitte zuerst mindestens einen Eintrag speichern.");
    return null;
  }
  const date = (norm($("pdfDate").value) || todayDE()).replaceAll(".","-");
  const fileName = `Dienstplan_${date}.html`; // browser-safe download
  const blob = new Blob([buildPdfHtml()], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
  return fileName;
}

function openPrint(){
  if(!state.entries.length){
    alert("Bitte zuerst mindestens einen Eintrag speichern.");
    return;
  }
  const w = window.open("", "_blank", "noopener,noreferrer");
  if(!w){
    alert("Popup blockiert. Bitte Popups erlauben und nochmal klicken.");
    return;
  }
  w.document.open();
  w.document.write(buildPdfHtml());
  w.document.close();
  setTimeout(()=>{ try{ w.focus(); w.print(); }catch{} }, 350);
}

/* =========================
   WHATSAPP FLOW
========================= */
function openWhatsApp(text){
  // Works on desktop + mobile
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  const w = window.open(url, "_blank", "noopener,noreferrer");
  if(!w){
    alert("Popup blockiert. Popups erlauben, dann nochmal WhatsApp drÃ¼cken.");
  }
}
function whatsappPdfFlow(){
  const fileName = downloadPdf();
  if(!fileName) return;
  const msg =
`${$("preview").value}

âœ… Datei wurde gespeichert: ${fileName}
âž¡ï¸ WhatsApp: ðŸ“Ž â†’ Dokument â†’ ${fileName} auswÃ¤hlen â†’ Senden.`;
  setTimeout(()=>openWhatsApp(msg), 700);
}

/* =========================
   EVENTS + TABS
========================= */
function bind(){
  // tabs
  $("tabPlan").addEventListener("click", ()=>{
    $("tabPlan").classList.add("active");
    $("tabDoc").classList.remove("active");
    $("planView").style.display = "";
    $("docView").classList.remove("active");
  });
  $("tabDoc").addEventListener("click", ()=>{
    $("tabDoc").classList.add("active");
    $("tabPlan").classList.remove("active");
    $("planView").style.display = "none";
    $("docView").classList.add("active");
  });

  // inputs
  ["empName","empNr","objekt","note","pdfDate"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      autoShiftTimeNote();
      buildPreview();
      saveAll();
    });
  });

  $("btnSaveEntry").addEventListener("click", saveEntry);
  $("btnPdf").addEventListener("click", ()=>{
    // real download + also offer print
    downloadPdf();
    openPrint();
  });
  $("btnWhatsPdf").addEventListener("click", whatsappPdfFlow);

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Reset? Alle gespeicherten Daten werden gelÃ¶scht.")) return;
    localStorage.removeItem(STORE_KEY);
    localStorage.removeItem(META_KEY);
    location.reload();
  });

  $("logoFile").addEventListener("change", async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const dataUrl = await new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result));
      r.onerror = ()=>rej(new Error("read error"));
      r.readAsDataURL(f);
    });
    meta.logoDataUrl = dataUrl;
    saveAll();
    setLogo(meta.logoDataUrl);
    alert("Logo gespeichert âœ…");
  });
}

/* =========================
   BOOT
========================= */
(function init(){
  // header
  $("companyNameHdr").textContent = `${COMPANY.name} â€” Dienstplan`;
  $("companyAddrHdr").textContent = COMPANY.address;
  $("companyPhoneHdr").textContent = COMPANY.phone;
  $("companyEmailHdr").textContent = COMPANY.email;

  // date default
  $("pdfDate").value = todayDE();

  loadAll();
  initLogo();
  renderDays();
  renderTable();
  autoShiftTimeNote();
  buildPreview();
  bind();
})();
</script>
</body>
</html>

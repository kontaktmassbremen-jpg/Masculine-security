<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security ‚Äî Mini Office (Rechnung + Payroll)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --card:#10203a; --line:#1a2a4b;
      --text:#e7eeff; --muted:#93a4c6; --accent:#3aa6ff; --good:#2bd4bd; --bad:#ff4d6d;
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
    }
    a{color:inherit;text-decoration:underline}
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin:0 auto;
    }
    .sidebar{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      padding:14px;
      position:sticky; top:14px;
      height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      color:#07101f;
      background: linear-gradient(135deg, rgba(58,166,255,.95), rgba(43,212,189,.95));
      box-shadow: 0 10px 30px rgba(58,166,255,.18);
    }
    .brand h1{margin:0; font-size:14px; line-height:1.2}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(58,166,255,.35);
      background: rgba(58,166,255,.08);
    }
    .nav button.active{
      border-color: rgba(58,166,255,.55);
      background: rgba(58,166,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }
    .foot{
      margin-top:auto;
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }

    .main{
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 32px);
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:900;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .grid2eq{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    .card{
      background: rgba(16,32,58,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px}

    .muted{color:var(--muted)}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px; border:1px solid rgba(255,255,255,.06)}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .hide{display:none!important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}
    .note{
      border:1px dashed rgba(58,166,255,.45);
      background: rgba(58,166,255,.08);
      padding:12px; border-radius: 12px;
      font-size:13px;
    }
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 520px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,41,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      color: var(--text);
      z-index: 9999;
      display:none;
    }
    .statusbar{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      padding:6px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);display:inline-block}
    .dot.off{background:rgba(255,255,255,.25)}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid2eq{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>

<!-- VERSION STAMP -->
<div style="position:fixed;left:10px;bottom:10px;z-index:99999;background:#000a;color:#fff;padding:6px 10px;border-radius:10px;font:12px Arial">
  v7-unified-pdf-no-bottom-text
</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">MS</div>
      <div>
        <h1 id="brandTitle">Masculine Security</h1>
        <small>Rechnung ‚Ä¢ Kunden ‚Ä¢ Mitarbeiter ‚Ä¢ Payroll</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="invoices" class="active"><span>üßæ Rechnung</span><span class="pill" id="pillInvoices">0</span></button>
      <button data-page="customers"><span>üë§ Kunden</span><span class="pill" id="pillCustomers">0</span></button>
      <button data-page="employees"><span>üßë‚Äçüíº Mitarbeiter</span><span class="pill" id="pillEmployees">0</span></button>
      <button data-page="payroll"><span>üí∂ Payroll</span><span class="pill" id="pillPayroll">PDF</span></button>
      <button data-page="settings"><span>‚öôÔ∏è Firma</span><span class="pill" id="pillStore">Auto</span></button>
    </div>

    <div class="foot">
      <div><b>Hinweis:</b> ¬ß19 UStG (Kleinunternehmer) ‚Üí USt = 0.</div>
      <div class="muted">Update nicht sichtbar? √ñffne Link mit <b>?v=999</b> oder Incognito.</div>
      <div class="muted">Backup: Export JSON.</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">Rechnung</h2>
        <small id="pageSub" class="muted">Auto Save ‚Ä¢ PDF (A4)</small>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnNewInvoice">+ Neue Rechnung</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" class="hide"/>
        <button class="btn danger" id="btnWipe">Alles l√∂schen</button>
      </div>
    </div>

    <div class="content">
      <!-- INVOICES -->
      <section id="page-invoices">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen / bearbeiten</h3>

            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="MS-2026-0001"/></div>
              <div class="field"><label>Rechnungsdatum</label><input id="i_date" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Von</label><input id="i_von" type="date"/></div>
              <div class="field"><label>Bis</label><input id="i_bis" type="date"/></div>
            </div>

            <div class="split">
              <div class="field"><label>F√§llig am</label><input id="i_due" type="date"/></div>
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <div class="field"><label>Kunde</label>
              <select id="i_customer"></select>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px 0">Auto Stunden (optional)</h3>
            <div class="split">
              <div class="field"><label>Tage (inta bari)</label><input id="w_days" type="number" step="1" placeholder="z.B. 18"/></div>
              <div class="field"><label>Std/Tag (saacado maalintii)</label><input id="w_hpd" type="number" step="0.25" placeholder="z.B. 12"/></div>
            </div>
            <div class="split">
              <div class="field"><label>‚Ç¨/h (qiime saacaddii)</label><input id="w_rate" type="number" step="0.01" placeholder="z.B. 16"/></div>
              <div class="field"><label>Total Stunden (auto)</label><input id="w_total_hours" readonly/></div>
            </div>
            <div class="note" id="w_note">
              Tage + Std/Tag + ‚Ç¨/h ‚Üí Position 1 wird automatisch gef√ºllt (Menge = Stunden, Preis = ‚Ç¨/h).
            </div>

            <div class="hr"></div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <h3 style="margin:0">Positionen</h3>
              <button class="btn" id="btnAddLine">+ Position</button>
            </div>

            <table class="table" style="margin-top:10px">
              <thead>
                <tr>
                  <th>Beschreibung</th>
                  <th class="right">Menge</th>
                  <th class="right">Preis</th>
                  <th class="right">Netto</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>

            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Summe Netto (auto)</label><input id="sum_net" readonly/></div>
              <div class="field"><label>Zu zahlen (auto)</label><input id="sum_total" readonly/></div>
            </div>

            <div class="note" id="i_preview">Positionen: 0 ‚Ä¢ Gesamt: 0,00 ‚Ç¨ ‚Ä¢ USt: 0,00 ‚Ç¨</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSaveInvoice">Speichern</button>
              <button class="btn" id="btnPrintInvoice">PDF Rechnung (A4)</button>
            </div>

            <input id="i_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Rechnungen Liste</h3>

            <div class="split">
              <div class="field"><label>Suche</label><input id="inv_search" placeholder="Nr / Kunde / Status"/></div>
              <div class="field"><label>Status Filter</label>
                <select id="inv_filter">
                  <option value="">Alle</option>
                  <option>Entwurf</option>
                  <option>Gesendet</option>
                  <option>Bezahlt</option>
                </select>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Nr.</th>
                  <th>Kunde</th>
                  <th>Status</th>
                  <th class="right">Total</th>
                  <th class="right">Aktion</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px 0">Firma Links (clickable)</h3>
            <div class="note" id="firmaLinksBox">‚Äî</div>
            <div class="hr"></div>
            <h3 style="margin:0 0 8px 0">Kunde Links (clickable)</h3>
            <div class="note" id="customerLinksBox">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde anlegen</h3>
            <div class="field"><label>Suche</label><input id="c_search" placeholder="Suche name/email..."/></div>
            <div class="hr"></div>

            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel GmbH"/></div>
            <div class="split">
              <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="c_phone" placeholder="+49 ..."/></div>
            </div>
            <div class="field"><label>Adresse</label><textarea id="c_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCustomerSave">Speichern</button>
              <button class="btn danger" id="btnCustomerClear">Leeren</button>
            </div>
          </div>

          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLOYEES -->
      <section id="page-employees" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Mitarbeiter anlegen</h3>
            <div class="field"><label>Suche</label><input id="m_search" placeholder="Name / Steuer-ID / PersNr"/></div>
            <div class="hr"></div>

            <div class="split">
              <div class="field"><label>Name</label><input id="m_name" placeholder="Vorname Nachname"/></div>
              <div class="field"><label>Pers.-Nr.</label><input id="m_persnr" placeholder="z.B. 4943"/></div>
            </div>

            <div class="field"><label>Adresse (optional)</label><textarea id="m_addr" placeholder="Stra√üe, PLZ Ort"></textarea></div>

            <div class="split">
              <div class="field"><label>Steuer-ID (IdNr.)</label><input id="m_taxid" placeholder="optional"/></div>
              <div class="field"><label>Steuerklasse</label>
                <select id="m_taxclass">
                  <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
                </select>
              </div>
            </div>

            <div class="split">
              <div class="field"><label>Familienstand</label>
                <select id="m_family">
                  <option value="single">single</option>
                  <option value="married">verheiratet</option>
                </select>
              </div>
              <div class="field"><label>Kinder (Anzahl)</label><input id="m_children" type="number" step="1" min="0" placeholder="0"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Krankenkasse (AOK/Barmer/...)</label><input id="m_kasse" placeholder="z.B. AOK"/></div>
              <div class="field"><label>Kassen-Nr. (optional)</label><input id="m_kasse_no" placeholder="z.B. 3424434"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Versicherungsnummer (optional)</label><input id="m_versnr" placeholder="SV-Nr. (optional)"/></div>
              <div class="field"><label>‚Ç¨/h (Standard)</label><input id="m_rate" type="number" step="0.01" placeholder="z.B. 14.00"/></div>
            </div>

            <div class="field"><label>SV aktiv?</label>
              <select id="m_sv">
                <option value="yes">Ja</option>
                <option value="no">Nein</option>
              </select>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnEmployeeSave">Speichern</button>
              <button class="btn danger" id="btnEmployeeClear">Leeren</button>
            </div>

            <input id="m_edit_id" class="hide"/>
          </div>

          <div class="card">
            <h3>Mitarbeiterliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>PersNr</th><th>Kasse</th><th>Klasse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="employeesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Payroll (Simulation) ‚Üí PDF</h3>

            <div class="field"><label>Mitarbeiter</label>
              <select id="p_emp"></select>
            </div>

            <div class="split">
              <div class="field"><label>Monat (YYYY-MM)</label><input id="p_month" placeholder="2026-02"/></div>
              <div class="field"><label>Pers.-Nr. (override)</label><input id="p_persnr" placeholder="optional"/></div>
            </div>

            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.25" placeholder="z.B. 216"/></div>
              <div class="field"><label>‚Ç¨/h</label><input id="p_rate" type="number" step="0.01" placeholder="auto aus Mitarbeiter"/></div>
            </div>

            <div class="hr"></div>

            <table class="table">
              <thead><tr><th>Item</th><th class="right">Betrag</th></tr></thead>
              <tbody id="payTable"></tbody>
            </table>

            <div class="hr"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnCalcPayroll">Berechnen</button>
              <button class="btn" id="btnPDFLohn">Lohnabrechnung (A4)</button>
              <button class="btn" id="btnPDFAArbeit">Arbeitbescheinigung (A4)</button>
              <button class="btn" id="btnPDFLSt">Lohnsteuerbescheinigung (A4)</button>
            </div>
          </div>

          <div class="card">
            <h3>Firma Links (CLICKABLE)</h3>
            <div class="note" id="firmaLinksBox2">‚Äî</div>
            <div class="hr"></div>
            <h3>Hinweis</h3>
            <div class="note">
              PDFs werden im Browser via Print ge√∂ffnet.<br/>
              Email/Telefon/Web sind clickable im PDF (mailto/tel/https).
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firma Einstellungen</h3>
            <div class="field"><label>Firma / Name</label><input id="s_company"/></div>
            <div class="field"><label>Adresse</label><textarea id="s_addr"></textarea></div>

            <div class="split">
              <div class="field"><label>Email</label><input id="s_email"/></div>
              <div class="field"><label>Telefon (optional)</label><input id="s_phone" placeholder="+49 ..."/></div>
            </div>

            <div class="split">
              <div class="field"><label>Website (optional)</label><input id="s_website" placeholder="https://..."/></div>
              <div class="field"><label>Steuernummer/ID (Firma)</label><input id="s_taxid" placeholder="z.B. 12/345/67890"/></div>
            </div>

            <div class="split">
              <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE..."/></div>
              <div class="field"><label>BIC</label><input id="s_bic" placeholder="NTSBDEB1XXX"/></div>
            </div>

            <div class="field"><label>¬ß19 Hinweis</label><input id="s_hint"/></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="btnSettingsSave">Speichern</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div class="note" id="storageNote">Storage: ...</div>
            <div class="hr"></div>
            <h3>Firma Links (clickable)</h3>
            <div class="note" id="firmaLinksBox3">‚Äî</div>
          </div>
        </div>
      </section>
    </div>

    <div class="statusbar">
      <span class="dot" id="dot"></span>
      <span id="statusText">Bereit</span>
      <span class="tag" id="storeTag">Storage</span>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   IMPORTANT FIX: Disable Service Worker + clear caches
============================================================ */
(async () => {
  try{
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();

/* =========================
   Utils
========================= */
const $ = (id)=>document.getElementById(id);
const DB_KEY = "ms_office_v7_unified_pdf_no_bottom_text";

const Toast = {
  t:null,
  show(msg){
    const el=$("toast");
    el.textContent=msg;
    el.style.display="block";
    clearTimeout(this.t);
    this.t=setTimeout(()=>{el.style.display="none";}, 2400);
  }
};

function storageWorks(which){
  try{ const k="__ms_test__"+Math.random(); which.setItem(k,"1"); which.removeItem(k); return true; }
  catch(e){ return false; }
}
const StorageDriver = (()=>{
  const canLocal = storageWorks(window.localStorage);
  const canSession = storageWorks(window.sessionStorage);
  const driver = canLocal ? window.localStorage : (canSession ? window.sessionStorage : null);
  return {
    type: canLocal ? "localStorage" : (canSession ? "sessionStorage" : "memory"),
    getItem:(k)=> driver ? driver.getItem(k) : (window.__MS_MEM__ ?? null),
    setItem:(k,v)=> { if(driver) driver.setItem(k,v); else window.__MS_MEM__=v; },
    removeItem:(k)=> { if(driver) driver.removeItem(k); else window.__MS_MEM__=null; }
  };
})();

function fmtEUR(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
}
function fmt2(n){
  const v = Number(n||0);
  return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function num(v){
  const x = Number(String(v??"").replace(",", "."));
  return Number.isFinite(x) ? x : 0;
}
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function todayISO(){
  const d=new Date();
  const p=(x)=>String(x).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(str){
  return String(str??"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function safeMailto(email){
  const e = String(email||"").trim();
  if(!e) return "";
  const href = "mailto:"+encodeURIComponent(e);
  return `<a href="${href}">${escapeHtml(e)}</a>`;
}
function safeTel(phone){
  const p = String(phone||"").trim();
  if(!p) return "";
  const cleaned = p.replace(/[^\d+]/g,"");
  return `<a href="tel:${escapeHtml(cleaned)}">${escapeHtml(p)}</a>`;
}
function safeUrl(url){
  let u = String(url||"").trim();
  if(!u) return "";
  if(!/^https?:\/\//i.test(u)) u = "https://"+u;
  return `<a href="${escapeHtml(u)}">${escapeHtml(u)}</a>`;
}

/* =========================
   Store
========================= */
const Store = {
  data:null,
  load(){
    const raw = StorageDriver.getItem(DB_KEY);
    if(raw){
      try{ this.data = JSON.parse(raw); }catch(e){ this.data=null; }
    }
    if(!this.data){
      this.data = {
        settings:{
          company:"Masculine Security",
          addr:"Werschenregerstra√üe 6\n28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          phone:"+4915778697052",
          website:"",
          iban:"DE98 1001 1001 2333 0146 96",
          bic:"NTSBDEB1XXX",
          taxid:"",
          hint:"Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet."
        },
        customers:[],
        invoices:[],
        employees:[]
      };
      this.save(true);
    }else{
      // migrate fields
      this.data.settings = this.data.settings || {};
      const s=this.data.settings;
      if(s.website===undefined) s.website="";
      if(s.taxid===undefined) s.taxid="";
      if(!Array.isArray(this.data.customers)) this.data.customers=[];
      if(!Array.isArray(this.data.invoices)) this.data.invoices=[];
      if(!Array.isArray(this.data.employees)) this.data.employees=[];
      this.save(true);
    }
    UI.updatePills();
    UI.updateStorageNote();
  },
  save(silent){
    try{
      StorageDriver.setItem(DB_KEY, JSON.stringify(this.data));
      if(!silent) Toast.show("Gespeichert");
      UI.setStatus("Gespeichert", true);
      UI.updatePills();
      UI.updateStorageNote();
    }catch(e){
      UI.setStatus("Speichern FEHLER: "+e.message, false);
      Toast.show("Speichern FEHLER");
    }
  },
  wipe(){
    StorageDriver.removeItem(DB_KEY);
    location.reload();
  }
};

/* =========================
   UI Navigation + Status
========================= */
const UI = {
  current:"invoices",
  go(page){
    this.current=page;
    // nav active
    [...document.querySelectorAll("#nav button")].forEach(b=>{
      b.classList.toggle("active", b.dataset.page===page);
    });
    // show pages
    ["invoices","customers","employees","payroll","settings"].forEach(p=>{
      $("page-"+p).classList.toggle("hide", p!==page);
    });
    // top title/sub
    const map = {
      invoices:["Rechnung","Tage + Std/Tag + ‚Ç¨/h ‚Üí Auto ‚Ä¢ PDF"],
      customers:["Kunden","Speichern ‚Ä¢ Liste ‚Ä¢ Klickbare Links"],
      employees:["Mitarbeiter","SV/Kasse/Steuerklasse ‚Ä¢ Speichern"],
      payroll:["Payroll","PDF: Lohnabrechnung / Arbeitbescheinigung / Lohnsteuerbescheinigung"],
      settings:["Firma","Einstellungen ‚Ä¢ Klickbare Links"]
    };
    $("pageTitle").textContent = map[page][0];
    $("pageSub").textContent = map[page][1];
    // refresh selects/links
    if(page==="invoices"){ Invoices.fillCustomerSelect(); Invoices.renderLinks(); }
    if(page==="payroll"){ Payroll.fillEmployeeSelect(); UI.renderFirmaLinks(); Payroll.calc(); }
    if(page==="settings"){ Settings.loadToForm(); UI.renderFirmaLinks(); }
    if(page==="employees"){ Employees.renderList(); }
    if(page==="customers"){ Customers.renderList(); }
  },
  setStatus(text, on){
    $("statusText").textContent=text;
    $("dot").classList.toggle("off", !on);
  },
  updatePills(){
    $("pillInvoices").textContent = String(Store.data.invoices.length||0);
    $("pillCustomers").textContent = String(Store.data.customers.length||0);
    $("pillEmployees").textContent = String(Store.data.employees.length||0);
    $("storeTag").textContent = StorageDriver.type;
  },
  updateStorageNote(){
    const ok = StorageDriver.type!=="memory";
    $("storageNote").textContent = "Storage: "+StorageDriver.type+(ok?" ‚úÖ":" ‚ö†Ô∏è (nur tempor√§r)");
  },
  renderFirmaLinks(){
    const s=Store.data.settings||{};
    const lines = [];
    if(s.email) lines.push(`<div><b>Email:</b> ${safeMailto(s.email)}</div>`);
    if(s.phone) lines.push(`<div><b>Tel:</b> ${safeTel(s.phone)}</div>`);
    if(s.website) lines.push(`<div><b>Web:</b> ${safeUrl(s.website)}</div>`);
    if(s.taxid) lines.push(`<div><b>Steuernummer/ID:</b> ${escapeHtml(s.taxid)}</div>`);
    if(!lines.length) lines.push("‚Äî");
    $("firmaLinksBox").innerHTML = lines.join("");
    $("firmaLinksBox2").innerHTML = lines.join("");
    $("firmaLinksBox3").innerHTML = lines.join("");
  }
};

/* =========================
   Customers
========================= */
const Customers = {
  clearForm(){
    $("c_name").value="";
    $("c_email").value="";
    $("c_phone").value="";
    $("c_addr").value="";
    $("c_search").value="";
  },
  save(){
    const name=$("c_name").value.trim();
    if(!name){ Toast.show("Name fehlt"); return; }
    const c={
      id: uid(),
      name,
      email:$("c_email").value.trim(),
      phone:$("c_phone").value.trim(),
      addr:$("c_addr").value.trim()
    };
    Store.data.customers.push(c);
    Store.save();
    this.clearForm();
    this.renderList();
    Invoices.fillCustomerSelect();
    UI.updatePills();
  },
  remove(id){
    Store.data.customers = Store.data.customers.filter(x=>x.id!==id);
    // also remove from invoices references (optional)
    Store.data.invoices.forEach(inv=>{
      if(inv.customerId===id) inv.customerId="";
    });
    Store.save();
    this.renderList();
    Invoices.fillCustomerSelect();
  },
  renderList(){
    const q=$("c_search").value.trim().toLowerCase();
    const rows = Store.data.customers
      .filter(c=>{
        if(!q) return true;
        return (c.name||"").toLowerCase().includes(q) || (c.email||"").toLowerCase().includes(q);
      })
      .map(c=>`
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${c.email?safeMailto(c.email):""}</td>
          <td style="white-space:pre-line">${escapeHtml(c.addr||"")}</td>
          <td class="right">
            <button class="btn danger" onclick="Customers.remove('${c.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("");
    $("customersList").innerHTML = rows || `<tr><td colspan="4" class="muted">Keine Kunden</td></tr>`;
  }
};

/* =========================
   Employees
========================= */
const Employees = {
  clearForm(){
    $("m_name").value="";
    $("m_persnr").value="";
    $("m_addr").value="";
    $("m_taxid").value="";
    $("m_taxclass").value="I";
    $("m_family").value="single";
    $("m_children").value="0";
    $("m_kasse").value="";
    $("m_kasse_no").value="";
    $("m_versnr").value="";
    $("m_rate").value="";
    $("m_sv").value="yes";
    $("m_edit_id").value="";
    $("m_search").value="";
  },
  save(){
    const id = $("m_edit_id").value || uid();
    const name=$("m_name").value.trim();
    if(!name){ Toast.show("Name fehlt"); return; }
    const emp = {
      id,
      name,
      persnr:$("m_persnr").value.trim(),
      addr:$("m_addr").value.trim(),
      taxid:$("m_taxid").value.trim(),
      taxclass:$("m_taxclass").value,
      family:$("m_family").value,
      children: Math.max(0, parseInt($("m_children").value||"0",10) || 0),
      krankenkasse:$("m_kasse").value.trim(),
      krankenkasse_no:$("m_kasse_no").value.trim(),
      versicherungsnr:$("m_versnr").value.trim(),
      rate: num($("m_rate").value),
      sv: $("m_sv").value==="yes"
    };
    const idx = Store.data.employees.findIndex(x=>x.id===id);
    if(idx>=0) Store.data.employees[idx]=emp;
    else Store.data.employees.push(emp);
    Store.save();
    this.clearForm();
    this.renderList();
    Payroll.fillEmployeeSelect();
  },
  edit(id){
    const e=Store.data.employees.find(x=>x.id===id);
    if(!e) return;
    $("m_name").value=e.name||"";
    $("m_persnr").value=e.persnr||"";
    $("m_addr").value=e.addr||"";
    $("m_taxid").value=e.taxid||"";
    $("m_taxclass").value=e.taxclass||"I";
    $("m_family").value=e.family||"single";
    $("m_children").value=String(e.children??0);
    $("m_kasse").value=e.krankenkasse||"";
    $("m_kasse_no").value=e.krankenkasse_no||"";
    $("m_versnr").value=e.versicherungsnr||"";
    $("m_rate").value=e.rate?fmt2(e.rate):"";
    $("m_sv").value=e.sv?"yes":"no";
    $("m_edit_id").value=e.id;
    Toast.show("Bearbeiten: "+e.name);
  },
  remove(id){
    Store.data.employees = Store.data.employees.filter(x=>x.id!==id);
    Store.save();
    this.renderList();
    Payroll.fillEmployeeSelect();
  },
  renderList(){
    const q=$("m_search").value.trim().toLowerCase();
    const rows = Store.data.employees
      .filter(e=>{
        if(!q) return true;
        return (e.name||"").toLowerCase().includes(q)
          || (e.taxid||"").toLowerCase().includes(q)
          || (e.persnr||"").toLowerCase().includes(q);
      })
      .map(e=>`
        <tr>
          <td>${escapeHtml(e.name||"")}</td>
          <td>${escapeHtml(e.persnr||"")}</td>
          <td>${escapeHtml(e.krankenkasse||"")}</td>
          <td>${escapeHtml(e.taxclass||"")}</td>
          <td class="right">
            <button class="btn" onclick="Employees.edit('${e.id}')">Edit</button>
            <button class="btn danger" onclick="Employees.remove('${e.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join("");
    $("employeesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Mitarbeiter</td></tr>`;
  }
};

/* =========================
   Invoices
========================= */
const Invoices = {
  newInvoice(){
    $("i_edit_id").value="";
    $("i_no").value=this.nextNumber();
    $("i_date").value=todayISO();
    $("i_von").value="";
    $("i_bis").value="";
    $("i_due").value="";
    $("i_status").value="Entwurf";
    $("i_customer").value="";
    $("w_days").value="";
    $("w_hpd").value="";
    $("w_rate").value="";
    $("w_total_hours").value="";
    this.lines = [ this.makeLine("Sicherheitsdienstleistung (Arbeitszeit)", 0, 0) ];
    this.renderLines();
    this.recalc();
  },
  lines:[],
  makeLine(desc, qty, price){
    return { id: uid(), desc: desc||"", qty: num(qty), price: num(price) };
  },
  addLine(){
    this.lines.push(this.makeLine("",0,0));
    this.renderLines();
    this.recalc();
  },
  removeLine(id){
    this.lines = this.lines.filter(l=>l.id!==id);
    if(!this.lines.length) this.lines=[this.makeLine("",0,0)];
    this.renderLines();
    this.recalc();
  },
  renderLines(){
    const rows = this.lines.map(l=>`
      <tr>
        <td><input style="width:100%" value="${escapeHtml(l.desc)}" oninput="Invoices.updateLine('${l.id}','desc',this.value)"/></td>
        <td class="right"><input style="width:120px;text-align:right" value="${fmt2(l.qty)}" oninput="Invoices.updateLine('${l.id}','qty',this.value)"/></td>
        <td class="right"><input style="width:120px;text-align:right" value="${fmt2(l.price)}" oninput="Invoices.updateLine('${l.id}','price',this.value)"/></td>
        <td class="right">${fmtEUR(round2(l.qty*l.price))}</td>
        <td class="right"><button class="btn danger" onclick="Invoices.removeLine('${l.id}')">L√∂schen</button></td>
      </tr>
    `).join("");
    $("linesBody").innerHTML = rows;
  },
  updateLine(id, key, val){
    const l=this.lines.find(x=>x.id===id);
    if(!l) return;
    if(key==="desc") l.desc = String(val||"");
    if(key==="qty") l.qty = num(val);
    if(key==="price") l.price = num(val);
    this.recalc();
  },
  applyAutoHours(){
    const days=num($("w_days").value);
    const hpd=num($("w_hpd").value);
    const rate=num($("w_rate").value);
    const total = round2(days*hpd);
    $("w_total_hours").value = total ? fmt2(total) : "";
    if(this.lines.length===0) this.lines=[this.makeLine("Sicherheitsdienstleistung (Arbeitszeit)",0,0)];
    // fill line 1
    this.lines[0].qty = total;
    this.lines[0].price = rate;
    if(!this.lines[0].desc) this.lines[0].desc="Sicherheitsdienstleistung (Arbeitszeit)";
    this.renderLines();
    this.recalc();
  },
  recalc(){
    const sum = round2(this.lines.reduce((s,l)=>s + round2(l.qty*l.price), 0));
    $("sum_net").value = fmt2(sum);
    $("sum_total").value = fmt2(sum);
    $("i_preview").textContent = `Positionen: ${this.lines.length} ‚Ä¢ Gesamt: ${fmtEUR(sum)} ‚Ä¢ USt: 0,00 ‚Ç¨`;
    this.renderLinks();
  },
  nextNumber(){
    // MS-YYYY-0001
    const y = new Date().getFullYear();
    const prefix = "MS-"+y+"-";
    const nums = Store.data.invoices
      .map(x=>String(x.no||""))
      .filter(n=>n.startsWith(prefix))
      .map(n=>parseInt(n.slice(prefix.length),10))
      .filter(n=>Number.isFinite(n));
    const next = (nums.length?Math.max(...nums):0)+1;
    return prefix + String(next).padStart(4,"0");
  },
  save(){
    const no=$("i_no").value.trim() || this.nextNumber();
    const invoice = {
      id: $("i_edit_id").value || uid(),
      no,
      date:$("i_date").value || todayISO(),
      von:$("i_von").value||"",
      bis:$("i_bis").value||"",
      due:$("i_due").value||"",
      status:$("i_status").value||"Entwurf",
      customerId:$("i_customer").value||"",
      auto:{ days:num($("w_days").value), hpd:num($("w_hpd").value), rate:num($("w_rate").value) },
      lines: this.lines.map(l=>({ ...l })),
    };
    const idx = Store.data.invoices.findIndex(x=>x.id===invoice.id);
    if(idx>=0) Store.data.invoices[idx]=invoice;
    else Store.data.invoices.unshift(invoice);
    Store.save();
    this.renderList();
    UI.updatePills();
  },
  edit(id){
    const inv=Store.data.invoices.find(x=>x.id===id);
    if(!inv) return;
    $("i_edit_id").value=inv.id;
    $("i_no").value=inv.no||"";
    $("i_date").value=inv.date||todayISO();
    $("i_von").value=inv.von||"";
    $("i_bis").value=inv.bis||"";
    $("i_due").value=inv.due||"";
    $("i_status").value=inv.status||"Entwurf";
    this.fillCustomerSelect();
    $("i_customer").value=inv.customerId||"";
    $("w_days").value=inv.auto?.days ?? "";
    $("w_hpd").value=inv.auto?.hpd ?? "";
    $("w_rate").value=inv.auto?.rate ?? "";
    this.lines = (inv.lines||[]).map(l=>({id:l.id||uid(), desc:l.desc||"", qty:num(l.qty), price:num(l.price)}));
    if(!this.lines.length) this.lines=[this.makeLine("",0,0)];
    this.applyAutoHours(); // will also recalc and render
    Toast.show("Invoice geladen");
  },
  remove(id){
    Store.data.invoices = Store.data.invoices.filter(x=>x.id!==id);
    Store.save();
    this.renderList();
    UI.updatePills();
  },
  fillCustomerSelect(){
    const sel=$("i_customer");
    const current=sel.value;
    sel.innerHTML = [`<option value="">Bitte Kunde w√§hlen</option>`].concat(
      Store.data.customers.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`)
    ).join("");
    if(current) sel.value=current;
  },
  renderList(){
    const q=$("inv_search").value.trim().toLowerCase();
    const f=$("inv_filter").value;
    const rows = Store.data.invoices
      .filter(inv=>{
        const c = Store.data.customers.find(x=>x.id===inv.customerId);
        const cname=(c?.name||"").toLowerCase();
        const okQ = !q || String(inv.no||"").toLowerCase().includes(q) || String(inv.status||"").toLowerCase().includes(q) || cname.includes(q);
        const okF = !f || inv.status===f;
        return okQ && okF;
      })
      .map(inv=>{
        const c = Store.data.customers.find(x=>x.id===inv.customerId);
        const sum = round2((inv.lines||[]).reduce((s,l)=>s + round2(num(l.qty)*num(l.price)),0));
        return `
          <tr>
            <td>${escapeHtml(inv.no||"")}</td>
            <td>${escapeHtml(c?.name||"")}</td>
            <td>${escapeHtml(inv.status||"")}</td>
            <td class="right">${fmtEUR(sum)}</td>
            <td class="right">
              <button class="btn" onclick="Invoices.edit('${inv.id}')">√ñffnen</button>
              <button class="btn danger" onclick="Invoices.remove('${inv.id}')">L√∂schen</button>
            </td>
          </tr>
        `;
      }).join("");
    $("invoicesList").innerHTML = rows || `<tr><td colspan="5" class="muted">Keine Rechnungen</td></tr>`;
  },
  renderLinks(){
    UI.renderFirmaLinks();
    const cid = $("i_customer").value || "";
    const c = Store.data.customers.find(x=>x.id===cid);
    if(!c){ $("customerLinksBox").innerHTML = "‚Äî"; return; }
    const html =
      `<div><b>Name:</b> ${escapeHtml(c.name||"")}</div>`+
      (c.email?`<div><b>Email:</b> ${safeMailto(c.email)}</div>`:"")+
      (c.phone?`<div><b>Telefon:</b> ${safeTel(c.phone)}</div>`:"")+
      (c.addr?`<div><b>Adresse:</b><div style="white-space:pre-line">${escapeHtml(c.addr)}</div></div>`:"");
    $("customerLinksBox").innerHTML = html;
  },
  printPDF(){
    const invId = $("i_edit_id").value;
    const tmp = {
      no:$("i_no").value.trim(),
      date:$("i_date").value||todayISO(),
      von:$("i_von").value||"",
      bis:$("i_bis").value||"",
      due:$("i_due").value||"",
      status:$("i_status").value||"Entwurf",
      customerId:$("i_customer").value||"",
      lines: this.lines.map(l=>({ ...l })),
    };
    const s=Store.data.settings||{};
    const c=Store.data.customers.find(x=>x.id===tmp.customerId) || {name:"",email:"",addr:"",phone:""};

    const sum = round2(tmp.lines.reduce((ss,l)=>ss + round2(num(l.qty)*num(l.price)),0));

    const emailLine = s.email ? `E-Mail: ${safeMailto(s.email)}` : "";
    const telLine = s.phone ? `Tel: ${safeTel(s.phone)}` : "";
    const webLine = s.website ? `Web: ${safeUrl(s.website)}` : "";
    const firmTax = s.taxid ? `Steuernummer/ID: ${escapeHtml(s.taxid)}` : "";

    const rows = tmp.lines.map((l,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(l.desc||"")}</td>
        <td class="right">${fmt2(num(l.qty))}</td>
        <td class="right">${fmtEUR(num(l.price))}</td>
        <td class="right">${fmtEUR(round2(num(l.qty)*num(l.price)))}</td>
      </tr>
    `).join("");

    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Rechnung ${escapeHtml(tmp.no)}</title>
<style>
  @page{size:A4;margin:12mm}
  body{font-family:Arial;color:#000}
  a{color:#000;text-decoration:underline}
  .top{display:flex;justify-content:space-between;gap:20px;border-bottom:1px solid #ddd;padding-bottom:10px;margin-bottom:10px}
  h1{margin:0;font-size:18px}
  .small{font-size:11px;color:#333;white-space:pre-line}
  .box{border:1px solid #ddd;padding:10px;margin:10px 0}
  table{width:100%;border-collapse:collapse;font-size:11px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .right{text-align:right}
</style></head><body>
<div class="small">${new Date().toLocaleString("de-DE")}</div>
<div class="top">
  <div>
    <h1>Rechnung</h1>
    <div><b>${escapeHtml(s.company||"")}</b></div>
    <div class="small">${escapeHtml(s.addr||"")}</div>
    <div class="small">${emailLine}</div>
    ${telLine?`<div class="small">${telLine}</div>`:""}
    ${webLine?`<div class="small">${webLine}</div>`:""}
    ${firmTax?`<div class="small">${firmTax}</div>`:""}
  </div>
  <div class="small" style="text-align:right">
    <div><b>Rechnungs-Nr.:</b> ${escapeHtml(tmp.no)}</div>
    <div><b>Rechnungsdatum:</b> ${escapeHtml(tmp.date)}</div>
    ${tmp.von||tmp.bis?`<div><b>Zeitraum:</b> ${escapeHtml(tmp.von||"")} ‚Äì ${escapeHtml(tmp.bis||"")}</div>`:""}
    ${tmp.due?`<div><b>F√§llig:</b> ${escapeHtml(tmp.due)}</div>`:""}
    <div><b>Status:</b> ${escapeHtml(tmp.status)}</div>
  </div>
</div>

<div class="box">
  <div><b>Rechnung an:</b></div>
  <div><b>${escapeHtml(c.name||"")}</b></div>
  ${c.email?`<div class="small">E-Mail: ${safeMailto(c.email)}</div>`:""}
  ${c.phone?`<div class="small">Tel: ${safeTel(c.phone)}</div>`:""}
  ${c.addr?`<div class="small">${escapeHtml(c.addr)}</div>`:""}
</div>

<table>
  <thead>
    <tr>
      <th style="width:40px">#</th>
      <th>Leistung</th>
      <th class="right" style="width:80px">Menge</th>
      <th class="right" style="width:90px">Preis</th>
      <th class="right" style="width:90px">Netto</th>
    </tr>
  </thead>
  <tbody>
    ${rows || `<tr><td colspan="5">‚Äî</td></tr>`}
  </tbody>
</table>

<div class="box" style="text-align:right">
  <div><b>Summe Netto:</b> ${fmtEUR(sum)}</div>
  <div><b>Umsatzsteuer:</b> 0,00 ‚Ç¨</div>
  <div><b>Zu zahlen:</b> ${fmtEUR(sum)}</div>
</div>

<div class="small"><b>Zahlung:</b> Bitte √ºberweisen Sie den Betrag auf folgendes Konto:</div>
<div class="small">IBAN: ${escapeHtml(s.iban||"")} ‚Ä¢ BIC: ${escapeHtml(s.bic||"")}</div>
<div class="small" style="margin-top:8px"><b>Hinweis:</b> ${escapeHtml(s.hint||"")}</div>

<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
    openPrint(html);
  }
};

/* =========================
   Payroll (Unified PDFs - NO bottom text)
========================= */
const Payroll = {
  fillEmployeeSelect(){
    const sel=$("p_emp");
    const current=sel.value;
    sel.innerHTML = [`<option value="">Bitte Mitarbeiter w√§hlen</option>`].concat(
      Store.data.employees.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}${e.persnr?` (PersNr ${escapeHtml(e.persnr)})`:""}</option>`)
    ).join("");
    if(current) sel.value=current;
  },
  employeeChanged(){
    const e=Store.data.employees.find(x=>x.id===$("p_emp").value);
    if(e){
      $("p_rate").value = e.rate ? fmt2(e.rate) : "";
      $("p_persnr").value = ($("p_persnr").value||"").trim() || (e.persnr||"");
    }
    this.calc();
  },
  calc(){
    const emp=Store.data.employees.find(x=>x.id===$("p_emp").value) || null;
    const month = ($("p_month").value||"").trim() || todayISO().slice(0,7);
    const hours = num($("p_hours").value);
    const rate  = num($("p_rate").value);
    const brutto = round2(hours * rate);

    // DEMO only (not official)
    const svEmployee = emp?.sv ? round2(brutto * 0.188) : 0;
    const svEmployer = emp?.sv ? round2(brutto * 0.205) : 0;
    const lst = round2(brutto * 0.095);
    const netto = round2(brutto - svEmployee - lst);

    const earnings = [{ code:"2000", text:"Zeitlohn", hours, unit:"Std.", rate, amount: brutto }];
    const deductions = [
      { text:"Lohnsteuer", amount: lst },
      ...(emp?.sv ? [{ text:"SV-Beitrag AN", amount: svEmployee }] : [])
    ];

    const sumDeductions = round2(deductions.reduce((s,x)=>s + round2(num(x.amount)), 0));
    const zahlbetrag = round2(brutto - sumDeductions);

    const persnr = ($("p_persnr").value||"").trim() || (emp?.persnr||"");
    const s = Store.data.settings || {};

    $("payTable").innerHTML = `
      <tr><td>Monat</td><td class="right">${escapeHtml(month)}</td></tr>
      <tr><td>Stunden</td><td class="right">${fmt2(hours)}</td></tr>
      <tr><td>‚Ç¨/h</td><td class="right">${fmt2(rate)}</td></tr>
      <tr><td><b>Brutto</b></td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
      <tr><td>Summe Abz√ºge</td><td class="right">${fmtEUR(sumDeductions)}</td></tr>
      <tr><td><b>Netto / Zahlbetrag</b></td><td class="right"><b>${fmtEUR(zahlbetrag)}</b></td></tr>
    `;
    return { s, emp, month, persnr, hours, rate, brutto, earnings, deductions, svEmployee, svEmployer, lst, netto, sumDeductions, zahlbetrag };
  },

  buildUnifiedDocHTML(ctx, docType){
    const {s, emp, month, persnr, earnings, deductions, brutto, sumDeductions, zahlbetrag, svEmployer, lst, svEmployee} = ctx;
    if(!emp) return null;

    const now = new Date();
    const stamp = now.toLocaleString("de-DE");

    const familyLabel = (emp.family==="married") ? "verheiratet" : "single";
    const children = String(emp.children ?? "0");
    const taxclass = emp.taxclass || "I";
    const kasse = emp.krankenkasse || "";
    const kasseNo = emp.krankenkasse_no ? ` ‚Ä¢ Nr.: ${escapeHtml(emp.krankenkasse_no)}` : "";
    const versNo = emp.versicherungsnr ? ` ‚Ä¢ Vers.-Nr.: ${escapeHtml(emp.versicherungsnr)}` : "";

    const title =
      docType==="arbeit" ? "Arbeitbescheinigung" :
      docType==="lohnsteuer" ? "Lohnsteuerbescheinigung" :
      "Lohn- und Gehaltsabrechnung";

    const emailLine = s.email ? `E-Mail: ${safeMailto(s.email)}` : "";
    const telLine = s.phone ? `Tel: ${safeTel(s.phone)}` : "";
    const webLine = s.website ? `Web: ${safeUrl(s.website)}` : "";
    const firmTax = s.taxid ? `Steuernummer/ID: ${escapeHtml(s.taxid)}` : "";

    const eRows = (earnings||[]).map(x=>`
      <tr>
        <td>${escapeHtml(x.code||"")}</td>
        <td>${escapeHtml(x.text||"")}</td>
        <td class="right">${fmt2(num(x.hours))}</td>
        <td class="right">${escapeHtml(x.unit||"")}</td>
        <td class="right">${fmt2(num(x.rate))}</td>
        <td class="right">${fmtEUR(num(x.amount))}</td>
      </tr>
    `).join("");

    const dRows = (deductions||[]).map(x=>`
      <tr><td>${escapeHtml(x.text||"")}</td><td class="right">${fmtEUR(num(x.amount))}</td></tr>
    `).join("");

    // Middle blocks per docType, but same template
    let middleBlockHTML = "";
    if(docType==="arbeit"){
      middleBlockHTML = `
        <div class="box">
          <div class="small"><b>Besch√§ftigung</b></div>
          <table>
            <tr><td>Zeitraum (Monat)</td><td class="right"><b>${escapeHtml(month)}</b></td></tr>
            <tr><td>Stunden</td><td class="right">${fmt2(ctx.hours)}</td></tr>
            <tr><td>‚Ç¨/h</td><td class="right">${fmt2(ctx.rate)}</td></tr>
            <tr><td>Brutto</td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
            <tr><td>Netto/Zahlbetrag</td><td class="right"><b>${fmtEUR(zahlbetrag)}</b></td></tr>
          </table>
        </div>
      `;
    }
    if(docType==="lohnsteuer"){
      middleBlockHTML = `
        <div class="box">
          <div class="small"><b>Lohnsteuer-Daten</b></div>
          <table>
            <tr><td>Steuerklasse</td><td class="right"><b>${escapeHtml(taxclass)}</b></td></tr>
            <tr><td>Kinder</td><td class="right">${escapeHtml(children)}</td></tr>
            <tr><td>Bruttoarbeitslohn</td><td class="right"><b>${fmtEUR(brutto)}</b></td></tr>
            <tr><td>Lohnsteuer</td><td class="right"><b>${fmtEUR(lst)}</b></td></tr>
            <tr><td>SV Arbeitnehmer</td><td class="right">${fmtEUR(svEmployee)}</td></tr>
            <tr><td>Netto/Zahlbetrag</td><td class="right"><b>${fmtEUR(zahlbetrag)}</b></td></tr>
          </table>
        </div>
      `;
    }

    // For "realistic" docs keep same structure, but no bottom text note.
    const showEarnings = (docType==="lohn");
    const showDeductions = (docType==="lohn");

    // Watermark kept, but no footer text
    const watermarkText = "ENTWURF";
    const watermarkCSS = `
      .wm{
        position:fixed; inset:0;
        display:flex; align-items:center; justify-content:center;
        font-size:78px; font-weight:900;
        color:rgba(0,0,0,.07);
        transform:rotate(-18deg);
        pointer-events:none;
        z-index:0;
      }
      .sheet{ position:relative; z-index:1; }
    `;

    return `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)} ${escapeHtml(month)}</title>
<style>
  @page{size:A4;margin:12mm}
  body{font-family:Arial;color:#000}
  a{color:#000;text-decoration:underline}
  .topstamp{font-size:11px;color:#333;display:flex;justify-content:space-between;align-items:flex-start}
  h1{margin:8px 0 6px 0;font-size:18px}
  .subtitle{font-size:12px;color:#333;margin-bottom:8px}
  .box{border:1px solid #bbb;padding:8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:11px;color:#333;white-space:pre-line}
  .line{border-top:1px solid #bbb;margin:10px 0}
  table{width:100%;border-collapse:collapse;font-size:11px}
  th,td{border-bottom:1px solid #ddd;padding:6px;vertical-align:top}
  th{border-top:1px solid #bbb}
  .right{text-align:right}
  .footergrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  ${watermarkCSS}
</style>
</head>
<body>
<div class="wm">${escapeHtml(watermarkText)}</div>
<div class="sheet">

<div class="topstamp">
  <div>${escapeHtml(stamp)}</div>
  <div>${escapeHtml(title)}</div>
</div>

<h1>${escapeHtml(title)} (Simulation)</h1>
<div class="subtitle">Monat/Zeitraum: <b>${escapeHtml(month)}</b></div>

<div class="grid">
  <div class="box">
    <div class="small"><b>Arbeitgeber</b></div>
    <div><b>${escapeHtml(s.company||"")}</b></div>
    <div class="small">${escapeHtml(s.addr||"")}</div>
    <div class="small">${emailLine}</div>
    ${telLine?`<div class="small">${telLine}</div>`:""}
    ${webLine?`<div class="small">${webLine}</div>`:""}
    ${firmTax?`<div class="small">${firmTax}</div>`:""}
  </div>

  <div class="box">
    <div class="small"><b>Arbeitnehmer</b></div>
    <div><b>${escapeHtml(emp.name||"")}</b> ‚Ä¢ <b>Pers.-Nr.</b>: ${escapeHtml(persnr||"")}</div>
    ${emp.addr?`<div class="small">${escapeHtml(emp.addr)}</div>`:""}
    ${emp.taxid?`<div class="small">Steuer-ID: ${escapeHtml(emp.taxid)}</div>`:""}
    <div class="small"><b>Krankenkasse:</b> ${escapeHtml(kasse)}${kasseNo}${versNo}</div>
    <div class="small"><b>Steuerklasse:</b> ${escapeHtml(taxclass)} ‚Ä¢ <b>Familienstand:</b> ${escapeHtml(familyLabel)} ‚Ä¢ <b>Kinder:</b> ${escapeHtml(children)}</div>
  </div>
</div>

<div class="line"></div>

${middleBlockHTML}

${showEarnings ? `
<div class="box">
  <div class="small"><b>Verdienst / Bez√ºge</b></div>
  <table>
    <thead>
      <tr>
        <th style="width:60px">Code</th>
        <th>Bezeichnung</th>
        <th class="right" style="width:70px">Stunden</th>
        <th class="right" style="width:55px">Einheit</th>
        <th class="right" style="width:70px">Lohnsatz</th>
        <th class="right" style="width:90px">Betrag</th>
      </tr>
    </thead>
    <tbody>
      ${eRows || `<tr><td colspan="6">‚Äî</td></tr>`}
      <tr>
        <td colspan="5" class="right"><b>GESAMTBRUTTO:</b></td>
        <td class="right"><b>${fmtEUR(brutto)}</b></td>
      </tr>
    </tbody>
  </table>
</div>
` : ``}

${showDeductions ? `
<div class="footergrid">
  <div class="box">
    <div class="small"><b>Gesetzliche Abz√ºge</b></div>
    <table>
      <tbody>
        ${dRows || `<tr><td>‚Äî</td><td class="right">0,00 ‚Ç¨</td></tr>`}
        <tr>
          <td class="right"><b>Summe Abz√ºge</b></td>
          <td class="right"><b>${fmtEUR(sumDeductions)}</b></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="box">
    <div class="small"><b>Netto / Auszahlung</b></div>
    <table>
      <tbody>
        <tr><td>Netto / Zahlbetrag</td><td class="right"><b>${fmtEUR(zahlbetrag)}</b></td></tr>
        <tr><td class="small">SV Arbeitgeber</td><td class="right">${fmtEUR(svEmployer||0)}</td></tr>
      </tbody>
    </table>
  </div>
</div>
` : ``}

<div class="small" style="margin-top:16px">
  Ort/Datum: ____________________  &nbsp;&nbsp; Unterschrift Arbeitgeber: ____________________
</div>

</div>
<script>window.onload=()=>setTimeout(()=>window.print(),150);<\/script>
</body></html>`;
  },

  lohnPDF(){
    const ctx=this.calc();
    if(!ctx.emp){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(this.buildUnifiedDocHTML(ctx,"lohn"));
  },
  arbeitPDF(){
    const ctx=this.calc();
    if(!ctx.emp){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(this.buildUnifiedDocHTML(ctx,"arbeit"));
  },
  lohnsteuerPDF(){
    const ctx=this.calc();
    if(!ctx.emp){ Toast.show("Mitarbeiter w√§hlen"); return; }
    openPrint(this.buildUnifiedDocHTML(ctx,"lohnsteuer"));
  }
};

/* =========================
   Settings
========================= */
const Settings = {
  loadToForm(){
    const s=Store.data.settings||{};
    $("s_company").value=s.company||"";
    $("s_addr").value=s.addr||"";
    $("s_email").value=s.email||"";
    $("s_phone").value=s.phone||"";
    $("s_website").value=s.website||"";
    $("s_taxid").value=s.taxid||"";
    $("s_iban").value=s.iban||"";
    $("s_bic").value=s.bic||"";
    $("s_hint").value=s.hint||"";
  },
  save(){
    const s=Store.data.settings||{};
    s.company=$("s_company").value.trim();
    s.addr=$("s_addr").value.trim();
    s.email=$("s_email").value.trim();
    s.phone=$("s_phone").value.trim();
    s.website=$("s_website").value.trim();
    s.taxid=$("s_taxid").value.trim();
    s.iban=$("s_iban").value.trim();
    s.bic=$("s_bic").value.trim();
    s.hint=$("s_hint").value.trim();
    Store.data.settings=s;
    Store.save();
    UI.renderFirmaLinks();
    $("brandTitle").textContent = s.company || "Masculine Security";
  }
};

/* =========================
   Export / Import
========================= */
function download(filename, text){
  const blob=new Blob([text],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function doExport(){
  download("ms-mini-office-export.json", JSON.stringify(Store.data,null,2));
}
function doImport(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      if(!obj || typeof obj!=="object") throw new Error("Invalid JSON");
      Store.data = obj;
      Store.save(true);
      Toast.show("Import OK");
      location.reload();
    }catch(e){
      Toast.show("Import Fehler");
    }
  };
  reader.readAsText(file);
}

/* =========================
   Print helper
========================= */
function openPrint(html){
  const w=window.open("about:blank","_blank");
  if(!w){ Toast.show("Popup blockiert"); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* =========================
   Events
========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  Store.load();

  // set brand
  $("brandTitle").textContent = Store.data.settings.company || "Masculine Security";

  // init
  UI.go("invoices");
  Invoices.newInvoice();
  Customers.renderList();
  Employees.renderList();
  Invoices.renderList();
  UI.renderFirmaLinks();

  // nav clicks
  [...document.querySelectorAll("#nav button")].forEach(b=>{
    b.addEventListener("click", ()=>UI.go(b.dataset.page));
  });

  // invoice events
  $("btnNewInvoice").addEventListener("click", ()=>{ UI.go("invoices"); Invoices.newInvoice(); });
  $("btnAddLine").addEventListener("click", ()=>Invoices.addLine());
  $("btnSaveInvoice").addEventListener("click", ()=>Invoices.save());
  $("btnPrintInvoice").addEventListener("click", ()=>Invoices.printPDF());
  $("i_customer").addEventListener("change", ()=>Invoices.renderLinks());
  $("w_days").addEventListener("input", ()=>Invoices.applyAutoHours());
  $("w_hpd").addEventListener("input", ()=>Invoices.applyAutoHours());
  $("w_rate").addEventListener("input", ()=>Invoices.applyAutoHours());
  $("inv_search").addEventListener("input", ()=>Invoices.renderList());
  $("inv_filter").addEventListener("change", ()=>Invoices.renderList());

  // customer events
  $("btnCustomerSave").addEventListener("click", ()=>Customers.save());
  $("btnCustomerClear").addEventListener("click", ()=>Customers.clearForm());
  $("c_search").addEventListener("input", ()=>Customers.renderList());

  // employee events
  $("btnEmployeeSave").addEventListener("click", ()=>Employees.save());
  $("btnEmployeeClear").addEventListener("click", ()=>Employees.clearForm());
  $("m_search").addEventListener("input", ()=>Employees.renderList());

  // payroll events
  $("p_emp").addEventListener("change", ()=>Payroll.employeeChanged());
  $("p_month").addEventListener("input", ()=>Payroll.calc());
  $("p_persnr").addEventListener("input", ()=>Payroll.calc());
  $("p_hours").addEventListener("input", ()=>Payroll.calc());
  $("p_rate").addEventListener("input", ()=>Payroll.calc());
  $("btnCalcPayroll").addEventListener("click", ()=>Payroll.calc());
  $("btnPDFLohn").addEventListener("click", ()=>Payroll.lohnPDF());
  $("btnPDFAArbeit").addEventListener("click", ()=>Payroll.arbeitPDF());
  $("btnPDFLSt").addEventListener("click", ()=>Payroll.lohnsteuerPDF());

  // settings events
  $("btnSettingsSave").addEventListener("click", ()=>Settings.save());

  // export/import/wipe
  $("btnExport").addEventListener("click", ()=>doExport());
  $("btnImport").addEventListener("click", ()=>$("fileImport").click());
  $("fileImport").addEventListener("change", (e)=>{ if(e.target.files?.[0]) doImport(e.target.files[0]); });
  $("btnWipe").addEventListener("click", ()=>{
    if(confirm("Wirklich alles l√∂schen?")) Store.wipe();
  });

});
</script>
</body>
</html>
